<!DOCTYPE html>
<html lang="ko">
<style>
    .btn-clear {
        display: none !important; /* ê°•ì œë¡œ ìˆ¨ê¹€ */
    }
    .btn-close {
        display: none !important; /* ê°•ì œë¡œ ìˆ¨ê¹€ */
    }
    .card {
        background-color: #ffffff;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        padding: 20px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        transition: transform 0.3s, box-shadow 0.3s;
        height: 400px;
    }
    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
    }

    .card-title {
        font-size: 18px;
        font-weight: bold;
        color: #333;
        margin-bottom: 10px;
    }

    .card-content {
        font-size: 14px;
        color: #555;
    }
    /* íŒì—… í™œì„±í™” ì‹œ */
    .popup-wrapper.active {
        transform: translateX(-50%) translateY(0); /* ğŸ“Œ í™”ë©´ ì•„ë˜ì—ì„œ ì˜¬ë¼ì˜¤ë„ë¡ ì„¤ì • */
        opacity: 1; /* ë³´ì´ë„ë¡ ì„¤ì • */
    }
    .popup-wrapper2.active {
        transform: translateX(-50%) translateY(0); /* ğŸ“Œ í™”ë©´ ì•„ë˜ì—ì„œ ì˜¬ë¼ì˜¤ë„ë¡ ì„¤ì • */
        opacity: 1; /* ë³´ì´ë„ë¡ ì„¤ì • */
    }
    /* íŒì—… ë°°ê²½ (ì–´ë‘¡ê²Œ ì²˜ë¦¬) */
    .popup-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100vh;
        background: rgba(0, 0, 0, 0.5); /* ğŸ“Œ ë°˜íˆ¬ëª… ê²€ì€ìƒ‰ ë°°ê²½ */
        z-index: 59; /* íŒì—…ë³´ë‹¤ í•œ ë‹¨ê³„ ë‚®ê²Œ ì„¤ì • */
        display: none; /* ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€ */
    }

    /* íŒì—…ì´ í™œì„±í™”ë  ë•Œ ë°°ê²½ í‘œì‹œ */
    .popup-overlay.active {
        display: block;
    }
    .card-content {
        white-space: pre-line; /* âœ… ì¤„ë°”ê¿ˆ ë°˜ì˜ */
    }
</style>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FACT CHECK</title>
    <link rel="icon" type="image/png" href="/images/logo/icon_FACT%20CHECK.png">
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/smoothness/jquery-ui.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/> <!-- Slide css -->
    <link rel="stylesheet" href="/resource/ax5ui/ax5ui.all.css">
    <link rel="stylesheet" type="text/css" href="/assets_mobile/css/import.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>

    <script src="/assets_mobile/js/ui.js"></script> <!-- Common js -->
    <script th:inline="javascript">
        var sandanData = /*[[${session.sandanList}]]*/ [];
    </script>


    <script type="text/javascript" src="/resource/ax5ui/ax5ui.all.min.js?v=1000"></script>

    <script type="text/javascript" src="/js/ax5commUtil.js?v=1070"></script>

    <script src="/js/common.js?v=1060"></script>
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script> <!-- Slide js -->
    <script src="/js/Mobile.js"></script>
</head>

<body>
<div class="mobile-wrapper page-ticket-list"><!-- â˜…í˜ì´ì§€ Classëª… -->
    <!-- [ëª¨ë°”ì¼] í—¤ë”  -->
    <div class="mobile-layout-header">
        <header>
            <div class="left">
                <a href="#" title="ì „ì²´ë©”ë‰´" class="logo">
                </a>
            </div>
            <div class="left" style="margin-left:35px;">
                <h2>FACT CHECK</h2>
            </div>
            <div class="right">
                <a href="#" title="ì „ì²´ë©”ë‰´" class="btn-menu">
                    <img src="/assets_mobile/images/icon/btn-menu.svg" alt="ì „ì²´ë©”ë‰´ ì•„ì´ì½˜">
                </a>
            </div>
        </header>
    </div> <!-- //mobile-layout-header end-->

    <!-- [ëª¨ë°”ì¼] ë©”ë‰´  -->
    <div th:insert="~{mobile/mobile_menu :: mobile_menu}"></div>
    <!-- [ëª¨ë°”ì¼] ì»¨ë´ì¸   -->
    <div class="mobile-layout-contents">
        <input type="hidden" id="REALID">
        <!--- (ë ˆì´ì•„ì›ƒ) Contents ì˜ì—­ -->
        <div class="layout-contents">
            <!-- ê²€ìƒ‰ ì˜ì—­  -->
<!--            <div class="search-wrap">-->
<!--            </div>-->
            <!-- ì»¨í…ì¸  ì˜ì—­  -->
            <div class="contents-wrap">

            </div> <!--// contents-wrap end-->
            <div id="addressWrap" class="contents-wrap">

            </div>
        </div> <!--//layout-contents end -->
    </div> <!-- //mobile-layout-contents end-->
    <button onclick="cardDetail()" style="margin-top: 10px; width: 100px; margin-left: auto">ìƒì„¸ë³´ê¸°</button>
    <button onclick="deductionDetail()" style="margin-top: 10px; width: 100px;">ì ìˆ˜ì´ë ¥</button>
    <button onclick="window.location.href = '/'" style="margin-top: 10px; width: 100px;">ë‹¤ì‹œì¡°íšŒ</button>
    </div> <!-- //mobile-layout-contents end-->
    <!-- íŒì—… ë°°ê²½ (í´ë¦­ ì°¨ë‹¨ + ì–´ë‘¡ê²Œ) -->
    <div class="popup-overlay" id="popupOverlay"></div>
    <div class="mobile-layout-popup" id="popup-history">
        <!--<div class="popup-overlay"></div>-->
        <div class="popup-wrapper" id="deductionWrap">
            <div class="popup-title">
                <h3>ì ìˆ˜ì´ë ¥</h3>
            </div>
            <div class="popup-contents">
                <div class="table-wrap" style="width: 600px">
                    <div class="write-wrap">
                        <section>a
                            <div class="tab-wrap" style="width: 100%;">
                                <ul class="tab-links" style="margin-bottom: 10px;">
                                </ul>

                                <section class="tab-item">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th style="text-align: center; width: 7%; padding: 5px; border: 1px solid #ddd; font-size: 13px;">
                                                    <label>ë“±ê¸°ëª©ì </label>
                                                </th>
                                                <th style="text-align: center; width: 7%; padding: 5px; border: 1px solid #ddd; font-size: 13px;">
                                                    <label>ê¸ˆì•¡</label>
                                                </th>
                                                <th style="text-align: center; width: 7%; padding: 5px; border: 1px solid #ddd; font-size: 13px;">
                                                    <label>ì ìˆ˜</label>
                                                </th>
                                                <th style="text-align: center; width: 7%; padding: 5px; border: 1px solid #ddd; font-size: 13px;">
                                                    <label>ê¸°ì¤€</label>
                                                </th>
                                                <th style="text-align: center; width: 7%; padding: 5px; border: 1px solid #ddd; font-size: 13px;">
                                                    <label>ì„ ìˆœìœ„</label>
                                                </th>
                                                <th style="text-align: center; width: 7%; padding: 5px; border: 1px solid #ddd; font-size: 13px;">
                                                    <label>ë‚ ì§œ</label>
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody id="scoreItems">

                                        </tbody>
                                    </table>
                                </section>
                            </div>
                        </section>
                    </div>
                </div>
            </div>
            <div class="popup-button">
                <button class="btn-popup-close btn-navy" id="closePopup">í™•ì¸</button>
            </div>
        </div>
    </div>

    <div class="mobile-layout-popup" id="popup-history2">
        <!--<div class="popup-overlay"></div>-->
        <div class="popup-wrapper" id="scoreWrapper">
            <div class="popup-title">
                <h3>ìƒì„¸ë³´ê¸°</h3>
            </div>
            <div class="popup-contents">
                <div class="table-wrap" style="width: 600px">
                    <div class="write-wrap">
                        <section class="tab-item">
                            <div class="tab-wrap" style="width: 100%;">
                                <ul class="tab-links" style="margin-bottom: 10px;">
                                </ul>

                                <section class="tab-item">
                                    <table>
                                        <thead>
                                        <tr>
                                            <th style="text-align: center; width: 20%; padding: 5px; border: 1px solid #ddd; font-size: 13px;">
                                                <label>ë“±ê¸°ëª©ì </label>
                                            </th>
                                            <th style="text-align: center; width: 37%; padding: 5px; border: 1px solid #ddd; font-size: 13px;">
                                                <label>COMMENT</label>
                                            </th>
                                            <th style="text-align: center; width: 7%; padding: 5px; border: 1px solid #ddd; font-size: 13px;">
                                                <label>ë‚ ì§œ</label>
                                            </th>
                                        </tr>
                                        </thead>
                                        <tbody id="scoreItems2">

                                        </tbody>
                                    </table>
                                </section>
                            </div>
                        </section>
                    </div>
                </div>
            </div>
            <div class="popup-button">
                <button class="btn-popup-close btn-navy" id="closePopup2">í™•ì¸</button>
            </div>
        </div>
    </div>
</div> <!-- //page-wrapper end-->

<script th:inline="javascript">
    // // Thymeleafì—ì„œ ê°’ ì„¤ì •: Null ì²´í¬ì™€ ê¸°ë³¸ê°’ ì²˜ë¦¬
    // var groupid = [[${session.groupid != null ? session.groupid : 'null'}]];
    // var id = /*[[${id != null ? id : 'null'}]]*/;
    // var groupname = /*[[${groupname != null ? groupname : 'null'}]]*/;
    // var username = /*[[${username != null ? username : 'null'}]]*/;
    //
    // // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— ê°’ ìœ ì§€ (null ë˜ëŠ” ë¹ˆ ë¬¸ìì—´ì€ ì €ì¥í•˜ì§€ ì•ŠìŒ)
    // if (groupid && groupid !== 'null') localStorage.setItem('groupid', groupid);
    // if (id && id !== 'null') localStorage.setItem('id', id);
    // if (username && username !== 'null') localStorage.setItem('username', username);
    // if (groupname && groupname !== 'null') localStorage.setItem('groupname', groupname);
</script>


<script type="text/javascript">
    document.readyState === 'complete' ? init() : window.onload = init;
    function init() {
        searchGoyuList();
    }
    // ì„¸ì…˜ê°’ ê°€ì ¸ì™€ ì¹´ë“œ ì¶œë ¥
    function searchGoyuList() {
        let storedData = sessionStorage.getItem("resultMap");

        if (!storedData) {
            console.log("ì„¸ì…˜ ë°ì´í„° ì—†ìŒ.");
            return;
        }

        let parsedData = JSON.parse(storedData);
        console.log("ì„¸ì…˜ì—ì„œ ë¶ˆëŸ¬ì˜¨ ë°ì´í„°:", parsedData);

        const contentsWrap = document.querySelector('.contents-wrap');
        contentsWrap.innerHTML = "";

        let scoreData = parsedData.GRADE;
        const idDocument = document.getElementById('REALID');
        if (idDocument) {
            idDocument.value = parsedData.REALID;
        }

        const card = document.createElement('div');
        card.className = 'card';

        const cardTitle = document.createElement('div');
        cardTitle.className = 'card-title';
        cardTitle.textContent = `ì£¼ì†Œ: ${parsedData.ADDRESS}`;

        const cardContent = document.createElement('div');
        cardContent.className = 'card-content';
        cardContent.textContent = `ë“±ê¸‰: ${parsedData.GRADE}`;

        const cardContent2 = document.createElement('div');
        cardContent2.className = 'card-content';
        cardContent2.textContent = `ì ìˆ˜: ${parsedData.REALSCORE}`;

        const cardContent3 = document.createElement('div');
        cardContent3.className = 'card-content';

        if (scoreData === "S") {
            cardContent3.textContent = `ì•ˆì „í•©ë‹ˆë‹¤.`;
        } else {
            // í…Œì´ë¸” ìƒì„±
            const table = document.createElement('table');
            table.className = 'comment-table';
            table.style.marginTop = "10px"; // margin-top 10px ì¶”ê°€

            // í…Œì´ë¸” í—¤ë” ì¶”ê°€
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');

            const thDate = document.createElement('th');
            thDate.textContent = 'ë‚ ì§œ';
            const thComment = document.createElement('th');
            thComment.textContent = 'ì½”ë©˜íŠ¸';

            headerRow.appendChild(thDate);
            headerRow.appendChild(thComment);
            thead.appendChild(headerRow);
            table.appendChild(thead);

            // í…Œì´ë¸” ë°”ë”” ìƒì„±
            const tbody = document.createElement('tbody');

            let uniqueComments = new Set(); // ì¤‘ë³µ ì²´í¬ìš© Set

            if (Array.isArray(parsedData.COMMENT)) {
                for (let comment of parsedData.COMMENT) {
                    const commentText = comment.REGREMARK || 'ì½”ë©˜íŠ¸ ì—†ìŒ';

                    // ì¤‘ë³µë˜ì§€ ì•Šì€ ê²½ìš°ì—ë§Œ ì¶”ê°€
                    if (!uniqueComments.has(commentText)) {
                        uniqueComments.add(commentText);

                        const row = document.createElement('tr');

                        const tdDate = document.createElement('td');
                        tdDate.textContent = comment.DATE || '';

                        const tdComment = document.createElement('td');
                        tdComment.textContent = commentText;

                        row.appendChild(tdDate);
                        row.appendChild(tdComment);
                        tbody.appendChild(row);
                    }
                }
            } else if (parsedData.COMMENT) {
                // ë‹¨ì¼ ê°ì²´ì¸ ê²½ìš°
                const commentText = parsedData.COMMENT.REGREMARK || 'ì½”ë©˜íŠ¸ ì—†ìŒ';

                if (!uniqueComments.has(commentText)) {
                    uniqueComments.add(commentText);

                    const row = document.createElement('tr');

                    const tdDate = document.createElement('td');
                    tdDate.textContent = parsedData.COMMENT.DATE || 'ë‚ ì§œ ì—†ìŒ';

                    const tdComment = document.createElement('td');
                    tdComment.textContent = commentText;

                    row.appendChild(tdDate);
                    row.appendChild(tdComment);
                    tbody.appendChild(row);
                }
            }

            table.appendChild(tbody);
            cardContent3.appendChild(table);
        }
        card.appendChild(cardTitle);
        card.appendChild(cardContent);
        card.appendChild(cardContent2);
        card.appendChild(cardContent3);
        contentsWrap.appendChild(card);
    }

    // ìƒì„¸ë³´ê¸°
    function cardDetail() {
        $.ajax({
            url: '/api/register/deductionDetail',
            type: 'GET',
            data: {
                "REALID": document.getElementById('REALID').value
            },
            async: false,
            success: function (response) {
                data2 = response.data;
                console.log("data2", data2);

                const scoreWrap = document.getElementById('scoreItems2');
                if (!scoreWrap) {
                    console.error("âŒ ì˜¤ë¥˜: 'scoreItems' ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    return;
                }

                // "í•­ëª©ì°¨ê°"ì´ ì•„ë‹Œ ë°ì´í„°ë§Œ í•„í„°ë§
                let filteredData = data2.filter(data => data.HISNM !== "í•­ëª©ì°¨ê°");

                let htmlContent = '';
                filteredData.forEach(data => {

                    // ë‚ ì§œ ë³€í™˜ (YYYYMMDD â†’ YYYY.MM.DD)
                    let formattedDate = data.HISDATE
                        ? `${data.HISDATE.slice(0, 4)}.${data.HISDATE.slice(4, 6)}.${data.HISDATE.slice(6, 8)}`
                        : '';

                    htmlContent += `
                    <tr>
                        <td style="width: 15%; padding: 5px; border: 1px solid #ddd;">
                            ${data.HISNM}
                        </td>
                        <td style="width: 15%; padding: 5px; border: 1px solid #ddd; text-align: left;">
                            ${data.REMARK}
                        </td>
                        <td style="width: 15%; padding: 5px; border: 1px solid #ddd;">
                            ${formattedDate}
                        </td>
                    </tr>`;
                });

                // ê¸°ì¡´ ë‚´ìš©ì„ ì´ˆê¸°í™” í›„ ìƒˆë¡œìš´ ë°ì´í„° ì¶”ê°€
                scoreWrap.innerHTML = htmlContent;


            },
            error: function (error) {
                console.error("âŒ API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
            }
        });
    }

    // ì ìˆ˜ì´ë ¥ ì¡°íšŒ ë° íŒì—… ì—´ê¸°
    function deductionDetail() {
        let data2 = [];
        $.ajax({
            url: '/api/register/deductionDetail',
            type: 'GET',
            data: {
                "REALID": document.getElementById('REALID').value
            },
            async: false,
            success: function (response) {
                data2 = response.data;
                console.log("data2", data2);

                const scoreWrap = document.getElementById('scoreItems');
                if (!scoreWrap) {
                    console.error("âŒ ì˜¤ë¥˜: 'scoreItems' ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    return;
                }

                let htmlContent = '';
                data2.forEach(data => {
                    // REGSTAND ê°’ ë³€í™˜
                    let regStandText = "";
                    switch (data.REGSTAND) {
                        case "A1": regStandText = "ê¸ˆì•¡"; break;
                        case "A2": regStandText = "ì ìˆ˜"; break;
                        case "A3": regStandText = "ë³µí•©"; break;
                        default: regStandText = ""; // ë³€í™˜ë˜ì§€ ì•Šì€ ê°’ ê·¸ëŒ€ë¡œ ì‚¬ìš©
                    }

                    // HISAMT ê°’ ìˆ«ì í¬ë§·íŒ… (ì²œ ë‹¨ìœ„ ì½¤ë§ˆ ì¶”ê°€, null ê°’ ê³µë°± ì²˜ë¦¬)
                    let formattedAmt = data.HISAMT ? Number(data.HISAMT).toLocaleString() : "";

                    // HISFLAG ê°’ ë³€í™˜
                    let flagText = data.HISFLAG === "1" ? "O" : "";

                    // ë‚ ì§œ ë³€í™˜ (YYYYMMDD â†’ YYYY.MM.DD)
                    let formattedDate = data.HISDATE
                        ? `${data.HISDATE.slice(0, 4)}.${data.HISDATE.slice(4, 6)}.${data.HISDATE.slice(6, 8)}`
                        : '';

                    htmlContent += `
                <tr>
                    <td style="width: 15%; padding: 5px; border: 1px solid #ddd;">
                        ${data.HISNM}
                    </td>
                    <td style="width: 15%; padding: 5px; border: 1px solid #ddd;">
                        ${formattedAmt}
                    </td>
                    <td style="width: 15%; padding: 5px; border: 1px solid #ddd;">
                        ${data.HISPOINT}
                    </td>
                    <td style="width: 15%; padding: 5px; border: 1px solid #ddd;">
                        ${regStandText}
                    </td>
                    <td style="width: 15%; padding: 5px; border: 1px solid #ddd;">
                        ${flagText}
                    </td>
                    <td style="width: 15%; padding: 5px; border: 1px solid #ddd;">
                        ${formattedDate}
                    </td>
                </tr>`;
                });

                // ê¸°ì¡´ ë‚´ìš©ì„ ì´ˆê¸°í™” í›„ ìƒˆë¡œìš´ ë°ì´í„° ì¶”ê°€
                scoreWrap.innerHTML = htmlContent;

            },
            error: function (error) {
                console.error("âŒ API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
            }
        });
    }

    // âœ… íŒì—… ì—´ê¸° (popup-history ìš”ì†Œì— 'open' í´ë˜ìŠ¤ ì¶”ê°€)
    document.addEventListener("DOMContentLoaded", function () {
        const popup = document.getElementById("deductionWrap");
        const popup2 = document.getElementById("scoreWrapper");
        const overlay = document.getElementById("popupOverlay");

        const openButton = document.querySelector("button[onclick='deductionDetail()']"); // íŒì—… ì—´ê¸° ë²„íŠ¼
        const closeButton = document.getElementById("closePopup");
        const openButton2 = document.querySelector("button[onclick='cardDetail()']"); // íŒì—… ì—´ê¸° ë²„íŠ¼
        const closeButton2 = document.getElementById("closePopup2");

        // íŒì—… ì—´ê¸°
        openButton.addEventListener("click", function () {
            console.log("âœ… íŒì—… ì—´ê¸°");
            popup.classList.add("active");
            overlay.classList.add("active"); // ë°°ê²½ ì–´ë‘¡ê²Œ ì„¤ì •
        });

        // íŒì—… ë‹«ê¸°
        closeButton.addEventListener("click", function () {
            console.log("âœ… íŒì—… ë‹«ê¸°");
            popup.classList.remove("active");
            overlay.classList.remove("active"); // ë°°ê²½ ì›ë˜ëŒ€ë¡œ
        });

        // íŒì—… ì—´ê¸°
        openButton2.addEventListener("click", function () {
            console.log("âœ… íŒì—… ì—´ê¸°");
            popup2.classList.add("active");
            overlay.classList.add("active"); // ë°°ê²½ ì–´ë‘¡ê²Œ ì„¤ì •
        });

        // íŒì—… ë‹«ê¸°
        closeButton2.addEventListener("click", function () {
            console.log("âœ… íŒì—… ë‹«ê¸°");
            popup2.classList.remove("active");
            overlay.classList.remove("active"); // ë°°ê²½ ì›ë˜ëŒ€ë¡œ
        });
        // ë°°ê²½ í´ë¦­ ì‹œ íŒì—… ë‹«ê¸°
        overlay.addEventListener("click", function () {
            popup.classList.remove("active");
            popup2.classList.remove("active");
            overlay.classList.remove("active"); // ë°°ê²½ ì›ë˜ëŒ€ë¡œ
        });
    });

    // âœ… ë’¤ë¡œ ê°€ê¸° ì‹œ ì„¸ì…˜ ë°ì´í„° ì‚­ì œ
    window.addEventListener("popstate", function () {
        sessionStorage.removeItem("resultMap");
    });

    // âœ… ë‹¤ë¥¸ í˜ì´ì§€ ì´ë™ ì‹œ ì„¸ì…˜ ì‚­ì œ (ìƒˆë¡œê³ ì¹¨ì€ ìœ ì§€)
    window.addEventListener("beforeunload", function (event) {
        // âœ… ìµœì‹  APIë¥¼ ì‚¬ìš©í•˜ì—¬ ìƒˆë¡œê³ ì¹¨ ì—¬ë¶€ ê°ì§€ (ì•ˆì „í•œ ë°©ì‹)
        let navEntries = window.performance.getEntriesByType("navigation");
        let isPageReload = (navEntries.length > 0 && navEntries[0].type === "reload")
            || event.persisted
            || performance.getEntriesByType("navigation")[0]?.type === "reload";

        if (!isPageReload) {
            sessionStorage.removeItem("resultMap"); // âœ… ìƒˆë¡œê³ ì¹¨ì´ ì•„ë‹ ë•Œë§Œ ì‚­ì œ
        }
    });
</script>
</body>
</html>
