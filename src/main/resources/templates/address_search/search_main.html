<!DOCTYPE html>
<html lang="ko">
<style>
    .btn-clear {
        display: none !important; /* ê°•ì œë¡œ ìˆ¨ê¹€ */
    }
    .btn-close {
        display: none !important; /* ê°•ì œë¡œ ìˆ¨ê¹€ */
    }
     .search-container {
         align-items: center;
         padding: 10px;
         border-bottom: 1px solid #ccc;
     }

    .search-container input {
        flex: 1;
        padding: 10px;
        font-size: 16px;
        border: 1px solid #ccc;
        border-radius: 5px;
    }

    .search-container button {
        background: none;
        border: none;
        font-size: 20px;
        cursor: pointer;
    }

    .search-guide {
        padding: 10px;
        font-size: 14px;
        color: #666;
    }
    #searcharea {
        display: flex;         /* í•œ ì¤„ ì •ë ¬ */
        align-items: center;   /* ì„¸ë¡œ ì¤‘ì•™ ì •ë ¬ */
        border: 1px solid #ccc;
        border-radius: 5px;
        width: 100%;
        max-width: 400px; /* ì›í•˜ëŠ” í¬ê¸°ë¡œ ì¡°ì • */
    }
    #searcharea input {
        flex-grow: 1;        /* ë‚¨ì€ ê³µê°„ì„ ëª¨ë‘ ì°¨ì§€ */
        border: none;
        outline: none;
        font-size: 16px;
    }

    .search-icon {
        font-size: 20px;
        cursor: pointer;
        padding-left: 45px;
    }

</style>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FACT CHECK</title>
    <link rel="icon" type="image/png" href="/images/logo/icon_FACT%20CHECK.png">
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/smoothness/jquery-ui.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/> <!-- Slide css -->
    <link rel="stylesheet" href="/resource/ax5ui/ax5ui.all.css">
    <link rel="stylesheet" type="text/css" href="/assets_mobile/css/import.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>

    <script src="/assets_mobile/js/ui.js"></script> <!-- Common js -->
    <script th:inline="javascript">
        var sandanData = /*[[${session.sandanList}]]*/ [];
    </script>


    <script type="text/javascript" src="/resource/ax5ui/ax5ui.all.min.js?v=1000"></script>

    <script type="text/javascript" src="/js/ax5commUtil.js?v=1070"></script>

    <script src="/js/common.js?v=1060"></script>
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script> <!-- Slide js -->
    <script src="/js/Mobile.js"></script>
</head>

<body>
<div class="mobile-wrapper page-ticket-list"><!-- â˜…í˜ì´ì§€ Classëª… -->
    <!-- [ëª¨ë°”ì¼] í—¤ë”  -->
    <div class="mobile-layout-header">
        <header>
            <div class="left">
                <a href="#" title="ì „ì²´ë©”ë‰´" class="logo">
                </a>
            </div>
            <div class="left" style="margin-left:35px;">
                <h2>FACT CHECK</h2>
            </div>
            <div class="right">
                <a href="#" title="ì „ì²´ë©”ë‰´" class="btn-menu">
                    <img src="/assets_mobile/images/icon/btn-menu.svg" alt="ì „ì²´ë©”ë‰´ ì•„ì´ì½˜">
                </a>
            </div>
        </header>
    </div> <!-- //mobile-layout-header end-->

    <!-- [ëª¨ë°”ì¼] ë©”ë‰´  -->
    <div th:insert="~{mobile/mobile_menu :: mobile_menu}"></div>
    <!-- [ëª¨ë°”ì¼] ì»¨ë´ì¸   -->
    <div class="mobile-layout-contents">
        <!--- (ë ˆì´ì•„ì›ƒ) Contents ì˜ì—­ -->
        <div class="layout-contents">
            <!-- ê²€ìƒ‰ ì˜ì—­  -->
            <div class="search-wrap">

            </div>
            <!-- ì»¨í…ì¸  ì˜ì—­  -->
            <div class="contents-wrap">
                <dl style="margin-bottom: 10px">
<!--                    <button onclick="openModal()" style="margin-bottom: 10px">ì£¼ì†Œ ê²€ìƒ‰</button>-->
                    <div class="search-container">
                        <input type="hidden" id="postno">
                        <h2>ì£¼ì†Œ ê²€ìƒ‰</h2>
                        <div id="searcharea">
                            <div id="guide" style="display:none; color: #888; font-size: 14px;"></div>
                            <input type="text" id="address1" placeholder="ê²€ìƒ‰í•  ë¶€ë™ì‚° ì£¼ì†Œ ì…ë ¥" onfocus="openModal()">
                            <span class="search-icon" id="searchIcon" onclick="openModal()">ğŸ”</span>
                        </div>
                    </div>
                    <div id="postcodeModal" class="modal" style="display: none">
                        <div class="modal-content">
                            <div style="display: flex">
                                <div class="modal-header"></div>
                                <button class="modal-close" onclick="closeModal()" style="width: 30px; margin-left: auto">Ã—</button>
                            </div>
                            <div id="postcodeContainer" style="width: 100%;"></div>
                        </div>
                    </div>
                    <div>
                        <label for="address2"></label>
                        <input type="text" id="address2" placeholder="ìƒì„¸ì£¼ì†Œ ì…ë ¥"><br>
                    </div>
                    <!-- ê²€ìƒ‰ ê°€ì´ë“œ -->
                    <div class="search-guide">
                        <p>* ë¶€ë™ì‚° ì†Œì¬ì§€ë²ˆ ë˜ëŠ” ë„ë¡œëª…, ë™/í˜¸ë¡œ ê²€ìƒ‰í•˜ë©´ ì •í™•í•œ ê²°ê³¼ë¥¼ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                        <p>* ë¯¸ë“±ê¸°ì¸ ê²½ìš° ì£¼ì†Œ ì¡°íšŒ ë° ë“±ë¡ì´ ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
                    </div>


                    <button onclick="searchGoyuList()" style="margin-top: 10px">ë¬¼ê±´ ì„ íƒ</button>
                </dl>
            </div> <!--// contents-wrap end-->
            <div id="addressWrap" class="contents-wrap">

            </div>
            <!-- ë¡œë”© í™”ë©´ -->
            <div id="loadingSpinner" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); justify-content: center; align-items: center; z-index: 9999;">
                <div style="background: white; padding: 20px; border-radius: 10px; text-align: center;">
                    <span>ğŸ”„ ë“±ê¸°ë¶€ë“±ë³¸ ë°œê¸‰ì¤‘ì…ë‹ˆë‹¤...</span>
                </div>
            </div>
<!--            <button onclick="searchdatatest()" style="margin-top: 10px">test</button>-->
        </div> <!--//layout-contents end -->

    </div> <!-- //mobile-layout-contents end-->
</div> <!-- //page-wrapper end-->
<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<script th:inline="javascript">
    // // Thymeleafì—ì„œ ê°’ ì„¤ì •: Null ì²´í¬ì™€ ê¸°ë³¸ê°’ ì²˜ë¦¬
    // var groupid = [[${session.groupid != null ? session.groupid : 'null'}]];
    // var id = /*[[${id != null ? id : 'null'}]]*/;
    // var groupname = /*[[${groupname != null ? groupname : 'null'}]]*/;
    // var username = /*[[${username != null ? username : 'null'}]]*/;
    //
    // // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— ê°’ ìœ ì§€ (null ë˜ëŠ” ë¹ˆ ë¬¸ìì—´ì€ ì €ì¥í•˜ì§€ ì•ŠìŒ)
    // if (groupid && groupid !== 'null') localStorage.setItem('groupid', groupid);
    // if (id && id !== 'null') localStorage.setItem('id', id);
    // if (username && username !== 'null') localStorage.setItem('username', username);
    // if (groupname && groupname !== 'null') localStorage.setItem('groupname', groupname);
</script>
<script>
    function openModal() {
        document.getElementById('postcodeModal').style.display= 'block';
        document.getElementById('searcharea').style.display= 'none';
        document.getElementById("searchIcon").style.display = "none";
        new daum.Postcode({
            oncomplete: function(data) {
                var roadAddr = data.roadAddress;
                var extraRoadAddr = '';

                if (data.bname !== '' && /[ë™|ë¡œ|ê°€]$/g.test(data.bname)) {
                    extraRoadAddr += data.bname;
                }
                if (data.buildingName !== '' && data.apartment === 'Y') {
                    extraRoadAddr += (extraRoadAddr !== '' ? ', ' + data.buildingName : data.buildingName);
                }
                if (extraRoadAddr !== '') {
                    extraRoadAddr = ' (' + extraRoadAddr + ')';
                }

                document.getElementById('postno').value = data.zonecode;
                document.getElementById('address1').value = roadAddr;

                closeModal();
            },
            onresize: function(size) {
                // ë™ì  ìŠ¤íƒ€ì¼ ì ìš©
                const layers = document.querySelectorAll('[id^="__daum__layer_"]');
                layers.forEach(layer => {
                    layer.style.width = '100%';
                    layer.style.height = '500px';
                    layer.style.overflow = 'hidden';
                    layer.style.backgroundColor = '#fff';
                });
            }

        }).embed(document.getElementById('postcodeContainer'));
    }

    function closeModal() {
        document.getElementById('postcodeModal').style.display= 'none';
        document.getElementById('searcharea').style.display= 'block';
    }
</script>
<script type="text/javascript">

    $(document).ready(function () {
        // 1.ì €ì¥ëœ ì£¼ì†Œ ë¶ˆëŸ¬ì˜¤ê¸° (í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰)
        loadAddressFromLocalStorage();

        // 2.ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ ì‹œ ì´ë²¤íŠ¸ ì²˜ë¦¬
        $(document).on('click', 'button[onclick="searchGoyuList()"]', function (e) {
            e.preventDefault(); // ê¸°ë³¸ ë™ì‘ ë°©ì§€
            handleSearchButtonClick(); // ê²€ìƒ‰ ë²„íŠ¼ ì²˜ë¦¬ í•¨ìˆ˜ ì‹¤í–‰
        });
    });

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì—ì„œ ì£¼ì†Œ ë¶ˆëŸ¬ì˜¤ê¸°
    function loadAddressFromLocalStorage() {
        const savedAddress1 = localStorage.getItem('savedAddress1') || ""; // ë„ë¡œëª… ì£¼ì†Œ
        const savedAddress2 = localStorage.getItem('savedAddress2') || ""; // ìƒì„¸ ì£¼ì†Œ

        $('#address1').val(savedAddress1);
        $('#address2').val(savedAddress2);

        console.log('ì£¼ì†Œ ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ:', savedAddress1, savedAddress2);
    }

    // ì£¼ì†Œë¥¼ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
    function saveAddressToLocalStorage() {
        const address1 = $('#address1').val().trim();
        const address2 = $('#address2').val().trim();

        if (!address1) {
            alert('ë„ë¡œëª… ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        localStorage.setItem('savedAddress1', address1);
        localStorage.setItem('savedAddress2', address2);

        console.log('ì£¼ì†Œ ì €ì¥ ì™„ë£Œ:', address1, address2);
    }

    // ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰ë  í•¨ìˆ˜
    function handleSearchButtonClick() {
        saveAddressToLocalStorage(); // ìƒˆ ì£¼ì†Œ ì €ì¥
        clearPreviousSearchResults(); // ê¸°ì¡´ ê²€ìƒ‰ ê²°ê³¼ ì‚­ì œ
        searchGoyuList(); // ìƒˆë¡œìš´ ê²€ìƒ‰ ì‹¤í–‰
    }

    // ê¸°ì¡´ ê²€ìƒ‰ ê²°ê³¼ ì‚­ì œ (ì˜¬ë°”ë¥¸ ì‚­ì œ ë°©ì‹)
    function clearPreviousSearchResults() {
        $('#addressWrap').empty(); // ê¸°ì¡´ ê²€ìƒ‰ ê²°ê³¼ ì‚­ì œ
        localStorage.removeItem('savedAddress1'); // ë„ë¡œëª… ì£¼ì†Œ ì‚­ì œ
        localStorage.removeItem('savedAddress2'); // ìƒì„¸ ì£¼ì†Œ ì‚­ì œ
    }


    // ê³ ìœ ë²ˆí˜¸ ì¡°íšŒ
    let isRequestInProgress = false;  // ì¤‘ë³µ ìš”ì²­ ë°©ì§€ í”Œë˜ê·¸

    function searchGoyuList() {
        if (isRequestInProgress) return;  // ì§„í–‰ ì¤‘ì´ë©´ ë¬´ì‹œ
        isRequestInProgress = true;

        if (document.getElementById('address1').value === "") {
            Alert.alert('', 'ì£¼ì†Œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”');
            isRequestInProgress = false;
            return false;
        }

        $.ajax({
            url: '/api/tilko/searchGoyuList',
            type: 'GET',
            data: {
                'address1': $('#address1').val() + " " + $('#address2').val()
            },
            async: false,
            success: function (data) {
                let data2 = data.data;
                // **ë¹„ì–´ ìˆëŠ” ë°ì´í„° ì²´í¬ ë° ê²½ê³  ë©”ì‹œì§€ í‘œì‹œ**
                if (!data2 || data2.length === 0) {
                    Alert.alert('', 'ê²€ìƒ‰ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    isRequestInProgress = false;
                    return;
                }
                console.log("data2", data);
                console.log("data2", data2);

                const listAddressWrap = document.getElementById('addressWrap');
                const availableColors = ['card-blue', 'card-green', 'card-black', 'card-red', 'card-yellow', 'card-purple'];
                listAddressWrap.innerHTML = '';  // ê¸°ì¡´ ë‚´ìš© ì´ˆê¸°í™”
                let colorIndex = 0;
                let htmlContent = '';

                // 'í† ì§€' ì œì™¸ ë¡œì§
                data2.forEach(data => {
                    if (data.Gubun !== 'í† ì§€') {
                        const cardColor = availableColors[colorIndex];
                        colorIndex = (colorIndex + 1) % availableColors.length;

                        let cleanAddress = preprocessAddress(data.rd_addr_detail);
                        htmlContent += `
                        <div class="card-box ${cardColor}" data-Goyu="${data.pin}">
                            <div class="card-cont">
                                <dl>
                                    <dt>ê³ ìœ ë²ˆí˜¸</dt>
                                    <dd>${data.pin}</dd>
                                </dl>
                                <dl>
                                    <dt>ì£¼ì†Œ</dt>
                                    <dd>${cleanAddress}</dd>
                                </dl>
                                <dl>
                                    <dt>êµ¬ë¶„</dt>
                                    <dd>${data.real_cls_cd}</dd>
                                </dl>
                                <dl>
                                    <dt>ìƒíƒœ</dt>
                                    <dd>${data.use_cls_cd}</dd>
                                </dl>
                            </div>
                            <button class="btn btn-popup-open" data-popup="popup-history" title="ë“±ê¸°ë¶€">
                                ë“±ê¸°ë¶€ ì¡°íšŒ
                            </button>
                        </div>`;
                    } else {
                        console.log("í† ì§€ ë°ì´í„°");
                    }
                });

                listAddressWrap.insertAdjacentHTML('beforeend', htmlContent);

                // AJAX ì™„ë£Œ ì‹œ í”Œë˜ê·¸ í•´ì œ
                isRequestInProgress = false;

                // ì´ë²¤íŠ¸ ìœ„ì„ (ì¤‘ë³µ ë°©ì§€)
                listAddressWrap.addEventListener('click', (event) => {
                    const button = event.target.closest('.btn-popup-open[data-popup="popup-history"]');
                    if (!button) return;

                    const cardBox = button.closest('.card-box');
                    const goyuNum = cardBox.getAttribute('data-Goyu');

                    const item = data2.find(d => d.pin === goyuNum);
                    if (item) {
                        const cleanAddress = preprocessAddress(item.rd_addr_detail);
                        searchaddress(item, cleanAddress);
                    }
                });
            },
            error: function () {
                isRequestInProgress = false;  // ì—ëŸ¬ ì‹œì—ë„ í”Œë˜ê·¸ í•´ì œ
            }
        });
    }

    // ì£¼ì† íƒœê·¸ ì‚­ì œ ë° ê³µë°± ë©”ì„œë“œ
    function preprocessAddress(input) {
        // 1. <span> ì‹œì‘/ì¢…ë£Œ ì‹œ ê³µë°± ì¶”ê°€
        let processed = input.replace(/<\/?span[^>]*>/g, match => ` ${match} `);
        // 2. ëª¨ë“  íƒœê·¸ ì œê±° ë° ê³µë°± ì¶•ì†Œ
        processed = processed.replace(/<[^>]+>/g, '').replace(/\s+/g, ' ').trim();
        return processed;
    }
    // HTML íƒœê·¸ ì œê±° í•¨ìˆ˜
    function stripHtmlTags(html) {
        let tempDiv = document.createElement("div");
        tempDiv.innerHTML = html;
        return tempDiv.textContent || tempDiv.innerText || "";
    }
    // pdf ë°ì´í„° ì¡°íšŒ ë° íŒŒì‹± ì €ì¥ ë©”ì„œë“œ í˜¸ì¶œ(ë“±ê¸°ë¶€ë“±ë³¸ ì¡°íšŒ ë©”ì„œë“œ)
    let isSearchInProgress = false;  // ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€ í”Œë˜ê·¸

    function searchaddress(data, cleanAddress) {
        if (isSearchInProgress) return;  // ì§„í–‰ ì¤‘ì´ë©´ í•¨ìˆ˜ ì¢…ë£Œ
        isSearchInProgress = true;  // í”Œë˜ê·¸ ì„¤ì •

        console.log("data : ", data);

        // ë¡œë”© í™”ë©´ í‘œì‹œ
        document.getElementById('loadingSpinner').style.display = 'flex';

        $.ajax({
            url: '/api/tilko/downloadPDF',
            type: 'GET',
            data: {
                "GoyuNUM": data.pin,
                "address": cleanAddress
            },
            async: true,
            success: function (response) {
                // ì‘ë‹µ ê°’ ê²€ì¦
                if (!response.success || response.data === null) {
                    // ë¡œë”© ìŠ¤í”¼ë„ˆ ìˆ¨ê¸°ê¸°
                    document.getElementById('loadingSpinner').style.display = 'none';
                    isSearchInProgress = false;  // í”Œë˜ê·¸ í•´ì œ

                    // ì‚¬ìš©ìì—ê²Œ ë©”ì‹œì§€ í‘œì‹œ
                    Alert.alert("","ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    return;  // í•¨ìˆ˜ ì¢…ë£Œ
                }
                let data2 = response.data;
                console.log("data2", data2);

                // API ì‘ë‹µì—ì„œ í•„ìš”í•œ ê°’ ì¶”ì¶œ í›„ sessionStorageì— ì €ì¥
                let resultMap = {
                    "REALSCORE": data2.REALSCORE,
                    "GRADE": data2.GRADE,
                    "COMMENT": data2.COMMENT,
                    "ADDRESS": data2.ADDRESS
                };
                sessionStorage.setItem("resultMap", JSON.stringify(resultMap));

                document.getElementById('loadingSpinner').style.display = 'none';
                isSearchInProgress = false;  // í”Œë˜ê·¸ í•´ì œ

                // search_card í˜ì´ì§€ë¡œ ì´ë™
                window.location.href = "mobile/search_card";
            },
            error: function (error) {
                document.getElementById('loadingSpinner').style.display = 'none';
                isSearchInProgress = false;  // ì—ëŸ¬ ë°œìƒ ì‹œ í”Œë˜ê·¸ í•´ì œ
                console.error("Error in API call:", error);
            }
        });
    }

    function searchdatatest() {
        $.ajax({
            url: '/api/tilko/downloadPDF2',
            type: 'GET',
            data: {
                "GoyuNUM" : '123123123',
                "address" : 'ì„œìš¸íŠ¹ë³„ì‹œ ê¸ˆì²œêµ¬'
            },
            async: false,
            success: function (response) {
                let data2 = response.data;
                console.log("data2", data2);

                // API ì‘ë‹µì—ì„œ í•„ìš”í•œ ê°’ ì¶”ì¶œ í›„ sessionStorageì— ì €ì¥
                let resultMap = {
                    "REALSCORE": data2.REALSCORE,
                    "GRADE": data2.GRADE,
                    "COMMENT": data2.COMMENT,
                    "ADDRESS": data2.ADDRESS
                };
                sessionStorage.setItem("resultMap", JSON.stringify(resultMap));

                // search_card í˜ì´ì§€ë¡œ ì´ë™
                window.location.href = "search_card";
            },
            error: function (error) {
                console.error("Error in API call:", error);
            }
        });
    }

</script>
</body>
</html>
