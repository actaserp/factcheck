<html layout:decorate="~{layout_page}" xmlns:layout="http://www.w3.org/1999/xhtml">
<style>
    #theGrid {
        width: 100%;
        height: 400px;
        overflow: auto; /* Ïä§ÌÅ¨Î°§ ÌôúÏÑ±Ìôî */
    }

    .wj-flexgrid .wj-header {
        position: sticky;
        top: 0;
        z-index: 10;
        overflow: auto;
    }

</style>
<th:block layout:fragment="content">
    <div class="layout-contents">
        <!-- Page Title -->
        <div class="page-title-wrap">
            <div class="left">
                <h2>Ïù¥ÎØ∏ÏßÄÍ¥ÄÎ¶¨</h2>
                <!--<a title="Î∂ÅÎßàÌÅ¨" class="bookmark toggle">
                    ÎÇ¥Î©îÎâ¥
                </a>-->
            </div>
            <ul class="page-navi">
                <li><img src="/images/icon/ico-nav-home.svg" alt="ÌôàÏïÑÏù¥ÏΩò"></li>
                <li>Î∂ÑÎ•ò Í¥ÄÎ¶¨</li>
                <li>Ïù¥ÎØ∏ÏßÄÍ¥ÄÎ¶¨</li>
            </ul>
        </div>
        <!-- Select -->
        <div class="tab-contents">
            <section class="tab-item" id="tab2" style="height: 750px; overflow: hidden;">
                <div class="section-top">
                    <div class="search-wrap">
                        <dl>
                            <dt>
                                <label for="startDate">
                                    ÎÇ†Ïßú<span class="eq">*</span>
                                </label>
                            </dt>
                            <dd>
                                <ul class="date-box">
                                    <li>
                                        <input type="date" id="startDate" name="startDate">
                                        <label for="startDate" class="hide">ÏãúÏûëÏùº</label>
                                    </li>
                                    <li>
                                        <input type="date" id="endDate" name="endDate">
                                        <label for="endDate" class="hide">Ï¢ÖÎ£åÏùº</label>
                                    </li>
                                </ul>
                            </dd>
                        </dl>
                        <dl>
                            <dt>
                                <label for="searchUserNm">
                                    ÏûÖÎ†•Ïûê<span class="eq">*</span>
                                </label>
                            </dt>
                            <dd>
                                <div class="srch-box">
                                    <input type="text" id="searchUserNm" name="searchUserNm" class="input-srch"
                                           placeholder="ÏûÖÎ†•Ïûê" style="border-radius: 5px;">
                                </div>
                            </dd>
                        </dl>
                        <dl>
                            <dt>&nbsp;</dt>
                            <dd>
                                <li>
                                    <a class="btn btn-delete" title="Í≤ÄÏÉâ" id="searchButton1" onclick="fetchListData()">
                                        <img src="/images/icon/btn-srch.svg" alt="Í≤ÄÏÉâ ÏïÑÏù¥ÏΩò">
                                        Í≤ÄÏÉâ
                                    </a>
                                </li>
                            </dd>
                        </dl>
                    </div>
                    <div class="button-wrap" style="border-top:none;">
                        <ul>
                            <li>
                                <a class="btn btn-excell" title="Ïã†Í∑úÎì±Î°ù" id="Newbtn" onclick="NewSave()">
                                    <img src="/images/icon/ico-plus.svg" alt="Îì±Î°ù ÏïÑÏù¥ÏΩò">
                                    Ïã†Í∑úÎì±Î°ù
                                </a>
                            </li>
                            <li>
                                <a class="btn btn-delete" title="ÏÇ≠Ï†ú" id="btnDelete" onclick="deleteData()">
                                    <img src="/images/icon/ico-delete.svg" alt="ÏóëÏÖÄ ÏïÑÏù¥ÏΩò">
                                    ÏÇ≠Ï†ú
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>

                <div class="container-fluid">
                    <p id="selectedItem"></p>
                    <div id="theGrid" style="max-height: 650px"></div>
                </div>
            </section>
        </div> <!--//tab-wrap end-->
    </div> <!--//layout-contents end -->
    <footer>
        <p>‚ìí factCheck corp.All rights reserved.</p>
    </footer>

    <div class="dashboard-layout-popup">
        <div class="popup-overlay" id="popup1"></div>
        <div class="popup-wrapper" id="wrapper1">
            <div class="popup-title">
                <h3>Ïù¥ÎØ∏ÏßÄ Í¥ÄÎ¶¨</h3>
                <a onclick="NewClose()" title="ÌåùÏóÖÎã´Í∏∞" class="btn-popup-close">
                    <img src="/images/icon/btn-popup-close.svg" alt="Îã´Í∏∞">
                </a>
            </div>
            <div class="popup-contents">
                <form id="MarketingForm" autocomplete="off">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    <div class="table-wrap">
                        <table class="view-table" id="selectedData" style="max-height: 740px;">
                            <caption>Ïù¥ÎØ∏ÏßÄÍ¥ÄÎ¶¨ Ïã†Í∑ú Îì±Î°ù ÌÖåÏù¥Î∏î</caption>
                            <colgroup>
                                <col class="wp20">
                                <col class="wauto">
                            </colgroup>
                            <tbody>
                            <tr>
                                <th><label for="imgflag"> Íµ¨Î∂Ñ</label></th>
                                <td colspan="3">
                                    <select id="imgflag">
                                        <option value="00">Ïπ¥Îìú Ïù¥ÎØ∏ÏßÄ</option>
                                        <option value="01">Í∏∞ÌÉÄ Ïù¥ÎØ∏ÏßÄ</option>
                                    </select>
                                    <input id="imgseq" type="hidden">
                                </td>
                            </tr>
                            <tr>
                                <th><label for="indatem">ÏûÖÎ†•ÏùºÏãú</label></th>
                                <td colspan="3">
                                    <input id="indatem" name="indatem" class="wp100" placeholder="" readonly/>
                                </td>
                            </tr>
                            <tr>
                                <th>
                                    <label for="inuserid">ÏûÖÎ†•Ïûê</label>
                                </th>
                                <td colspan="3">
                                    <input type="text" id="inuserid" name="inuserid" class="wp100" placeholder="" readonly/>
                                </td>
                            </tr>
                            <tr>
                                <th><label for="fileInput2">Ï≤®Î∂ÄÌååÏùº</label></th>
                                <td colspan="3">
                                    <div id="uploadComponent2" class="upload-component2">
                                        <div class="upload-filebox2">
                                            <img src="/images/icon/ico-fileupload.svg" alt="ÏóÖÎ°úÎìúÏïÑÏù¥ÏΩò">
                                            <a class="btn" title="ÌååÏùºÏóÖÎ°úÎìú">ÌååÏùº ÏóÖÎ°úÎìú</a>
                                            <input type="file" id="fileInput2" class="fileInput2" multiple>
                                            <p>png ÌååÏùºÌòïÏãùÎßå Îì±Î°ù Í∞ÄÎä•Ìï©ÎãàÎã§.</p>
                                            <p>Maximun upload file size <span>1GiB</span></p>
                                        </div>

                                        <div class="upload-filelist2">
                                            <div class="title">
                                                <h5>Files (0)</h5>
                                                <a title="Delete all" class="btn-file-deleteall2">Delete all</a>
                                            </div>
                                            <ul class="filelist2" id="filelist2">
                                            </ul>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </form>
            </div>
            <div class="popup-button">
                <button class="btn-popup-close" onclick="NewClose()">Ï∑®ÏÜå</button>
                <button class="btn-navy" id="btnSaveAuth" onclick="SaveForm()"> Ï†ÄÏû•</button>
            </div>
        </div>
    </div>

</th:block>
<th:block layout:fragment="scripts">
    <th:block th:replace="/common/columns_setting :: columns_setting"></th:block>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="text/javascript">
        let theGrid;

        $(document).ready(function () {
            // ÌòÑÏû¨ ÎÇ†Ïßú ÏÑ§Ï†ï
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth();

            // ÏãúÏûëÏùº
            const startOfYear = new Date(year, 0, 1);
            const startYearFormatted = `${startOfYear.getFullYear()}-${String(startOfYear.getMonth() + 1).padStart(2, '0')}-${String(startOfYear.getDate()).padStart(2, '0')}`;
            $('#startDate').val(startYearFormatted);

            // Ï¢ÖÎ£åÏùº
            const endOfMonth = new Date(year, month + 1, 0);
            const endMonthFormatted = `${endOfMonth.getFullYear()}-${String(endOfMonth.getMonth() + 1).padStart(2, '0')}-${String(endOfMonth.getDate()).padStart(2, '0')}`;
            $('#endDate').val(endMonthFormatted);
            init();
        });

        document.getElementById('searchUserNm').addEventListener('keydown', function (event) {
            if (event.key === 'Enter') {
                fetchListData(); // ÏóîÌÑ∞ ÌÇ§Î•º ÎàåÎ†ÄÏùÑ Îïå Ïã§ÌñâÌï† Ìï®Ïàò
            }
        })

        function init() {
            fetchListData();
        }

        function fetchListData() {
            let data = [];

            const params = {
                startDate: $('#startDate').val(),
                endDate: $('#endDate').val(),
                searchUserNm: $('#searchUserNm').val()
            };

            // ÏÑúÎ≤ÑÏóêÏÑú Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
            $.ajax({
                url: '/api/CardImg/read',
                type: 'GET',
                data: params,
                async: false,
                success: function (response) {
                    console.log("ÏÑúÎ≤ÑÏóêÏÑú Î∞õÏùÄ Îç∞Ïù¥ÌÑ∞ :", response);
                    // ÏùëÎãµÏù¥ Ïò¨Î∞îÎ•¥Í≤å ÎèÑÏ∞©ÌñàÍ≥†, data ÏÜçÏÑ±Ïù¥ Î∞∞Ïó¥Ïù∏ÏßÄ ÌôïÏù∏
                    response.data.forEach(item => {
                        switch (item.imgflag){
                            case '00' :
                                item.imgflag = 'Ïπ¥Îìú';
                                break;
                            case '01' :
                                item.imgflag = 'Í∏∞ÌÉÄÏù¥ÎØ∏ÏßÄ';
                                break;
                        }
                    });
                },
                error: function () {
                    console.error("Îç∞Ïù¥ÌÑ∞Î•º Í∞ÄÏ†∏Ïò§Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.");
                }
            });

            while (data.length < 15) {
                data.push({
                    rownum: data.length + 1,
                    imgflag: '',
                    fileList: '',
                    indatem: '',
                    inuserid: '',
                    isdownload: '',
                });
            }

            const viewdata = new wijmo.collections.CollectionView(data);

            if (!theGrid) {
                theGrid = new wijmo.grid.FlexGrid('#theGrid', {
                    autoGenerateColumns: false,
                    showMarquee: true,
                    isReadOnly: true,
                    columns: [
                        {binding: 'rownum', header: 'ÏàúÎ≤à', width: 70, align: 'center'},
                        {binding: 'imgseq', header: 'ÏùºÎ†®Î≤àÌò∏', visible: false},
                        {binding: 'imgflag', header: 'Íµ¨Î∂Ñ', width: 100, align: 'center'},
                        {binding: 'fileList', header: 'Ï≤®Î∂ÄÌååÏùº', width: 170, align: 'left'},
                        {binding: 'indatem', header: 'ÏûÖÎ†•ÏùºÏãú', width: '*', minWidth: 150, align: 'center'},
                        {binding: 'inuserid', header: 'ÏûÖÎ†•Ïûê', width: '*', minWidth: 150, align: 'center'},
                        {binding: 'isdownload', visible: false},
                    ],
                    itemsSource: viewdata,
                    itemFormatter: function (panel, r, c, cell) {
                        if (panel.cellType === wijmo.grid.CellType.Cell) {
                            let item = panel.rows[r].dataItem;

                            if (panel.columns[c].binding === 'fileList') {
                                cell.innerHTML = ''; // Í∏∞Ï°¥ ÎÇ¥Ïö© ÏÇ≠Ï†ú

                                if (item.isdownload && item.fileList.length > 0) {
                                    let downloadBtn = document.createElement("a");
                                    downloadBtn.href = "#";
                                    downloadBtn.classList.add("btn-filedown");
                                    downloadBtn.title = "Îã§Ïö¥Î°úÎìú";
                                    downloadBtn.textContent = "Îã§Ïö¥Î°úÎìú";

                                    // ÌÅ¥Î¶≠ Ïãú, Ìï¥Îãπ ÌñâÏùò `fileList` Ï†ÑÎã¨
                                    downloadBtn.onclick = function (event) {
                                        event.preventDefault();
                                        downloadFile_order(item.fileList);
                                    };

                                    cell.appendChild(downloadBtn);
                                }
                            }
                        }
                    }
                });
                // Ìó§ÎçîÎ•º Ï§ëÏïô Ï†ïÎ†¨ÌïòÎäî Ïù¥Î≤§Ìä∏ Ìï∏Îì§Îü¨
                theGrid.formatItem.addHandler(function (s, e) {
                    if (e.panel === s.columnHeaders) {
                        e.cell.style.textAlign = 'center';
                    }
                });
                theGrid.rowHeaders.columns.splice(0, 1);
                attachDoubleClickEvent(theGrid); //ÎçîÎ∏î ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
                new FlexGridContextMenu(theGrid);
                window.downloadFileName = 'Ïù¥ÎØ∏ÏßÄÍ¥ÄÎ¶¨';
            } else {
                theGrid.itemsSource = viewdata;
            }
        }

        // ÎçîÎ∏î ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏: ÌÅ¥Î¶≠Ìïú Îç∞Ïù¥ÌÑ∞Î°ú ÌåùÏóÖ Ïó¥Í∏∞
        function attachDoubleClickEvent(grid) {
            let lastClickTime = 0;
            grid.hostElement.addEventListener('click', function (e) {
                const now = new Date().getTime();

                if (now - lastClickTime < 300) { // 300ms Ïù¥ÎÇ¥ ÌÅ¥Î¶≠ -> ÎçîÎ∏îÌÅ¥Î¶≠ Ï≤òÎ¶¨
                    const ht = grid.hitTest(e);

                    if (ht.cellType === wijmo.grid.CellType.Cell) {
                        const rowData = grid.rows[ht.row].dataItem; // ÎçîÎ∏î ÌÅ¥Î¶≠Ìïú ÌñâÏùò Îç∞Ïù¥ÌÑ∞
                        console.log('Row Data:', rowData); // ÎîîÎ≤ÑÍπÖ

                        if (rowData) {
                            modifyData(rowData); // Îç∞Ïù¥ÌÑ∞ ÏûÖÎ†• ÌïÑÎìú Ï±ÑÏö∞Í∏∞
                            NewSave(); // ÌåùÏóÖ Ïó¥Í∏∞
                        }
                    }
                }
                lastClickTime = now;
            });
        }

        // ÏÑ†ÌÉùÌïú ÌñâÏùò Îç∞Ïù¥ÌÑ∞Î•º ÌåùÏóÖ ÏûÖÎ†• ÌïÑÎìúÏóê Ï±ÑÏö∞Í≥†, Ï≤®Î∂Ä ÌååÏùºÏùÑ UIÏóê ÌëúÏãú
        function modifyData(rowData) {
            console.log("‚úîÔ∏è ÎçîÎ∏îÌÅ¥Î¶≠Ìïú ÌñâÏùò Îç∞Ïù¥ÌÑ∞:", rowData);
            console.log("‚úîÔ∏è ÌååÏùº Î™©Î°ù Îç∞Ïù¥ÌÑ∞:", rowData.fileList || "üö® fileListÍ∞Ä ÏóÜÏäµÎãàÎã§!");

            document.getElementById('imgseq').value = rowData.imgseq || "";
            document.getElementById('makcltnm').value = rowData.makcltnm || "";
            document.getElementById('title').value = rowData.maksubject || "";
            document.getElementById('makcondyul').value = rowData.makcondyul || "";
            document.getElementById('makuseyul').value = rowData.makuseyul || "";

            let fileList = document.getElementById('filelist2');
            fileList.innerHTML = "";
            uploadedFiles2 = [];

            if (rowData.fileList && Array.isArray(rowData.fileList)) {
                rowData.fileList.forEach(file => {
                    let listItem = document.createElement("li");

                    let fileInfo = document.createElement("p");
                    fileInfo.textContent = file.fileornm + " ";

                    // ÌååÏùº ÏÇ¨Ïù¥Ï¶à ÌëúÏãú (ÏÑúÎ≤ÑÏóêÏÑú ÎÇ¥Î†§Ïò§Îäî ÏÜçÏÑ±Î™ÖÏù¥ "fileSize" ÎòêÎäî "filesize"Ïóê ÎßûÏ∂∞ ÏÇ¨Ïö©)
                    let size = file.fileSize || file.filesize;  // ÏÜçÏÑ±Î™ÖÏù¥ Îã§Î•º Ïàò ÏûàÏúºÎØÄÎ°ú Îëê Í∞ÄÏßÄ Î™®Îëê ÌôïÏù∏
                    let fileSize = document.createElement("span");
                    if (size) {
                        // Ïòà: 85309 bytes ‚Üí "85 KB" (ÏõêÌïòÎäî Îã®ÏúÑÎ°ú Î≥ÄÌôò Í∞ÄÎä•)
                        let kb = Math.round(size / 1024);
                        fileSize.textContent = `(${kb} KB)`;
                    } else {
                        fileSize.textContent = "(ÌååÏùº ÌÅ¨Í∏∞ Ïïå Ïàò ÏóÜÏùå)";
                    }
                    fileInfo.appendChild(fileSize);

                    let deleteBtn = document.createElement("a");
                    deleteBtn.href = "#";
                    deleteBtn.title = "ÏÇ≠Ï†ú";
                    deleteBtn.classList.add("btn-file-delete2");

                    let deleteIcon = document.createElement("img");
                    deleteIcon.src = "/images/icon/ico-filedelete.svg";
                    deleteIcon.alt = "ÏÇ≠Ï†úÏïÑÏù¥ÏΩò";

                    deleteBtn.appendChild(deleteIcon);
                    deleteBtn.onclick = function (event) {
                        event.preventDefault();
                        uploadedFiles2 = uploadedFiles2.filter(f => f.filesvnm !== file.filesvnm);
                        listItem.remove();
                        updateFileCount();
                    };

                    listItem.appendChild(fileInfo);
                    listItem.appendChild(deleteBtn);
                    fileList.appendChild(listItem);

                    uploadedFiles2.push(file);
                });

                updateFileCount();
            }
        }

        // ÌååÏùº Í∞úÏàò ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò
        function updateFileCount() {
            let fileCount = uploadedFiles2.length;
            $(".upload-filelist2 h5").text(`Files (${fileCount})`);
            $(".btn-file2 span").text(`(${fileCount})`);
        }

        // Îã§Ïö¥Î°úÎìú
        function downloadFile_order(fileList) {
            if (!fileList || fileList.length === 0) {
                console.warn("Îã§Ïö¥Î°úÎìúÌï† ÌååÏùºÏù¥ ÏóÜÏäµÎãàÎã§.");
                return;
            }

            console.log("Îã§Ïö¥Î°úÎìúÌï† ÌååÏùº Î™©Î°ù:", fileList);

            let downloadList = fileList.map(file => ({
                filepath: file.filepath,
                filesvnm: file.filesvnm,
                fileornm: file.fileornm
            }));

            let downloadUrl = '/api/announcement/downloader';

            // ÌååÏùº Î¶¨Ïä§Ìä∏Î•º ÏÑúÎ≤ÑÏóê Ï†ÑÏÜ°ÌïòÏó¨ Îã§Ïö¥Î°úÎìú Ïã§Ìñâ
            downloadFiles(downloadList, downloadUrl);
        }

        //Ï†ÄÏû•
        function SaveForm() {
            const formData = {
                makseq: $("#makseq").val(),
                makcltnm: $("#makcltnm").val(),
                maksubject: $("#title").val(),
                makcondyul: $("#makcondyul").val(),
                makuseyul: $("#makuseyul").val(),
            };

            let formDataObj = new FormData();
            formDataObj.append("formData", new Blob([JSON.stringify(formData)], {type: "application/json"}));

            console.log("Ï†ÄÏû•Ìï† Îç∞Ïù¥ÌÑ∞:", formData);

            // üîπ Í∏∞Ï°¥ filelist(ÏóÖÎ°úÎìúÌï† ÌååÏùº Î™©Î°ù)ÏóêÏÑú ÌååÏùº Í∞ÄÏ†∏Ïò§Í∏∞
            if (uploadedFiles2 && uploadedFiles2.length > 0) {
                console.log("ÌååÏùº Í∞úÏàò (filelist):", uploadedFiles2.length);
                uploadedFiles2.forEach((file, index) => {
                    formDataObj.append("files", file);  // Ïó¨Îü¨ Í∞úÏùò ÌååÏùºÏùÑ Í∞úÎ≥ÑÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÌï¥Ïïº Ìï®
                    console.log(`ÌååÏùº Ï∂îÍ∞ÄÎê® [${index + 1}/${uploadedFiles2.length}]:`, file.name);
                });
            } else {
                console.log("Ï∂îÍ∞ÄÌï† ÌååÏùºÏù¥ ÏóÜÏùå.");
            }

            // AJAX ÏöîÏ≤≠
            $.ajax({
                url: '/api/CardImg/save',
                type: 'POST',
                data: formDataObj,
                contentType: false,
                processData: false,
                headers: {
                    'X-CSRF-Token': $('[name=_csrf]').val()
                },
                success: function (response) {
                    if (response.success) {
                        Alert.alert("", "Ï†ÄÏû•Ïù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§!");
                        NewClose();
                        fetchListData();
                    } else {
                        console.error("Ï†ÄÏû• Ï§ë Î¨∏Ï†úÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§:", response.message);
                        Alert.alert("", "Ï†ÄÏû• Ï§ë Î¨∏Ï†úÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.");
                    }
                },
                error: function (xhr, status, error) {
                    console.error("Ï†ÄÏû• Ï§ë Ïò§Î•ò Î∞úÏÉù:", status, error);
                    Alert.alert("", "Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. Í¥ÄÎ¶¨ÏûêÏóêÍ≤å Î¨∏ÏùòÌïòÏÑ∏Ïöî.");
                }
            });
        }

        // ÏÇ≠Ï†ú Ìï®Ïàò
        function deleteData() {
            let selectedItem = theGrid.selection.row >= 0 ? theGrid.rows[theGrid.selection.row].dataItem : null;

            console.log("ÏÑ†ÌÉùÎêú ÏïÑÏù¥ÌÖú:", selectedItem); // ÏÑ†ÌÉùÎêú ÌñâÏùò Îç∞Ïù¥ÌÑ∞ ÌôïÏù∏

            if (!selectedItem || !selectedItem.makseq) {
                Alert.alert('', "ÏÇ≠Ï†úÌï† Îç∞Ïù¥ÌÑ∞Î•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.");
                console.warn("ÏÇ≠Ï†úÌï† Îç∞Ïù¥ÌÑ∞Í∞Ä ÏÑ†ÌÉùÎêòÏßÄ ÏïäÏùå");
                return;
            }

            const makseq = selectedItem.makseq; // ÏÑ†ÌÉùÌïú ÌñâÏùò makseq Í∞í
            console.log("ÏÇ≠Ï†úÌï† makseq:", makseq); // makseq Í∞í ÌôïÏù∏

            Alert.confirm('', 'ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?', function () {
                $.ajax({
                    url: '/api/Marketing/delete',  // API URL ÌôïÏù∏
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({makseq: makseq}),  // JSON Îç∞Ïù¥ÌÑ∞ ÌôïÏù∏
                    headers: {
                        'X-CSRF-Token': $('[name=_csrf]').val()
                    },
                    success: function (response) {
                        console.log("ÏÑúÎ≤Ñ ÏùëÎãµ:", response); // ÏÑúÎ≤Ñ ÏùëÎãµ ÌôïÏù∏
                        if (response.success) {
                            Alert.alert('', "ÏÇ≠Ï†úÍ∞Ä ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§.");
                            fetchListData(); // Îç∞Ïù¥ÌÑ∞ ÏÉàÎ°úÍ≥†Ïπ®
                            clearForm(); // Ìèº Ï¥àÍ∏∞Ìôî
                        } else {
                            Alert.alert('', "ÏÇ≠Ï†ú Ï§ë Î¨∏Ï†úÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: " + response.message);
                            console.warn("ÏÇ≠Ï†ú Ï§ë Ïò§Î•ò:", response.message);
                        }
                    },
                    error: function (xhr, status, error) {
                        Alert.alert('', "ÏÇ≠Ï†ú ÏöîÏ≤≠ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.");
                        console.error("ÏÇ≠Ï†ú ÏöîÏ≤≠ Ïã§Ìå®:", status, error);
                    }
                });
            });
        }

        /*ÌåùÏóÖ*/

        function NewSave() {
            let popup = document.getElementById('popup1');
            let wrapper = document.getElementById('wrapper1');

            popup.style.display = 'block';
            wrapper.style.display = 'block';
        }

        function NewClose() {
            // ÌåùÏóÖ Îã´Í∏∞
            let popup = document.getElementById('popup1');
            let wrapper = document.getElementById('wrapper1');
            clearForm();  // Ìèº Ï¥àÍ∏∞Ìôî
            popup.style.display = 'none';
            wrapper.style.display = 'none';
        }

        // Ìèº Ï¥àÍ∏∞Ìôî Ìï®Ïàò
        function clearForm() {
            // Ìèº ÏöîÏÜå ÏÑ†ÌÉù
            const form = document.getElementById('MarketingForm');

            if (form) {
                form.reset(); // Î™®Îì† ÏûÖÎ†• ÌïÑÎìú Ï¥àÍ∏∞Ìôî
            }

            // ÌååÏùº ÏûÖÎ†• ÌïÑÎìú Ï¥àÍ∏∞Ìôî
            let fileInput = document.getElementById('fileInput2');
            if (fileInput) {
                fileInput.value = "";
            }

            // ÌååÏùº Î™©Î°ù UI Ï¥àÍ∏∞Ìôî
            let fileList = document.getElementById('filelist2');
            if (fileList) {
                fileList.innerHTML = "";
            }

            // ÌååÏùº Î¶¨Ïä§Ìä∏ Î∞∞Ïó¥ Ï¥àÍ∏∞Ìôî
            uploadedFiles2 = [];

            // ÌååÏùº Í∞úÏàò ÌÖçÏä§Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏ (Ïã§ÏãúÍ∞Ñ Î∞òÏòÅ ÌôïÏù∏)
            let fileCountText = document.querySelector(".upload-filelist2 h5");
            if (fileCountText) {
                fileCountText.textContent = `Files (${uploadedFiles2.length})`;
            }
            let clearButton = document.querySelector(".btn-clear");
            if (clearButton) {
                clearButton.remove();  // ÏöîÏÜå ÏûêÏ≤¥Î•º ÏÇ≠Ï†ú
            }
        }

        // Î∞úÏÉùÎπÑÏú®(Í∏∞Ìò∏)
        function addPercentageSign(input) {
            const cursorPosition = input.selectionStart;
            // Ïà´ÏûêÎßå Ï∂îÏ∂ú
            let value = input.value.replace(/[^0-9.]/g, '');
            // ÏûÖÎ†•Í∞íÏù¥ Ïà´ÏûêÎ°ú Î≥ÄÌôò Í∞ÄÎä•ÌïòÍ≥†, ÏµúÎåÄÍ∞í 100 Ïù¥ÌïòÏù∏ÏßÄ Ï≤¥ÌÅ¨
            if (value && parseInt(value, 10) > 100) {
                value = '100'; // 100ÏúºÎ°ú Í∞ïÏ†ú ÏÑ§Ï†ï
            }
            // ÏûÖÎ†• Í∞íÏù¥ ÎπÑÏñ¥ ÏûàÏßÄ ÏïäÏùÑ ÎïåÎßå % Ï∂îÍ∞Ä
            if (value) {
                input.value = value + '%';
            } else {
                input.value = ''; // Îπà Í∞í Ï≤òÎ¶¨
            }
            // Ïª§ÏÑú ÏúÑÏπò Ï°∞Ï†ï
            if (cursorPosition <= value.length) {
                input.setSelectionRange(cursorPosition, cursorPosition); // Ïª§ÏÑúÎ•º Ïú†ÏßÄ
            }
        }

    </script>
</th:block>
</html>