<html layout:decorate="~{layout_page}" xmlns:layout="http://www.w3.org/1999/xhtml">
<style>
    #theGrid {
        width: 100%;
        height: 400px;
        overflow: auto; /* ìŠ¤í¬ë¡¤ í™œì„±í™” */
    }

    .wj-flexgrid .wj-header {
        position: sticky;
        top: 0;
        z-index: 10;
        overflow: auto;
    }

</style>
<th:block layout:fragment="content">
    <div class="layout-contents">
        <!-- Page Title -->
        <div class="page-title-wrap">
            <div class="left">
                <h2>ì´ë¯¸ì§€ê´€ë¦¬</h2>
                <!--<a title="ë¶ë§ˆí¬" class="bookmark toggle">
                    ë‚´ë©”ë‰´
                </a>-->
            </div>
            <ul class="page-navi">
                <li><img src="/images/icon/ico-nav-home.svg" alt="í™ˆì•„ì´ì½˜"></li>
                <li>ë¶„ë¥˜ ê´€ë¦¬</li>
                <li>ì´ë¯¸ì§€ê´€ë¦¬</li>
            </ul>
        </div>
        <!-- Select -->
        <div class="tab-contents">
            <section class="tab-item" id="tab2" style="height: 750px; overflow: hidden;">
                <div class="section-top">
                    <div class="search-wrap">
                        <dl>
                            <dt>
                                <label for="startDate">
                                    ë‚ ì§œ<span class="eq">*</span>
                                </label>
                            </dt>
                            <dd>
                                <ul class="date-box">
                                    <li>
                                        <input type="date" id="startDate" name="startDate">
                                        <label for="startDate" class="hide">ì‹œì‘ì¼</label>
                                    </li>
                                    <li>
                                        <input type="date" id="endDate" name="endDate">
                                        <label for="endDate" class="hide">ì¢…ë£Œì¼</label>
                                    </li>
                                </ul>
                            </dd>
                        </dl>
                        <dl>
                            <dt>
                                <label for="searchUserNm">
                                    ì…ë ¥ì<span class="eq">*</span>
                                </label>
                            </dt>
                            <dd>
                                <div class="srch-box">
                                    <input type="text" id="searchUserNm" name="searchUserNm" class="input-srch"
                                           placeholder="ì…ë ¥ì" style="border-radius: 5px;">
                                </div>
                            </dd>
                        </dl>
                        <dl>
                            <dt>&nbsp;</dt>
                            <dd>
                                <li>
                                    <a class="btn btn-delete" title="ê²€ìƒ‰" id="searchButton1" onclick="fetchListData()">
                                        <img src="/images/icon/btn-srch.svg" alt="ê²€ìƒ‰ ì•„ì´ì½˜">
                                        ê²€ìƒ‰
                                    </a>
                                </li>
                            </dd>
                        </dl>
                    </div>
                    <div class="button-wrap" style="border-top:none;">
                        <ul>
                            <li>
                                <a class="btn btn-excell" title="ì‹ ê·œë“±ë¡" id="Newbtn" onclick="NewSave()">
                                    <img src="/images/icon/ico-plus.svg" alt="ë“±ë¡ ì•„ì´ì½˜">
                                    ì‹ ê·œë“±ë¡
                                </a>
                            </li>
                            <li>
                                <a class="btn btn-delete" title="ì‚­ì œ" id="btnDelete" onclick="deleteData()">
                                    <img src="/images/icon/ico-delete.svg" alt="ì—‘ì…€ ì•„ì´ì½˜">
                                    ì‚­ì œ
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>

                <div class="container-fluid">
                    <p id="selectedItem"></p>
                    <div id="theGrid" style="max-height: 650px"></div>
                </div>
            </section>
        </div> <!--//tab-wrap end-->
    </div> <!--//layout-contents end -->
    <footer>
        <p>â“’ factCheck corp.All rights reserved.</p>
    </footer>

    <div class="dashboard-layout-popup">
        <div class="popup-overlay" id="popup1"></div>
        <div class="popup-wrapper" id="wrapper1">
            <div class="popup-title">
                <h3>ì´ë¯¸ì§€ ê´€ë¦¬</h3>
                <a onclick="NewClose()" title="íŒì—…ë‹«ê¸°" class="btn-popup-close">
                    <img src="/images/icon/btn-popup-close.svg" alt="ë‹«ê¸°">
                </a>
            </div>
            <div class="popup-contents">
                <form id="MarketingForm" autocomplete="off">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    <div class="table-wrap">
                        <table class="view-table" id="selectedData" style="max-height: 740px;">
                            <caption>ì´ë¯¸ì§€ê´€ë¦¬ ì‹ ê·œ ë“±ë¡ í…Œì´ë¸”</caption>
                            <colgroup>
                                <col class="wp20">
                                <col class="wauto">
                            </colgroup>
                            <tbody>
                            <tr>
                                <th><label for="imgflag"> êµ¬ë¶„</label></th>
                                <td colspan="3">
                                    <select id="imgflag" style="width: 100%;">
                                        <option value="00" selected>ì¹´ë“œ ì´ë¯¸ì§€</option>
                                        <option value="01">ê¸°íƒ€ ì´ë¯¸ì§€</option>
                                    </select>
                                    <input id="imgseq" type="hidden">
                                </td>
                            </tr>
                            <tr>
                                <th><label for="indatem">ì…ë ¥ì¼ì‹œ</label></th>
                                <td colspan="3">
                                    <input id="indatem" name="indatem" class="wp100" placeholder="" readonly/>
                                </td>
                            </tr>
                            <tr>
                                <th>
                                    <label for="inuserid">ì…ë ¥ì</label>
                                </th>
                                <td colspan="3">
                                    <input type="text" id="inuserid" name="inuserid" class="wp100" placeholder="" readonly/>
                                </td>
                            </tr>
                            <tr>
                                <th><label for="fileInput2">ì²¨ë¶€íŒŒì¼</label></th>
                                <td colspan="3">
                                    <div id="uploadComponent2" class="upload-component2">
                                        <div class="upload-filebox2">
                                            <img src="/images/icon/ico-fileupload.svg" alt="ì—…ë¡œë“œì•„ì´ì½˜">
                                            <a class="btn" title="íŒŒì¼ì—…ë¡œë“œ">íŒŒì¼ ì—…ë¡œë“œ</a>
                                            <input type="file" id="fileInput2" class="fileInput2" multiple>

                                            <p>png íŒŒì¼í˜•ì‹ë§Œ ë“±ë¡ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
                                            <p>ì¹´ë“œì´ë¯¸ì§€ì¼ê²½ìš° íŒŒì¼ëª…ì„ "CARD_001" ìˆ«ìëŠ” 3ìë¦¬ë¡œ ë§ì¶°ì£¼ì„¸ìš”</p>
                                        </div>

                                        <div class="upload-filelist2">
                                            <div class="title">
                                                <h5>Files (0)</h5>
                                                <a title="Delete all" class="btn-file-deleteall2">Delete all</a>
                                            </div>
                                            <ul class="filelist2" id="filelist2">
                                            </ul>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </form>
            </div>
            <div class="popup-button">
                <button class="btn-popup-close" onclick="NewClose()">ì·¨ì†Œ</button>
                <button class="btn-navy" id="btnSaveAuth" onclick="SaveForm()"> ì €ì¥</button>
            </div>
        </div>
    </div>

</th:block>
<th:block layout:fragment="scripts">
    <th:block th:replace="/common/columns_setting :: columns_setting"></th:block>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="text/javascript">
        let theGrid;

        $(document).ready(function () {
            // í˜„ì¬ ë‚ ì§œ ì„¤ì •
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth();

            // ì‹œì‘ì¼
            const startOfYear = new Date(year, 0, 1);
            const startYearFormatted = `${startOfYear.getFullYear()}-${String(startOfYear.getMonth() + 1).padStart(2, '0')}-${String(startOfYear.getDate()).padStart(2, '0')}`;
            $('#startDate').val(startYearFormatted);

            // ì¢…ë£Œì¼
            const endOfMonth = new Date(year, month + 1, 0);
            const endMonthFormatted = `${endOfMonth.getFullYear()}-${String(endOfMonth.getMonth() + 1).padStart(2, '0')}-${String(endOfMonth.getDate()).padStart(2, '0')}`;
            $('#endDate').val(endMonthFormatted);
            init();
        });

        document.getElementById('searchUserNm').addEventListener('keydown', function (event) {
            if (event.key === 'Enter') {
                fetchListData(); // ì—”í„° í‚¤ë¥¼ ëˆŒë €ì„ ë•Œ ì‹¤í–‰í•  í•¨ìˆ˜
            }
        })

        function init() {
            fetchListData();
        }

        function fetchListData() {
            let data = [];

            const params = {
                startDate: $('#startDate').val(),
                endDate: $('#endDate').val(),
                searchUserNm: $('#searchUserNm').val()
            };

            // ì„œë²„ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            $.ajax({
                url: '/api/CardImg/read',
                type: 'GET',
                data: params,
                async: false,
                success: function (response) {
                    console.log("ì„œë²„ì—ì„œ ë°›ì€ ë°ì´í„° :", response);
                    // ì‘ë‹µì´ ì˜¬ë°”ë¥´ê²Œ ë„ì°©í–ˆê³ , data ì†ì„±ì´ ë°°ì—´ì¸ì§€ í™•ì¸
                    if (response && Array.isArray(response.data)) {
                        data = response.data.map((item, index) => ({
                            rownum: index + 1,
                            imgseq: item.imgseq || '',
                            imgflag: item.imgflag || '',
                            indatem: item.indatem || '',
                            inuserid: item.inuserid || '',
                            inuserid: item.inuserid || '',
                            fileList: Array.isArray(item.filelist) ? item.filelist : [],
                            isdownload: item.isdownload
                        }));
                    }
                },
                error: function () {
                    console.error("ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                }
            });

            while (data.length < 15) {
                data.push({
                    rownum: data.length + 1,
                    imgflag: '',
                    fileList: [],
                    indatem: '',
                    inuserid: '',
                    isdownload: '',
                });
            }

            const viewdata = new wijmo.collections.CollectionView(data);

            if (!theGrid) {
                theGrid = new wijmo.grid.FlexGrid('#theGrid', {
                    autoGenerateColumns: false,
                    showMarquee: true,
                    isReadOnly: true,
                    columns: [
                        {binding: 'rownum', header: 'ìˆœë²ˆ', width: 70, align: 'center'},
                        {binding: 'imgseq', header: 'ì¼ë ¨ë²ˆí˜¸', visible: false},
                        {binding: 'imgflag', header: 'êµ¬ë¶„', width: 220, align: 'center'},
                        {binding: 'fileList', header: 'ì²¨ë¶€íŒŒì¼', width: 630, align: 'left'},
                        {binding: 'indatem', header: 'ì…ë ¥ì¼ì‹œ', width: '*', minWidth: 300, align: 'center'},
                        {binding: 'inuserid', header: 'ì…ë ¥ì', width: '*', minWidth: 300, align: 'center'},
                        {binding: 'isdownload', visible: false},
                    ],
                    itemsSource: viewdata,
                    itemFormatter: function (panel, r, c, cell) {
                        if (panel.cellType === wijmo.grid.CellType.Cell) {
                            let item = panel.rows[r].dataItem;

                            if (panel.columns[c].binding === 'fileList') {
                                cell.innerHTML = ''; // ê¸°ì¡´ ë‚´ìš© ì‚­ì œ

                                if (item.isdownload && item.fileList.length > 0) {
                                    let downloadBtn = document.createElement("a");
                                    downloadBtn.href = "#";
                                    downloadBtn.classList.add("btn-filedown");
                                    downloadBtn.title = "ë‹¤ìš´ë¡œë“œ";
                                    downloadBtn.textContent = "ë‹¤ìš´ë¡œë“œ";

                                    // í´ë¦­ ì‹œ, í•´ë‹¹ í–‰ì˜ `fileList` ì „ë‹¬
                                    downloadBtn.onclick = function (event) {
                                        event.preventDefault();
                                        downloadFile_order(item.fileList);
                                    };

                                    cell.appendChild(downloadBtn);
                                }
                            }
                        }
                    }
                });
                // í—¤ë”ë¥¼ ì¤‘ì•™ ì •ë ¬í•˜ëŠ” ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
                theGrid.formatItem.addHandler(function (s, e) {
                    if (e.panel === s.columnHeaders) {
                        e.cell.style.textAlign = 'center';
                    }
                });
                theGrid.rowHeaders.columns.splice(0, 1);
                attachDoubleClickEvent(theGrid); //ë”ë¸” í´ë¦­ ì´ë²¤íŠ¸
                new FlexGridContextMenu(theGrid);
                window.downloadFileName = 'ì´ë¯¸ì§€ê´€ë¦¬';
            } else {
                theGrid.itemsSource = viewdata;
            }
        }

        // ë”ë¸” í´ë¦­ ì´ë²¤íŠ¸: í´ë¦­í•œ ë°ì´í„°ë¡œ íŒì—… ì—´ê¸°
        function attachDoubleClickEvent(grid) {
            let lastClickTime = 0;
            grid.hostElement.addEventListener('click', function (e) {
                const now = new Date().getTime();

                if (now - lastClickTime < 300) { // 300ms ì´ë‚´ í´ë¦­ -> ë”ë¸”í´ë¦­ ì²˜ë¦¬
                    const ht = grid.hitTest(e);

                    if (ht.cellType === wijmo.grid.CellType.Cell) {
                        const rowData = grid.rows[ht.row].dataItem; // ë”ë¸” í´ë¦­í•œ í–‰ì˜ ë°ì´í„°
                        console.log('Row Data:', rowData); // ë””ë²„ê¹…

                        if (rowData) {
                            modifyData(rowData); // ë°ì´í„° ì…ë ¥ í•„ë“œ ì±„ìš°ê¸°
                            NewSave(); // íŒì—… ì—´ê¸°
                        }
                    }
                }
                lastClickTime = now;
            });
        }

        // ì„ íƒí•œ í–‰ì˜ ë°ì´í„°ë¥¼ íŒì—… ì…ë ¥ í•„ë“œì— ì±„ìš°ê³ , ì²¨ë¶€ íŒŒì¼ì„ UIì— í‘œì‹œ
        function modifyData(rowData) {
            console.log("âœ”ï¸ ë”ë¸”í´ë¦­í•œ í–‰ì˜ ë°ì´í„°:", rowData);
            console.log("âœ”ï¸ íŒŒì¼ ëª©ë¡ ë°ì´í„°:", rowData.fileList || "ğŸš¨ fileListê°€ ì—†ìŠµë‹ˆë‹¤!");

            document.getElementById('imgseq').value = rowData.imgseq || "";
            const selectimgflag = document.getElementById('imgflag');   // ë¬¸ì˜êµ¬ë¶„(ê³µí†µì½”ë“œ)
            setSelectedIndex(selectimgflag, rowData.imgflag);
            document.getElementById('indatem').value = rowData.indatem || "";
            document.getElementById('inuserid').value = rowData.inuserid || "";

            let fileList = document.getElementById('filelist2');
            fileList.innerHTML = "";
            uploadedFiles2 = [];
            deletedFiles2 = [];

            if (rowData.fileList && Array.isArray(rowData.fileList)) {
                rowData.fileList.forEach(file => {
                    let listItem = document.createElement("li");

                    let fileInfo = document.createElement("p");
                    fileInfo.textContent = file.fileornm + " ";

                    // íŒŒì¼ ì‚¬ì´ì¦ˆ í‘œì‹œ (ì„œë²„ì—ì„œ ë‚´ë ¤ì˜¤ëŠ” ì†ì„±ëª…ì´ "fileSize" ë˜ëŠ” "filesize"ì— ë§ì¶° ì‚¬ìš©)
                    let size = file.fileSize || file.filesize;  // ì†ì„±ëª…ì´ ë‹¤ë¥¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ë‘ ê°€ì§€ ëª¨ë‘ í™•ì¸
                    let fileSize = document.createElement("span");
                    if (size) {
                        // ì˜ˆ: 85309 bytes â†’ "85 KB" (ì›í•˜ëŠ” ë‹¨ìœ„ë¡œ ë³€í™˜ ê°€ëŠ¥)
                        let kb = Math.round(size / 1024);
                        fileSize.textContent = `(${kb} KB)`;
                    } else {
                        fileSize.textContent = "(íŒŒì¼ í¬ê¸° ì•Œ ìˆ˜ ì—†ìŒ)";
                    }
                    fileInfo.appendChild(fileSize);

                    let deleteBtn = document.createElement("a");
                    deleteBtn.href = "#";
                    deleteBtn.title = "ì‚­ì œ";
                    deleteBtn.classList.add("btn-file-delete2");

                    let deleteIcon = document.createElement("img");
                    deleteIcon.src = "/images/icon/ico-filedelete.svg";
                    deleteIcon.alt = "ì‚­ì œì•„ì´ì½˜";

                    deleteBtn.appendChild(deleteIcon);
                    deleteBtn.onclick = function (event) {
                        event.preventDefault();
                        uploadedFiles2 = uploadedFiles2.filter(f => f.filesvnm !== file.filesvnm);
                        listItem.remove();
                        updateFileCount();
                    };
                    deleteBtn.onclick = function (event) {
                        event.preventDefault();
                        deletedFiles2.push(file); // ğŸ”¹ ì‚­ì œëœ íŒŒì¼ì„ ë°°ì—´ì— ì¶”ê°€
                        listItem.remove();
                        updateFileCount();
                    };

                    listItem.appendChild(fileInfo);
                    listItem.appendChild(deleteBtn);
                    fileList.appendChild(listItem);

                    uploadedFiles2.push(file);
                });

                updateFileCount();
            }
        }
        // select ë°”ì¸ë“œ ë©”ì„œë“œ
        function setSelectedIndex(selectElement, selectedValue) {
            for (let i = 1; i < selectElement.options.length; i++) {
                // íŠ¸ë¦¼(ê³µë°± ì œê±°), ëŒ€ì†Œë¬¸ì ë¬´ì‹œ, íƒ€ì… ì¼ì¹˜ì‹œí‚¤ê¸°
                if (selectElement.options[i].text === String(selectedValue).trim().toLowerCase()) {
                    selectElement.selectedIndex = i;
                    break;
                }
            }
        }

        // íŒŒì¼ ê°œìˆ˜ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateFileCount() {
            let fileCount = uploadedFiles2.length;
            $(".upload-filelist2 h5").text(`Files (${fileCount})`);
            $(".btn-file2 span").text(`(${fileCount})`);
        }

        // ë‹¤ìš´ë¡œë“œ
        function downloadFile_order(fileList) {
            if (!fileList || fileList.length === 0) {
                console.warn("ë‹¤ìš´ë¡œë“œí•  íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            console.log("ë‹¤ìš´ë¡œë“œí•  íŒŒì¼ ëª©ë¡:", fileList);

            let downloadList = fileList.map(file => ({
                filepath: file.filepath,
                filesvnm: file.filesvnm,
                fileornm: file.fileornm
            }));

            let downloadUrl = '/api/announcement/downloader';

            // íŒŒì¼ ë¦¬ìŠ¤íŠ¸ë¥¼ ì„œë²„ì— ì „ì†¡í•˜ì—¬ ë‹¤ìš´ë¡œë“œ ì‹¤í–‰
            downloadFiles(downloadList, downloadUrl);
        }

        //ì €ì¥
        function SaveForm() {
            const formData = {
                imgseq: $("#imgseq").val(),
                imgflag: $("#imgflag").val(),
                inuserid: $("#inuserid").val(),
            };

            let formDataObj = new FormData();
            formDataObj.append("formData", new Blob([JSON.stringify(formData)], {type: "application/json"}));

            console.log("ì €ì¥í•  ë°ì´í„°:", formData);

            // ğŸ”¹ ê¸°ì¡´ filelist(ì—…ë¡œë“œí•  íŒŒì¼ ëª©ë¡)ì—ì„œ íŒŒì¼ ê°€ì ¸ì˜¤ê¸°
            if (uploadedFiles2 && uploadedFiles2.length > 0) {
                console.log("íŒŒì¼ í™•ì¸",uploadedFiles2);
                console.log("íŒŒì¼ ê°œìˆ˜ (filelist):", uploadedFiles2.length);
                //  ï¸ì²« ë²ˆì§¸ íŒŒì¼ ì´ë¦„ ì €ì¥
                imgfilenm = uploadedFiles2[0].name;

                // íŒŒì¼ ê°œìˆ˜ê°€ 2ê°œ ì´ìƒì´ë©´ 'ì™¸ nê±´' ì¶”ê°€
                if (uploadedFiles2.length > 1) {
                    imgfilenm += ` ì™¸ ${uploadedFiles2.length - 1}ê±´`;
                }
                uploadedFiles2.forEach((file, index) => {
                    formDataObj.append("files", file);  // ì—¬ëŸ¬ ê°œì˜ íŒŒì¼ì„ ê°œë³„ì ìœ¼ë¡œ ì¶”ê°€í•´ì•¼ í•¨
                    console.log(`íŒŒì¼ ì¶”ê°€ë¨ [${index + 1}/${uploadedFiles2.length}]:`, file.name);
                });
            } else {
                console.log("ì¶”ê°€í•  íŒŒì¼ì´ ì—†ìŒ.");
            }

            // ğŸ”¹ ì‚­ì œëœ íŒŒì¼ ë¦¬ìŠ¤íŠ¸ë¥¼ JSON ë¬¸ìì—´ì´ ì•„ë‹Œ "plain string"ìœ¼ë¡œ ì „ë‹¬ (ğŸš€ ìˆ˜ì •!)
            if (deletedFiles2.length > 0) {
                const deletedFilesJson = JSON.stringify(deletedFiles2.map(file => file.filesvnm)); // íŒŒì¼ ì‹ë³„ìë§Œ ì¶”ì¶œ
                formDataObj.append("deletedFiles", deletedFilesJson); // âŒ Blobì´ ì•„ë‹ˆë¼ ê·¸ëƒ¥ ë¬¸ìì—´ë¡œ ì¶”ê°€!
            }
            // imgfilenm ì¶”ê°€
            formDataObj.append("imgfilenm", imgfilenm);

            // AJAX ìš”ì²­
            $.ajax({
                url: '/api/CardImg/save',
                type: 'POST',
                data: formDataObj,
                contentType: false,
                processData: false,
                headers: {
                    'X-CSRF-Token': $('[name=_csrf]').val()
                },
                success: function (response) {
                    if (response.success) {
                        Alert.alert("", "ì €ì¥ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
                        NewClose();
                        fetchListData();
                    } else {
                        console.error("ì €ì¥ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:", response.message);
                        Alert.alert("", "ì €ì¥ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                    }
                },
                error: function (xhr, status, error) {
                    console.error("ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", status, error);
                    Alert.alert("", "ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.");
                }
            });
            fetchListData();
        }

        // ì‚­ì œ í•¨ìˆ˜
        function deleteData() {
            let selectedItem = theGrid.selection.row >= 0 ? theGrid.rows[theGrid.selection.row].dataItem : null;

            console.log("ì„ íƒëœ ì•„ì´í…œ:", selectedItem); // ì„ íƒëœ í–‰ì˜ ë°ì´í„° í™•ì¸

            if (!selectedItem || !selectedItem.imgseq) {
                Alert.alert('', "ì‚­ì œí•  ë°ì´í„°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return;
            }

            const imgseq = selectedItem.imgseq; // ì„ íƒí•œ í–‰ì˜ imgseq ê°’
            console.log("ì‚­ì œí•  imgseq:", imgseq); // imgseq ê°’ í™•ì¸

            Alert.confirm('', 'ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', function () {
                $.ajax({
                    url: '/api/CardImg/delete',  // API URL í™•ì¸
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({imgseq: imgseq}),  // JSON ë°ì´í„° í™•ì¸
                    headers: {
                        'X-CSRF-Token': $('[name=_csrf]').val()
                    },
                    success: function (response) {
                        console.log("ì„œë²„ ì‘ë‹µ:", response); // ì„œë²„ ì‘ë‹µ í™•ì¸
                        if (response.success) {
                            Alert.alert('', "ì‚­ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                            fetchListData(); // ë°ì´í„° ìƒˆë¡œê³ ì¹¨
                            clearForm(); // í¼ ì´ˆê¸°í™”
                        } else {
                            Alert.alert('', "ì‚­ì œ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + response.message);
                            console.warn("ì‚­ì œ ì¤‘ ì˜¤ë¥˜:", response.message);
                        }
                    },
                    error: function (xhr, status, error) {
                        Alert.alert('', "ì‚­ì œ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                        console.error("ì‚­ì œ ìš”ì²­ ì‹¤íŒ¨:", status, error);
                    }
                });
            });
        }

        /*íŒì—…*/

        function NewSave() {
            let popup = document.getElementById('popup1');
            let wrapper = document.getElementById('wrapper1');

            popup.style.display = 'block';
            wrapper.style.display = 'block';
        }

        function NewClose() {
            // íŒì—… ë‹«ê¸°
            let popup = document.getElementById('popup1');
            let wrapper = document.getElementById('wrapper1');
            clearForm();  // í¼ ì´ˆê¸°í™”
            popup.style.display = 'none';
            wrapper.style.display = 'none';
        }

        // í¼ ì´ˆê¸°í™” í•¨ìˆ˜
        function clearForm() {
            // í¼ ìš”ì†Œ ì„ íƒ
            const form = document.getElementById('MarketingForm');

            if (form) {
                form.reset(); // ëª¨ë“  ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                document.getElementById('imgseq').value = '';
            }

            // íŒŒì¼ ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
            let fileInput = document.getElementById('fileInput2');
            if (fileInput) {
                fileInput.value = "";
            }

            // íŒŒì¼ ëª©ë¡ UI ì´ˆê¸°í™”
            let fileList = document.getElementById('filelist2');
            if (fileList) {
                fileList.innerHTML = "";
            }

            // íŒŒì¼ ë¦¬ìŠ¤íŠ¸ ë°°ì—´ ì´ˆê¸°í™”
            uploadedFiles2 = [];

            // íŒŒì¼ ê°œìˆ˜ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ (ì‹¤ì‹œê°„ ë°˜ì˜ í™•ì¸)
            let fileCountText = document.querySelector(".upload-filelist2 h5");
            if (fileCountText) {
                fileCountText.textContent = `Files (${uploadedFiles2.length})`;
            }
            let clearButton = document.querySelector(".btn-clear");
            if (clearButton) {
                clearButton.remove();  // ìš”ì†Œ ìì²´ë¥¼ ì‚­ì œ
            }
        }

        // ë°œìƒë¹„ìœ¨(ê¸°í˜¸)
        function addPercentageSign(input) {
            const cursorPosition = input.selectionStart;
            // ìˆ«ìë§Œ ì¶”ì¶œ
            let value = input.value.replace(/[^0-9.]/g, '');
            // ì…ë ¥ê°’ì´ ìˆ«ìë¡œ ë³€í™˜ ê°€ëŠ¥í•˜ê³ , ìµœëŒ€ê°’ 100 ì´í•˜ì¸ì§€ ì²´í¬
            if (value && parseInt(value, 10) > 100) {
                value = '100'; // 100ìœ¼ë¡œ ê°•ì œ ì„¤ì •
            }
            // ì…ë ¥ ê°’ì´ ë¹„ì–´ ìˆì§€ ì•Šì„ ë•Œë§Œ % ì¶”ê°€
            if (value) {
                input.value = value + '%';
            } else {
                input.value = ''; // ë¹ˆ ê°’ ì²˜ë¦¬
            }
            // ì»¤ì„œ ìœ„ì¹˜ ì¡°ì •
            if (cursorPosition <= value.length) {
                input.setSelectionRange(cursorPosition, cursorPosition); // ì»¤ì„œë¥¼ ìœ ì§€
            }
        }

    </script>
</th:block>
</html>