<html layout:decorate="~{layout_page}" xmlns:layout="http://www.w3.org/1999/xhtml">
<style>

</style>

<th:block layout:fragment="content">
    <div class="layout-contents">
        <!-- Page Title -->
        <div class="page-title-wrap">
            <div class="left">
                <h2>사용자 관리</h2>
                <!--                <a title="북마크" class="bookmark toggle">-->
                <!--                    내메뉴-->
                <!--                </a>-->
            </div>
            <ul class="page-navi">
                <li><img src="/images/icon/ico-nav-home.svg" alt="홈아이콘"></li>
                <li>시스템설정</li>
                <li>사용자관리</li>
            </ul>
        </div>
        <!-- Select -->

        <div class="tab-wrap">
            <!--            <ul class="tab-links">-->
            <!--                <li>-->
            <!--                    <a href="#tab1" title="목록" id="listTabLink">목록</a>-->
            <!--                </li>-->
            <!--                <li>-->
            <!--                    <a href="#tab2" title="등록" id="inputTabLink">등록</a>-->
            <!--                </li>-->
            <!--            </ul>-->
            <div class="tab-contents">
                <!-- Section -->
                <section class="tab-item" id="tab1">

                    <div class="section-top">
                        <div class="title-wrap">
                            <h3>사용자 등록</h3>
                        </div>
                        <div class="button-wrap">
                            <ul>
                                <li>
                                    <a class="btn btn-excell" title="신규등록" onclick="clearForm()">
                                        <img src="/images/icon/ico-plus.svg" alt="등록 아이콘">
                                        신규등록
                                    </a>
                                </li>
                                <!--<li>
                                    <a  class="btn btn-delete" title="삭제" id="btnDelete2">
                                        <img src="/images/icon/ico-delete.svg" alt="삭제 아이콘">
                                        삭제
                                    </a>
                                </li>-->
                                <li>
                                    <a class="btn btn-edit" id="btnSave" title="저장">
                                        <img src="/images/icon/ico-save.svg" alt="저장 아이콘">
                                        저장
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="table-wrap">
                        <table class="write-table">
                            <caption>사용자등록 테이블</caption>
                            <colgroup>
                                <col class="wp20">
                                <col class="wp30">
                                <col class="wp20">
                                <col class="wp30">
                            </colgroup>
                            <tbody>
                            <tr>
                                <th>
                                    <label for="userid">
                                        아이디
                                    </label>
                                </th>
                                <td>
                                    <div class="input-clear">
                                        <input type="text" id="userid" name="userid" class="wp50"
                                               style="width: 300px !important;" placeholder="아이디">
                                    </div>
                                    <a href="#" class="btn" id="btnDuplicate" style="margin:5px; ">중복확인</a>
                                </td>
                                <th>
                                    <label for="email">
                                        이메일
                                    </label>
                                </th>
                                <td>
                                    <div class="input-clear">
                                        <input type="text" id="email" name="email" placeholder="이메일"
                                               style="width: 400px !important;">
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <th>
                                    <label for="password">
                                        비밀번호
                                    </label>
                                </th>
                                <td>
                                    <input type="password" id="password" name="password" placeholder="비밀번호" style="width: 400px !important;">
                                </td>
                                <th>
                                    <label for="passwordchk">
                                        비밀번호 확인
                                    </label>
                                </th>
                                <td>
                                    <input type="password" id="passwordchk" name="passwordchk" placeholder="비밀번호 확인" style="width: 400px !important;">
                                </td>
                            </tr>
                            <tr>
                                <th>
                                    <label for="pernm">
                                        이&nbsp;&nbsp;&nbsp;&nbsp;름
                                    </label>
                                </th>
                                <td>
                                    <div class="input-clear">
                                        <input type="text" id="pernm" name="pernm" placeholder="이름" style="width: 400px !important;">
                                    </div>
                                </td>
                                <th>
                                    <label for="Phone">
                                        서비스 수신 연락처
                                    </label>
                                </th>
                                <td colspan="3">
                                    <div class="input-clear">
                                        <input type="tel" id="Phone" name="Phone" placeholder="핸드폰 번호" style="width: 400px !important;">
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <th>
                                    사용자그룹
                                </th>
                                <td>
                                    <select id="authType" name="authType" class="wp30">
                                        <option></option>
                                    </select>
                                </td>
                                <th><label for="is_active">사용여부</label></th>
                                <td style="text-align: center; vertical-align: middle;">
                                    <input type="checkbox" id="is_active" name="is_active" style="display: block; margin: auto;">
                                </td>
                            </tr>
                            <!--<tr>
                                <th>
                                    <label for="postno">
                                        주소
                                    </label>
                                </th>
                                <td colspan="3">
                                    <div class="input-clear">
                                        <input type="text" id="postno" name="postno" placeholder="우편번호"
                                               onclick="sample4_execDaumPostcode()"
                                               style="width: 85px; margin-bottom: 3px; display: inline-block;">
                                        <input type="text" id="address1" name="address1" placeholder="도로명주소"
                                               style="width: 380px; display: inline-block; margin-left: 5px;"
                                               readonly>
                                        <input type="text" id="address2" name="address2" placeholder="상세주소"
                                               style="width: 390px; display: inline-block; margin-left: 7px;">
                                        <span id="guide" style="color:#999;display:none"></span>
                                    </div>
                                </td>
                            </tr>-->
                            </tbody>
                        </table>
                    </div>

                    <div class="section-top" style="margin-top: 24px;">
                        <div class="search-wrap">
                            <dl>
                                <dt>
                                    사용자그룹
                                </dt>
                                <dd>
                                    <select class="mg-r5" id="cboUserGroup" name="cboUserGroup" style="width: 100%">
                                        <option></option>
                                    </select>
                                </dd>
                            </dl>
                            <dl>
                                <dt>
                                    <label for="select1">
                                        이름</label></dt>
                                <dd>
                                    <div class="input-clear"><input type="text" id="keyword" name="keyword" class="wp100" maxlength="50" placeholder="이름"></div>
                                </dd>
                            </dl>
                            <dl>
                                <dt>
                                    <label>
                                        사용자ID</label></dt>

                                <dd>
                                    <div class="input-clear"><input type="text" id="username" name="username" class="wp100" maxlength="50" placeholder="아이디" autocomplete="off"></div>
                                </dd>
                            </dl>
                            <dl>
                                <dt>
                                    <label>
                                    </label>
                                </dt>
                                <dd>
                                    <div class="srch-box">
                                        <div class="input-clear"></div>
                                        <a style="margin-left: 10px" class="btn btn-delete" title="검색" id="searchgrid" onclick="searchData()" onkeyup="searchData()">
                                            <!--                                        class 쓰이는 곳 찾고 없으면 클래스명 수정하기-->
                                            <img src="/images/icon/btn-srch.svg" alt="검색 아이콘">
                                            검색
                                        </a>
                                    </div>
                                </dd>
                            </dl>
                        </div>
                        <div class="button-wrap">
                            <ul>
                                <li>
                                    <a  class="btn btn-delete" title="삭제" id="btnDelete">
                                        <img src="/images/icon/ico-delete.svg" alt="엑셀 아이콘">
                                        삭제
                                    </a>
                                </li>
                                <!--<li>
                                    <a  class="btn btn-edit" title="수정" onclick="modifyData()">
                                        <img src="/images/icon/ico-edit.svg" alt="엑셀 아이콘">
                                        수정
                                    </a>
                                </li>-->

                            </ul>
                        </div>

                    </div>
                    <!--//section-top end -->
                    <div class="container-fluid">
                        <p id="selectedItem"></p>
                        <div id="theGrid" style="max-height: 450px;"></div>
                    </div>
                    <div class="btn-wrap">
                    </div>
                </section>
            </div> <!--//tab-contens end-->
        </div> <!--//tab-wrap end-->
    </div> <!--//layout-contents end -->

    <footer>
        <p>Copyrightⓒ 0000 corp. All rights reserved.</p>
    </footer>

</th:block>
<th:block layout:fragment="scripts">
    <th:block th:replace="/common/approve_box :: approve_box"></th:block>
    <th:block th:replace="/common/ax5_uploader :: ax5_uploader" ></th:block>
    <th:block th:replace="/common/upload_one_image_box :: upload_one_image_box" ></th:block>
    <th:block th:replace="/common/popup_select_user_code :: popup_select_user_code"></th:block>
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <script>
        var popupWindow;

        function sample4_execDaumPostcode() {
            popupWindow = window.open('', 'postcodePopup', 'width=530,height=530');
            new daum.Postcode({
                oncomplete: function(data) {
                    // 검색 결과 선택 시 실행할 코드
                    var roadAddr = data.roadAddress;
                    var extraRoadAddr = '';

                    if (data.bname !== '' && /[동|로|가]$/g.test(data.bname)) {
                        extraRoadAddr += data.bname;
                    }
                    if (data.buildingName !== '' && data.apartment === 'Y') {
                        extraRoadAddr += (extraRoadAddr !== '' ? ', ' + data.buildingName : data.buildingName);
                    }
                    if (extraRoadAddr !== '') {
                        extraRoadAddr = ' (' + extraRoadAddr + ')';
                    }

                    document.getElementById('postno').value = data.zonecode;
                    document.getElementById('address1').value = roadAddr;

                    var guideTextBox = document.getElementById("guide");
                    if (data.autoRoadAddress) {
                        var expRoadAddr = data.autoRoadAddress + extraRoadAddr;
                        guideTextBox.innerHTML = '(예상 도로명 주소 : ' + expRoadAddr + ')';
                        guideTextBox.style.display = 'block';
                    } else if (data.autoJibunAddress) {
                        var expJibunAddr = data.autoJibunAddress;
                        guideTextBox.innerHTML = '(예상 지번 주소 : ' + expJibunAddr + ')';
                        guideTextBox.style.display = 'block';
                    } else {
                        guideTextBox.innerHTML = '';
                        guideTextBox.style.display = 'none';
                    }

                    // 검색 완료 후 팝업 닫기
                    popupWindow.close();
                }
            }).embed(popupWindow.document.body);
        }
    </script>

    <script type="text/javascript">

        var theGrid;
        var viewdata;
        let csrfToken = $("[name=_csrf]").val();

        document.readyState === 'complete' ? init() : window.onload = init;

        <!-- 초반 페이지 진입시 그리드 바인딩 끝-->
        function init() {
            fetchListData();
        }
        function fetchListData(searchParams = {}) {
            let data2 = [];

            // 기본 검색 조건 설정
            const defaultParams = {
                group: '',
                keyword: '',
                username: '',
                divinm: ''
            };

            // 전달된 검색 조건과 기본값 병합
            const requestParams = { ...defaultParams, ...searchParams };

            // 서버로부터 데이터를 비동기적으로 가져오기
            $.ajax({
                url: '/api/system/user/read',
                type: 'GET',
                data: requestParams, // 검색 조건 전달
                success: function (response) {
                    console.log("API Response:", response); // 응답 데이터를 출력
                    if (response && Array.isArray(response.data)) {
                        data2 = response.data;
                    }

                    // 데이터 가공: 순번 추가 및 최소 행 수 유지
                    const minimumRows = 5;
                    data2.forEach((item, index) => {
                        item.rownum = index + 1; // 순번 추가
                    });

                    if (data2.length < minimumRows) {
                        const additionalRows = minimumRows - data2.length;
                        for (let i = 0; i < additionalRows; i++) {
                            data2.push({
                                id: '',
                                userid: '',
                                pernm: '',
                                group_name: '',
                                group_id: '',
                                Phone: '',
                                email: '',
                                is_active: '',
                                date_joined: '',
                            });
                        }
                    }

                    // viewdata와 그리드 초기화 및 업데이트
                    if (!viewdata) {
                        viewdata = new wijmo.collections.CollectionView(data2);
                    } else {
                        viewdata.sourceCollection = data2;
                        viewdata.refresh();
                    }

                    if (!theGrid) {
                        theGrid = new wijmo.grid.FlexGrid('#theGrid', {
                            autoGenerateColumns: false,
                            showMarquee: true,
                            allowSorting: 'MultiColumn',
                            selectionMode: wijmo.grid.SelectionMode.Row,
                            columns: [
                                { binding: 'id', header: 'id', width: '*', align: 'center', visible: false, isReadOnly: false },
                                { binding: 'userid', header: '사용자ID', width: '*', align: 'center', isReadOnly: false },
                                { binding: 'pernm', header: '이름', width: '*', align: 'center', isReadOnly: false },
                                { binding: 'group_name', header: '사용자그룹', width: '*', align: 'center', isReadOnly: false },
                                { binding: 'group_id', header: '사용자그룹', width: '*', align: 'center', visible: false },
                                { binding: 'Phone', header: '핸드폰', width: '*', align: 'center', visible: false },
                                { binding: 'email', header: '이메일', width: '*', align: 'center', visible: false },
                                { binding: 'is_active', header: '활성화', width: '*', align: 'center', isReadOnly: false },
                                { binding: 'date_joined', header: '생성일', width: '*', align: 'center', isReadOnly: false },
                            ],
                            itemsSource: viewdata,
                        });
                        theGrid.rowHeaders.columns.splice(0, 1);
                        new FlexGridContextMenu(theGrid);
                    } else {
                        theGrid.itemsSource = viewdata; // 갱신된 CollectionView로 업데이트
                        theGrid.refresh(); // 그리드 새로고침
                    }

                    // 그리드 더블 클릭 이벤트 추가
                    let lastClickTime = 0;
                    theGrid.hostElement.addEventListener('click', function (e) {
                        const now = new Date().getTime();

                        if (now - lastClickTime < 300) {
                            const ht = theGrid.hitTest(e);

                            if (ht.cellType === wijmo.grid.CellType.Cell) {
                                const rowData = theGrid.rows[ht.row].dataItem;
                                showUserInfo(rowData);
                            }
                        }
                        lastClickTime = now;
                    });
                },
                error: function () {
                    console.error("데이터를 가져오는 중 오류가 발생했습니다.");
                }
            });
        }

        function showUserInfo(rowData) {
            // 필드 중 하나라도 비어있는지 확인하여 추가 데이터를 가져올지 결정
            const hasMissingFields = !rowData || !rowData.userid || !rowData.email;

            if (hasMissingFields) {
                // 데이터가 불완전하거나 비어 있을 때
                console.log("전송할 ID:", rowData.id);
                if (rowData && rowData.id) {
                    // 추가 데이터가 필요한 경우 AJAX 요청으로 가져오기
                    $.ajax({
                        url: '/api/system/user/detail',
                        type: 'GET',
                        data: { id: rowData.id },
                        success: function (response) {
                            if (response && response.data) {
                                populateFields(response.data); // 서버에서 가져온 데이터로 폼 채우기
                            } else {
                                populateFields({}); // 데이터가 없을 경우 빈 필드로 채우기
                            }
                        },
                        error: function () {
                            console.error("데이터를 가져오는 중 오류가 발생했습니다.");
                            populateFields({}); // 오류 발생 시 빈 필드로 채우기
                        }
                    });
                } else {
                    // rowData가 없거나 ID가 없는 경우 빈 필드로 채우기
                    populateFields({});
                }
            } else {
                // 데이터가 완전한 경우
                populateFields(rowData);
            }
        }

        function populateFields(data) {
            // 각 필드에 데이터를 채움
            document.getElementById("pernm").value = data.pernm || '';
            document.getElementById("userid").value = data.userid || '';
            document.getElementById("Phone").value = data.Phone || '';
            document.getElementById("is_active").value = data.is_active || '';
            document.getElementById("email").value = data.email || '';

            // authType(사용자 그룹) 설정
            document.getElementById('authType').value = data.group_id;

            // 체크박스 설정
            document.getElementById("is_active").checked = data.is_active || false;

            $('#userid').prop('readonly', true);
        }

        <!-- 초반 페이지 진입시 그리드 바인딩 끝-->
        //검색
        function searchData() {
            const searchParams = {
                group: $('#cboUserGroup').val(), // 사용자 그룹 ID
                keyword: $('#keyword').val(),   // 이름 검색
                username: $('#username').val(), // 사용자 ID 검색
                divinm: $('#divinm').val(),     // 기타 조건
            };
            console.log("Search Params:", searchParams);
            fetchListData(searchParams);
        }

        function grid_binding(data) {
            var inspecDto = data;
            var inspecData = [];
            var cnt = 1;
            for (let i = 0; i < inspecDto.length; i++) {
                inspecData.push({
                    id: inspecDto[i]["id"],
                    login_id: inspecDto[i]["login_id"],
                    Name: inspecDto[i]["Name"],
                    group_name: inspecDto[i]["group_name"],
                    group_id: inspecDto[i]["group_id"],
                    Value: inspecDto[i]["Value"],
                    is_active: inspecDto[i]["is_active"],
                    date_joined: inspecDto[i]["date_joined"],
                    email: inspecDto[i]["email"],
                    tel: inspecDto[i]["tel"],
                    is_superuser: inspecDto[i]["is_superuser"],
                });
                cnt++;
            }

            theGrid.columns.clear();
            theGrid.autoGenerateColumns = false;
            viewdata.sourceCollection = inspecData;

            for (var i = 0; i < columns.length; i++) {
                var col = new wijmo.grid.Column(columns[i]);
                theGrid.columns.push(col);
            }
        }

        function clearForm(){
            ['id', 'userid', 'pernm', 'password','passwordchk','cltnm', 'authType', 'email','Phone', 'tel','username'].forEach(id => {
                const element = document.getElementById(id);
                if (element) { // 요소가 존재하는 경우에만 실행
                    element.value = '';
                }
            });
            // 체크박스 초기화 (체크 해제)
            const isActiveCheckbox = document.getElementById('is_active');
            if (isActiveCheckbox) {
                isActiveCheckbox.checked = false;
            }
            const form = document.getElementById('tab1'); // 섹션 ID로 form 대체
            if (form) {
                const inputs = form.querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                    if (input.hasAttribute('readonly')) {
                        input.removeAttribute('readonly'); // readonly 속성 제거
                    }
                });
            }

            $('#password').prop('readonly', false);
            $('.new-fl-ac').remove();
        }

        $(document).ready(function (e) {

            AjaxUtil.fillSelectOptions($('#cboUserGroup'), 'user_group', '', '');
            AjaxUtil.fillSelectOptions($('#authType'), 'user_group', '', '');
            initializeSelect({
                url: '/user-auth/type',
                params: {},
                elementId: 'cboUserGroup',
                valueField: "id",
                textField: "name"
            })
            initializeSelect({
                url: '/user-auth/type',
                params: {},
                elementId: 'authType',
                valueField: "id",
                textField: "name"
            })
            initializeSelect({
                url: '/user-codes/parent',
                params: {parentId: 110},
                elementId: 'firstSelect',
                valueField: "code"
            })

            //저장
            $('#btnSave').click(function () {
                if (!validateFields()) {
                    return false;
                }
                const emailInput = document.getElementById('email');
                const emailValue = emailInput.value.trim();

                if (!emailValidate(emailValue.trim())) {
                    Alert.alert('', '유효한 이메일 형식을 입력하세요.');
                    return false;
                }

                let id = document.getElementById('id').value.trim();
                let password = document.getElementById('password');
                let pwd = password.value.trim();
                if (id === undefined || id === '') {  //신규등록이므로 비밀번호 입력 체크
                    if (pwd === undefined || pwd === '') {
                        Alert.alert('', '비밀번호를 입력해주세요', function () {
                            password.focus();
                        })
                        return;
                    }
                }

                let formData = new FormData();

                formData.append('id', id);
                formData.append('login_id', $('#userid').val());
                formData.append('Name', $('#usernm').val());
                formData.append('UserGroup_id', $('#authType').val());
                formData.append('password', pwd);
                formData.append('email', emailValue);
                formData.append('tel', $('#tel').val());
                formData.append('divinm', $('#divinm2').val());
                formData.append('agencycd', $('#agencycd').val());
                formData.append('_csrf', $('[name=_csrf]').val());

                let bindingList = ['id', 'userid', 'usernm', 'authType', 'password', 'email', 'tel', 'agencycd'];
                AjaxFunction.PostAjaxRequest('/api/system/user/save', true, false, false, formData, function (response) {
                        if (response.success) {
                            Alert.alert('', response.message, function () {
                                $('#listTabLink').click();
                                searchData();
                            });
                            clearForm();

                        } else {
                            Alert.alert('', response.message);
                        }
                    },
                    function (res){
                        Alert.alert('', '에러가 발생하였습니다.');

                    })
            });

            $('#btnDelete').click(function () {
                let selectedItems = theGrid.selectedItems;
                let auth = selectedItems[0].is_superuser;


                if(auth === true){
                    Alert.alert('', '슈퍼유저 계정은 수정 및 삭제가 불가합니다.');
                    return false;
                }

                if (selectedItems[0].id === undefined || selectedItems.length === 0) {
                    Alert.alert('', '삭제할 항목을 선택하세요.');
                    return;
                }
                console.log('zz', selectedItems)
                let delList = SelectItemPush(selectedItems, 'id');
                let del940List = SelectItemPush(selectedItems, 'login_id');
                console.log('삭제확인2', del940List);
                console.log('삭제확인', delList);
                Alert.confirm('', '삭제하시겠습니까?', function () {
                    let data = {
                        'id': JSON.stringify(delList),
                        'username': JSON.stringify(del940List),
                        '_csrf': csrfToken,
                        'auth' : auth
                    }
                    let fnSuccess = function (res) {
                        if (res.success) {
                            Alert.alert('', '삭제되었습니다.');
                            searchData();
                        }
                    }
                    AjaxUtil.postAsyncData('/api/system/user/delete', data, fnSuccess);
                })
            });

            /*$('#btnDelete2').click(function(){



                Alert.confirm('', '삭제하시겠습니까?', function () {
                    let data = {
                        'id': JSON.stringify($('#id').val()),
                        'username': JSON.stringify($('#userid').val()),
                        '_csrf': csrfToken
                    }
                    let fnSuccess = function (res) {
                        if (res.success) {
                            Alert.alert('', '삭제되었습니다.');
                            clearForm();
                            $('listTabLink').click();
                            searchData();
                        }
                    }
                    AjaxUtil.postAsyncData('/api/system/user/delete', data, fnSuccess);
                })
            })*/
        });
    </script>
</th:block>
</html>