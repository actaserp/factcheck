<html layout:decorate="~{layout_page}" xmlns:layout="http://www.w3.org/1999/xhtml">
<style>

</style>

<th:block layout:fragment="content">


  <div class="layout-contents">
    <!-- Page Title -->
    <div class="page-title-wrap">
      <div class="left">
        <h2>통계보고서</h2>
        <!--                <a title="북마크" class="bookmark toggle">-->
        <!--                    내메뉴-->
        <!--                </a>-->
      </div>
      <ul class="page-navi">
        <li><img src="/images/icon/ico-nav-home.svg" alt="홈아이콘"></li>
        <li>회원관리</li>
        <li>통계보고서</li>
      </ul>
    </div>
    <div class="tab-wrap">
      <div class="tab-contents">
        <!-- Section -->
        <section class="tab-item" id="tab1" style="height: 820px;">
          <div class="section-top">
            <form id="searchForm">
              <div class="search-wrap">
                <dl>
                  <dt>
                    조회일자<span class="eq">*</span>
                  </dt>
                  <dd>
                    <ul class="date-box">
                      <li>
                        <input class="tac w150 " type="date" id="startDate" name="date_from"/>
                        <label for="startDate" class="hide">시작일</label>
                      </li>
                      <li>
                        <input class="tac w150" type="date" id="endDate" name="date_to"/>
                        <label for="endDate" class="hide">종료일</label>
                      </li>
                    </ul>
                  </dd>
                </dl>

                <dl>
                  <dt>
                    <label for="select1">
                      회원명<span class="eq"></span>
                    </label>
                  </dt>
                  <dd>
                    <div class="srch-box">
                      <input type="text" id="txtCode" name="txtCode">
                    </div>
                  </dd>
                </dl>

                <dl>
                  <dt><span class="eq"></span></dt>
                  <dd>
                    <li>
                      <a class="btn btn-delete" title="검색" id="btnSearch1">
                        <img src="/images/icon/btn-srch.svg" alt="검색 아이콘">
                        검색
                      </a>
                    </li>
                  </dd>
                </dl>
              </div>
            </form>

          </div> <!--//section-top end -->
          <div class="container-fluid">
            <p id="selectedItem"></p>
            <div id="theGrid" style="max-height: 700px;"></div>
          </div>

          <div class="btn-wrap">
          </div>
        </section>
      </div> <!--//tab-contens end-->
    </div> <!--//tab-wrap end-->
  </div> <!--//layout-contents end -->

  <footer style="margin-top: 24px;">
    <p>Copyrightⓒ 0000 corp. All rights reserved.</p>
  </footer>

</th:block>
<th:block layout:fragment="scripts">
  <th:block th:replace="/common/approve_box :: approve_box"></th:block>
  <th:block th:replace="/common/ax5_uploader :: ax5_uploader"></th:block>
  <th:block th:replace="/common/upload_one_image_box :: upload_one_image_box"></th:block>
  <th:block th:replace="/common/popup_select_user_code :: popup_select_user_code"></th:block>

  <script type="text/javascript">

    var theGrid;
    var viewdata;



    $(document).ready(function() {
      // 현재 날짜 설정
      const today = new Date();
      const year = today.getFullYear();
      const month = today.getMonth();

      // 시작일
      const startOfYear = new Date(year, 0, 1);
      const startYearFormatted = `${startOfYear.getFullYear()}-${String(startOfYear.getMonth() + 1).padStart(2, '0')}-${String(startOfYear.getDate()).padStart(2, '0')}`;
      $('#startDate').val(startYearFormatted);

      // 종료일
      const endOfMonth = new Date(year, month + 1, 0);
      const endMonthFormatted = `${endOfMonth.getFullYear()}-${String(endOfMonth.getMonth() + 1).padStart(2, '0')}-${String(endOfMonth.getDate()).padStart(2, '0')}`;
      $('#endDate').val(endMonthFormatted);

    });
    document.readyState === 'complete' ? init() : window.onload = init;
    function init() {
      fetchDynamicGridData();
    }
    function fetchDynamicGridData() {
      const params = {
        startDate: $('#startDate').val(),
        endDate: $('#endDate').val(),
        searchUserNm: $('#searchUserNm').val(),
      };

      // Ajax 통신을 통해 데이터 가져오기
      $.ajax({
        url: '/api/MUserInfo/read', // 기존 API를 사용
        type: 'GET',
        data: params,
        dataType: 'json',
        success: function (response) {
          if (response && response.data && Array.isArray(response.data)) {
            const processedData = processResponseData(response.data);
            renderFlexGrid(processedData);
          } else {
            console.warn('데이터가 없습니다.');
          }
        },
        error: function (xhr, status, error) {
          console.error('데이터를 가져오는 중 오류 발생:', error);
        },
      });
    }

    function processResponseData(data) {
      // 데이터 가공
      const ageGroups = ['20', '30', '40', '50', '60', '70+α']; // 나이대별 그룹
      const gridData = {};

      data.forEach((item) => {
        const region = item.usersido || '기타';
        const district = item.userGU || '알수없음';
        const age = item.ageGroup || '미상';

        if (!gridData[region]) {
          gridData[region] = { districts: {}, regionTotal: 0 };
        }
        if (!gridData[region].districts[district]) {
          gridData[region].districts[district] = { total: 0 };
        }

        gridData[region].districts[district].total += 1;

        // 나이대별 데이터 추가
        if (!gridData[region].districts[district][`age_${age}`]) {
          gridData[region].districts[district][`age_${age}`] = 0;
        }
        gridData[region].districts[district][`age_${age}`] += 1;
        gridData[region].regionTotal += 1;
      });

      // FlexGrid에 적합한 형식으로 변환
      const formattedData = [];
      for (const [region, regionData] of Object.entries(gridData)) {
        for (const [district, districtData] of Object.entries(regionData.districts)) {
          formattedData.push({
            region,
            district,
            ...ageGroups.reduce((acc, age) => {
              acc[`age_${age}`] = districtData[`age_${age}`] || 0;
              return acc;
            }, {}),
            total: districtData.total,
          });
        }
      }

      return formattedData;
    }

    function renderFlexGrid(dynamicData) {
      const ageGroups = ['20', '30', '40', '50', '60', '70+α'];

      if (!theGrid) {
        // FlexGrid 생성
        theGrid = new wijmo.grid.FlexGrid('#theGrid', {
          allowMerging: 'ColumnHeaders',
          autoGenerateColumns: false,
          selectionMode: wijmo.grid.SelectionMode.Row,
          isReadOnly: true,
          columns: [
            { binding: 'region', header: '지역(시)', width: 120, allowMerging: true },
            { binding: 'district', header: '구군', width: 120 },
            ...ageGroups.map((age) => ({
              binding: `age_${age}`,
              header: age,
              width: '*',
              align: 'center',
            })),
            { binding: 'total', header: '합계', width: 100, align: 'center' },
          ],
        });

        // 상위 헤더 병합 및 스타일 설정
        const headerRow = new wijmo.grid.Row();
        headerRow.allowMerging = true;
        theGrid.columnHeaders.rows.splice(0, 0, headerRow);

        const panel = theGrid.columnHeaders;
        panel.setCellData(0, 0, '나이');
        panel.setCellData(0, 1, '지역 및 구군');


        theGrid.formatItem.addHandler((s, e) => {
          if (e.panel === s.columnHeaders && e.range.rowSpan > 1) {
            e.cell.style.textAlign = 'center';
            e.cell.style.verticalAlign = 'middle';
            e.cell.style.backgroundColor = '#d0e1eb';
            e.cell.style.fontWeight = 'bold';
          }
        });
      }
      theGrid.rowHeaders.columns.splice(0, 1);
      new FlexGridContextMenu(theGrid);
      window.downloadFileName = '통계보고서';

      // 데이터 바인딩
      theGrid.itemsSource = dynamicData;
    }




  </script>
</th:block>

</html>