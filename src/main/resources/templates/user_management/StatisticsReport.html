<html layout:decorate="~{layout_page}" xmlns:layout="http://www.w3.org/1999/xhtml">

<meta name="_csrf" content="${_csrf.token}">
<meta name="_csrf_header" content="${_csrf.headerName}">
<style>
    /* ë¶€ëª¨ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
    .div selection-container {
        display: flex;
        gap: 20px; /* ë‘ dl ê°„ì˜ ê°„ê²© */
        align-items: flex-start; /* ë‘ dlì˜ ìœ„ìª½ ì •ë ¬ */
    }

    /* ê° dlì˜ ìŠ¤íƒ€ì¼ */
    .selection-container dl {
        width: 100%; /* ê° dlì˜ ë„ˆë¹„ë¥¼ ë™ì¼í•˜ê²Œ ì„¤ì • */
    }

    dt {
        font-weight: bold;
        margin-bottom: 10px;
    }

    .selection-container srch-box {
        margin-top: 10px;
    }

    /* ë‚´ë¶€ ìš”ì†Œ ê°„ ê°„ê²© ì¡°ì • */
    label, select {
        display: block;
        margin-bottom: 10px;
    }

</style>

<th:block layout:fragment="content">


  <div class="layout-contents">
    <!-- Page Title -->
    <div class="page-title-wrap">
      <div class="left">
        <h2>í†µê³„ë³´ê³ ì„œ</h2>
        <!--                <a title="ë¶ë§ˆí¬" class="bookmark toggle">-->
        <!--                    ë‚´ë©”ë‰´-->
        <!--                </a>-->
      </div>
      <ul class="page-navi">
        <li><img src="/images/icon/ico-nav-home.svg" alt="í™ˆì•„ì´ì½˜"></li>
        <li>íšŒì›ê´€ë¦¬</li>
        <li>í†µê³„ë³´ê³ ì„œ</li>
      </ul>
    </div>
    <div class="tab-wrap">
      <div class="tab-contents">
        <!-- Section -->
        <section class="tab-item" id="tab1" style="height: 850px;">
          <div class="section-top">
            <form id="searchForm">
              <div class="search-wrap">
                <dl>
                  <dt>
                    ë°œê¸‰ ê¸°ê°„<span class="eq">*</span>
                  </dt>
                  <dd>
                    <ul class="date-box">
                      <li>
                        <input class="tac w150 " type="date" id="startDate" name="date_from"/>
                        <label for="startDate" class="hide">ì‹œì‘ì¼</label>
                      </li>
                      <li>
                        <input class="tac w150" type="date" id="endDate" name="date_to"/>
                        <label for="endDate" class="hide">ì¢…ë£Œì¼</label>
                      </li>
                    </ul>
                  </dd>
                </dl>
                <!--<dl>
                  <dt><span class="eq"></span></dt>
                  <dd>
                    <li>
                      <a class="btn btn-delete" title="ê²€ìƒ‰" id="btnSearch1"
                         onclick="">
                        <img src="/images/icon/btn-srch.svg" alt="ê²€ìƒ‰ ì•„ì´ì½˜">
                        ê²€ìƒ‰
                      </a>
                    </li>
                  </dd>
                </dl>-->
                <dl style="display: flex; flex-direction: column; gap: 4px;">
                  <dt>
                    <label for="RowSelect">í–‰ ì„ íƒ<span class="eq"></span></label>
                  </dt>
                  <dd style="display: flex; flex-wrap: wrap; gap: 16px; margin-bottom: 13px;">
                    <div class="form-check" style="display: flex; align-items: center;">
                      <input
                          class="form-check-input"
                          type="radio"
                          name="rowSelect"
                          value="region"
                          id="RowRegion"
                          style="margin-right: 8px;"
                      />
                      <label class="form-check-label" for="RowRegion">ì§€ì—­(ì‹œ)/êµ¬ì¶•ë¬¼</label>
                    </div>
                    <div class="form-check" style="display: flex; align-items: center;">
                      <input
                          class="form-check-input"
                          type="radio"
                          name="rowSelect"
                          value="ageNum"
                          id="ageNum"
                          style="margin-right: 8px;"
                      />
                      <label class="form-check-label" for="ageNum">ë‚˜ì´/êµ¬ì¶•ë¬¼</label>
                    </div>
                  </dd>
                </dl>
                <div id="selection-container" style="display: flex; gap: 20px; margin-bottom: 10px;">
                  <dl style="display: flex; flex-direction: column; gap: 4px;">
                    <dt>
                      <label for="columnSelect">ì—´ ì„ íƒ<span class="eq"></span></label>
                    </dt>
                    <dd style="display: flex; flex-wrap: wrap; gap: 16px; margin-top: -8px;">
                      <div class="form-check region-checkbox" style="display: flex; align-items: center;">
                        <input
                            class="form-check-input"
                            type="checkbox"
                            value="region"
                            id="region"
                            style="margin-right: 8px;"
                        />
                        <label class="form-check-label" for="region">ì§€ì—­(ì‹œ)</label>
                      </div>
                      <div class="form-check" style="display: flex; align-items: center;">
                        <input
                            class="form-check-input"
                            type="checkbox"
                            value="district"
                            id="district"
                            style="margin-right: 8px;"
                        />
                        <label class="form-check-label" for="district">ì§€ì—­(êµ¬êµ°)</label>
                      </div>
                      <div class="form-check" style="display: flex; align-items: center;">
                        <input
                            class="form-check-input"
                            type="checkbox"
                            value="inDatem"
                            id="inDatem"
                            style="margin-right: 8px;"
                        />
                        <!--                    <label class="form-check-label" for="inDatem">ë°œê¸‰ ì¼ì</label>-->
                        <select class="form-check-select" id="inDatemValue">
                          <option value="" disabled selected>ë°œê¸‰ ì¼ìë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                          <option value="Year">ë°œê¸‰ì¼ì (ë…„)</option>
                          <option value="Month">ë°œê¸‰ì¼ì (ë…„, ì›”)</option>
                          <option value="Day">ë°œê¸‰ì¼ì (ë…„, ì›”, ì¼)</option>
                        </select>

                      </div>
                      <div class="form-check" style="display: flex; align-items: center;">
                        <input
                            class="form-check-input"
                            type="checkbox"
                            value="sexYn"
                            id="sexYn"
                            style="margin-right: 8px;"
                        />
                        <label class="form-check-label" for="sexYn">ì„±ë³„</label>
                      </div>
                    </dd>
                  </dl>
                  <dd style="margin-top: 16px;">
                    <li>
                      <a class="btn btn-delete" title="ì ìš©" id="addSheetBtn">
                        <img src="/images/icon/btn-srch.svg" alt="ì ìš© ì•„ì´ì½˜"/>
                        í–‰/ì—´ ì¡°ê±´ì ìš©
                      </a>
                    </li>
                  </dd>
                </div>
              </div>
            </form>
          </div> <!--//section-top end -->
          <div class="container-fluid">
            <p id="selectedItem"></p>
            <!-- ì´ˆê¸°ì—ëŠ” theGrid í‘œì‹œ -->
            <div id="theGrid" style="max-height: 700px; display: block;"></div>
            <div id="theGrid2" style="max-height: 700px; display: none;"></div>
          </div>

          <div class="btn-wrap">
          </div>
        </section>
      </div> <!--//tab-contens end-->
    </div> <!--//tab-wrap end-->
  </div> <!--//layout-contents end -->

  <footer style="margin-top: 24px;">
    <p>Copyrightâ“’ 0000 corp. All rights reserved.</p>
  </footer>

</th:block>
<th:block layout:fragment="scripts">
  <th:block th:replace="/common/approve_box :: approve_box"></th:block>
  <th:block th:replace="/common/ax5_uploader :: ax5_uploader"></th:block>
  <th:block th:replace="/common/upload_one_image_box :: upload_one_image_box"></th:block>
  <th:block th:replace="/common/popup_select_user_code :: popup_select_user_code"></th:block>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.wijmo.com/5.latest/controls/wijmo.grid.sheet.min.js"></script>

  <script type="text/javascript">
    $(document).ready(function () {
      // í˜„ì¬ ë‚ ì§œ ì„¤ì •
      const today = new Date();
      const year = today.getFullYear();
      const month = today.getMonth();

      // ì‹œì‘ì¼
      const startOfYear = new Date(year, 0, 1);
      const startYearFormatted = `${startOfYear.getFullYear()}-${String(startOfYear.getMonth() + 1).padStart(2, '0')}-${String(startOfYear.getDate()).padStart(2, '0')}`;
      $('#startDate').val(startYearFormatted);

      // ì¢…ë£Œì¼
      const endOfMonth = new Date(year, month + 1, 0);
      const endMonthFormatted = `${endOfMonth.getFullYear()}-${String(endOfMonth.getMonth() + 1).padStart(2, '0')}-${String(endOfMonth.getDate()).padStart(2, '0')}`;
      $('#endDate').val(endMonthFormatted);

    });

    function toggleCheckboxVisibility(selected) {
      // ì²´í¬ë°•ìŠ¤ ìš”ì†Œ ì„ íƒ
      const regionCheckbox = document.querySelector('.region-checkbox');
      const districtCheckbox = document.querySelector('#district').parentElement; // êµ¬êµ° ì²´í¬ë°•ìŠ¤ ë¶€ëª¨
      const allCheckboxes = document.querySelectorAll('#selection-container input[type="checkbox"]'); // ëª¨ë“  ì²´í¬ë°•ìŠ¤ ì„ íƒ

      //  "ë°œê¸‰ ì¼ì" ì²´í¬ë°•ìŠ¤ ë° ì½¤ë³´ë°•ìŠ¤ ìš”ì†Œ ì¶”ê°€ ì„ íƒ
      const inDatemCheckbox = document.querySelector('#inDatem');
      const inDatemSelect = document.querySelector('#inDatemValue');

      // ì²´í¬ë°•ìŠ¤ ì´ˆê¸°í™” (ì„ íƒ í•´ì œ)
      allCheckboxes.forEach(checkbox => {
        checkbox.checked = false;
      });

      // "ë°œê¸‰ ì¼ì" ì½¤ë³´ë°•ìŠ¤ ì´ˆê¸°í™” ë° ë¹„í™œì„±í™”
      inDatemCheckbox.checked = false;
      inDatemSelect.selectedIndex = 0;  // ì²« ë²ˆì§¸ ê¸°ë³¸ ì˜µì…˜ ì„ íƒ
      inDatemSelect.disabled = true;    // ì²´í¬ í•´ì œ ì‹œ ë¹„í™œì„±í™”

      if (selected === 'ageNum') {
        // ë‚˜ì´ í´ë¦­ ì‹œ ëª¨ë‘ í‘œì‹œ
        regionCheckbox.style.display = 'flex';
        districtCheckbox.style.display = 'flex';
      } else if (selected === 'region') {
        // ì§€ì—­(ì‹œ) í´ë¦­ ì‹œ ì§€ì—­(ì‹œ) ì²´í¬ë°•ìŠ¤ ìˆ¨ê¸°ê¸°
        regionCheckbox.style.display = 'none';
        districtCheckbox.style.display = 'flex';
      }
    }

    document.getElementById("inDatem").addEventListener("change", function () {
      document.getElementById("inDatemValue").disabled = !this.checked;
    });

    // ì´ˆê¸°í™”: í˜ì´ì§€ ë¡œë“œ ì‹œ ëª¨ë“  ì²´í¬ë°•ìŠ¤ê°€ ë³´ì´ë„ë¡ ì„¤ì •
    document.addEventListener("DOMContentLoaded", function () {
      // ê¸°ë³¸ ë¼ë””ì˜¤ ë²„íŠ¼ ì„ íƒ (ì§€ì—­ ì„ íƒ)
      document.getElementById("RowRegion").checked = true;

      // ê·¸ë¦¬ë“œ ì´ˆê¸°í™” ë° RegionData() ì‹¤í–‰
      toggleGrid('theGrid2');
      RegionData([], true);
      // ì²´í¬ë°•ìŠ¤ í‘œì‹œ ë¡œì§ ì‹¤í–‰
      toggleCheckboxVisibility('region');
    });

    // ë¼ë””ì˜¤ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ì—°ê²°
    document.querySelectorAll('input[name="rowSelect"]').forEach(radio => {
      radio.addEventListener('change', (e) => {
        toggleCheckboxVisibility(e.target.value);
      });
    });

    function toggleGrid(gridToShow) {
      // ëª¨ë“  ê·¸ë¦¬ë“œ ìˆ¨ê¸°ê¸°
      document.getElementById('theGrid').style.display = 'none';
      document.getElementById('theGrid2').style.display = 'none';
      // ì„ íƒí•œ ê·¸ë¦¬ë“œë§Œ í‘œì‹œ
      document.getElementById(gridToShow).style.display = 'block';
      if (gridToShow === 'theGrid') {
        DefaultData(); // ë‚˜ì´ ê·¸ë¦¬ë“œ ë°ì´í„° ì´ˆê¸°í™”
      } else if (gridToShow === 'theGrid2') {
        RegionData(); // ì§€ì—­ ê·¸ë¦¬ë“œ ë°ì´í„° ì´ˆê¸°í™”
      }
    }

    // ë¼ë””ì˜¤ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ì— ì—°ê²°
    document.getElementById('RowRegion').addEventListener('click', function () {
      toggleGrid('theGrid2'); // ì§€ì—­(ì‹œ) ì„ íƒ ì‹œ theGrid2 í‘œì‹œ
      RegionData([], true);
    });

    // ë‚˜ì´/êµ¬ì¶•ë¬¼ ë¼ë””ì˜¤ ë²„ë“ 
    document.getElementById('ageNum').addEventListener('click', function () {
      toggleGrid('theGrid'); // ë‚˜ì´ ì„ íƒ ì‹œ theGrid í‘œì‹œ
      //updateGridColumns([], true);
      DefaultData([], true);
    });

    document.getElementById("RowRegion").checked = true;

    document.readyState === 'complete' ? init() : window.onload = init;
    const columnNames = {
      region: "ì§€ì—­(ì‹œ)",
      district: "ì§€ì—­(êµ¬êµ°)",
      inDatem: "ë“±ë¡ ì¼ì",
      sexYn: "ì„±ë³„"
    };

    function init() {
      RegionData();
    }

    var theGrid2;
    var viewdata2;

    // ì§€ì—­ ì´ë¦„ ë°°ì—´
    const regions = [
      'ì„œìš¸íŠ¹ë³„ì‹œ', 'ë¶€ì‚°ê´‘ì—­ì‹œ', 'ëŒ€êµ¬ê´‘ì—­ì‹œ', 'ì¸ì²œê´‘ì—­ì‹œ', 'ê´‘ì£¼ê´‘ì—­ì‹œ',
      'ëŒ€ì „ê´‘ì—­ì‹œ', 'ìš¸ì‚°ê´‘ì—­ì‹œ', 'ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ', 'ê²½ê¸°ë„', 'ê°•ì›ë„',
      'ì¶©ì²­ë¶ë„', 'ì¶©ì²­ë‚¨ë„', 'ì „ë¼ë¶ë„', 'ì „ë¼ë‚¨ë„', 'ê²½ìƒë¶ë„', 'ê²½ìƒë‚¨ë„', 'ì œì£¼íŠ¹ë³„ìì¹˜ë„'
    ];

    // í•˜ìœ„ í•­ëª© ë°°ì—´
    const subCategories = ['ì•„íŒŒíŠ¸', 'ë¹Œë¼', 'ë‹¨ë…', 'ì˜¤í”¼ìŠ¤', 'ê¸°íƒ€'];

    // ì´ˆê¸° ì»¬ëŸ¼ ë°°ì—´
    const columns = [
      {binding: 'rownum', header: 'NO', width: 70, align: 'center', visible: false},
      {binding: 'inDatem', header: 'ë…„ë„', width: 120, allowMerging: true},
      {binding: 'district', header: 'êµ¬êµ°', width: 120},
      {binding: 'total', header: 'í•©ê³„', width: 100, align: 'center'},
      {binding: 'construction', header: 'êµ¬ì¶•ë¬¼', width: 100},
    ];

    // ì§€ì—­ê³¼ í•˜ìœ„ í•­ëª©ì„ ê¸°ë°˜ìœ¼ë¡œ ì»¬ëŸ¼ ë™ì  ì¶”ê°€
    regions.forEach(region => {
      const regionKey = region.replace(/[^a-zA-Zê°€-í£]/g, '').toLowerCase(); // í‚¤ ìƒì„± (íŠ¹ìˆ˜ë¬¸ì ì œê±°)
      subCategories.forEach(subCategory => {
        const subKey = subCategory.replace(/[^a-zA-Zê°€-í£]/g, '').toLowerCase(); // í•˜ìœ„ í•­ëª© í‚¤ ìƒì„±
        columns.push({
          binding: `${regionKey}_${subKey}`, // ë°ì´í„° ë°”ì¸ë”© í‚¤ (ì˜ˆ: seoul_apartment)
          header: ` ${subCategory}`, // í—¤ë” ì´ë¦„ (ì˜ˆ: " ì•„íŒŒíŠ¸")
          width: 150,
          align: 'center'
        });
      });
    });

    function RegionData(selectedRows = []) {
      let data2 = [];

      // ì„ íƒí•œ ë°œê¸‰ì¼ì
      const inDatemChecked = document.getElementById("inDatem").checked;
      const inDatemValue = document.getElementById("inDatemValue").value;

      const params = {
        startDate: $('#startDate').val(),
        endDate: $('#endDate').val(),
      };

      if (selectedRows.length === 0) {
        params.district = $('#district').val() || ''; // ì§€ì—­(êµ¬êµ°)
        params.inDatem = $('#inDatem').val() || '';   // ë“±ë¡ ì¼ì
      }

      if (inDatemChecked) {
        params.inDatem = inDatemValue; // ì²´í¬ë˜ì–´ ìˆìœ¼ë©´ ì„ íƒëœ ê°’ ì¶”ê°€
      }

      selectedRows.forEach(col => {
        if (col !== 'inDatem') {
          params[col] = $('#' + col).val() || '';
        }
      });
      //console.log("ğŸ“Œ ìµœì¢… ìš”ì²­ íŒŒë¼ë¯¸í„°:", params);

      // Ajax í†µì‹ ì„ í†µí•´ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
      $.ajax({
        url: '/api/report/read2',
        type: 'GET',
        data: params,
        dataType: 'json',
        success: function (response) {
          //console.log("API ì§€ì—­(ì‹œ) ì‘ë‹µ ë°ì´í„°:", response);
          var data_renew = [];
          var cnt = 0;
          if (response && Array.isArray(response.data)) {
            data2 = response.data.map((item, index) => {
              const rowData = {
                rownum: index + 1,
                inDatem: item.inDatem || '',
                district: item.district || '', // êµ¬êµ° ì •ë³´
                region: item.region || '',
                sexYn: item.sexYn || '',
                total: item.total || ''
              };

              let ll_valuesum = 0; // ì´í•© ê³„ì‚° ë³€ìˆ˜

              // ì§€ì—­ë³„ ë°ì´í„° ì¶”ê°€
              regions.forEach(region => {
                subCategories.forEach(subCategory => {
                  const regionKey = region.replace(/[^a-zA-Zê°€-í£]/g, '').toLowerCase();
                  const subKey = subCategory.replace(/[^a-zA-Zê°€-í£]/g, '').toLowerCase();
                  const dataKey = `${regionKey}_${subKey}`;
                  //  0ì´ë©´ ''(ë¹ˆ ë¬¸ìì—´)ë¡œ ë³€í™˜
                  rowData[dataKey] = item[dataKey] === 0 ? '' : item[dataKey] ?? '';

                  ll_valuesum += rowData[dataKey] === '' ? 0 : rowData[dataKey];
                });
              });

              rowData.total = item.total === 0 ? '' : item.total || ''; // ì†Œê³„ë„ ê°™ì€ ë°©ì‹ ì ìš©

              if (ll_valuesum > 0) {
                data_renew.push({
                  index: cnt,
                  data: rowData // ì „ì²´ í–‰ ì¶”ê°€
                });
                cnt++;
              }
              return rowData;
            });
          }
          //console.log("data_renew :", data_renew);
          // ë°ì´í„°ê°€ 15ê°œ ë¯¸ë§Œì¼ ê²½ìš° ë¹ˆ ë°ì´í„° ì¶”ê°€
          while (data2.length < 15) {
            const emptyRow = {rownum: data2.length + 1};
            regions.forEach(region => {
              subCategories.forEach(subCategory => {
                const dataKey = `${region}_${subCategory}`;
                emptyRow[dataKey] = ''; // ë¹ˆ ë°ì´í„° ì¶”ê°€
              });
            });
            emptyRow.total = ''; // ì†Œê³„
            data2.push(emptyRow);
          }
          // ê·¸ë¦¬ë“œì— ë°ì´í„° ì ìš©
          viewdata2 = new wijmo.collections.CollectionView(data2);

          if (!theGrid2) {
            theGrid2 = new wijmo.grid.FlexGrid('#theGrid2', {
              allowMerging: 'ColumnHeaders',
              autoGenerateColumns: false,
              selectionMode: wijmo.grid.SelectionMode.Row,
              isReadOnly: true,
              columns: columns,
              itemsSource: viewdata2,
              allowMerging: 'Cells',
            });

            theGrid2.hostElement.addEventListener('click', function (e) {
              let ht = theGrid2.hitTest(e);

              if (ht.cellType === wijmo.grid.CellType.Cell) {
                let rowIndex = ht.row;
                let colIndex = ht.col;
                let rowData = theGrid2.rows[rowIndex].dataItem;
                let columnHeader = theGrid2.columns[colIndex].header.trim();

                // "í•©ê³„" ì»¬ëŸ¼ í´ë¦­ ì‹œ ì´ë²¤íŠ¸ ì œì™¸
                if (columnHeader === "í•©ê³„") {
                  console.log("'í•©ê³„' ì»¬ëŸ¼ í´ë¦­ì€ ë¬´ì‹œë©ë‹ˆë‹¤.");
                  return; // í´ë¦­ ì´ë²¤íŠ¸ ì¤‘ì§€
                }

                // "í•©ê³„" ì»¬ëŸ¼ ì•ì˜ ë°ì´í„° ì°¾ê¸°
                let totalColumnIndex = theGrid2.columns.findIndex(col => col.binding === 'total');

                let beforeTotalColumns = theGrid2.columns
                  .slice(0, totalColumnIndex)
                  .map(col => ({
                    key: col.binding,
                    name: col.header,
                    value: rowData[col.binding] || ''
                  }));

                // ë³‘í•©ëœ í—¤ë” ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                let mergedHeader = getMergedHeader(colIndex);

                // API ìš”ì²­ì„ ìœ„í•œ íŒŒë¼ë¯¸í„° ìƒì„±
                let params = {
                  region: mergedHeader || '',
                  district: rowData.district || '',
                  yearMonth: rowData.inDatem || '',
                  sexYn: rowData.sexYn || '',
                  selectedColumn: columnHeader,
                  selectedValue: rowData[theGrid2.columns[colIndex].binding] || ''
                };

                console.log("ì—‘ì…€_API ìš”ì²­ ë°ì´í„°:", params);

                // ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ & ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì‹¤í–‰
                fetchCellData(params);
              }
            });

            const headerRow1 = new wijmo.grid.Row();

            headerRow1.allowMerging = true; // ë³‘í•© í—ˆìš©

            theGrid2.columnHeaders.rows.splice(0, 0, headerRow1); // ì²« ë²ˆì§¸ ì¤„ ì¶”ê°€

            const panel = theGrid2.columnHeaders;

            // ì²« ë²ˆì§¸ í—¤ë” ì¤„
            panel.setCellData(0, 2, 'êµ¬ë¶„');
            panel.setCellData(0, 4, 'ì§€ì—­');

            // ì²« ë²ˆì§¸ í—¤ë” ì¤„ êµ¬ì„±
            panel.setCellData(0, 5, 'ì„œìš¸íŠ¹ë³„ì‹œ');
            panel.setCellData(0, 10, 'ë¶€ì‚°ê´‘ì—­ì‹œ');
            panel.setCellData(0, 15, 'ëŒ€êµ¬ê´‘ì—­ì‹œ');
            panel.setCellData(0, 20, 'ì¸ì²œê´‘ì—­ì‹œ');
            panel.setCellData(0, 25, 'ê´‘ì£¼ê´‘ì—­ì‹œ');
            panel.setCellData(0, 30, 'ëŒ€ì „ê´‘ì—­ì‹œ');
            panel.setCellData(0, 35, 'ìš¸ì‚°ê´‘ì—­ì‹œ');
            panel.setCellData(0, 40, 'ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ');
            panel.setCellData(0, 45, 'ê²½ê¸°ë„');
            panel.setCellData(0, 50, 'ê°•ì›ë„');
            panel.setCellData(0, 55, 'ì¶©ì²­ë¶ë„');
            panel.setCellData(0, 60, 'ì¶©ì²­ë‚¨ë„');
            panel.setCellData(0, 65, 'ì „ë¼ë¶ë„');
            panel.setCellData(0, 70, 'ì „ë¼ë‚¨ë„');
            panel.setCellData(0, 75, 'ê²½ìƒë¶ë„');
            panel.setCellData(0, 80, 'ê²½ìƒë‚¨ë„');
            panel.setCellData(0, 85, 'ì œì£¼íŠ¹ë³„ìì¹˜ë„');

            theGrid2.rowHeaders.columns.splice(0, 1);
            // ContextMenu ì¶”ê°€
            new FlexGridContextMenu(theGrid2);
            window.downloadFileName = 'í†µê³„ë³´ê³ ì„œ_ì§€ì—­/êµ¬ì¶•ë¬¼';

          } else {
            theGrid2.itemsSource = viewdata2;
           // console.log('ê·¸ë¦¬ë“œ ë°ì´í„° ë°”ì¸ë”© í›„:', theGrid2.itemsSource);
          }
        },
        error: function () {
          console.error("ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      });
      // ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ì—°ê²°
      document.getElementById('addSheetBtn').onclick = applyChanges2;
    }

    // í´ë¦­í•œ ì»¬ëŸ¼ì˜ ë³‘í•©ëœ ìƒìœ„ í—¤ë” ì°¾ê¸°
    function getMergedHeader(colIndex) {
      const mergedHeaders = {
        5: 'ì„œìš¸íŠ¹ë³„ì‹œ',
        10: 'ë¶€ì‚°ê´‘ì—­ì‹œ',
        15: 'ëŒ€êµ¬ê´‘ì—­ì‹œ',
        20: 'ì¸ì²œê´‘ì—­ì‹œ',
        25: 'ê´‘ì£¼ê´‘ì—­ì‹œ',
        30: 'ëŒ€ì „ê´‘ì—­ì‹œ',
        35: 'ìš¸ì‚°ê´‘ì—­ì‹œ',
        40: 'ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ',
        45: 'ê²½ê¸°ë„',
        50: 'ê°•ì›ë„',
        55: 'ì¶©ì²­ë¶ë„',
        60: 'ì¶©ì²­ë‚¨ë„',
        65: 'ì „ë¼ë¶ë„',
        70: 'ì „ë¼ë‚¨ë„',
        75: 'ê²½ìƒë¶ë„',
        80: 'ê²½ìƒë‚¨ë„',
        85: 'ì œì£¼íŠ¹ë³„ìì¹˜ë„'
      };

      let nearestHeader = '';
      Object.keys(mergedHeaders).forEach(index => {
        if (colIndex >= index) {
          nearestHeader = mergedHeaders[index];
        }
      });

      return nearestHeader;
    }

    function applyChanges2() {
      const selectedRows = Array.from(
        document.querySelectorAll('#selection-container .form-check-input:checked')
      ).map((checkbox) => checkbox.value);
      console.log('ì„ íƒëœ ì—´ë“¤:', selectedRows);
      RegionData(selectedRows);

      updateGridColumns2(selectedRows);
    }

    function updateGridColumns2(selectedRows) {

      if (!theGrid2) {
        console.error('FlexGrid2ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        return;
      }

      // í•­ìƒ ìœ ì§€í•´ì•¼ í•˜ëŠ” ê¸°ë³¸ ì—´ ëª©ë¡
      const alwaysColumns2 = [
        {binding: 'rownum', header: 'NO', width: 70, align: 'center', visible: false},
        {binding: 'construction', header: 'êµ¬ì¶•ë¬¼', width: 100},
        {binding: 'total', header: 'í•©ê³„', width: 100, align: 'center'},
      ];

      // ì§€ì—­ê³¼ í•˜ìœ„ í•­ëª© ì—´ ì¶”ê°€
      regions.forEach(region => {
        const regionKey = region.replace(/[^a-zA-Zê°€-í£]/g, '').toLowerCase(); // í‚¤ ìƒì„±
        subCategories.forEach(subCategory => {
          const subKey = subCategory.replace(/[^a-zA-Zê°€-í£]/g, '').toLowerCase(); // í•˜ìœ„ í•­ëª© í‚¤ ìƒì„±
          alwaysColumns2.push({
            binding: `${regionKey}_${subKey}`, // ë°ì´í„° ë°”ì¸ë”© í‚¤
            header: `${region} ${subCategory}`, // í—¤ë” ì´ë¦„
            width: 150,
            align: 'center'
          });
        });
      });

      // ë™ì ìœ¼ë¡œ ì¶”ê°€í•  ì—´ ìƒì„± (ì²´í¬ë°•ìŠ¤ì—ì„œ ì„ íƒëœ ì—´ë§Œ ì¶”ê°€)
      const dynamicColumns2 = [];
      selectedRows.forEach(binding => {
        dynamicColumns2.push({
          binding: binding,
          header: columnNames[binding] || binding, // ê¸°ë³¸ì ìœ¼ë¡œ bindingì„ headerë¡œ ì„¤ì •
          width: 150,
          align: 'center'
        });
      });

      // ìµœì¢… ìœ ì§€í•´ì•¼ í•  ì—´ ëª©ë¡ (ê¸°ë³¸ ì—´ + ì„ íƒëœ ì—´)
      const allColumns = [...alwaysColumns2, ...dynamicColumns2];

      // í˜„ì¬ FlexGridì— ìˆëŠ” ì—´ ëª©ë¡
      const existingColumns = theGrid2.columns.map(col => col.binding);

      // **1. ê¸°ì¡´ ì—´ ì¤‘ ì œê±° ëŒ€ìƒ í™•ì¸ ë° ì œê±°**
      for (let i = existingColumns.length - 1; i >= 0; i--) {
        const col = existingColumns[i];
        if (!allColumns.some(c => c.binding === col)) {
          // console.log(`Removing column: ${col}`); // ë””ë²„ê¹…ìš© ë¡œê·¸
          theGrid2.columns.removeAt(i);
        }
      }

      // **2. ì¶”ê°€í•´ì•¼ í•  ì—´ ì¶”ê°€**
      allColumns.forEach((col, index) => {
        if (!existingColumns.includes(col.binding)) {
          // console.log(`Adding column: ${col.binding}`); // ë””ë²„ê¹…ìš© ë¡œê·¸

          // rownumì˜ ë‹¤ìŒ ìœ„ì¹˜ë¥¼ ê³„ì‚°
          const rownumIndex = theGrid2.columns.findIndex(c => c.binding === 'rownum');
          const insertionIndex = rownumIndex !== -1 ? rownumIndex + 1 : 0; // rownumì´ ì—†ìœ¼ë©´ ë§¨ ì•ì— ì¶”ê°€

          theGrid2.columns.splice(insertionIndex, 0, new wijmo.grid.Column({
            binding: col.binding,
            header: col.header || col.binding, // headerê°€ ì—†ìœ¼ë©´ binding ì‚¬ìš©
            width: col.width || 100,
            align: col.align || 'center',
            visible: col.visible !== undefined ? col.visible : true,
            allowMerging: col.allowMerging || false
          }));
        }
      });

      //console.log('theGrid2 ì—…ë°ì´íŠ¸:', theGrid2.columns.map(col => col.binding));
    }

    function fetchCellData(params) {
      $.ajax({
        url: '/api/report/getUserInfo', // ì„œë²„ API ì—”ë“œí¬ì¸íŠ¸
        type: 'GET',
        data: params,
        success: function (response) {
          console.log("âœ… API ì‘ë‹µ ë°ì´í„°:", response);

          if (!response || !Array.isArray(response) || response.length === 0) {
            Alert.alert('',"ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
          }

          // ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì‹¤í–‰
          downloadExcel(response, params);
        },
        error: function () {
          console.error("âŒ ì…€ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
          Alert.alert('',"ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      });
    }

    // ì—‘ì…€ ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜ (ê¸°ì¡´ ì½”ë“œ ìœ ì§€)
    function downloadExcel(data, params) {
      if (!Array.isArray(data)) {
        console.error("ë°ì´í„°ê°€ ë°°ì—´ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤:", data);
        return;
      }

      // í—¤ë” ìƒì„± (ì²« ë²ˆì§¸ ê°ì²´ì˜ í‚¤ ì‚¬ìš©)
      const headers = Object.keys(data[0]);

      // ë°ì´í„° ìƒì„± (ë°°ì—´ì˜ ê° ê°ì²´ ê°’ì„ 2ì°¨ì› ë°°ì—´ë¡œ ë³€í™˜)
      const worksheetData = [headers]; // ì²« ë²ˆì§¸ í–‰ì— í—¤ë” ì¶”ê°€
      data.forEach(item => {
        worksheetData.push(Object.values(item));
      });

      // SheetJSë¥¼ ì‚¬ìš©í•˜ì—¬ ì›Œí¬ì‹œíŠ¸ ìƒì„±
      const ws = XLSX.utils.aoa_to_sheet(worksheetData);

      // ì›Œí¬ë¶ ìƒì„± ë° ì›Œí¬ì‹œíŠ¸ ì¶”ê°€
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "í†µê³„ë³´ê³ ì„œ");

      // í˜„ì¬ ë‚ ì§œ ê°€ì ¸ì˜¤ê¸°
      const now = new Date();
      const formattedDate =
        now.getFullYear() +
        "-" +
        String(now.getMonth() + 1).padStart(2, "0") +
        "-" +
        String(now.getDate()).padStart(2, "0");

      // íŒŒì¼ ì´ë¦„ ìƒì„± (ê°’ì´ ì—†ì„ ê²½ìš° 'N/A' ì²˜ë¦¬)
      const region = params.region || '';
      const district = params.district || '';
      const yearMonth = params.yearMonth || '';
      const sexYn = params.sexYn || '';
      const selectedColumn = params.selectedColumn || '';
      const ageGroup = params.ageGroup || '';

      const excelFileName = `í†µê³„ë³´ê³ ì„œ_${region}_${district}_${ageGroup}_${yearMonth}_${sexYn}_${selectedColumn}_${formattedDate}.xlsx`;

      console.log("ë‹¤ìš´ë¡œë“œ íŒŒì¼ëª…:", excelFileName); // íŒŒì¼ëª… í™•ì¸

      XLSX.writeFile(wb, excelFileName);
    }

    //ì§€ì—­(ì‹œ)/êµ¬ì¶•ë¬¼ ë ################################################

    var theGrid;
    var viewdata;

    // ê¸°ë³¸ ì»¬ëŸ¼ ì •ì˜
    const columns2 = [
      {binding: 'rownum', header: 'NO', width: 70, align: 'center', visible: false},
      {binding: 'inDatem', header: 'ë°œê¸‰ì¼ì', width: 120, allowMerging: true},
      {binding: 'region', header: 'ì§€ì—­(ì‹œ)', width: 100, allowMerging: true},
      {binding: 'district', header: 'êµ¬êµ°', width: 120},
      {binding: 'total', header: 'í•©ê³„', width: 100, align: 'center'},
    ];

    const ageGroups = ["20ëŒ€ ì´í•˜", "20ëŒ€", "30ëŒ€", "40ëŒ€", "50ëŒ€", "60ëŒ€", "70ëŒ€ ì´ìƒ"];


    // ë‚˜ì´ë³„ & êµ¬ì¶•ë¬¼ë³„ ì»¬ëŸ¼ ë™ì  ì¶”ê°€
    ageGroups.forEach(age => {
      const ageKey = age.replace(/[^0-9]/g, ''); // ë‚˜ì´ ìˆ«ìë§Œ ì¶”ì¶œ (ex. "70ëŒ€ ì´ìƒ" â†’ "70")
      subCategories.forEach(type => {
        columns2.push({
          binding: `age_${ageKey}_${type}`,  // ë°”ì¸ë”© í‚¤ ì˜ˆ: "age_30_ì•„íŒŒíŠ¸"
          header: `${type}`,         // í—¤ë” ì˜ˆ: "ì•„íŒŒíŠ¸"
          width: 100,
          align: 'center'
        });
      });
    });

    function DefaultData(selectedRows = []) {
      let data = [];

      // ì„ íƒí•œ ë°œê¸‰ì¼ì
      const inDatemChecked = document.getElementById("inDatem").checked;
      const inDatemValue = document.getElementById("inDatemValue").value;

      const params = {
        startDate: $('#startDate').val(),
        endDate: $('#endDate').val(),
      };

      if (selectedRows.length === 0) {
        params.district = $('#district').val() || '';
        params.inDatem = $('#inDatem').val() || '';
        params.region = $('#region').val() || '';
      }

      if (inDatemChecked) {
        params.inDatem = inDatemValue;
      }

      selectedRows.forEach(col => {
        if (col !== 'inDatem') {
          params[col] = $('#' + col).val() || '';
        }
      });

      //console.log("ìµœì¢… ìš”ì²­ íŒŒë¼ë¯¸í„°:", params);

      // Ajax ìš”ì²­
      $.ajax({
        url: '/api/report/read',
        type: 'GET',
        data: params,
        traditional: true,
        dataType: 'json',
        success: function (response) {
          //console.log("API ì‘ë‹µ ë°ì´í„°:", response);
          var data_renew = [];
          var cnt = 0;

          if (response && Array.isArray(response.data)) {
            data = response.data.map((item, index) => {
              const rowData2 = {
                rownum: index + 1,
                inDatem: item.inDatem || '',
                district: item.district || '',
                region: item.region || '',
                sexYn: item.sexYn || '',
                total: item.total || ''
              };

              let valueSum = 0; // ì´í•© ê³„ì‚° ë³€ìˆ˜

              // ë‚˜ì´ë³„ & êµ¬ì¶•ë¬¼ë³„ ë°ì´í„° ë™ì  ë§¤í•‘
              ageGroups.forEach(age => {
                const ageKey = age.replace(/[^0-9]/g, ''); // "70ëŒ€ ì´ìƒ" â†’ "70"
                subCategories.forEach(type => {
                  const key = `age_${ageKey}_${type}`;
                  rowData2[key] = item[key] === 0 ? '' : item[key] ?? ''; // 0ì´ë©´ ë¹ˆ ë¬¸ìì—´
                  valueSum += rowData2[key] === '' ? 0 : rowData2[key]; // ì´í•© ê³„ì‚°
                });
              });

              if (valueSum > 0) {
                data_renew.push({
                  index: cnt,
                  data: rowData2
                });
                cnt++;
              }
              return rowData2;
            });
          }

          // ë°ì´í„°ê°€ 15ê°œ ë¯¸ë§Œì¼ ê²½ìš° ë¹ˆ ë°ì´í„° ì¶”ê°€
          while (data.length < 15) {
            const emptyRow = {rownum: data.length + 1};
            ageGroups.forEach(age => {
              const ageKey = age.replace(/[^0-9]/g, '');
              subCategories.forEach(type => {
                const key = `age_${ageKey}_${type}`;
                emptyRow[key] = '';
              });
            });
            emptyRow.total = '';
            data.push(emptyRow);
          }

          //console.log('ìµœì¢… ì²˜ë¦¬ëœ ë°ì´í„°:', data);

          // ê·¸ë¦¬ë“œì— ë°ì´í„° ì ìš©
          viewdata = new wijmo.collections.CollectionView(data);

          if (!theGrid) {
            theGrid = new wijmo.grid.FlexGrid('#theGrid', {
              allowMerging: 'ColumnHeaders',
              autoGenerateColumns: false,
              selectionMode: wijmo.grid.SelectionMode.Row,
              isReadOnly: true,
              columns: columns2,
              itemsSource: viewdata,
              allowMerging: 'Cells',
            });

            theGrid.hostElement.addEventListener('click', function (e) {
              let ht = theGrid.hitTest(e);

              if (ht.cellType === wijmo.grid.CellType.Cell) {
                let rowIndex = ht.row;
                let colIndex = ht.col;
                let rowData = theGrid.rows[rowIndex].dataItem;
                let columnHeader = theGrid.columns[colIndex].header.trim();

                // "í•©ê³„" ì»¬ëŸ¼ í´ë¦­ ì‹œ ì´ë²¤íŠ¸ ì œì™¸
                if (columnHeader === "í•©ê³„") {
                  console.log("'í•©ê³„' ì»¬ëŸ¼ í´ë¦­ì€ ë¬´ì‹œë©ë‹ˆë‹¤.");
                  return;
                }

                // ì„ íƒí•œ ì…€ì˜ "ë‚˜ì´" í—¤ë” ê°€ì ¸ì˜¤ê¸°
                let mergedHeader = getMergedHeader2(colIndex); // "30ëŒ€", "40ëŒ€" ë“± ë°˜í™˜

                // API ìš”ì²­ì„ ìœ„í•œ íŒŒë¼ë¯¸í„° ìƒì„±
                let params = {
                  region: rowData.region || '',
                  district: rowData.district || '',
                  yearMonth: rowData.inDatem || '',
                  sexYn: rowData.sexYn || '',
                  ageGroup: mergedHeader, // ë‚˜ì´ ê·¸ë£¹ ì¶”ê°€
                  selectedColumn: columnHeader, // ì„ íƒí•œ ì—´
                  selectedValue: rowData[theGrid.columns[colIndex].binding] || ''
                };

                console.log("ì—‘ì…€_API ìš”ì²­ ë°ì´í„°:", params);

                // ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ & ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì‹¤í–‰
                fetchCellData(params);
              }
            });

            const headerRow1 = new wijmo.grid.Row();

            headerRow1.allowMerging = true; // ë³‘í•© í—ˆìš©

            theGrid.columnHeaders.rows.splice(0, 0, headerRow1); // ì²« ë²ˆì§¸ ì¤„ ì¶”ê°€

            const panel = theGrid.columnHeaders;

            // ì²« ë²ˆì§¸ í—¤ë” ì¤„
            panel.setCellData(0, 1, 'êµ¬ë¶„');
            panel.setCellData(0, 4, 'ë‚˜ì´');

            // ë‘ ë²ˆì§¸ í—¤ë” ì¤„
            panel.setCellData(0, 5, '20ëŒ€ ì´í•˜');
            panel.setCellData(0, 10, '20ëŒ€');
            panel.setCellData(0, 15, '30ëŒ€');
            panel.setCellData(0, 20, '40ëŒ€');
            panel.setCellData(0, 25, '50ëŒ€');
            panel.setCellData(0, 30, '60ëŒ€');
            panel.setCellData(0, 35, '70ëŒ€ ì´ìƒ');

            theGrid.rowHeaders.columns.splice(0, 1);
            // ContextMenu ì¶”ê°€
            new FlexGridContextMenu(theGrid);
            window.downloadFileName = 'í†µê³„ë³´ê³ ì„œ_ë‚˜ì´';

          } else {
            theGrid.itemsSource = viewdata;
           // console.log('ê·¸ë¦¬ë“œ ë°ì´í„° ë°”ì¸ë”© í›„:', theGrid.itemsSource);
          }
        },
        error: function () {
          console.error("ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      });

      // ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ì—°ê²°
      document.getElementById('addSheetBtn').onclick = applyChanges;
    }
    // ì„ íƒí•œ ì—´(colIndex)ì´ ì†í•œ "ë‚˜ì´" í—¤ë” ê°€ì ¸ì˜¤ê¸°
    function getMergedHeader2(colIndex) {
      // í˜„ì¬ ì„ íƒí•œ ì—´ì˜ í—¤ë” ê°€ì ¸ì˜¤ê¸°
      let columnHeader = theGrid.columns[colIndex].header.trim();

      // ì—°ë ¹ëŒ€ í—¤ë” ë¦¬ìŠ¤íŠ¸ (ì˜ˆ: "20ëŒ€ ì´í•˜", "20ëŒ€", ...)
      const ageGroups = ["20ëŒ€ ì´í•˜", "20ëŒ€", "30ëŒ€", "40ëŒ€", "50ëŒ€", "60ëŒ€", "70ëŒ€ ì´ìƒ"];

      // í˜„ì¬ ì—´(`colIndex`)ì´ ì†í•œ ì—°ë ¹ëŒ€ ì°¾ê¸°
      let matchedAgeGroup = ageGroups.find(age => columnHeader.includes(age));

      // í˜„ì¬ í—¤ë”ì— ì—°ë ¹ëŒ€ê°€ ì§ì ‘ í¬í•¨ë˜ì§€ ì•Šì•˜ë‹¤ë©´, ë¶€ëª¨ í—¤ë”ë¥¼ ì°¾ì•„ì•¼ í•¨.
      if (!matchedAgeGroup) {
        let columnPanel = theGrid.columnHeaders;
        let headerRowIndex = 0; // ë³‘í•©ëœ í—¤ë”ê°€ ìˆëŠ” ì²« ë²ˆì§¸ í–‰

        try {
          matchedAgeGroup = columnPanel.getCellData(headerRowIndex, colIndex).trim();
        } catch (e) {
          console.error("âš ï¸ ì—°ë ¹ëŒ€ í—¤ë”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ:", e);
          matchedAgeGroup = ""; // ì—ëŸ¬ ë°œìƒ ì‹œ ë¹ˆ ë¬¸ìì—´ ë°˜í™˜
        }
      }

      // ê²°ê³¼ ë°˜í™˜ (ì—°ë ¹ëŒ€ê°€ ì—†ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´ ë°˜í™˜)
      return ageGroups.includes(matchedAgeGroup) ? matchedAgeGroup : "";
    }

    function applyChanges() {
      const selectedRows = Array.from(
        document.querySelectorAll('#selection-container .form-check-input:checked')
      ).map((checkbox) => checkbox.value);
     // console.log('ì„ íƒëœ ì—´ë“¤:', selectedRows);
      DefaultData(selectedRows);

      updateGridColumns(selectedRows);
    }

    function updateGridColumns(selectedRows) {
      if (!theGrid) {
        console.error('FlexGridê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        return;
      }

      // í•­ìƒ ìœ ì§€í•´ì•¼ í•˜ëŠ” ê¸°ë³¸ ì—´ ëª©ë¡
      const alwaysColumns = [
        {binding: 'rownum', header: 'NO', width: 70, align: 'center', visible: false},
        {binding: 'total', header: 'í•©ê³„', width: 100, align: 'center'},
      ];

      // ì„ íƒëœ ì—´ì„ ë™ì ìœ¼ë¡œ ì¶”ê°€í•  ëª©ë¡
      let dynamicColumns = selectedRows.map(binding => ({
        binding: binding,
        header: columnNames[binding] || binding, // ê¸°ë³¸ì ìœ¼ë¡œ bindingì„ headerë¡œ ì„¤ì •
        width: 150,
        align: 'center'
      }));

      // ğŸ›  ë‚˜ì´ë³„ & êµ¬ì¶•ë¬¼ë³„ ì»¬ëŸ¼ ë™ì  ì¶”ê°€
      ageGroups.forEach(age => {
        const ageKey = age.replace(/[^0-9]/g, ''); // ìˆ«ìë§Œ ì¶”ì¶œ (ì˜ˆ: "70ëŒ€ ì´ìƒ" â†’ "70")

        subCategories.forEach(type => {
          const key = `age_${ageKey}_${type}`;
          dynamicColumns.push({
            binding: key,
            header: `${age} - ${type}`, // ì˜ˆ: "30ëŒ€ - ì•„íŒŒíŠ¸"
            width: 100,
            align: 'center'
          });
        });
      });

      // ìœ ì§€í•´ì•¼ í•  ëª¨ë“  ì—´ (ê¸°ë³¸ ì—´ + ì„ íƒëœ ì—´)
      const allSelectedColumns = [...alwaysColumns, ...dynamicColumns];

      // í˜„ì¬ FlexGridì— ìˆëŠ” ì—´ ëª©ë¡
      const existingColumns2 = theGrid.columns.map(col => col.binding);

      // **1. ê¸°ì¡´ ì—´ ì¤‘ ì œê±° ëŒ€ìƒ í™•ì¸ ë° ì œê±°**
      for (let i = existingColumns2.length - 1; i >= 0; i--) {
        const col = existingColumns2[i];
        if (!allSelectedColumns.some(c => c.binding === col)) { // ìœ ì§€í•´ì•¼ í•  ì—´ ëª©ë¡ì— í¬í•¨ë˜ì§€ ì•Šìœ¼ë©´ ì œê±°
          theGrid.columns.removeAt(i);
        }
      }

      // **2. ì¶”ê°€í•´ì•¼ í•  ì—´ ì¶”ê°€**
      let insertionIndex = existingColumns2.indexOf('rownum') + 1;
      dynamicColumns.forEach(col => {
        if (!existingColumns2.includes(col.binding)) {
          theGrid.columns.splice(insertionIndex, 0, new wijmo.grid.Column({
            binding: col.binding,
            header: col.header,
            width: col.width,
            align: col.align,
          }));
          insertionIndex++; // ë‹¤ìŒ ì—´ì€ ë°”ë¡œ ë’¤ì— ì¶”ê°€ë˜ë„ë¡ ì¸ë±ìŠ¤ ì¦ê°€
        }
      });

     // console.log('ê·¸ë¦¬ë“œ ì—…ë°ì´íŠ¸ ì™„ë£Œ:', theGrid.columns.map(col => col.binding));
    }
  </script>
</th:block>

</html>