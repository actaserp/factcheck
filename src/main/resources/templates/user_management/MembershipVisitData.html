<html layout:decorate="~{layout_page}" xmlns:layout="http://www.w3.org/1999/xhtml">
<style>
    .container-fluid {
        padding: 20px;
    }

    .chartModal {
        display: none; /* 기본적으로 숨겨짐 */
        position: fixed;
        z-index: 10000; /* z-index 값을 높게 설정하여 다른 요소보다 위에 오도록 함 */
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5); /* 배경을 반투명하게 설정 */
        overflow: auto;
    }

    .modal-content {
        position: absolute; /* absolute로 설정하여 화면 중앙에 배치 */
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%); /* 화면 중앙 정렬 */
        background-color: #fff;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        max-width: 600px;
        border-radius: 8px;
    }

    .chart-container {
        position: relative; /* 부모 요소에 위치 고정 */
        width: 100%; /* 원하는 너비 */
        height: 250px; /* 고정된 높이 */
        overflow-y: auto; /* 세로 스크롤 활성화 */
        overflow-x: hidden; /* 가로 스크롤 비활성화 */
        border: 1px solid #ccc; /* 테두리 추가 (선택 사항) */
        padding: 10px; /* 여백 추가 (선택 사항) */
    }

    #chartControls {
        display: flex;
        gap: 5px; /* 버튼 간격 */
    }

    #chartControls button {
        padding: 5px 10px;
        font-size: 12px;
        border: 1px solid #ccc;
        background-color: #f5f5f5;
        cursor: pointer;
        border-radius: 3px;
    }

    #chartControls button:hover {
        background-color: #ddd;
    }

</style>
<th:block layout:fragment="content">
    <div class="layout-contents">
        <!-- Page Title -->
        <div class="page-title-wrap">
            <div class="left">
                <h2>회원 방문 통계</h2>
                <!--<a title="북마크" class="bookmark toggle">
                    내메뉴
                </a>-->
            </div>
            <ul class="page-navi">
                <li><img src="/images/icon/ico-nav-home.svg" alt="홈아이콘"></li>
                <li>회원 관리</li>
                <li>회원 방문 통계</li>
            </ul>
        </div>
        <!-- Select -->
        <div class="tab-contents">
            <section class="tab-item" style="height: 800px;  overflow: auto; ">
                <div class="section-top">
                    <div class="search-wrap">
                        <dl>
                            <dt>
                                조회기간<span class="eq">*</span>
                            </dt>
                            <dd>
                                <ul class="date-box">
                                    <li>
                                        <input type="date" id="startDate" name="startDate">
                                        <label for="startDate" class="hide">시작일</label>
                                    </li>
                                    <li>
                                        <input type="date" id="endDate" name="endDate">
                                        <label for="endDate" class="hide">종료일</label>
                                    </li>
                                </ul>
                            </dd>
                        </dl>
                        <!--<dl>
                            <dt>
                                <label for="searchTitle">
                                    회원명<span class="eq">*</span>
                                </label>
                            </dt>
                            <dd>
                                <div class="srch-box">
                                    <input type="text" id="searchTitle" name="searchTitle" class="input-srch"
                                           placeholder="회원명" style="border-radius: 5px;">
                                </div>
                            </dd>
                        </dl>-->
                        <dl>
                            <dt>&nbsp;</dt>
                            <dd>
                                <li>
                                    <a class="btn btn-delete" title="검색" id="searchButton" onclick="init()">
                                        <!--                                        class 쓰이는 곳 찾고 없으면 클래스명 수정하기-->
                                        <img src="/images/icon/btn-srch.svg" alt="검색 아이콘">
                                        검색
                                    </a>
                                </li>
                            </dd>
                        </dl>
                    </div>
                </div>
                <div class="container-fluid" style="display: flex; align-items: center; justify-content: space-between;">
                    <!-- 첫 번째 섹션 -->
                    <section class="col wp50" style="flex: 1; margin-right: 10px; height:650px; position: relative;">
                        <div>
                            <!-- 차트 -->
                            <canvas id="chart1" style="width: 100%; height:250px;"></canvas>
                            <!-- 그리드 -->
                            <div id="theGrid1" style="display: none; width: 100%; height: 250px;"></div>

                            <!-- 탭 링크 -->
                            <ul class="tab-links-sub" style="position: absolute; top:10px; right: 10px;">
                                <li>
                                    <a href="#tab1-chart1" title="통계" onclick="loadStatsData1('chart1', 'theGrid1')">통계</a>
                                </li>
                                <li>
                                    <a href="#tab2-theGrid1" title="현황" onclick="showGrid1('chart1', 'theGrid1')">현황</a>
                                </li>
                            </ul>

                            <!-- 확대 버튼 -->
                            <span class="material-symbols-outlined"
                                  style="position: absolute;top:70px; right: 10px;cursor: pointer;z-index: 10;color: rgb(179, 179, 179);"
                                  onclick="openModal('chart1')">zoom_out_map</span>
                        </div>
                    </section>

                    <!-- 두 번째 섹션 -->
                    <section class="col wp50" style="flex: 1; margin-right: 10px; height:650px; position: relative;">
                        <div>
                            <!-- 차트 -->
                            <canvas id="chart2" style="width: 100%; height:250px;"></canvas>
                            <!-- 그리드 -->
                            <div id="theGrid2" style="display: none; width: 100%; height: 250px;"></div>

                            <!-- 탭 링크 -->
                            <ul class="tab-links-sub" style="position: absolute; top:10px; right: 10px;">
                                <li>
                                    <a href="#tab1-chart2" title="통계" onclick="loadStatsData2('chart2', 'theGrid2')">통계</a>
                                </li>
                                <li>
                                    <a href="#tab2-theGrid2" title="현황" onclick="showGrid2('chart2', 'theGrid2')">현황</a>
                                </li>
                            </ul>

                            <!-- 확대 버튼 -->
                            <span class="material-symbols-outlined"
                                  style="position: absolute;top:70px; right: 10px;cursor: pointer;z-index: 10;color: rgb(179, 179, 179);"
                                  onclick="openModal('chart2')">zoom_out_map</span>
                        </div>
                    </section>
                </div>

            </section>
        </div> <!--//tab-wrap end-->
    </div> <!--//layout-contents end -->
    <footer>
        <p>Copyrightⓒ factCheck corp. All rights reserved.</p>
    </footer>
    <div id="chartModal" class="modal" style="opacity:100">
        <div class="modal-content">
            <span class="close">&times;</span>
            <canvas id="modalChartHolder" style="width: 1250px; height: 490px; display: block; box-sizing: border-box;"
                    width="1250" height="490"></canvas>
        </div>
    </div>

</th:block>
<th:block layout:fragment="scripts">
    <th:block th:replace="/common/columns_setting :: columns_setting"></th:block>
   <!-- <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>-->
    <script type="text/javascript">

        $(document).ready(function() {
            // 현재 날짜 설정
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth();

            // 시작일
            const startOfYear = new Date(year, 0, 1);
            const startYearFormatted = `${startOfYear.getFullYear()}-${String(startOfYear.getMonth() + 1).padStart(2, '0')}-${String(startOfYear.getDate()).padStart(2, '0')}`;
            $('#startDate').val(startYearFormatted);

            // 종료일
            const endOfMonth = new Date(year, month + 1, 0);
            const endMonthFormatted = `${endOfMonth.getFullYear()}-${String(endOfMonth.getMonth() + 1).padStart(2, '0')}-${String(endOfMonth.getDate()).padStart(2, '0')}`;
            $('#endDate').val(endMonthFormatted);

            init();

        });


        function init() {
            loadStatsData1();
            loadStatsData2();
        }

        // 모달 열기 함수
        function openModal(chartId) {
            const modal = document.getElementById('chartModal');
            const modalCanvas = document.getElementById('modalChartHolder'); // 모달 캔버스
            const chartElement = document.getElementById(chartId); // 원본 차트 캔버스

            if (!chartElement) {
                console.error(`차트 요소를 찾을 수 없습니다: ${chartId}`);
                return;
            }

            const chart = Chart.getChart(chartElement); // 차트 인스턴스 가져오기
            if (!chart) {
                console.error(`해당 차트를 찾을 수 없습니다: ${chartId}`);
                return;
            }

            // 모달 보이기
            modal.style.display = 'block';

            // 기존 모달 차트 제거
            if (window.modalChartInstance) {
                window.modalChartInstance.destroy(); // 기존 차트 삭제
                window.modalChartInstance = null; // 초기화
            }

            // 모달 차트 생성
            const modalChartHolder = modalCanvas.getContext('2d');
            window.modalChartInstance = new Chart(modalChartHolder, {
                type: chart.config.type,
                data: JSON.parse(JSON.stringify(chart.data)), // 데이터 복사
                options: {
                    ...chart.options,
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        // 모달 닫기 함수
        function closeModal() {
            const modal = document.getElementById('chartModal');
            modal.style.display = 'none';

            // 모달 차트 제거
            if (window.modalChartInstance) {
                window.modalChartInstance.destroy();
                window.modalChartInstance = null; // 인스턴스 초기화
            }
        }

        // 모달 외부 클릭으로 닫기 이벤트
        window.addEventListener('click', (event) => {
            const modal = document.getElementById('chartModal');
            if (event.target === modal) {
                closeModal();
            }
        });

        // 닫기 버튼 클릭 이벤트
        document.querySelector('.close').addEventListener('click', closeModal);

        const ctx1 = document.getElementById('chart1').getContext('2d');
        const ctx2 = document.getElementById('chart2').getContext('2d');

        // 첫 번째 차트 생성
        let chart1 = new Chart(ctx1, {
            type: 'bar',
            data: {
                labels: Array.from({ length: 12 }, (_, i) => `${i + 1}월`),
                datasets: [{
                    label: `데이터`,
                    data: Array.from({ length: 12 }, () => Math.floor(Math.random() * 200)), // 초기값
                    backgroundColor: 'rgba(54, 162, 235, 0.5)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1,
                }],
            },
            options: {
                plugins: {
                    legend: {
                        display: false, // 범례 숨기기
                    },
                    title: {
                        display: true,
                        text: '회원 등록',
                        font: {
                            size: 24, // 글씨 크기 (기본값: 12)
                        },
                        align: 'start', //글씨 위치
                    },
                },
                responsive: true,
                scales: {
                    y: {
                        min: 0, // Y축 최소값
                        max: 300, // Y축 최대값
                        ticks: {
                            stepSize: 20, // 10 단위로 눈금 표시
                        },
                    },
                },
            },
        });

        // 데이터 로드 및 차트 업데이트
        function loadStatsData1() {
            // 입력된 날짜를 가져옵니다.
            const params = {
                startDate: $('#startDate').val(),
                endDate: $('#endDate').val(),
            };

            $.ajax({
                url: '/api/userStatistics/chart1', // API 엔드포인트
                type: 'GET',
                data: params, // GET 요청의 파라미터
                async: false, // 동기 요청
                success: function (response) {
                    // 응답이 올바르게 도착했는지 확인
                    if (response && response.success && response.data) {
                        // 서버에서 받은 데이터를 차트에 반영
                        chart1.data.labels = response.data.labels || chart1.data.labels; // X축 레이블
                        chart1.data.datasets[0].data = response.data.values || []; // Y축 데이터
                        chart1.update(); // 차트 업데이트
                    } else {
                        console.error("서버에서 유효한 데이터를 받지 못했습니다.");
                    }
                },
                error: function (xhr, status, error) {
                    console.error("데이터를 가져오는 중 오류가 발생했습니다.", error);
                }
            });
        }

        // 두 번째 차트 생성
        let chart2 = new Chart(ctx2, {
            type: 'bar',
            data: {
                labels: Array.from({ length: 12 }, (_, i) => `${i + 1}월`),
                datasets: [{
                    label: '통계 데이터',
                    data: Array.from({ length: 12 }, () => Math.floor(Math.random() * 200)), // 초기값
                    backgroundColor: 'rgba(255, 99, 132, 0.5)',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 1,
                }],
            },
            options: {
                plugins: {
                    legend: {
                        display: false, // 범례 숨기기
                    },
                    title: {
                        display: true,
                        text: '조회 건수',
                        font: {
                            size: 24, // 글씨 크기 (기본값: 12)
                        },
                        align: 'start', //글씨 위치
                    },
                },
                responsive: true,
                scales: {
                    y: {
                        min: 0, // Y축 최소값
                        max: 100, // Y축 최대값
                        ticks: {
                            stepSize: 10, // 10 단위로 눈금 표시
                        },
                    },
                },
            },
        });

        // 두 번째 차트 업데이트
        function loadStatsData2() {
            // 입력된 날짜를 가져옵니다.
            const params = {
                startDate: $('#startDate').val(),
                endDate: $('#endDate').val(),
            };

            $.ajax({
                url: '/api/userStatistics/chart2', // API 엔드포인트
                type: 'GET',
                data: params, // GET 요청의 파라미터
                async: false, // 동기 요청
                success: function (response) {
                    // 응답이 올바르게 도착했는지 확인
                    if (response && response.success && response.data) {
                        // 서버에서 받은 데이터를 차트에 반영
                        chart2.data.labels = response.data.labels || chart2.data.labels; // X축 레이블
                        chart2.data.datasets[0].data = response.data.values || []; // Y축 데이터
                        chart2.update(); // 차트 업데이트
                    } else {
                        console.error("서버에서 유효한 데이터를 받지 못했습니다.");
                    }
                },
                error: function (xhr, status, error) {
                    console.error("데이터를 가져오는 중 오류가 발생했습니다.", error);
                }
            });
        }

        function showGrid1(){

            let data = [ ];
            const params = {
                startDate: $('#startDate').val(),
                endDate: $('#endDate').val(),
                searchUserNm: $('#searchUserNm').val()
            };

            // 서버에서 데이터 가져오기
            $.ajax({
                url: '/api/userStatistics/read',
                type: 'GET',
                data: params,
                async: false,
                success: function (response) {
                    // 응답이 올바르게 도착했고, data 속성이 배열인지 확인
                    if (response && Array.isArray(response.data)) {
                        data = response.data.map((item, index) => ({
                            rownum: index + 1,
                            USERID: item.USERID ||'',
                            userNm: item.userNm ||'',
                            indatem :item.indatem || '' ,
                            inDateTm:item.inDateTm || '',
                            userAddr: item.userAddr || '',
                            InquiryCount: item.InquiryCount ||'',
                            remark:item.remark || '',
                        }));
                    }
                },
                error: function () {
                    console.error("데이터를 가져오는 중 오류가 발생했습니다.");
                }
            });

            while (data.length < 15) {
                data.push({
                    rownum: data.length + 1,
                    USERID:'',
                    userNm: '',
                    indatem: '',
                    userAddr: '',
                    InquiryCount: '',
                    remark: '',
                });
            }

            const viewdata = new wijmo.collections.CollectionView(data);

            if (!theGrid1) {
                theGrid1 = new wijmo.grid.FlexGrid('#theGrid1', {
                    autoGenerateColumns: false,
                    showMarquee: true,
                    isReadOnly: true,
                    columns: [
                        { binding: 'rownum', header: '순번', width: 70, align: 'center' },
                        { binding: 'USERID', header:'유저아이디', visible: false},
                        { binding: 'userNm', header: '사용자명', width: 110, minWidth: 100, align: 'center' },
                        { binding: 'indatem', header: '등록일자', width: 150, minWidth: 100, align: 'center'},
                        { binding: 'userAddr', header: '주소', width: '*', minWidth: 230, align: 'left' },
                        { binding: 'InquiryCount', header: '조회건수', width: 80, align: 'center', minWidth: 100},
                        { binding: 'remark', header: '비고', width: 100, align: 'center', minWidth: 150 }
                    ],
                    itemsSource: viewdata
                });

                theGrid1.rowHeaders.columns.splice(0, 1);
            } else {
                theGrid1.itemsSource = viewdata;
            }
        }

        function showGrid2(){

        }


    </script>
</th:block>
</html>