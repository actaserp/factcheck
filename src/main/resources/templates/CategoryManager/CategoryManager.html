<html layout:decorate="~{layout_page}" xmlns:layout="http://www.w3.org/1999/xhtml">

<meta name="_csrf" content="${_csrf.token}">
<meta name="_csrf_header" content="${_csrf.headerName}">

<head>
  <style>
    .wj-header {
      text-align: center;
    }

    /* ì…€ ì™¼ìª½ ì •ë ¬ */
    .wj-cell {
      text-align: left;
    }
    .wp100 {
      width: 100% !important;
      box-sizing: border-box;
    }
    table th {
      width: 120px !important;
    }
    .keyword-container {
        display: flex;
        align-items: center;
        gap: 8px; /* ê°„ê²© ì¡°ì ˆ */
    }

    .keyword-item {
        display: flex;
        align-items: center;
        gap: 8px; /* ê°„ê²© ì¡°ì ˆ */
        margin-top: 5px;
    }

    .keyword-field {
        flex: 1; /* ì…ë ¥ í•„ë“œê°€ ìë™ìœ¼ë¡œ í™•ì¥ë¨ */
    }
  </style>
</head>

<th:block layout:fragment="content">
  <!--- (ë ˆì´ì•„ì›ƒ) Contents ì˜ì—­ -->
  <div class="layout-contents">
    <!-- Page Title -->
    <div class="page-title-wrap">
      <div class="left">
        <h2>ë¶„ë¥˜ê´€ë¦¬ ë“±ë¡</h2>
        <!--                <a title="ë¶ë§ˆí¬" class="bookmark toggle">-->
        <!--                    ë‚´ë©”ë‰´-->
        <!--                </a>-->
      </div>
      <ul class="page-navi">
        <li><img src="/images/icon/ico-nav-home.svg" alt="í™ˆì•„ì´ì½˜"></li>
        <li></li>
        <li>ë¶„ë¥˜ê´€ë¦¬ ë“±ë¡</li>
      </ul>
    </div>
    <div class="tab-wrap">
      <!--            <ul class="tab-links">-->
      <!--                <li>-->
      <!--                    <a href="#tab1" title="ëª©ë¡">ëª©ë¡</a>-->
      <!--                </li>-->
      <!--                 <li>-->
      <!--                  <a href="#tab2" title="ë“±ë¡">ë“±ë¡</a>-->
      <!--                </li>-->
      <!--            </ul>-->
      <div class="tab-contents">
        <!-- Section -->
        <section class="tab-item" id="tab1">
          <div class="section-top">
            <div class="search-wrap">
              <dl>
                <dt>
                  <label for="searchInput">
                    ê²€ìƒ‰<span class="eq">*</span>
                  </label>
                </dt>
                <dd>
                  <div class="srch-box">
                    <input type="text" id="searchInput" name="searchInput" class="input-srch" placeholder="ë“±ê¸° ëª…ì¹­" >
                    <a class="btn-srch" id="btnSearch" title="ê²€ìƒ‰" onclick="fetchListData()"></a>
                  </div>
                </dd>
              </dl>
            </div>
            <div class="button-wrap" style="border-top:none;">
              <ul>
                <li>
                  <a class="btn btn-excell" title="ì‹ ê·œë“±ë¡" id="Newbtn" onclick="clearForm()">
                    <img src="/images/icon/ico-plus.svg" alt="ë“±ë¡ ì•„ì´ì½˜">
                    ì‹ ê·œë“±ë¡
                  </a>
                </li>
                <li>
                  <a class="btn btn-edit" id="btnSave" title="ì €ì¥" onclick="SaveForm()">
                    <img src="/images/icon/ico-save.svg" alt="ì €ì¥ ì•„ì´ì½˜">
                    ì €ì¥
                  </a>
                </li>
                <li>
                  <a class="btn btn-delete" title="ì‚­ì œ" id="btnDelete" onclick="deleteData()">
                    <img src="/images/icon/ico-delete.svg" alt="ì—‘ì…€ ì•„ì´ì½˜">
                    ì‚­ì œ
                  </a>
                </li>
              </ul>
            </div>
          </div> <!--//section-top end -->
          <div class="row">
            <div class="wp50 mg-r20">
              <div class="container-fluid col">
                <p id="selectedItem"></p>
                <div id="theGrid" style="max-height: 630px;"></div>
              </div>
            </div>
            <div class="col wp50">
              <div class="section">
                <form id="CategoryForm">
                  <!-- Hidden Fields -->
                  <input type="hidden" id="parent_id" name="parent_id" value="" />
                  <input class="form-control2" type="text" id="id" name="id" hidden />

                  <!-- Table Wrap -->
                  <div class="table-wrap">
                    <table class="view-table" id="selectedData" style="max-height: 740px;">
                      <caption>ë¶„ë¥˜ê´€ë¦¬ ë“±ë¡ í…Œì´ë¸”</caption>
                      <colgroup>
                        <col class="wp20">
                        <col class="wauto">
                      </colgroup>
                      <tbody>
                      <!--<tr>
                        <th>
                          <label for="regnm">ë“±ê¸° ëª…ì¹­</label>
                        </th>
                        <td colspan="3">
                          <input type="text" id="regnm" name="regnm" class="wp100" placeholder="ë“±ê¸°ëª…ì¹­" readonly />
                        </td>
                      </tr>-->
                      <tr>
                        <th><label for="reggroup">ìƒìœ„ê·¸ë£¹</label></th>
                        <td colspan="3">
                          <input type="hidden" id="regnm" name="regnm" class="wp100" placeholder="ë“±ê¸°ëª…ì¹­" readonly />
                          <select  id="reggroup" name="reggroup" class="wp100"  style="width: 300px;!important" >
                            <option></option>
                          </select>
                        </td>
                      </tr>
                      <tr>
                        <th><label for="regstand">íŒì •ê¸°ì¤€</label></th>
                        <td colspan="3">
                          <select id="regstand" name="regstand" class="wp100"  style="width: 300px;!important" >
                            <option></option>
                          </select>
                        </td>
                      </tr>
                      <tr colspan="2">
                        <th><label for="regmaxnum">ìµœëŒ€ìœ„í—˜ì ìˆ˜</label></th>
                        <td><input type="text" id="regmaxnum" name="regmaxnum" class="wp100" placeholder=" ìµœëŒ€ìœ„í—˜ ì ìˆ˜" oninput="validateAndFormatInput(this)"/></td>

                        <th><label for="regyul">ë°œìƒë¹„ìœ¨</label></th>
                        <td><input type="text" id="regyul" name="regyul" class="wp100" placeholder="ë°œìƒë¹„ìœ¨" oninput="addPercentageSign(this)"/></td>
                      </tr>
                      <tr>
                        <th><label for="regstamt">ê¸°ì¤€ê¸ˆì•¡</label></th>
                        <td><input type="text" id="regstamt" name="regstamt" class="wp100" placeholder="ê¸°ì¤€ê¸ˆì•¡ (ë‹¨ìœ„: ë§Œì›)" oninput="formatWithCommas(this)"/></td>

                        <th><label for="riskclass">ìœ„í—˜ë¶„ë¥˜</label></th>
                        <td>
                          <select id="riskclass" name="riskclass" class="wp100">
                           <option></option>
                          </select>
                        </td>
                      </tr>
                      <tr>
                        <th><label for="">ìˆœìœ„ì¡°ê±´</label></th>
                        <td >
                          <input type="text" id="subScore" name="subScore" class="wp100" placeholder="í›„ìˆœìœ„ì¡°ê±´ì ìˆ˜" style="width: 300px !important" oninput="inputNumber(this)" />
                        </td>
                        <td colspan="2">
                          <input type="text" id="senScore" name="senScore" class="wp100" placeholder="ì„ ìˆœìœ„ì¡°ê±´ì ìˆ˜" style="width: 300px !important" oninput="inputNumber(this)" />
                        </td>
                      </tr>
                      <tr>
                        <th><label for="regAsName">ìˆœí™”ëª…ì¹­</label></th>
                        <td colspan="3">
                          <input type="text" id="regAsName" name="regAsName" class="wp100" placeholder="ìˆœí™”ëª…ì¹­"/>
                        </td>
                      </tr>
                      <tr>
                        <th><label for="exflag">íŒëª…ê¸°ì¤€ì œì™¸</label></th>
                        <td colspan="3">
                          <input type="checkbox" id="exflag" name="exflag" class="wp100" style="display: flex; justify-content: center; align-items: center; " />
                        </td>
                      </tr>
                      <tr>
                        <th><label for="description">ì„¤ëª…</label></th>
                        <td colspan="3">
                          <input type="text" id="description" name="description" class="wp100" placeholder="ë¶€ë™ì‚°ì„ ë‹´ë³´ë¡œ ì€í–‰ê¶Œì—ì„œ ëŒ€ì¶œ" />
                        </td>
                      </tr>
                      <tr>
                        <th><label for="remark">ë¹„ê³ </label></th>
                        <td colspan="3">
                          <input type="text" id="remark" name="remark" class="wp100" placeholder="ë¹„ê³ " />
                          <input type="hidden" id="REGSEQ" name="REGSEQ" />
                        </td>
                      </tr>
                      <tr>
                        <th><label for="keywordInput">ë“±ê¸° í‚¤ì›Œë“œ</label></th>
                        <td colspan="4">
                          <div class="keyword-container">
                            <input type="text" id="keywordInput" placeholder="ë“±ê¸° í‚¤ì›Œë“œ ì…ë ¥">
                            <input type="text" id="REGREMARK" placeholder="ë“±ê¸° í‚¤ì›Œë“œ ì„¤ëª… ì…ë ¥">
                            <button class="btn btn-outline-secondary" type="button" onclick="addKeywordRow()">ì¶”ê°€</button>
                          </div>
                        </td>
                      </tr>
                      </tbody>
                    </table>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </section>
        <!-- Section -->
      </div>
    </div>
  </div> <!--//layout-contents end -->

  <footer style="margin-top: 12px;">
    <p>Copyrightâ“’ factCheck corp.All rights reserved.</p>
  </footer>

</th:block>

<th:block layout:fragment="scripts">
  <th:block th:replace="/common/columns_setting :: columns_setting"></th:block>

  <script type="text/javascript">
    let theGrid;

    function init() {
      fetchListData();
    }

    function fetchListData() {
      let data2 = [];
      const searchValue = $('#searchInput').val();

      // ì„œë²„ë¡œë¶€í„° ë°ì´í„°ë¥¼ ë¹„ë™ê¸°ì ìœ¼ë¡œ ê°€ì ¸ì˜¤ê¸°
      $.ajax({
        url: '/api/category/read',
        type: 'GET',
        data: { regnm: searchValue },
        async: false,
        headers: {
          'X-CSRF-Token': $('[name=_csrf]').val()
        },
        success: function (response) {
          if (response && Array.isArray(response.data)) {
            data2 = response.data.map((item, index) => ({
              rownum: index + 1,
              REGSEQ: item.REGSEQ ||'',
              regnm: item.regnm || '',
              reggroup_display: item.reggroup_display || '',
              reggroup: item.reggroup || '',
              regmaxnum: item.regmaxnum || '',
              exflag: item.exflag || '',
              regstamt: item.regstamt || '',
              regStand: item.regStand || '',
              regStand_display: item.regStand_display || '',
              regYul: item.regYul || '',
              riskclass: item.riskclass || '',
              subScore: item.subScore || '',
              senScore: item.senScore || '',
              regAsName: item.regAsName || '',
              regComment: item.regComment || '',
              remark: item.remark || '',
            }));
          }
        },
        error: function () {
          console.error("ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      });

      while (data2.length < 15) {
        data2.push({
          rownum: data2.length + 1,
          REGSEQ:'',
          regnm: '',
          reggroup_display: '',
          reggroup: '',
          regmaxnum: '',
          exflag: '',
          regstamt: '',
          regStand: '',
          regStand_display: '',
          riskclass: '',
          subScore: '',
          senScore: '',
          regAsName: '',
          regComment: '',
          regYul:'',
          remark: '',
        });

      }

      const viewdata = new wijmo.collections.CollectionView(data2);

      if (!theGrid) {
        // ê·¸ë¦¬ë“œ ì´ˆê¸°í™”
        theGrid = new wijmo.grid.FlexGrid('#theGrid', {
          autoGenerateColumns: false,
          showMarquee: true,
          isReadOnly: true,
          columns: [
            { binding: 'rownum', header: 'NO', align: 'center', width: 70 },
            { binding: 'REGSEQ', header: 'ê³ ìœ ë²ˆí˜¸', align: 'center', width: '*', visible: false},
            //{ binding: 'regnm', header: 'ë“±ê¸° ëª…ì¹­', align: 'center', width: 150 },
            { binding: 'reggroup_display',header:'ìƒìœ„ ê·¸ë£¹', align: 'center', width: 150 },
            { binding: 'reggroup', header: 'ìƒìœ„ê·¸ë£¹ì½”ë“œ', align: 'center', width: 150 ,visible: false },
            { binding: 'regmaxnum', header: 'ìµœëŒ€ìœ„í—˜ì ìˆ˜', align: 'center', width: 150 },
            { binding: 'regstamt', header: 'ê¸°ì¤€ê¸ˆì•¡(ë§Œì›)', align: 'center', width: "*" },
            { binding: 'regStand_display', header: 'íŒì •ê¸°ì¤€', align: 'center', width: 100 },
            { binding: 'regStand', header: 'íŒì •ê¸°ì¤€', align: 'center', width: 100 , visible: false },

            { binding: 'exflag', header: 'íŒëª…ê¸°ì¤€ì œì™¸', visible: false },
            { binding: 'regYul', header: 'ë°œìƒë¹„ìœ¨', visible: false },
            { binding: 'riskclass', header: 'ìœ„í—˜ë¶„ë¥˜', visible: false },
            { binding: 'subScore', header: 'í›„ìˆœìœ„', visible: false },
            { binding: 'senScore', header: 'ì„ ìˆœìœ„', visible: false },
            { binding: 'regAsName', header: 'ìˆœí™”ëª…ì¹­', visible: false },
            { binding: 'regComment', header: 'ì„¤ëª…', visible: false },
            { binding: 'remark', header: 'ë¹„ê³ ', visible: false }
          ],

          itemsSource: viewdata
        });

        theGrid.rowHeaders.columns.splice(0, 1);
        attachDoubleClickEvent(theGrid); // ë”ë¸”í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
      } else {
        theGrid.itemsSource = viewdata; // ê°±ì‹ ëœ CollectionViewë¡œ ì—…ë°ì´íŠ¸
        theGrid.refresh(); // ê·¸ë¦¬ë“œ ìƒˆë¡œê³ ì¹¨
      }

      // ì…€ ë Œë”ë§ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
      theGrid.formatItem.addHandler(function (s, e) {
        if (e.panel === s.cells) {
          const col = s.columns[e.col];
          const item = s.rows[e.row].dataItem[col.binding];

          if (col.binding === 'exflag') {
            e.cell.innerHTML = '';

            if (item) {
              const input = document.createElement('input');
              input.type = 'checkbox';
              input.checked = item === '1';
              input.disabled = true;
              input.style.margin = '0 auto';
              input.style.display = 'block';

              e.cell.appendChild(input);
              e.cell.style.display = 'flex';
              e.cell.style.justifyContent = 'center';
              e.cell.style.alignItems = 'center';
            } else {
              e.cell.style.display = '';
            }
          }
        }
      });
    }

    // ë”ë¸”í´ë¦­ ì´ë²¤íŠ¸
    function attachDoubleClickEvent(grid) {
      let lastClickTime = 0;
      grid.hostElement.addEventListener('click', function (e) {
        const now = new Date().getTime();

        if (now - lastClickTime < 300) { // 300ms ì´ë‚´ì˜ ë‘ ë²ˆ í´ë¦­ì€ ë”ë¸”í´ë¦­ìœ¼ë¡œ ì²˜ë¦¬
          const ht = grid.hitTest(e);

          if (ht.cellType === wijmo.grid.CellType.Cell) {
            const rowData = grid.rows[ht.row].dataItem; // ë”ë¸”í´ë¦­í•œ í–‰ ë°ì´í„°
            console.log('Row Data:', rowData); // ë””ë²„ê¹…: rowData í™•ì¸
            modifyData(rowData); // ë°ì´í„° ì…ë ¥ í•„ë“œì— ì±„ìš°ê¸°
          }
        }

        lastClickTime = now;
      });
    }

    function modifyData(rowData) {
      clearForm();
      // ìµœëŒ€ìœ„í—˜ì ìˆ˜
      const regmaxnumInput = $('#regmaxnum');
      regmaxnumInput.val(rowData.regmaxnum || ''); // ê¸°ë³¸ ê°’ ì„¤ì •
      validateAndFormatInput(regmaxnumInput[0]); // í¬ë§· ì ìš©

      // ë°œìƒë¹„ìœ¨
      const regyulInput = $('#regyul');
      regyulInput.val(rowData.REGYUL || '');
      addPercentageSign(regyulInput[0]); // í¬ë§· ì ìš©

      // ê¸°ì¤€ê¸ˆì•¡
      const regstamtInput = $('#regstamt');
      regstamtInput.val(rowData.regstamt || '');
      formatWithCommas(regstamtInput[0]); // í¬ë§· ì ìš©

      // ê¸°ë³¸ ë°ì´í„° ì±„ìš°ê¸°
      $('#REGSEQ').val(rowData.REGSEQ);
      $('#regnm').val(rowData.regnm || '');
      $('#reggroup').val(rowData.reggroup || '');
      $('#regstand').val(rowData.regStand || '');
      $('#riskclass').val(rowData.riskclass || '');
      $('#subScore').val(rowData.subScore || '');
      $('#senScore').val(rowData.senScore || '');
      $('#regAsName').val(rowData.REGASNAME || '');
      $('#exflag').prop('checked', rowData.exflag === '1');
      $('#description').val(rowData.regComment || '');
      $('#remark').val(rowData.remark || '');

      // ì¶”ê°€ ë°ì´í„° ìš”ì²­
      $.ajax({
        url: '/api/category/details',
        type: 'GET',
        data: { REGSEQ: rowData.REGSEQ },
        headers: {
          'X-CSRF-Token': $('[name=_csrf]').val()
        },
        success: function (response) {
          console.log("ì„œë²„ì—ì„œ ë°›ì•„ì˜¨ ë°ì´í„°",response);
          if (response && response.data) {
           console.log('Server Response:', response.data); // ì‘ë‹µ í™•ì¸
            // ì„œë²„ ì‘ë‹µ ë°ì´í„°ë¡œ UI ì—…ë°ì´íŠ¸
            $('#subScore').val(response.data.SUBSCORE || rowData.SUBSCORE || '');
            $('#senScore').val(response.data.SENSCORE || rowData.SENSCORE || '');
            $('#regAsName').val(response.data.REGASNAME || rowData.REGASNAME || '');
            $('#riskclass').val(response.data.RISKCLASS ||rowData.RISKCLASS || '');
            $('#description').val(response.data.REGCOMMENT || rowData.REGCOMMENT || '');
            $('#remark').val(response.data.REMARK || rowData.REMARK || '');
            $('#regyul').val(response.data.REGYUL || rowData.REGYUL ||'');
            addPercentageSign(regyulInput[0]); // í¬ë§· ì ìš©

            if (response.data.keywords && response.data.keywords.length > 0) {
              response.data.keywords.forEach(keywordObj => {
                addKeywordRow({
                  REGWORD: keywordObj.REGWORD,  // í‚¤ì›Œë“œ ê°’
                  REGREMARK: keywordObj.REGREMARK // í‚¤ì›Œë“œ ì„¤ëª… ê°’
                });
              });
            } else {
              console.warn('í‚¤ì›Œë“œ ì—†ìŒ');
            }

          } else {
            console.warn('ì‘ë‹µì—ì„œ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', response);
          }
        },
        error: function () {
          console.error('ì¶”ê°€ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      });
    }

    // ë°œìƒë¹„ìœ¨(ê¸°í˜¸)
    function addPercentageSign(input) {
      const cursorPosition = input.selectionStart;
      // ìˆ«ìë§Œ ì¶”ì¶œ
      let value = input.value.replace(/[^0-9.]/g, '');
      // ì…ë ¥ê°’ì´ ìˆ«ìë¡œ ë³€í™˜ ê°€ëŠ¥í•˜ê³ , ìµœëŒ€ê°’ 100 ì´í•˜ì¸ì§€ ì²´í¬
      if (value && parseInt(value, 10) > 100) {
        value = '100'; // 100ìœ¼ë¡œ ê°•ì œ ì„¤ì •
      }
      // ì…ë ¥ ê°’ì´ ë¹„ì–´ ìˆì§€ ì•Šì„ ë•Œë§Œ % ì¶”ê°€
      if (value) {
        input.value = value + '%';
      } else {
        input.value = ''; // ë¹ˆ ê°’ ì²˜ë¦¬
      }
      // ì»¤ì„œ ìœ„ì¹˜ ì¡°ì •
      if (cursorPosition <= value.length) {
        input.setSelectionRange(cursorPosition, cursorPosition); // ì»¤ì„œë¥¼ ìœ ì§€
      }
    }

    //ê¸°ì¤€ê¸ˆì•¡(ë‹¨ìœ„)
    function formatWithCommas(input) {
      // ê¸°ì¡´ ì»¤ì„œ ìœ„ì¹˜ ì €ì¥
      const cursorPosition = input.selectionStart;

      // ìˆ«ìë§Œ ì¶”ì¶œ (ì†Œìˆ˜ì  ì œì™¸)
      let value = input.value.replace(/[^0-9]/g, '');

      // ì…ë ¥ ê°’ì´ ë¹„ì–´ìˆì§€ ì•Šì„ ë•Œë§Œ ì²˜ë¦¬
      if (value) {
        // ì²œ ë‹¨ìœ„ ì½¤ë§ˆ ì¶”ê°€
        const formatted = new Intl.NumberFormat().format(value);
        input.value = formatted + 'ë§Œì›';
      } else {
        input.value = ''; // ë¹ˆ ê°’ ì²˜ë¦¬
      }

      // ì»¤ì„œ ìœ„ì¹˜ ì¡°ì •
      const adjustment = input.value.length - value.length - 2; // "ë§Œì›" ê¸¸ì´(2)ë¥¼ ê³ ë ¤
      const newCursorPosition = cursorPosition + adjustment;

      // ì»¤ì„œ ìœ„ì¹˜ê°€ ìœ íš¨í•œ ë²”ìœ„ ë‚´ì¸ì§€ í™•ì¸
      if (newCursorPosition >= 0 && newCursorPosition <= input.value.length - 2) {
        input.setSelectionRange(newCursorPosition, newCursorPosition); // ì»¤ì„œë¥¼ ìœ ì§€
      } else {
        input.setSelectionRange(input.value.length - 2, input.value.length - 2); // "ë§Œì›" ì•ì— ì»¤ì„œë¥¼ ê³ ì •
      }
    }


    //ìµœëŒ€ìœ„í—˜ì ìˆ˜
    function validateAndFormatInput(input) {
      // ê¸°ì¡´ ì»¤ì„œ ìœ„ì¹˜ ì €ì¥
      const cursorPosition = input.selectionStart;
      let value = input.value.replace(/[^0-9]/g, ''); // ìˆ«ìë§Œ ì¶”ì¶œ

      // ìµœëŒ€ê°’ 100 ì²´í¬
      if (value && parseInt(value, 10) > 100) {
        value = '100'; // 100ìœ¼ë¡œ ê°•ì œ ì„¤ì •
      }

      // "ì " ì¶”ê°€
      if (value) {
        input.value = value + 'ì ';
      } else {
        input.value = '';
      }

      // ì»¤ì„œ ìœ„ì¹˜ ì¡°ì •
      if (cursorPosition <= value.length) {
        input.setSelectionRange(cursorPosition, cursorPosition); // ì»¤ì„œë¥¼ ìœ ì§€
      }
    }

    function inputNumber(input) {
      let value = input.value.replace(/[^0-9]/g, ''); // ìˆ«ìë§Œ ì¶”ì¶œ

      // ìµœëŒ€ê°’ 100 ì œí•œ
      if (value && parseInt(value, 10) > 100) {
        value = '100';
      }
      input.value = value; // ë³€ê²½ëœ ê°’ì„ ë‹¤ì‹œ í• ë‹¹
    }

    // ì´ˆê¸°í™” ì‹¤í–‰
    init();

    $(document).ready(function () {
      // ìƒìœ„ê·¸ë£¹ ë³€ê²½ ì‹œ ë“±ê¸° ëª…ì¹­ ìë™ ì„¤ì •
      $("#reggroup").change(function () {
        let selectedText = $("#reggroup option:selected").text();
        $("#regnm").val(selectedText);
      });
    });

    //ê³µí†µ ì½”ë“œ
    const selectConfigs = [
      { parentCode: 'AA', elementId: 'regstand' },
      { parentCode: 'Risk', elementId: 'riskclass' },
      { parentCode: 'AC', elementId: 'regnm' },
      { parentCode: 'AC', elementId: 'reggroup' },
    ];

    selectConfigs.forEach(config => {
      initializeSelect2({
        url: '/api/category/type',
        params: { parentCode: config.parentCode },
        elementId: config.elementId,
        valueField: "code",
        textField: "value"
      });
    });

    //ì €ì¥
    function SaveForm() {

      // í¼ ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•˜ê¸° ì „ì— ìœ íš¨ì„± ê²€ì‚¬
      const reggroup = $("#reggroup").val();
      const regstand = $("#regstand").val();

      // í•„ìˆ˜ ì…ë ¥ê°’ ìœ íš¨ì„± ê²€ì‚¬
      if (!reggroup) {
        Alert.alert("", "ë“±ë¡ ê·¸ë£¹ì„ ì„ íƒí•˜ì„¸ìš”.");
        return;
      }
      if (!regstand) {
        Alert.alert("", "ê¸°ì¤€ ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”.");
        return;
      }

      const keywordList = [];
      $(".keyword-item").each(function () {
        let keywordValue = $(this).find(".keyword-field").val();
        let descriptionValue = $(this).find(".keyword-description").val();

        keywordList.push({ REGWORD: keywordValue, REGREMARK: descriptionValue });
      });

      // í¼ ë°ì´í„°ë¥¼ ìˆ˜ì§‘
      const formData = {
        REGSEQ: $('#REGSEQ').val() || null,
        regnm: $("#regnm").val(),
        reggroup: $("#reggroup").val(),
        regstand: $("#regstand").val(),
        regmaxnum: $("#regmaxnum").val(),
        regyul: $("#regyul").val(),
        regstamt: $("#regstamt").val(),
        riskclass: $("#riskclass").val(),
        subScore: $("#subScore").val(),
        senScore: $("#senScore").val(),
        regAsName: $("#regAsName").val(),
        exflag: $("#exflag").is(":checked"),
        regComment: $("#description").val(),
        remark: $("#remark").val(),
        keywords: keywordList,
        _csrf: $('[name=_csrf]').val()
      };
      console.info("ì €ì¥ ìˆ˜ì§‘ ë°ì´í„°:", formData);
      // AJAX ìš”ì²­
      $.ajax({
        url: '/api/category/save',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(formData),
        headers: {
          'X-CSRF-Token': $('[name=_csrf]').val()
        },
        success: function (response) {
          // ì €ì¥ ì„±ê³µ ì‹œ ì²˜ë¦¬
          if (response.success) {
            Alert.alert("","ì €ì¥ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
            clearForm();
            fetchListData();
          } else {
            console.error("ì €ì¥ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:", response.message);
            Alert.alert("","ì €ì¥ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
          }
        },
        error: function (xhr, status, error) {
          console.error("ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", status, error);
          Alert.alert("","ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.");
        }
      });
    }

    function deleteData() {
      const regSeq = $('#REGSEQ').val(); // í¼ì˜ ìˆ¨ê²¨ì§„ í•„ë“œì—ì„œ REGSEQ ê°€ì ¸ì˜¤ê¸°

      if (!regSeq) {
        Alert.alert('',"ì‚­ì œí•  ë°ì´í„°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
        return;
      }
      Alert.confirm('', 'ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', function () {
        $.ajax({
          url: '/api/category/delete',
          type: 'POST',
          contentType: 'application/json',
          data: JSON.stringify({REGSEQ: regSeq}),
          headers: {
            'X-CSRF-Token': $('[name=_csrf]').val()
          },
          success: function (response) {
            if (response.success) {
              Alert.alert('', "ì‚­ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
              fetchListData(); // ë°ì´í„° ìƒˆë¡œê³ ì¹¨
              clearForm(); // í¼ ì´ˆê¸°í™”
            } else {
              Alert.alert('', "ì‚­ì œ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ");
            }
          },
          error: function (xhr, status, error) {
            Alert.alert('', "ì‚­ì œ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            console.error("Error:", status, error);
          }
        });
      });
    }

    //ì´ˆê¸°í™”
    function clearForm() {
      const form = document.getElementById('CategoryForm');

      Array.from(form.elements).forEach(element => {
        switch (element.type) {
          case 'text':
          case 'hidden':
            element.value = '';
            break;
          case 'checkbox':
            element.checked = false;
            break;
          case 'select-one':
            element.selectedIndex = 0;
            break;
          default:
            break;
        }
      });

      // "ë“±ê¸° í‚¤ì›Œë“œ ì…ë ¥" í•„ë“œ ì´ˆê¸°í™”
      document.getElementById("keywordInput").value = "";
      document.getElementById("REGREMARK").value = "";

      // ì¶”ê°€ëœ í‚¤ì›Œë“œ ë¦¬ìŠ¤íŠ¸ ì´ˆê¸°í™” (td ë‚´ë¶€ ì»¨í…ì¸  ì‚­ì œ)
      let keywordTd = document.querySelector("#selectedData tbody tr:last-child td");
      if (keywordTd) {
        keywordTd.innerHTML = ''; // ê¸°ì¡´ í‚¤ì›Œë“œì™€ ë²„íŠ¼ì„ ëª¨ë‘ ì‚­ì œ
      }

      // "ë“±ê¸° í‚¤ì›Œë“œ ì…ë ¥ í•„ë“œ"ì™€ "ì¶”ê°€ ë²„íŠ¼" ë‹¤ì‹œ ìƒì„± (ì´ˆê¸° ìƒíƒœ ìœ ì§€)
      let keywordContainer = document.createElement("div");
      keywordContainer.classList.add("keyword-container");

      let newInput = document.createElement("input");
      newInput.setAttribute("type", "text");
      newInput.setAttribute("id", "keywordInput");
      newInput.setAttribute("class", "form-control");
      newInput.setAttribute("placeholder", "ë“±ê¸° í‚¤ì›Œë“œ ì…ë ¥");

      let newRemark = document.createElement("input");
      newRemark.setAttribute("type", "text");
      newRemark.setAttribute("id", "REGREMARK");
      newRemark.setAttribute("class", "form-control");
      newRemark.setAttribute("placeholder", "ë“±ê¸° í‚¤ì›Œë“œ ì„¤ëª… ì…ë ¥");

      let addButton = document.createElement("button");
      addButton.setAttribute("class", "btn btn-outline-secondary");
      addButton.setAttribute("type", "button");
      addButton.setAttribute("onclick", "addKeywordRow()");
      addButton.textContent = "ì¶”ê°€";

      keywordContainer.appendChild(newInput);
      keywordContainer.appendChild(newRemark);
      keywordContainer.appendChild(addButton);
      keywordTd.appendChild(keywordContainer);
    }


    //í‚¤ì›Œë“œ ì¶”ê°€
    function addKeywordRow(keywordObj = null) {
      // ì…ë ¥í•œ ê°’ ê°€ì ¸ì˜¤ê¸° (ì´ˆê¸°ê°’ì´ nullì´ë©´ ìƒˆ ê°’ ì¶”ê°€)
      let keywordValue = keywordObj ? keywordObj.REGWORD : document.getElementById("keywordInput").value.trim();
      let keywordDescription = keywordObj ? keywordObj.REGREMARK : document.getElementById("REGREMARK").value.trim();

      if (keywordValue === "") {
        Alert.alert('', "í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }

      if (keywordDescription === "") {
        Alert.alert('', "í‚¤ì›Œë“œ ì„¤ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }

      // âœ… í‚¤ì›Œë“œ ë¦¬ìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ ì°¾ê¸°
      let keywordListContainer = document.getElementById("keywordListContainer");

      // ğŸ”¥ ì»¨í…Œì´ë„ˆê°€ ì—†ìœ¼ë©´ ìƒì„± (ìµœëŒ€ ë†’ì´ ìœ ì§€)
      if (!keywordListContainer) {
        let parentTd = document.querySelector("#selectedData tbody tr:last-child td");
        keywordListContainer = document.createElement("div");
        keywordListContainer.id = "keywordListContainer";
        keywordListContainer.style.maxHeight = "150px"; //ìµœëŒ€ ë†’ì´ ìœ ì§€
        keywordListContainer.style.overflowY = "auto"; //ìŠ¤í¬ë¡¤ í™œì„±í™”
        parentTd.appendChild(keywordListContainer);
      }

      // ìƒˆë¡œìš´ ì»¨í…Œì´ë„ˆ(div) ìƒì„±
      let keywordContainer = document.createElement("div");
      keywordContainer.classList.add("keyword-item");

      // í‚¤ì›Œë“œ ì…ë ¥ í•„ë“œ (ì½ê¸° ì „ìš©, ì—¬ëŸ¬ ì¤„ ê°€ëŠ¥)
      let newKeywordInput = document.createElement("textarea");
      newKeywordInput.setAttribute("class", "wp30 keyword-field");
      newKeywordInput.setAttribute("name", "Keyword");
      newKeywordInput.setAttribute("placeholder", "ë“±ê¸° í‚¤ì›Œë“œ");
      newKeywordInput.value = keywordValue;
      newKeywordInput.readOnly = true;
      newKeywordInput.style.resize = "none"; // ğŸ”¥ í¬ê¸° ì¡°ì ˆ ë¹„í™œì„±í™”
      newKeywordInput.style.height = "60px"; // ğŸ”¥ ê¸°ë³¸ ë†’ì´ ì„¤ì •
      newKeywordInput.style.overflow = "hidden"; // âœ… ìŠ¤í¬ë¡¤ ì œê±°
      newKeywordInput.style.whiteSpace = "normal"; // âœ… ì¤„ ë°”ê¿ˆ í—ˆìš©
      newKeywordInput.style.wordBreak = "break-word"; // âœ… ê¸´ ë‹¨ì–´ë„ ìë™ ì¤„ë°”ê¿ˆ

// í‚¤ì›Œë“œ ì„¤ëª… ì…ë ¥ í•„ë“œ (ì½ê¸° ì „ìš©, ì—¬ëŸ¬ ì¤„ ê°€ëŠ¥)
      let newDescriptionInput = document.createElement("textarea");
      newDescriptionInput.setAttribute("class", "wp70 keyword-description");
      newDescriptionInput.setAttribute("name", "KeywordDescription");
      newDescriptionInput.setAttribute("placeholder", "í‚¤ì›Œë“œ ì„¤ëª…");
      newDescriptionInput.value = keywordDescription;
      newDescriptionInput.readOnly = true;
      newDescriptionInput.style.resize = "none"; // ğŸ”¥ í¬ê¸° ì¡°ì ˆ ë¹„í™œì„±í™”
      newDescriptionInput.style.height = "60px"; // ğŸ”¥ ê¸°ë³¸ ë†’ì´ ì„¤ì •
      newDescriptionInput.style.overflow = "hidden"; // âœ… ìŠ¤í¬ë¡¤ ì œê±°
      newDescriptionInput.style.whiteSpace = "normal"; // âœ… ì¤„ ë°”ê¿ˆ í—ˆìš©
      newDescriptionInput.style.wordBreak = "break-word"; // âœ… ê¸´ ë‹¨ì–´ë„ ìë™ ì¤„ë°”ê¿ˆ



      // ì‚­ì œ ë²„íŠ¼ ì¶”ê°€
      let removeBtn = document.createElement("button");
      removeBtn.innerHTML = "âŒ";
      removeBtn.setAttribute("type", "button");
      removeBtn.classList.add("btn", "btn-sm", "btn-outline-danger", "ms-2");
      removeBtn.onclick = function () {
        keywordTd.removeChild(keywordContainer);
      };

      // ì»¨í…Œì´ë„ˆì— í‚¤ì›Œë“œ & ì„¤ëª… & ë²„íŠ¼ ì¶”ê°€
      keywordContainer.appendChild(newKeywordInput);
      keywordContainer.appendChild(newDescriptionInput);
      keywordContainer.appendChild(removeBtn);

      // âœ… í‚¤ì›Œë“œ ë¦¬ìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆì— ì¶”ê°€ (í‚¤ì›Œë“œ ê°œìˆ˜ ì œí•œ)
      keywordListContainer.appendChild(keywordContainer);

      // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
      if (!keywordObj) {
        document.getElementById("keywordInput").value = "";
        document.getElementById("REGREMARK").value = "";
      }
    }
  </script>
</th:block>
</html>