<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FACT CHECK</title>
    <link rel="icon" type="image/png" href="/images/logo/icon_FACT%20CHECK.png">
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/smoothness/jquery-ui.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/> <!-- Slide css -->
    <link rel="stylesheet" href="/resource/ax5ui/ax5ui.all.css">
    <link rel="stylesheet" type="text/css" href="/assets_mobile/css/import.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>


    <script src="/assets_mobile/js/ui.js"></script> <!-- Common js -->
    <script type="text/javascript" src="/resource/ax5ui/ax5ui.all.min.js?v=1000"></script>

    <script type="text/javascript" src="/js/ax5commUtil.js?v=1070"></script>

    <script src="/js/common.js?v=1060"></script>
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script> <!-- Slide js -->
    <script src="/js/Mobile.js"></script>
    <style>
        .new-fl-ac {

        }

        .sd-select {
            margin-top: 6px;
        }

        .toggle-password {
            position: absolute;
            right: 10px; /* 오른쪽 여백 */
            top: 50%; /* 수직 가운데 정렬 */
            transform: translateY(-50%); /* 가운데 정렬 보정 */
            width: 24px; /* 아이콘 너비 */
            height: 24px; /* 아이콘 높이 */
            background: url('/images/icon/btn-show.svg') no-repeat center;
            background-size: contain; /* 아이콘 크기 조정 */
            cursor: pointer; /* 클릭 가능 표시 */
            z-index: 2; /* 인풋 필드 위에 표시 */
            pointer-events: auto; /* 클릭 가능 */
        }

        .center {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .btn-close {
            display: none !important; /* 강제로 숨김 */
        }
    </style>
</head>

<body>
<div class="mobile-wrapper page-ticket-list"><!-- ★페이지 Class명 -->
    <!-- [모바일] 헤더  -->
    <div class="mobile-layout-header">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
        <header>
            <div class="left">
                <div class="hd-btn">
                    <!--                    <a href="javascript:void(0);" onclick="history.back();" title="뒤로가기">-->
                    <!--                        <img src="/images/icon/btn-prev.svg" alt="뒤로가기 아이콘">-->
                    <!--                    </a>-->
                </div>
            </div>
            <div class="center">
                <h2>내 정보</h2>
            </div>
            <div class="right">
                <a href="#" title="전체메뉴" class="btn-menu">
                    <img src="/assets_mobile/images/icon/btn-menu.svg" alt="전체메뉴 아이콘">
                </a>
            </div>
        </header>
    </div> <!-- //mobile-layout-header end-->

    <!-- [모바일] 메뉴  -->
    <div th:insert="~{mobile/mobile_menu :: mobile_menu}"></div>

    <!-- [모바일] 컨덴츠  -->
    <div class="mobile-layout-contents">
        <!--- (레이아웃) Contents 영역 -->
        <div class="layout-contents">
            <!-- 컨텐츠 영역  -->
            <div class="contents-wrap">
                <form id="userForm" autocomplete="off">
                    <div class="write-wrap">
                        <dl>
                            <dt>
                                <label for="login_id">
                                    ID
                                    <span id="ssoCd"></span>
                                </label>
                            </dt>
                            <dd>
                                <div class="input-clear">
                                    <input type="text" id="login_id" name="login_id" readonly>
                                </div>
                            </dd>
                        </dl>
                        <dl>
                            <dt>
                                <label for="name">
                                    성명<span class="eq">*</span>
                                </label>
                            </dt>
                            <dd>
                                <div class="input-clear">
                                    <input type="text" id="name" name="name">
                                </div>
                            </dd>
                        </dl>
                        <div id="passwordChangeSection">
                            <dl>
                                <dt>
                                    <label>
                                        비밀번호
                                    </label>
                                </dt>
                                <dd>
                                    <div class="input-clear">
                                        <input type="password" id="PasswordChange" name="PasswordChange"
                                               placeholder="변경시에 입력하세요."
                                               autocomplete="off">
                                        <i class="toggle-password" data-target="PasswordChange"></i>
                                    </div>
                                </dd>
                            </dl>
                            <dl>
                                <dt>
                                    <label>
                                        비밀번호 확인
                                    </label>
                                </dt>
                                <dd>
                                    <div class="input-clear">
                                        <input type="password" id="PasswordChangeChk" name="PasswordChangeChk"
                                               placeholder="비밀번호 확인" autocomplete="off">
                                        <i class="toggle-password" data-target="PasswordChangeChk"></i>
                                    </div>
                                </dd>
                            </dl>
                        </div>
                        <dl>
                            <dt>
                                <label for="birthYear">
                                    생년월일
                                </label>
                            </dt>
                            <dd>
                                <div class="input-clear">
                                    <input type="date" id="birthYear" name="birthYear">
                                </div>
                            </dd>
                        </dl>
                        <dl>
                            <dt>
                                <label for="sexYn">
                                    성별
                                </label>
                            </dt>
                            <dd>
                                <div class="input-clear">
                                    <select id="sexYn" name="sexYn">
                                        <option value="1">남자</option>
                                        <option value="2">여자</option>
                                    </select>
                                </div>
                            </dd>
                        </dl>
                        <dl>
                            <dt>
                                <label for="postno">주소<span class="eq">*</span></label>
                            </dt>
                            <dd>
                                <div class="flex-row" style="display: flex">
                                    <input type="text" id="postno" name="postno" placeholder="우편번호" style="width: 85px;"
                                           readonly>
                                    <input type="text" id="address1" name="address1" placeholder="도로명주소"
                                           onclick="openAddressSearch()">
                                </div>
                            </dd>
                        </dl>
                        <dl>
                            <dt>
                                <label for="userHp">
                                    핸드폰<span class="eq">*</span>
                                </label>
                            </dt>
                            <dd>
                                <input type="text" id="userHp" name="userHp">
                            </dd>
                        </dl>
                        <dl>
                            <dt>
                                <label for="userMail">
                                    이메일<span class="eq">*</span>
                                </label>
                            </dt>
                            <dd>
                                <div class="input-clear">
                                    <input type="text" id="userMail" name="userMail" disabled>
                                </div>
                            </dd>
                        </dl>
                    </div>
                </form>
            </div> <!--// contents-wrap end-->
            <div class="button-wrap">
                <button class="btn-navy" id="btnSaveAuth" onclick="upUserInfo()">수정</button>
            </div>
        </div> <!--//layout-contents end -->
    </div> <!-- //mobile-layout-contents end-->

    <div class="mobile-layout-popup">

        <div class="popup-wrapper" id="popup-addr">
            <div id="searchPage" style="display:none;min-height: 500px;">
                <div id="postcodeLayer" style="width:100%; height:400px;"></div>
            </div>
            <div class="popup-button">
                <button class="btn-popup-close btn-navy">취소</button>
            </div>
        </div>
    </div>
</div> <!-- //page-wrapper end-->
<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<script>
    function openAddressSearch() {
        let popup = document.getElementById('popup-addr');
        const postcodeLayer = document.getElementById('postcodeLayer');
        const searchPage = document.getElementById('searchPage');

        if (popup) {
            popup.classList.add('active'); // 팝업 활성화
            // 주소 검색 화면 표시
            searchPage.style.display = 'block';
        } else {
            console.error('popup1 또는 popup-overlay 요소를 찾을 수 없습니다.');
        }

        // Daum Postcode API 실행
        new daum.Postcode({
            oncomplete: function (data) {
                var roadAddr = data.roadAddress; // 도로명 주소
                var extraRoadAddr = '';

                // 법정동 정보 추가
                if (data.bname !== '' && /[동|로|가]$/g.test(data.bname)) {
                    extraRoadAddr += data.bname;
                }
                // 건물명 정보 추가
                if (data.buildingName !== '' && data.apartment === 'Y') {
                    extraRoadAddr += (extraRoadAddr !== '' ? ', ' + data.buildingName : data.buildingName);
                }
                // 괄호로 감싸기
                if (extraRoadAddr !== '') {
                    extraRoadAddr = ' (' + extraRoadAddr + ')';
                }

                // 우편번호와 주소 업데이트
                document.getElementById('postno').value = data.zonecode;
                document.getElementById('address1').value = roadAddr + extraRoadAddr;

                // 검색 완료 후 레이어 숨기기
                closeAddressSearch();
            },
            onresize: function (size) {
                // 동적 스타일 적용
                const layers = document.querySelectorAll('[id^="__daum__layer_"]');
                layers.forEach(layer => {
                    layer.style.width = '100%';
                    layer.style.height = '500px';
                    layer.style.overflow = 'hidden';
                    layer.style.backgroundColor = '#fff';
                });
            }
        }).embed(postcodeLayer);
    }

    function closeAddressSearch() {
        const searchPage = document.getElementById('searchPage');

        if (searchPage) {
            // 검색 레이어 숨기기
            searchPage.style.display = 'none';
        }
        $('.popup-wrapper').removeClass('active');
    }


</script>
<script type="text/javascript">

    document.readyState === 'complete' ? init() : window.onload = init;

    function init() {
        UserInfo();
    }


    function UserInfo() {

        $.ajax({
            url: '/mobile/myinfo', // 사용자 정보를 가져올 URL
            type: 'GET',
            dataType: 'json', // 응답 데이터 형식 지정
            success: function (response) {
                console.log('response.data.birthYear)', response.data.birthYear);
                // AJAX 호출 성공 시 처리할 로직
                if (response && response.data) {
                    $('#login_id').val(response.data.userId); // ID 필드 채우기
                    $('#name').val(response.data.userNm); // 이름 필드 채우기
                    $('#birthYear').val(formatDate(response.data.birthYear));
                    $('#sexYn').val(response.data.sexYn);
                    $('#postno').val(response.data.postCd);
                    $('#address1').val(response.data.userAddr);
                    $('#userHp').val(formatPhoneNumber(response.data.userHp));
                    $('#userMail').val(response.data.userMail);
                    $('#PasswordChange').val("");
                    $('#PasswordChangeChk').val("");

                    // ssocd가 null이 아닐 경우 비밀번호 변경 입력 필드 숨김
                    if (response.data.ssoCd !== null) {
                        $("#passwordChangeSection").hide();
                        $("#PasswordChange, #PasswordChangeChk").prop("disabled", true);
                        $('#ssoCd').text('(' + response.data.ssoCd + ' 로그인)');
                    } else {
                        $("#passwordChangeSection").show();
                        $("#PasswordChange, #PasswordChangeChk").prop("disabled", false);
                        $('#ssoCd').text("");
                    }
                }
                // console.log('사용자 정보 가져오기 성공: ', response);
            },
            error: function (xhr, status, error) {
                // AJAX 호출 실패 시 처리할 로직
                console.error('사용자 정보 가져오기 실패: ', error);
            }
        });

    }

    function formatDate(dateString) {
        if (!dateString || dateString.length !== 6) return ""; // 예외 처리

        let yearPart = dateString.substring(0, 2); // 연도 부분 (00, 01, ..., 99)
        let month = dateString.substring(2, 4); // 월
        let day = dateString.substring(4, 6); // 일

        // ✅ "00"~"49" → 2000년대, "50"~"99" → 1900년대
        let fullYear = (parseInt(yearPart, 10) >= 50) ? `19${yearPart}` : `20${yearPart}`;

        return `${fullYear}-${month}-${day}`;
    }


    function upUserInfo() {
        const userId = $('#login_id').val();
        const userNm = $('#name').val();
        const birthYear = $('#birthYear').val();
        const sexYn = $('#sexYn').val();
        const postCd = $('#postno').val();
        const userAddr = $('#address1').val();
        const userHp = $('#userHp').val().replace(/-/g, "");
        const userMail = $('#userMail').val();
        const password = $('#PasswordChange').val();
        const password2 = $('#PasswordChangeChk').val();

        if (!userId || !userNm || !userHp || !userMail) {
            Alert.alert('', '모든 필수 항목을 입력해주세요.');
            return;
        }

        if (password !== password2) {
            Alert.alert('', '비밀번호가 맞지 않습니다.');
            return;
        }

        // 비밀번호가 비어 있으면 null로 설정 (비밀번호 변경 안 함)
        const passwordValue = password.trim() !== "" ? password : null;

        $.ajax({
            url: '/mobile/userInfo/update', // 사용자 정보 업데이트 URL
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                userId: userId,
                userNm: userNm,
                birthYear: birthYear,
                sexYn: sexYn,
                postCd: postCd,
                userAddr: userAddr,
                userHp: userHp,
                userMail: userMail,
                loginPw: passwordValue
            }),
            headers: {
                'X-CSRF-Token': $('[name=_csrf]').val() // CSRF 토큰 추가
            },
            success: function (response) {
                if (response.success) {
                    Alert.alert('', '사용자 정보가 성공적으로 수정되었습니다.');
                    UserInfo();
                } else {
                    Alert.alert('', '수정 중 문제가 발생했습니다: ' + response.message);
                }
            },
            error: function (xhr, status, error) {
                console.error('사용자 정보 수정 실패: ', error);
                Alert.alert('', '사용자 정보 수정 요청 중 오류가 발생했습니다.');
            }
        });
    }

    document.querySelectorAll('.toggle-password').forEach(icon => {
        icon.addEventListener('click', () => {
            const targetId = icon.getAttribute('data-target');
            const inputField = document.getElementById(targetId);

            if (inputField.type === 'password') {
                inputField.type = 'text';
                icon.style.backgroundImage = "url('/images/icon/btn-hidden.svg')"; // 비밀번호 보임 상태
            } else {
                inputField.type = 'password';
                icon.style.backgroundImage = "url('/images/icon/btn-show.svg')"; // 비밀번호 숨김 상태
            }
        });
    });

    $('.btn-popup-close').on('click', function () {
        $('.popup-overlay').fadeOut(200);
        $('.popup-wrapper').removeClass('active');
    });

    function formatPhoneNumber(number) {
        if (!number) return "";
        let rawNumber = number.replace(/\D/g, ""); // 숫자만 유지
        if (rawNumber.length === 11) {
            return rawNumber.replace(/(\d{3})(\d{4})(\d{4})/, "$1-$2-$3");
        } else if (rawNumber.length === 10) {
            return rawNumber.replace(/(\d{3})(\d{3})(\d{4})/, "$1-$2-$3");
        }
        return rawNumber; // 변환 불가능한 경우 원본 반환
    }

    $(document).ready(function () {
        let userHpInput = $("#userHp");

        // 🔥 입력 필드가 포커스를 받을 때 '-' 제거
        userHpInput.on("focus", function () {
            let rawNumber = $(this).val().replace(/-/g, ""); // 하이픈 제거
            $(this).val(rawNumber);
        });

        // 🔥 입력 필드에서 포커스를 잃으면 '-' 추가하여 포맷 적용
        userHpInput.on("blur", function () {
            let rawNumber = $(this).val().replace(/\D/g, ""); // 숫자만 남김
            let formattedNumber = formatPhoneNumber(rawNumber);
            $(this).val(formattedNumber);
        });

        // 🔥 입력할 때 자동으로 하이픈이 적용되도록 처리
        userHpInput.on("input", function () {
            let rawNumber = $(this).val().replace(/\D/g, ""); // 숫자만 유지
            $(this).val(rawNumber);
        });

        // 🔥 페이지가 로드될 때 즉시 하이픈 추가
        let initialUserHp = userHpInput.val();
        if (initialUserHp) {
            userHpInput.val(formatPhoneNumber(initialUserHp));
        }
    });


</script>
</body>
</html>
