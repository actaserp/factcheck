<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FACT CHECK</title>
    <link rel="icon" type="image/png" href="/images/logo/icon_FACT%20CHECK.png">
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/smoothness/jquery-ui.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/> <!-- Slide css -->
    <link rel="stylesheet" href="/resource/ax5ui/ax5ui.all.css">
    <link rel="stylesheet" type="text/css" href="/assets_mobile/css/import.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>


    <script src="/assets_mobile/js/ui.js"></script> <!-- Common js -->
    <script type="text/javascript" src="/resource/ax5ui/ax5ui.all.min.js?v=1000"></script>

    <script type="text/javascript" src="/js/ax5commUtil.js?v=1070"></script>

    <script src="/js/common.js?v=1060"></script>
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script> <!-- Slide js -->
    <script src="/js/Mobile.js"></script>
    <style>
        .new-fl-ac {

        }

        .sd-select {
            margin-top: 6px;
        }

        .toggle-password {
            position: absolute;
            right: 10px; /* ì˜¤ë¥¸ìª½ ì—¬ë°± */
            top: 50%; /* ìˆ˜ì§ ê°€ìš´ë° ì •ë ¬ */
            transform: translateY(-50%); /* ê°€ìš´ë° ì •ë ¬ ë³´ì • */
            width: 24px; /* ì•„ì´ì½˜ ë„ˆë¹„ */
            height: 24px; /* ì•„ì´ì½˜ ë†’ì´ */
            background: url('/images/icon/btn-show.svg') no-repeat center;
            background-size: contain; /* ì•„ì´ì½˜ í¬ê¸° ì¡°ì • */
            cursor: pointer; /* í´ë¦­ ê°€ëŠ¥ í‘œì‹œ */
            z-index: 2; /* ì¸í’‹ í•„ë“œ ìœ„ì— í‘œì‹œ */
            pointer-events: auto; /* í´ë¦­ ê°€ëŠ¥ */
        }

        .center {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .btn-close {
            display: none !important; /* ê°•ì œë¡œ ìˆ¨ê¹€ */
        }
    </style>
</head>

<body>
<div class="mobile-wrapper page-ticket-list"><!-- â˜…í˜ì´ì§€ Classëª… -->
    <!-- [ëª¨ë°”ì¼] í—¤ë”  -->
    <div class="mobile-layout-header">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
        <header>
            <div class="left">
                <div class="hd-btn">
                    <!--                    <a href="javascript:void(0);" onclick="history.back();" title="ë’¤ë¡œê°€ê¸°">-->
                    <!--                        <img src="/images/icon/btn-prev.svg" alt="ë’¤ë¡œê°€ê¸° ì•„ì´ì½˜">-->
                    <!--                    </a>-->
                </div>
            </div>
            <div class="center">
                <h2>ë‚´ ì •ë³´</h2>
            </div>
            <div class="right">
                <a href="#" title="ì „ì²´ë©”ë‰´" class="btn-menu">
                    <img src="/assets_mobile/images/icon/btn-menu.svg" alt="ì „ì²´ë©”ë‰´ ì•„ì´ì½˜">
                </a>
            </div>
        </header>
    </div> <!-- //mobile-layout-header end-->

    <!-- [ëª¨ë°”ì¼] ë©”ë‰´  -->
    <div th:insert="~{mobile/mobile_menu :: mobile_menu}"></div>

    <!-- [ëª¨ë°”ì¼] ì»¨ë´ì¸   -->
    <div class="mobile-layout-contents">
        <!--- (ë ˆì´ì•„ì›ƒ) Contents ì˜ì—­ -->
        <div class="layout-contents">
            <!-- ì»¨í…ì¸  ì˜ì—­  -->
            <div class="contents-wrap">
                <form id="userForm" autocomplete="off">
                    <div class="write-wrap">
                        <dl>
                            <dt>
                                <label for="login_id">
                                    ID
                                    <span id="ssoCd"></span>
                                </label>
                            </dt>
                            <dd>
                                <div class="input-clear">
                                    <input type="text" id="login_id" name="login_id" readonly>
                                </div>
                            </dd>
                        </dl>
                        <dl>
                            <dt>
                                <label for="name">
                                    ì„±ëª…<span class="eq">*</span>
                                </label>
                            </dt>
                            <dd>
                                <div class="input-clear">
                                    <input type="text" id="name" name="name">
                                </div>
                            </dd>
                        </dl>
                        <div id="passwordChangeSection">
                            <dl>
                                <dt>
                                    <label>
                                        ë¹„ë°€ë²ˆí˜¸
                                    </label>
                                </dt>
                                <dd>
                                    <div class="input-clear">
                                        <input type="password" id="PasswordChange" name="PasswordChange"
                                               placeholder="ë³€ê²½ì‹œì— ì…ë ¥í•˜ì„¸ìš”."
                                               autocomplete="off">
                                        <i class="toggle-password" data-target="PasswordChange"></i>
                                    </div>
                                </dd>
                            </dl>
                            <dl>
                                <dt>
                                    <label>
                                        ë¹„ë°€ë²ˆí˜¸ í™•ì¸
                                    </label>
                                </dt>
                                <dd>
                                    <div class="input-clear">
                                        <input type="password" id="PasswordChangeChk" name="PasswordChangeChk"
                                               placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸" autocomplete="off">
                                        <i class="toggle-password" data-target="PasswordChangeChk"></i>
                                    </div>
                                </dd>
                            </dl>
                        </div>
                        <dl>
                            <dt>
                                <label for="birthYear">
                                    ìƒë…„ì›”ì¼
                                </label>
                            </dt>
                            <dd>
                                <div class="input-clear">
                                    <input type="date" id="birthYear" name="birthYear">
                                </div>
                            </dd>
                        </dl>
                        <dl>
                            <dt>
                                <label for="sexYn">
                                    ì„±ë³„
                                </label>
                            </dt>
                            <dd>
                                <div class="input-clear">
                                    <select id="sexYn" name="sexYn">
                                        <option value="1">ë‚¨ì</option>
                                        <option value="2">ì—¬ì</option>
                                    </select>
                                </div>
                            </dd>
                        </dl>
                        <dl>
                            <dt>
                                <label for="postno">ì£¼ì†Œ<span class="eq">*</span></label>
                            </dt>
                            <dd>
                                <div class="flex-row" style="display: flex">
                                    <input type="text" id="postno" name="postno" placeholder="ìš°í¸ë²ˆí˜¸" style="width: 85px;"
                                           readonly>
                                    <input type="text" id="address1" name="address1" placeholder="ë„ë¡œëª…ì£¼ì†Œ"
                                           onclick="openAddressSearch()">
                                </div>
                            </dd>
                        </dl>
                        <dl>
                            <dt>
                                <label for="userHp">
                                    í•¸ë“œí°<span class="eq">*</span>
                                </label>
                            </dt>
                            <dd>
                                <input type="text" id="userHp" name="userHp">
                            </dd>
                        </dl>
                        <dl>
                            <dt>
                                <label for="userMail">
                                    ì´ë©”ì¼<span class="eq">*</span>
                                </label>
                            </dt>
                            <dd>
                                <div class="input-clear">
                                    <input type="text" id="userMail" name="userMail" disabled>
                                </div>
                            </dd>
                        </dl>
                    </div>
                </form>
            </div> <!--// contents-wrap end-->
            <div class="button-wrap">
                <button class="btn-navy" id="btnSaveAuth" onclick="upUserInfo()">ìˆ˜ì •</button>
            </div>
        </div> <!--//layout-contents end -->
    </div> <!-- //mobile-layout-contents end-->

    <div class="mobile-layout-popup">

        <div class="popup-wrapper" id="popup-addr">
            <div id="searchPage" style="display:none;min-height: 500px;">
                <div id="postcodeLayer" style="width:100%; height:400px;"></div>
            </div>
            <div class="popup-button">
                <button class="btn-popup-close btn-navy">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>
</div> <!-- //page-wrapper end-->
<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<script>
    function openAddressSearch() {
        let popup = document.getElementById('popup-addr');
        const postcodeLayer = document.getElementById('postcodeLayer');
        const searchPage = document.getElementById('searchPage');

        if (popup) {
            popup.classList.add('active'); // íŒì—… í™œì„±í™”
            // ì£¼ì†Œ ê²€ìƒ‰ í™”ë©´ í‘œì‹œ
            searchPage.style.display = 'block';
        } else {
            console.error('popup1 ë˜ëŠ” popup-overlay ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }

        // Daum Postcode API ì‹¤í–‰
        new daum.Postcode({
            oncomplete: function (data) {
                var roadAddr = data.roadAddress; // ë„ë¡œëª… ì£¼ì†Œ
                var extraRoadAddr = '';

                // ë²•ì •ë™ ì •ë³´ ì¶”ê°€
                if (data.bname !== '' && /[ë™|ë¡œ|ê°€]$/g.test(data.bname)) {
                    extraRoadAddr += data.bname;
                }
                // ê±´ë¬¼ëª… ì •ë³´ ì¶”ê°€
                if (data.buildingName !== '' && data.apartment === 'Y') {
                    extraRoadAddr += (extraRoadAddr !== '' ? ', ' + data.buildingName : data.buildingName);
                }
                // ê´„í˜¸ë¡œ ê°ì‹¸ê¸°
                if (extraRoadAddr !== '') {
                    extraRoadAddr = ' (' + extraRoadAddr + ')';
                }

                // ìš°í¸ë²ˆí˜¸ì™€ ì£¼ì†Œ ì—…ë°ì´íŠ¸
                document.getElementById('postno').value = data.zonecode;
                document.getElementById('address1').value = roadAddr + extraRoadAddr;

                // ê²€ìƒ‰ ì™„ë£Œ í›„ ë ˆì´ì–´ ìˆ¨ê¸°ê¸°
                closeAddressSearch();
            },
            onresize: function (size) {
                // ë™ì  ìŠ¤íƒ€ì¼ ì ìš©
                const layers = document.querySelectorAll('[id^="__daum__layer_"]');
                layers.forEach(layer => {
                    layer.style.width = '100%';
                    layer.style.height = '500px';
                    layer.style.overflow = 'hidden';
                    layer.style.backgroundColor = '#fff';
                });
            }
        }).embed(postcodeLayer);
    }

    function closeAddressSearch() {
        const searchPage = document.getElementById('searchPage');

        if (searchPage) {
            // ê²€ìƒ‰ ë ˆì´ì–´ ìˆ¨ê¸°ê¸°
            searchPage.style.display = 'none';
        }
        $('.popup-wrapper').removeClass('active');
    }


</script>
<script type="text/javascript">

    document.readyState === 'complete' ? init() : window.onload = init;

    function init() {
        UserInfo();
    }


    function UserInfo() {

        $.ajax({
            url: '/mobile/myinfo', // ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ URL
            type: 'GET',
            dataType: 'json', // ì‘ë‹µ ë°ì´í„° í˜•ì‹ ì§€ì •
            success: function (response) {
                console.log('response.data.birthYear)', response.data.birthYear);
                // AJAX í˜¸ì¶œ ì„±ê³µ ì‹œ ì²˜ë¦¬í•  ë¡œì§
                if (response && response.data) {
                    $('#login_id').val(response.data.userId); // ID í•„ë“œ ì±„ìš°ê¸°
                    $('#name').val(response.data.userNm); // ì´ë¦„ í•„ë“œ ì±„ìš°ê¸°
                    $('#birthYear').val(formatDate(response.data.birthYear));
                    $('#sexYn').val(response.data.sexYn);
                    $('#postno').val(response.data.postCd);
                    $('#address1').val(response.data.userAddr);
                    $('#userHp').val(formatPhoneNumber(response.data.userHp));
                    $('#userMail').val(response.data.userMail);
                    $('#PasswordChange').val("");
                    $('#PasswordChangeChk').val("");

                    // ssocdê°€ nullì´ ì•„ë‹ ê²½ìš° ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì…ë ¥ í•„ë“œ ìˆ¨ê¹€
                    if (response.data.ssoCd !== null) {
                        $("#passwordChangeSection").hide();
                        $("#PasswordChange, #PasswordChangeChk").prop("disabled", true);
                        $('#ssoCd').text('(' + response.data.ssoCd + ' ë¡œê·¸ì¸)');
                    } else {
                        $("#passwordChangeSection").show();
                        $("#PasswordChange, #PasswordChangeChk").prop("disabled", false);
                        $('#ssoCd').text("");
                    }
                }
                // console.log('ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì„±ê³µ: ', response);
            },
            error: function (xhr, status, error) {
                // AJAX í˜¸ì¶œ ì‹¤íŒ¨ ì‹œ ì²˜ë¦¬í•  ë¡œì§
                console.error('ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: ', error);
            }
        });

    }

    function formatDate(dateString) {
        if (!dateString || dateString.length !== 6) return ""; // ì˜ˆì™¸ ì²˜ë¦¬

        let yearPart = dateString.substring(0, 2); // ì—°ë„ ë¶€ë¶„ (00, 01, ..., 99)
        let month = dateString.substring(2, 4); // ì›”
        let day = dateString.substring(4, 6); // ì¼

        // âœ… "00"~"49" â†’ 2000ë…„ëŒ€, "50"~"99" â†’ 1900ë…„ëŒ€
        let fullYear = (parseInt(yearPart, 10) >= 50) ? `19${yearPart}` : `20${yearPart}`;

        return `${fullYear}-${month}-${day}`;
    }


    function upUserInfo() {
        const userId = $('#login_id').val();
        const userNm = $('#name').val();
        const birthYear = $('#birthYear').val();
        const sexYn = $('#sexYn').val();
        const postCd = $('#postno').val();
        const userAddr = $('#address1').val();
        const userHp = $('#userHp').val().replace(/-/g, "");
        const userMail = $('#userMail').val();
        const password = $('#PasswordChange').val();
        const password2 = $('#PasswordChangeChk').val();

        if (!userId || !userNm || !userHp || !userMail) {
            Alert.alert('', 'ëª¨ë“  í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        if (password !== password2) {
            Alert.alert('', 'ë¹„ë°€ë²ˆí˜¸ê°€ ë§ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            return;
        }

        // ë¹„ë°€ë²ˆí˜¸ê°€ ë¹„ì–´ ìˆìœ¼ë©´ nullë¡œ ì„¤ì • (ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì•ˆ í•¨)
        const passwordValue = password.trim() !== "" ? password : null;

        $.ajax({
            url: '/mobile/userInfo/update', // ì‚¬ìš©ì ì •ë³´ ì—…ë°ì´íŠ¸ URL
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                userId: userId,
                userNm: userNm,
                birthYear: birthYear,
                sexYn: sexYn,
                postCd: postCd,
                userAddr: userAddr,
                userHp: userHp,
                userMail: userMail,
                loginPw: passwordValue
            }),
            headers: {
                'X-CSRF-Token': $('[name=_csrf]').val() // CSRF í† í° ì¶”ê°€
            },
            success: function (response) {
                if (response.success) {
                    Alert.alert('', 'ì‚¬ìš©ì ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    UserInfo();
                } else {
                    Alert.alert('', 'ìˆ˜ì • ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + response.message);
                }
            },
            error: function (xhr, status, error) {
                console.error('ì‚¬ìš©ì ì •ë³´ ìˆ˜ì • ì‹¤íŒ¨: ', error);
                Alert.alert('', 'ì‚¬ìš©ì ì •ë³´ ìˆ˜ì • ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        });
    }

    document.querySelectorAll('.toggle-password').forEach(icon => {
        icon.addEventListener('click', () => {
            const targetId = icon.getAttribute('data-target');
            const inputField = document.getElementById(targetId);

            if (inputField.type === 'password') {
                inputField.type = 'text';
                icon.style.backgroundImage = "url('/images/icon/btn-hidden.svg')"; // ë¹„ë°€ë²ˆí˜¸ ë³´ì„ ìƒíƒœ
            } else {
                inputField.type = 'password';
                icon.style.backgroundImage = "url('/images/icon/btn-show.svg')"; // ë¹„ë°€ë²ˆí˜¸ ìˆ¨ê¹€ ìƒíƒœ
            }
        });
    });

    $('.btn-popup-close').on('click', function () {
        $('.popup-overlay').fadeOut(200);
        $('.popup-wrapper').removeClass('active');
    });

    function formatPhoneNumber(number) {
        if (!number) return "";
        let rawNumber = number.replace(/\D/g, ""); // ìˆ«ìë§Œ ìœ ì§€
        if (rawNumber.length === 11) {
            return rawNumber.replace(/(\d{3})(\d{4})(\d{4})/, "$1-$2-$3");
        } else if (rawNumber.length === 10) {
            return rawNumber.replace(/(\d{3})(\d{3})(\d{4})/, "$1-$2-$3");
        }
        return rawNumber; // ë³€í™˜ ë¶ˆê°€ëŠ¥í•œ ê²½ìš° ì›ë³¸ ë°˜í™˜
    }

    $(document).ready(function () {
        let userHpInput = $("#userHp");

        // ğŸ”¥ ì…ë ¥ í•„ë“œê°€ í¬ì»¤ìŠ¤ë¥¼ ë°›ì„ ë•Œ '-' ì œê±°
        userHpInput.on("focus", function () {
            let rawNumber = $(this).val().replace(/-/g, ""); // í•˜ì´í”ˆ ì œê±°
            $(this).val(rawNumber);
        });

        // ğŸ”¥ ì…ë ¥ í•„ë“œì—ì„œ í¬ì»¤ìŠ¤ë¥¼ ìƒìœ¼ë©´ '-' ì¶”ê°€í•˜ì—¬ í¬ë§· ì ìš©
        userHpInput.on("blur", function () {
            let rawNumber = $(this).val().replace(/\D/g, ""); // ìˆ«ìë§Œ ë‚¨ê¹€
            let formattedNumber = formatPhoneNumber(rawNumber);
            $(this).val(formattedNumber);
        });

        // ğŸ”¥ ì…ë ¥í•  ë•Œ ìë™ìœ¼ë¡œ í•˜ì´í”ˆì´ ì ìš©ë˜ë„ë¡ ì²˜ë¦¬
        userHpInput.on("input", function () {
            let rawNumber = $(this).val().replace(/\D/g, ""); // ìˆ«ìë§Œ ìœ ì§€
            $(this).val(rawNumber);
        });

        // ğŸ”¥ í˜ì´ì§€ê°€ ë¡œë“œë  ë•Œ ì¦‰ì‹œ í•˜ì´í”ˆ ì¶”ê°€
        let initialUserHp = userHpInput.val();
        if (initialUserHp) {
            userHpInput.val(formatPhoneNumber(initialUserHp));
        }
    });


</script>
</body>
</html>
