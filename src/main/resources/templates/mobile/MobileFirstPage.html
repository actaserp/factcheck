<!DOCTYPE html>
<html lang="ko">
<style>
    .btn-clear {
        display: none !important; /* ê°•ì œë¡œ ìˆ¨ê¹€ */
    }

    .btn-close {
        display: none !important; /* ê°•ì œë¡œ ìˆ¨ê¹€ */
    }

</style>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>>FACT CHECK - ëª¨ë°”ì¼</title>
  <link rel="shortcut icon" href="/img/favicon.ico">
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/smoothness/jquery-ui.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/> <!-- Slide css -->
  <link rel="stylesheet" href="/resource/ax5ui/ax5ui.all.css">
  <link rel="stylesheet" type="text/css" href="/assets_mobile/css/import.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>

  <script src="/assets_mobile/js/ui.js"></script> <!-- Common js -->
  <script th:inline="javascript">
    var sandanData = /*[[${session.sandanList}]]*/ [];
  </script>


  <script type="text/javascript" src="/resource/ax5ui/ax5ui.all.min.js?v=1000"></script>

  <script type="text/javascript" src="/js/ax5commUtil.js?v=1070"></script>

  <script src="/js/common.js?v=1060"></script>
  <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script> <!-- Slide js -->
</head>

<body>
<div class="mobile-wrapper page-ticket-list"><!-- â˜…í˜ì´ì§€ Classëª… -->
  <!-- [ëª¨ë°”ì¼] í—¤ë”  -->
  <div class="mobile-layout-header">
    <header>
      <div class="left">
        <h2>FACT CHECK</h2>
      </div>
    </header>
  </div> <!-- //mobile-layout-header end-->

  <!-- [ëª¨ë°”ì¼] ë©”ë‰´  -->
  <div th:insert="~{mobile/mobile_menu :: mobile_menu}"></div>
  <!-- [ëª¨ë°”ì¼] ì»¨ë´ì¸   -->
  <div class="mobile-layout-contents">
    <!--- (ë ˆì´ì•„ì›ƒ) Contents ì˜ì—­ -->
    <div class="layout-contents">
      <!-- ê²€ìƒ‰ ì˜ì—­  -->
      <div class="search-wrap">

      </div>
      <!-- ì»¨í…ì¸  ì˜ì—­  -->
      <div class="contents-wrap">
        <dl style="margin-bottom: 10px">
          <button onclick="openModal()" style="margin-bottom: 10px">ì£¼ì†Œ ê²€ìƒ‰</button>

          <div id="postcodeModal" class="modal" style="display: none">
            <div class="modal-content">
              <div style="display: flex">
                <div class="modal-header">ì£¼ì†Œ ê²€ìƒ‰</div>
                <button class="modal-close" onclick="closeModal()" style="width: 30px; margin-left: auto">Ã—</button>
              </div>
              <div id="postcodeContainer" style="width: 100%;"></div>
            </div>
          </div>

          <div>
            <input type="hidden" id="postno" readonly>
            <label for="address1">ë„ë¡œëª… ì£¼ì†Œ:</label>
            <input type="text" id="address1" readonly><br>
            <div id="guide" style="display:none; color: #888; font-size: 14px;"></div>
          </div>
          <div>
            <label for="address2">ìƒì„¸ ì£¼ì†Œ:</label>
            <input type="text" id="address2" placeholder="ìƒì„¸ì£¼ì†Œë¥¼ ê²€ìƒ‰"><br>
          </div>
          <button onclick="searchGoyuList()" style="margin-top: 10px">ìƒì„¸ ì£¼ì†Œ í™•ì¸</button>
        </dl>
      </div> <!--// contents-wrap end-->
    </div> <!--//layout-contents end -->

  </div> <!-- //mobile-layout-contents end-->
</div> <!-- //page-wrapper end-->
<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<script th:inline="javascript">
  // // Thymeleafì—ì„œ ê°’ ì„¤ì •: Null ì²´í¬ì™€ ê¸°ë³¸ê°’ ì²˜ë¦¬
  // var groupid = [[${session.groupid != null ? session.groupid : 'null'}]];
  // var id = /*[[${id != null ? id : 'null'}]]*/;
  // var groupname = /*[[${groupname != null ? groupname : 'null'}]]*/;
  // var username = /*[[${username != null ? username : 'null'}]]*/;
  //
  // // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— ê°’ ìœ ì§€ (null ë˜ëŠ” ë¹ˆ ë¬¸ìì—´ì€ ì €ì¥í•˜ì§€ ì•ŠìŒ)
  // if (groupid && groupid !== 'null') localStorage.setItem('groupid', groupid);
  // if (id && id !== 'null') localStorage.setItem('id', id);
  // if (username && username !== 'null') localStorage.setItem('username', username);
  // if (groupname && groupname !== 'null') localStorage.setItem('groupname', groupname);
</script>
<script>
  function openModal() {
    document.getElementById('postcodeModal').style.display = 'block';

    new daum.Postcode({
      oncomplete: function (data) {
        var roadAddr = data.roadAddress;
        var extraRoadAddr = '';

        if (data.bname !== '' && /[ë™|ë¡œ|ê°€]$/g.test(data.bname)) {
          extraRoadAddr += data.bname;
        }
        if (data.buildingName !== '' && data.apartment === 'Y') {
          extraRoadAddr += (extraRoadAddr !== '' ? ', ' + data.buildingName : data.buildingName);
        }
        if (extraRoadAddr !== '') {
          extraRoadAddr = ' (' + extraRoadAddr + ')';
        }

        document.getElementById('postno').value = data.zonecode;
        document.getElementById('address1').value = roadAddr;

        var guideTextBox = document.getElementById("guide");
        if (data.autoRoadAddress) {
          var expRoadAddr = data.autoRoadAddress + extraRoadAddr;
          guideTextBox.innerHTML = '(ì˜ˆìƒ ë„ë¡œëª… ì£¼ì†Œ : ' + expRoadAddr + ')';
          guideTextBox.style.display = 'block';
        } else if (data.autoJibunAddress) {
          var expJibunAddr = data.autoJibunAddress;
          guideTextBox.innerHTML = '(ì˜ˆìƒ ì§€ë²ˆ ì£¼ì†Œ : ' + expJibunAddr + ')';
          guideTextBox.style.display = 'block';
        } else {
          guideTextBox.innerHTML = '';
          guideTextBox.style.display = 'none';
        }

        closeModal();
      },
      onresize: function (size) {
        // ë™ì  ìŠ¤íƒ€ì¼ ì ìš©
        const layers = document.querySelectorAll('[id^="__daum__layer_"]');
        layers.forEach(layer => {
          layer.style.width = '100%';
          layer.style.height = '500px';
          layer.style.overflow = 'hidden';
          layer.style.backgroundColor = '#fff';
        });
      }

    }).embed(document.getElementById('postcodeContainer'));
  }

  function closeModal() {
    document.getElementById('postcodeModal').style.display = 'none';
  }
</script>
<script type="text/javascript">

  // ìƒì„¸ì£¼ì†Œ ì¡°íšŒ
  function searchGoyuList() {
    isUserLoggedIn(function (isLoggedIn) {
      if (!isLoggedIn) {
        Alert.alert('', "ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
        window.location.href = "/mobile/mlogin"; // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë””ë ‰ì…˜
        return;
      }

      let data2 = [];
      if (document.getElementById('address1').value === "") {
        Alert.alert('', 'ì£¼ì†Œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”');
        return false;
      }

      $.ajax({
        url: '/api/tilko/searchGoyuList',
        type: 'GET',
        data: {
          'address1': $('#address1').val() + " " + $('#address2').val()
        },
        async: false,
        success: function (data) {
          data2 = data.data;
          console.log("data2", data);

          const listAddressWrap = document.getElementById('addressWrap');
          const availableColors = [
            'card-blue', 'card-green', 'card-black',
            'card-red', 'card-yellow', 'card-purple'
          ];
          listAddressWrap.innerHTML = ''; // ê¸°ì¡´ ë‚´ìš©ì„ ì´ˆê¸°í™”

          // ìƒ‰ìƒì„ ìˆœí™˜ì ìœ¼ë¡œ í• ë‹¹í•˜ê¸° ìœ„í•œ ì¸ë±ìŠ¤
          let colorIndex = 0;
          let htmlContent = '';

          // Gubun ë°ì´í„°ì—ì„œ 'í† ì§€' ë°ì´í„° ì œì™¸ í›„ í™”ë©´ì— ì¶œë ¥
          data2.forEach(data => {
            const cardColor = availableColors[colorIndex];
            colorIndex = (colorIndex + 1) % availableColors.length;

            if (data.Gubun !== 'í† ì§€') {
              // ë²„íŠ¼ ì²˜ë¦¬
              let buttonsHtml = `<button class="btn btn-popup-open"
                                                    data-popup="popup-history" title="ë“±ê¸°ë¶€">
                                                ë“±ê¸°ë¶€ ì¡°íšŒ
                                            </button>`;

              // rd_addr_detailì—ì„œ íƒœê·¸ ì œê±° í›„ ì ìš©
              let cleanAddress = stripHtmlTags(data.rd_addr_detail).replace(/\s+/g, '');

              htmlContent += `
                            <div class="card-box ${cardColor}" data-Goyu="${data.pin}">
                                <div class="card-cont">
                                    <dl><dt>ê³ ìœ ë²ˆí˜¸</dt><dd>${data.pin}</dd></dl>
                                    <dl><dt>ì£¼ì†Œ</dt><dd>${cleanAddress}</dd></dl>
                                    <dl><dt>êµ¬ë¶„</dt><dd>${data.real_cls_cd}</dd></dl>
                                    <dl><dt>ìƒíƒœ</dt><dd>${data.use_cls_cd}</dd></dl>
                                </div>
                                ${buttonsHtml}
                            </div>
                        `;
            } else {
              console.log("í† ì§€ë°ì´í„° ì œì™¸ë¨");
            }
          });

          listAddressWrap.insertAdjacentHTML('beforeend', htmlContent);

          // ì´ë²¤íŠ¸ ìœ„ì„ ì¶”ê°€
          listAddressWrap.addEventListener('click', (event) => {
            const button = event.target.closest('.btn-popup-open[data-popup="popup-history"]');
            if (!button) return; // í´ë¦­ëœ ìš”ì†Œê°€ ë²„íŠ¼ì´ ì•„ë‹Œ ê²½ìš° ë¬´ì‹œ

            const cardBox = button.closest('.card-box');
            const goyuNum = cardBox.getAttribute('data-Goyu');

            // ë°ì´í„° ì°¾ê¸°
            const item = data2.find(d => d.pin === goyuNum);
            if (item) {
              searchaddress(item);
            }
          });
        }
      });
    });
  }

  // HTML íƒœê·¸ ì œê±° í•¨ìˆ˜
  function stripHtmlTags(html) {
    let tempDiv = document.createElement("div");
    tempDiv.innerHTML = html;
    return tempDiv.textContent || tempDiv.innerText || "";
  }

  // ì‚¬ìš©ì ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
  function isUserLoggedIn(callback) {
    $.ajax({
      url: '/account/userinfo2',
      type: 'GET',
      dataType: 'json',
      success: function (response) {
        if (response.success) {
          console.log("ë¡œê·¸ì¸ ìƒíƒœ: ì‚¬ìš©ì ì •ë³´ í™•ì¸ë¨");
          callback(true);
        } else {
          console.error("ë¡œê·¸ì¸ë˜ì§€ ì•ŠìŒ:", response.message);
          callback(false);
        }
      },
      error: function (xhr, status, error) {
        console.error("ë¡œê·¸ì¸ ì²´í¬ ì‹¤íŒ¨:", status, error);

        if (xhr.status === 401) {
          try {
            // ì‘ë‹µì´ ë¹„ì–´ ìˆëŠ” ê²½ìš° ëŒ€ë¹„ (JSON íŒŒì‹± ì˜¤ë¥˜ ë°©ì§€)
            let response = xhr.responseText && xhr.responseText.trim() ? JSON.parse(xhr.responseText) : {};
            let redirectUrl = response.redirectUrl || "/mobile/mlogin"; // ê¸°ë³¸ì ìœ¼ë¡œ /mobile/mlogin ì‚¬ìš©

            console.log("401 Unauthorized ë°œìƒ â†’ " + redirectUrl + " ìœ¼ë¡œ ì´ë™");
            alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.");

            // ğŸš€ ê°•ì œ ì´ë™
            window.location.replace(redirectUrl);
          } catch (e) {
            console.error("JSON íŒŒì‹± ì˜¤ë¥˜:", e);
            window.location.replace("/mobile/mlogin"); // JSON íŒŒì‹± ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
          }
        } else {
          console.error("ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜ ë°œìƒ:", xhr.responseText);
        }
        callback(false);
      }
    });
  }

  function searchaddress(data) {
    console.log("data : ", data)
    $.ajax({
      url: '/api/tilko/searchaddress',
      type: 'GET',
      data: {
        "GoyuNUM": data.pin,
        "address": data.rd_addr
      },
      async: false,
      success: function (response) {
        let data2 = response.data;
        console.log("data2", data2);

        // API ì‘ë‹µì—ì„œ í•„ìš”í•œ ê°’ ì¶”ì¶œ í›„ sessionStorageì— ì €ì¥
        let resultMap = {
          "REALSCORE": data2.REALSCORE,
          "GRADE": data2.GRADE,
          "COMMENT": data2.COMMENT,
          "ADDRESS": data2.ADDRESS
        };
        sessionStorage.setItem("resultMap", JSON.stringify(resultMap));

        // search_card í˜ì´ì§€ë¡œ ì´ë™
        window.location.href = "search_card";
      },
      error: function (error) {
        console.error("Error in API call:", error);
      }
    });
  }


</script>
</body>
</html>
