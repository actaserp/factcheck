<!DOCTYPE html>
<html lang="ko">
<style>
    .btn-clear {
        display: none !important; /* ê°•ì œë¡œ ìˆ¨ê¹€ */
    }

    .btn-close {
        display: none !important; /* ê°•ì œë¡œ ìˆ¨ê¹€ */
    }
    .table-container {
        position: relative;
    }
    .address {
        word-wrap: break-word;  /* ê¸´ ë‹¨ì–´ë„ ê°•ì œë¡œ ì¤„ë°”ê¿ˆ */
        white-space: normal;  /* ê¸°ë³¸ì ì¸ ì¤„ë°”ê¿ˆ í—ˆìš© */
        max-width: 200px; /* ì›í•˜ëŠ” ìµœëŒ€ ë„ˆë¹„ ì§€ì • */
    }
    /* ìŠ¤í”¼ë„ˆë¥¼ ì§€ë„ ìœ„ ì¤‘ì•™ì— ë°°ì¹˜ */
    #loading-spinner {
        position: fixed;
        top: 40%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 1000; /* ì§€ë„ë³´ë‹¤ ìœ„ì— ë°°ì¹˜ */
        display: none; /* ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€ */
    }

    /* ì§€ë„ ì»¨í…Œì´ë„ˆë¥¼ ìƒëŒ€ ìœ„ì¹˜ë¡œ ì„¤ì •í•´ì•¼ `absolute`ê°€ ì ìš©ë¨ */
    #map {
        position: relative;
    }



</style>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FACT CHECK</title>
  <link rel="icon" type="image/png" href="/images/logo/icon_FACT%20CHECK.png">

  <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/smoothness/jquery-ui.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/> <!-- Slide css -->
  <link rel="stylesheet" href="/resource/ax5ui/ax5ui.all.css">
  <link rel="stylesheet" type="text/css" href="/assets_mobile/css/import.css">
  <link rel="stylesheet" type="text/css" href="/css/MapStyle.css">
  <link rel="stylesheet" type="text/css" href="/css/loading.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>

  <script src="/assets_mobile/js/ui.js"></script> <!-- Common js -->
  <script th:inline="javascript">
    var sandanData = /*[[${session.sandanList}]]*/ [];
  </script>
  <script type="text/javascript" src="/resource/ax5ui/ax5ui.all.min.js?v=1000"></script>
  <script type="text/javascript" src="/js/ax5commUtil.js?v=1070"></script>
  <script src="/js/common.js?v=1060"></script>
  <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script> <!-- Slide js -->
  <script src="/js/Mobile.js"></script>
</head>
<div class="mobile-wrapper page-kakaoMap2"><!-- â˜…í˜ì´ì§€ Classëª… -->
  <!-- [ëª¨ë°”ì¼] í—¤ë”  -->
  <div class="mobile-layout-header">
    <header>
      <div class="left">
        <a href="#" title="ì „ì²´ë©”ë‰´" class="logo">
        </a>
      </div>
      <div class="center" style="margin-left:10px;">
        <h2>ì§€ì—­ë³„ ë“±ê¸° ìƒí™©ë§µ(ì§€ë„ë¡œ ë³´ê¸°)</h2>
      </div>
      <div class="right">
        <a href="#" title="ì „ì²´ë©”ë‰´" class="btn-menu">
          <img src="/assets_mobile/images/icon/btn-menu.svg" alt="ì „ì²´ë©”ë‰´ ì•„ì´ì½˜">
        </a>
      </div>
    </header>
  </div> <!-- //mobile-layout-header end-->

  <!-- [ëª¨ë°”ì¼] ë©”ë‰´  -->
  <div th:insert="~{mobile/mobile_menu :: mobile_menu}"></div>
  <!-- [ëª¨ë°”ì¼] ì»¨ë´ì¸   -->
  <div class="mobile-layout-contents">
    <!--- (ë ˆì´ì•„ì›ƒ) Contents ì˜ì—­ -->
    <div class="layout-contents" style="width:100%;height:auto;">
      <!-- ì»¨í…ì¸  ì˜ì—­  -->
      <div class="contents-wrap">
        <div>
          <li style="margin-top: 5% ">
            <a href="#" class="btn btn-popup-open" data-popup="popup1" onclick="regionList()"
               title="ì§€ì—­ì„ íƒ">ì§€ì—­ ì„ íƒ</a>
          </li>
        </div>
        <div style=" margin-top: 5%">
          <span id="selected-region" style="font-size: 20px; font-weight: bold; color: #333;"></span>
        </div>
        <!-- ë¡œë”© ìŠ¤í”¼ë„ˆ ì¶”ê°€ -->
        <div id="loading-spinner" class="loadingio-spinner-spinner-nq4q5u6dq7r">
            <div class="ldio-x2uulkbinbj">
              <div></div><div></div><div></div><div></div><div></div><div></div>
              <div></div><div></div><div></div><div></div><div></div><div></div>
            </div>
        </div>

        <div id="map" style="width:100%;height: 65vh ; flex-grow: 1;"></div>

        <div class="table-container">
          <table class="table table-striped" style="width: 100%; border-collapse: collapse; margin-top: 10px;">
            <thead>
            <tr>
              <th style="width: 10%; text-align: center;">NO</th>
              <th style="width: 60%; text-align: left;">ì£¼ì†Œ</th>
            </tr>
            </thead>
            <tbody id="search-results">
            <!-- ë°ì´í„°ê°€ ì—¬ê¸°ì— ì‚½ì…ë¨ -->
            </tbody>
          </table>
        </div>


      </div>  <!--// contents-wrap end-->
    </div> <!--//layout-contents end -->
  </div> <!-- //mobile-layout-contents end-->

  <div class="mobile-layout-popup">
    <div class="popup-overlay"></div>
    <div class="popup-wrapper" id="popup1">
      <form id="bomForm1">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
        <div class="popup-title">
          <h3>ì§€ì—­ ì„ íƒ</h3>
          <a onclick="RegisterUserClose()" title="íŒì—…ë‹«ê¸°" class="btn-popup-close">
            <img src="/assets_mobile/images/icon/btn-popup-close.svg" alt="ë‹«ê¸°">
          </a>
        </div>
        <div class="popup-contents">
          <div class="table-wrap" id="bomForm">
            <div class="write-wrap">
              <div class="row">
                <dl>
                  <dt>
                  </dt>
                  <dd>
                    <div id="region-modal" style="display: none;">
                      <div id="region-SelectList" style="font-size: 20px; margin-bottom:25px; "></div>
                      <div id="region-list"></div>
                    </div>
                  </dd>
                </dl>
              </div>
            </div>
          </div>
        </div>
        <div class="popup-button">
          <button type="button" class="btn-navy" id="btnSaveAuth" onclick="moveToSelectedRegion()">ì§€ì—­ ê²€ìƒ‰</button>
        </div>
      </form>
    </div>
  </div> <!-- //mobile-layout-popup end -->

  <div class="mobile-layout-popup" >

    <div class="popup-wrapper" id="popup-own">
      <div class="popup-title">
        <h3>ìƒì„¸ ë‚´ì—­</h3>
        <a title="íŒì—…ë‹«ê¸°" class="btn-popup-close">
          <img src="/assets_mobile/images/icon/btn-popup-close.svg" alt="ë‹«ê¸°">
        </a>
      </div>
      <div class="popup-contents">
        <div class="ticket-tit">
          <dl>
            <dt>ì£¼ì†Œ</dt>
            <dd></dd>
          </dl>
        </div>
        <div class="list-card-wrap">

        </div>
        <div class="write-wrap">

        </div>
      </div>
      <div class="popup-button">
        <button class="btn-popup-close btn-navy">í™•ì¸</button>
      </div>
    </div>
  </div>

</div> <!-- //page-wrapper end-->
<body>
<script type="text/javascript">
  document.readyState === 'complete' ? init() : window.onload = init;
  let map;

  let selectedPath = {
    city: '',  // ì„ íƒí•œ ì‹œ/ë„
    district: '', // ì„ íƒí•œ êµ¬
    neighborhood: '' // ì„ íƒí•œ ë™
  };

  function init() {
    loadKakaoMapScript();

    localStorage.removeItem('loadedRegions'); // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ì‚­ì œ
    loadedRegions = new Set();
    //console.log("ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì´ˆê¸°í™”ë¨. loadedRegions:", loadedRegions);
  }

  //ì§€ì—­ì„ íƒ íŒì—…ì—´ê¸°
  function regionList() {
    let popup = document.getElementById('popup1');
    let overlay = document.querySelector('.popup-overlay');

    if (popup && overlay) {
      popup.classList.add('active'); // íŒì—… í™œì„±í™”
      overlay.style.display = 'block'; // ì˜¤ë²„ë ˆì´ ë³´ì´ê¸°
    } else {
      console.error('popup1 ë˜ëŠ” popup-overlay ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }
    fetchRegionDataAjax();
  }

  function RegisterUserClose() {
    let popup = document.getElementById('popup1');
    let overlay = document.querySelector('.popup-overlay');

    if (popup && overlay) {
      // íŒì—… ë¹„í™œì„±í™”
      popup.classList.remove('active');

      // ì˜¤ë²„ë ˆì´ ìˆ¨ê¸°ê¸°
      overlay.style.display = 'none';
      $('#region-SelectList').empty(); // ì„ íƒí•œ ê²½ë¡œ ì´ˆê¸°í™”
      selectedPath = {city: '', district: '', neighborhood: ''}; // ì„ íƒ ê²½ë¡œ ì´ˆê¸°í™”
      // ì…ë ¥ í¼ ì´ˆê¸°í™”
    } else {
      console.error('popup1 ë˜ëŠ” popup-overlay ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }
  }

  //ëª¨ë‹¬ ë###############################################

  // ì„œë²„ë¥¼ í†µí•´ ì¹´ì¹´ì˜¤ ì§€ë„ ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ
  function loadKakaoMapScript() {
    $.ajax({
      url: '/api/Map/script',
      type: 'GET',
      dataType: 'text',
      headers: {
        'X-CSRF-Token': $('[name=_csrf]').val()
      },
      success: function (scriptUrl) {

        // ê¸°ì¡´ script íƒœê·¸ ì œê±° (ì¤‘ë³µ ë°©ì§€)
        const existingScript = document.querySelector("script[src^='https://dapi.kakao.com/v2/maps/sdk.js']");
        if (existingScript) {
          existingScript.remove();
        }

        // ìƒˆë¡œìš´ script íƒœê·¸ ìƒì„± ë° ì‚½ì…
        const scriptElement = document.createElement('script');
        scriptElement.type = 'text/javascript';
        scriptElement.src = scriptUrl + "&libraries=clusterer,services&autoload=false";
        scriptElement.async = false;
        document.head.appendChild(scriptElement);

        scriptElement.onload = function () {
          console.log("ì¹´ì¹´ì˜¤ ì§€ë„ ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì™„ë£Œ");

          // ë¡œë”© ì™„ë£Œ í›„, Kakao API ê°ì²´ ì´ˆê¸°í™”
          if (typeof kakao === "undefined" || typeof kakao.maps === "undefined") {
            console.error("Kakao ì§€ë„ APIê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
            return;
          }

          // Kakao APIì˜ load ë©”ì„œë“œë¥¼ ì‚¬ìš©í•´ ì´ˆê¸°í™” ì§„í–‰
          kakao.maps.load(function () {
            initializeMap(); // ì§€ë„ ì´ˆê¸°í™” í˜¸ì¶œ

            //ì§€ë„ ì»¨íŠ¸ë¡¤ëŸ¬
            if (window.map) {
              var zoomControl = new kakao.maps.ZoomControl();
              window.map.addControl(zoomControl, kakao.maps.ControlPosition.RIGHT);
              console.log("ZoomControl ì¶”ê°€ ì™„ë£Œ");
            } else {
              console.error("ì§€ë„ ê°ì²´ê°€ ì•„ì§ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
            }

          });
        };

        scriptElement.onerror = function () {
          console.error("ì¹´ì¹´ì˜¤ ì§€ë„ ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        };
      },
      error: function (xhr, status, error) {
        console.error("ì¹´ì¹´ì˜¤ ì§€ë„ ìŠ¤í¬ë¦½íŠ¸ ìš”ì²­ ì‹¤íŒ¨:", error);
      }
    });
  }

  //   ë“±ê¸‰ë³„ í´ëŸ¬ìŠ¤í„° ìƒ‰ìƒ ë§¤í•‘
  var gradeColors = {
    "S": "#B0E57C",   // ì—°ë‘ìƒ‰ (ë§¤ìš° ì•ˆì „)
    "A": "#00A36C",   // ì´ˆë¡ìƒ‰ (ì•ˆì „)
    "B": "#3399FF",   // íŒŒë€ìƒ‰ (ë³´í†µ)
    "C": "#FFCC00",   // ë…¸ë€ìƒ‰ (ì£¼ì˜)
    "D": "#FF9900",   // ì§„í•œ ì£¼í™©ìƒ‰ (ê²½ê³ )
    "E": "#FF3333",   // ë¹¨ê°„ìƒ‰ (ìœ„í—˜)
    "F": "#000000"    // ê²€ì€ìƒ‰ (ë§¤ìš° ìœ„í—˜)
  };

  // ì§€ë„ ì´ˆê¸°í™” í•¨ìˆ˜
  function initializeMap() {
    try {
      const container = document.getElementById('map');
      if (!container) {
        throw new Error("ì§€ë„ë¥¼ í‘œì‹œí•  #map ìš”ì†Œê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
      }

      const options = {
        center: new kakao.maps.LatLng(37.5665, 126.9780), // ì„œìš¸íŠ¹ë³„ì‹œ ì¤‘ì‹¬ ì¢Œí‘œ
        level: 3 // í™•ëŒ€ ë ˆë²¨
      };

      window.map = new kakao.maps.Map(container, options);
      console.log("Kakao ì§€ë„ ì´ˆê¸°í™” ì™„ë£Œ");

      // í´ëŸ¬ìŠ¤í„°ëŸ¬ ìƒì„±
      if (!window.clusterer) {
        window.clusterer = new kakao.maps.MarkerClusterer({
          map: window.map,
          averageCenter: true,
          minLevel: 3
        });
        console.log("í´ëŸ¬ìŠ¤í„°ëŸ¬ ìƒì„± ì™„ë£Œ");

        // í´ëŸ¬ìŠ¤í„° ìƒ‰ìƒ ë³€ê²½ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        kakao.maps.event.addListener(window.clusterer, 'clustered', function (clusters) {
          clusters.forEach(cluster => {
            var markers = cluster.getMarkers();
            if (markers.length === 0) return;

            // í´ëŸ¬ìŠ¤í„° ë‚´ì—ì„œ ê°€ì¥ ë§ì´ ë“±ì¥í•œ ë“±ê¸‰ ì°¾ê¸°
            var gradePriority = ["F", "E", "D", "C", "B", "A", "S"];
            var gradeCount = {};

            markers.forEach(marker => {
              var markerGrade = marker.markerData?.grade || "S"; // ê¸°ë³¸ê°’ "S"
              gradeCount[markerGrade] = (gradeCount[markerGrade] || 0) + 1;
            });

            var highestGrade = Object.entries(gradeCount).reduce((topGrade, current) => {
              var [grade, count] = current;
              if (
                count > (gradeCount[topGrade] || 0) ||
                (count === gradeCount[topGrade] && gradePriority.indexOf(grade) < gradePriority.indexOf(topGrade))
              ) {
                return grade;
              }
              return topGrade;
            }, "S");

            var backgroundColor = gradeColors[highestGrade] || "#3399FF";

            // í´ëŸ¬ìŠ¤í„° ë§ˆì»¤ ìŠ¤íƒ€ì¼ ë³€ê²½
            var clusterMarker = cluster.getClusterMarker();
            clusterMarker.setContent(`
                        <div style="
                            min-width: 50px;
                            height: 50px;
                            padding: 10px;
                            color: white;
                            font-size: 14px;
                            font-weight: bold;
                            line-height: 30px;
                            text-align: center;
                            border: 3px solid white;
                            border-radius: 50%;
                            background-color: ${backgroundColor};
                            box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
                            white-space: nowrap;
                            position: relative;
                            z-index: 2;">
                           ${markers.length} ê°œ
                        </div>
                    `);
          });
        });
      } else {
        console.error("ì§€ë„ ê°ì²´ ì´ˆê¸°í™” ì‹¤íŒ¨");
        return;
      }

      // ì§€ë„ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ (`idle` ì‚¬ìš©)
      kakao.maps.event.addListener(window.map, 'idle', function () {
        var center = window.map.getCenter();
        getRegionFromCoords(center, function (regionName, gugunName) {
          if (regionName && gugunName) {
            let regionKey = `${regionName} ${gugunName}`;

            if (!loadedRegions.has(regionKey)) {
              loadMarkersForRegion(regionName, gugunName);
              loadedRegions.add(regionKey);
              localStorage.setItem('loadedRegions', JSON.stringify(Array.from(loadedRegions)));
            }
          }
        });
      });
    } catch (error) {
      console.error("Kakao ì§€ë„ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
    }
  }

  // localStorageì—ì„œ ê¸°ì¡´ ì €ì¥ëœ ì§€ì—­ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° (ì—†ìœ¼ë©´ ë¹ˆ ë°°ì—´)
  var loadedRegions = new Set(JSON.parse(localStorage.getItem('loadedRegions')) || []);

  // ì¢Œí‘œë¥¼ ì‹œ/êµ¬ ì´ë¦„ìœ¼ë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
  function getRegionFromCoords(coords, callback) {
    var geocoder = new kakao.maps.services.Geocoder();

    geocoder.coord2RegionCode(coords.getLng(), coords.getLat(), function (result, status) {
      if (status === kakao.maps.services.Status.OK) {
        var regionInfo = result[0]; // ê°€ì¥ ê°€ê¹Œìš´ í–‰ì •êµ¬ì—­ ì •ë³´
        let regionName = regionInfo.address_name.split(" ")[0]; // ì˜ˆ: "ì„œìš¸íŠ¹ë³„ì‹œ"
        let gugunName = regionInfo.address_name.split(" ")[1]; // ì˜ˆ: "ê°•ë‚¨êµ¬"
        callback(regionName, gugunName);
      } else {
        console.warn("ì¢Œí‘œë¥¼ ì§€ì—­ëª…ìœ¼ë¡œ ë³€í™˜í•˜ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        callback(null, null);
      }
    });
  }

  let isMapLoading = false;

  function moveToSelectedRegion() {
    if (!window.map) {
      if (!isMapLoading) {
        isMapLoading = true;
        console.warn("ì§€ë„ ê°ì²´ê°€ ì•„ì§ ì´ˆê¸°í™”ë˜ì§€ ì•ŠìŒ, 500ms í›„ ì¬ì‹œë„...");
        setTimeout(() => {
          isMapLoading = false;  // ë‹¤ìŒ ì‹¤í–‰ì„ í—ˆìš©
          moveToSelectedRegion();
        }, 500);
      }
      return;
    }

    const regionName = `${selectedPath.city} ${selectedPath.district} ${selectedPath.neighborhood}`.trim();
    if (!regionName) {
      Alert.alert('', "ì§€ì—­ì„ ì„ íƒí•´ì£¼ì„¸ìš”!");
      return;
    }
    // ìŠ¤í”¼ë„ˆ ë³´ì´ê¸°
    $("#loading-spinner").show();

    $.ajax({
      url: "/api/Map/coordinates",
      type: "GET",
      data: {name: regionName},
      headers: {
        'X-CSRF-Token': $('[name=_csrf]').val()
      },
      success: function (response) {
        if (response.success) {
          const latitude = response.lat;
          const longitude = response.lng;
          RegisterUserClose(); // ì§€ì—­ ì„ íƒ ì‹œ ëª¨ë‹¬ ë‹«ê¸°

          if (window.map) {
            const newCenter = new kakao.maps.LatLng(latitude, longitude);
            window.map.setCenter(newCenter);
            console.log(`ì§€ë„ ì¤‘ì‹¬ì´ ${regionName}(${latitude}, ${longitude})ë¡œ ì´ë™í–ˆìŠµë‹ˆë‹¤.`);
            window.map.setCenter(newCenter);
            //ì§€ë„ ì¤‘ì‹¬ ì´ë™ í›„ ì¤Œ ë ˆë²¨ ë³€ê²½
            window.map.setLevel(4);  // ì›í•˜ëŠ” ì¤Œ ë ˆë²¨ë¡œ ë³€ê²½ (1 ~ 14)
            // ì§€ì—­ ì •ë³´ë¥¼ ì–»ê³ , ì¤‘ë³µ ìš”ì²­ ë°©ì§€ í›„ ë§ˆì»¤ë¥¼ ë¡œë“œ
            let loadedRegions = new Set(JSON.parse(localStorage.getItem('loadedRegions') || "[]"));

            getRegionFromCoords(newCenter, function (regionName, gugunName) {
              if (regionName && gugunName) {
                let regionKey = `${regionName.trim()} ${gugunName.trim()}`;

                if (!loadedRegions.has(regionKey)) {
                  console.log(`ìƒˆë¡œìš´ ì§€ì—­(${regionKey}) ë§ˆì»¤ ìš”ì²­`);

                  // ë§ˆì»¤ ë¡œë”© í›„ì— loadedRegionsì— ì¶”ê°€í•´ì•¼ ì¤‘ë³µ ìš”ì²­ì´ ë°œìƒí•˜ì§€ ì•ŠìŒ
                  loadMarkersForRegion(regionName, gugunName).then(() => {
                    loadedRegions.add(regionKey);
                    localStorage.setItem('loadedRegions', JSON.stringify(Array.from(loadedRegions)));
                    //ìŠ¤í”¼ë„ˆ ìˆ¨ê¸°ê¸°
                    $("#loading-spinner").hide(); resolve();
                  }).catch(err => {
                    console.error(` ë§ˆì»¤ ë¡œë”© ì‹¤íŒ¨: ${err}`);
                  });

                } else {
                  //console.log(`ì´ë¯¸ ë¡œë“œëœ ì§€ì—­(${regionKey}), API ìš”ì²­ ìƒëµ`);
                }
              }
            });

            $.ajax({
              url: "/api/Map/RegionList",
              type: "GET",
              data: {region: regionName},
              headers: {
                'X-CSRF-Token': $('[name=_csrf]').val()
              },
              success: function (response) {
                if (response.success) {
                  // ì¶”ê°€ ë°ì´í„°ë¥¼ ë™ì ìœ¼ë¡œ ë¦¬ìŠ¤íŠ¸ì— ë°˜ì˜
                  //console.log("ì¶”ê°€ ë°ì´í„° ë¡œë“œ ì„±ê³µ:", response.markers);
                  updateSearchResults(response.markers);
                } else {
                  console.warn("ì¶”ê°€ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨");
                }
              },
              error: function (xhr, status, error) {
                console.error("ì¶”ê°€ ë°ì´í„° API ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
              },
            });
          } else {
            console.warn("ì§€ë„ ê°ì²´ê°€ ì•„ì§ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
          }
        } else {
          alert("ì¢Œí‘œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }
      },
      error: function (xhr, status, error) {
        console.error("ì¢Œí‘œ ê²€ìƒ‰ API ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
        alert("ì¢Œí‘œ ê²€ìƒ‰ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
    });
  }

  // ê²€ìƒ‰ ê²°ê³¼ í…Œì´ë¸”ì„ ìƒì„±í•˜ëŠ” í•¨ìˆ˜
  function updateSearchResults(data) {
    const searchResults = $("#search-results"); // í…Œì´ë¸” tbody ìš”ì†Œ ì„ íƒ
    searchResults.empty(); // ê¸°ì¡´ ë°ì´í„° ì´ˆê¸°í™”

    if (!data || data.length === 0) {
      searchResults.append(`
            <tr>
                <td colspan="2" style="text-align: center;">ì§€ì—­ ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td>
            </tr>
        `);
      return;
    }

    // ë°ì´í„° ì¶”ê°€
    data.forEach((item, index) => {
      const row = `
            <tr data-realid="${item.REALID || ''}" data-realadd="${item.REALADD || 'ì •ë³´ ì—†ìŒ'}">
                <td>${index + 1}</td>
                <td class="clickable-td">${item.REALADD || "ì •ë³´ ì—†ìŒ"}</td>
            </tr>
        `;
      searchResults.append(row);
    });
  }

  // í´ë¦­ ì´ë²¤íŠ¸ë¥¼ í…Œì´ë¸”ì— ìœ„ì„í•˜ì—¬ ë™ì ìœ¼ë¡œ ìƒì„±ëœ ìš”ì†Œì—ë„ ì ìš© ê°€ëŠ¥
  $(document).on("click", ".clickable-td", function () {
    const parentRow = $(this).closest("tr");
    const realid = parentRow.data("realid");
    const address = parentRow.data("realadd");

    // `REALID` ê°’ì´ ì—†ìœ¼ë©´ ìš”ì²­í•˜ì§€ ì•ŠìŒ
    if (!realid) {
      Alert.alert('',"ì˜ëª»ëœ ë°ì´í„°ì…ë‹ˆë‹¤.");
      return;
    }

    handleClick(realid, address);
  });

  // í´ë¦­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ í•¨ìˆ˜ (REALIDì™€ ì£¼ì†Œ ì „ë‹¬)
  function handleClick(realid, address) {
    $.ajax({
      url: "/api/Map/getOwn",
      type: "GET",
      data: { realid: realid },
      headers: {
        'X-CSRF-Token': $('[name=_csrf]').val()
      },
      success: function (response) {
        if (response.success) {
          let listData = {
            REALID: realid,
            SHORT_ADDR: address // ë°›ì•„ì˜¨ ì£¼ì†Œê°’ ì‚¬ìš©
          };

          // ë°ì´í„° ê°€ê³µ í›„ updatePopupContent í˜¸ì¶œ
          let transformedDataA = response.dataA ? response.dataA.map(item => ({
            ...item,
            displayText: `[ê°‘êµ¬] ${item.RgsAimCont}`
          })) : [];

          let transformedDataB = response.dataB ? response.dataB.map(item => ({
            ...item,
            displayText: `[ì„êµ¬] ${item.RgsAimCont}`
          })) : [];

          updatePopupContent(transformedDataA, transformedDataB, listData);
          $('.list-card-wrap').scrollTop(0);
        } else {
          Alert.alert('',"í•´ë‹¹ ë¬¼ê±´ì— ëŒ€í•œ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }
      },
      error: function (xhr, status, error) {
        // ì—ëŸ¬ ì²˜ë¦¬
        Alert.alert("ì„œë²„ì™€ì˜ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
    });
  }

  function updatePopupContent(dataA, dataB, listData) {
    let popup = document.getElementById('popup-own');
    let overlay = document.querySelector('.popup-overlay');
    let listContainer = document.querySelector('.list-card-wrap');
    let addressField = document.querySelector('#popup-own .ticket-tit dd');

    // ì£¼ì†Œ ì—…ë°ì´íŠ¸ (null ë˜ëŠ” undefinedì¼ ê²½ìš° ë¹ˆ ë¬¸ìì—´)
    addressField.textContent = listData?.SHORT_ADDR ?? 'ì£¼ì†Œ ì •ë³´ ì—†ìŒ';

    // íŒì—… ì´ˆê¸°í™”
    listContainer.innerHTML = '';

    let allData = [];

    // A ë°ì´í„° ì¶”ê°€
    if (dataA && dataA.length > 0) {
      dataA.forEach(item => {
        allData.push({ ...item, type: 'A' });
      });
    }

    // B ë°ì´í„° ì¶”ê°€
    if (dataB && dataB.length > 0) {
      dataB.forEach(item => {
        allData.push({ ...item, type: 'B' });
      });
    }

    // ë°ì´í„°ê°€ ì—†ì„ ê²½ìš°
    if (allData.length === 0) {
      listContainer.innerHTML = '<p style="text-align: center; padding: 10px;">í•´ë‹¹ ë¬¼ê±´ì˜ ë“±ê¸°ë¶€ë“±ë³¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
    } else {
      allData.forEach(item => {
        let formatValue = (value) => {
          return value === null || value === undefined || value.toString().trim().toLowerCase() === "null"
            ? '' // ë¹ˆì¹¸ ì²˜ë¦¬
            : value;
        };

        // Aì™€ Bë¥¼ êµ¬ë¶„í•˜ì—¬ ì¹´ë“œ ìƒ‰ìƒ ë° êµ¬ë¶„ ëª…ì¹­ ì ìš©
        let cardClass = item.type === 'A' ? 'card-red' : 'card-blue';
        let statusClass = item.type === 'A' ? 'sta-red' : 'sta-blue';
        let sectionName = item.type === 'A' ? 'ê°‘êµ¬' : 'ì„êµ¬'; // AëŠ” 'ê°‘êµ¬', BëŠ” 'ì„êµ¬'

        let cardHtml = `
                <div class="card-box ${cardClass}">
                    <div class="card-cont">
                        <dl>
                            <dt>êµ¬ë¶„</dt>
                            <dd><span class="${statusClass}">${sectionName}</span></dd>
                        </dl>
                        <dl>
                            <dt>ìˆœìœ„ ë²ˆí˜¸</dt>
                            <dd>${formatValue(item?.RankNo)}</dd>
                        </dl>
                        <dl>
                            <dt>ë“±ê¸°ëª©ì </dt>
                            <dd>${formatValue(item?.RgsAimCont)}</dd>
                        </dl>
                        <dl>
                            <dt>ì ‘ìˆ˜</dt>
                            <dd>${formatValue(item?.Receve)}</dd>
                        </dl>
                        <dl>
                            <dt>ë“±ê¸°ì›ì¸</dt>
                            <dd>${formatValue(item?.RgsCaus)}</dd>
                        </dl>
                        <dl>
                            <dt colspan="2" style="width: 100%;text-align: left;">ê¶Œë¦¬ì ë° ê¸°íƒ€ì‚¬í•­</dt>
                        </dl>
                        <dl>
                            <dd colspan="2" style="width: 100%;text-align: left;">${formatValue(item?.NomprsAndEtc)}</dd>
                        </dl>
                    </div>
                </div>
            `;

        // ìƒì„±ëœ ì¹´ë“œ ì¶”ê°€
        listContainer.innerHTML += cardHtml;
      });
    }

    // íŒì—… í™œì„±í™”
    if (popup && overlay) {
      popup.classList.add('active');
      overlay.style.display = 'block';
    } else {
      console.error('popup-own ë˜ëŠ” popup-overlay ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }

    // ìŠ¤í¬ë¡¤ ì´ˆê¸°í™” (íŒì—…ì´ ê¸¸ì–´ì§ˆ ê²½ìš°)
    popup.scrollTop = 0;
  }

  //ì§€ì—­ ë¶ˆëŸ¬ì˜¤ê¸° ###########
  // SGIS API ë°ì´í„° ìš”ì²­
  function fetchRegionDataAjax() {
    $.ajax({
      url: '/api/Map', // SGIS API ì—”ë“œí¬ì¸íŠ¸
      type: 'GET',
      async: false,
      headers: {
        'X-CSRF-Token': $('[name=_csrf]').val()
      },
      success: function (data) {
        if (data.success) {
          populateRegionListAjax(data);
        } else {
          console.error("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", data.message);
        }
      },
      error: function (xhr, status, error) {
        console.error("API ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
      }
    });
  }

  // ì§€ì—­ ëª©ë¡ ìƒì„±
  function populateRegionListAjax(data) {
    const regionList = $('#region-list');
    regionList.empty(); // ê¸°ì¡´ ëª©ë¡ ì´ˆê¸°í™”

    // ì´ë¯¸ JSON ê°ì²´ë¼ë©´ JSON.parseë¥¼ í˜¸ì¶œí•˜ì§€ ì•ŠìŒ
    const results = data.data.result; // JSON ë°ì´í„° ì ‘ê·¼
    results.forEach(region => {
      const button = $('<button></button>')
        .text(region.addr_name) // ì‹œ/ë„ ì´ë¦„ ì„¤ì •
        .attr('class', 'region-button') // ìŠ¤íƒ€ì¼ í´ë˜ìŠ¤
        .attr('type', 'button')
        .on('click', () => loadDistrictsAjax(region.cd, region.addr_name)); // ì´ë¦„ê³¼ ì½”ë“œ ì „ë‹¬
      regionList.append(button); // ë²„íŠ¼ ì¶”ê°€
    });

    $('#region-modal').show(); // ëª¨ë‹¬ ë³´ì´ê¸°
  }

  // ì‹œ/ë„ ì„ íƒ ì‹œ êµ¬ ëª©ë¡ ë¡œë“œ
  function loadDistrictsAjax(cityCode, cityName) {
    selectedPath.city = cityName; // ì‹œ/ë„ ì´ë¦„ ì €ì¥
    updateSelectedPath(); // ì„ íƒ ê²½ë¡œ ì—…ë°ì´íŠ¸

    $.ajax({
      url: '/api/Map',
      type: 'GET',
      data: {cd: cityCode},
      headers: {
        'X-CSRF-Token': $('[name=_csrf]').val()
      },
      success: function (data) {
        const regionList = $('#region-list');
        regionList.empty();

        if (data.success) {
          // JSON ê°ì²´ë¡œ ë°”ë¡œ ì ‘ê·¼
          const results = data.data.result;
          results.forEach(district => {
            const button = $('<button></button>')
              .text(district.addr_name)
              .attr('class', 'district-button')
              .attr('type', 'button')
              .on('click', () => loadNeighborhoodsAjax(district.cd, district.addr_name));
            regionList.append(button);
          });
        } else {
          console.error("êµ¬ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", data.message);
        }
      },
      error: function (xhr, status, error) {
        console.error("API ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
      }
    });
  }

  // êµ¬ ì„ íƒ ì‹œ ë™ ëª©ë¡ ë¡œë“œ
  function loadNeighborhoodsAjax(districtCode, districtName) {
    selectedPath.district = districtName; // êµ¬ ì´ë¦„ ì €ì¥
    updateSelectedPath(); // ì„ íƒ ê²½ë¡œ ì—…ë°ì´íŠ¸

    $.ajax({
      url: '/api/Map',
      type: 'GET',
      data: {cd: districtCode},
      headers: {
        'X-CSRF-Token': $('[name=_csrf]').val()
      },
      success: function (data) {
        const regionList = $('#region-list');
        regionList.empty();

        if (data.success) {
          const results = data.data.result;
          results.forEach(neighborhood => {
            const button = $('<button></button>')
              .text(neighborhood.addr_name)
              .attr('class', 'neighborhood-button')
              .attr('type', 'button')
              .on('click', () => selectNeighborhood(neighborhood.addr_name));
            regionList.append(button);
          });
        } else {
          console.error("ë™ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", data.message);
        }
      },
      error: function (xhr, status, error) {
        console.error("API ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
      }
    });
  }

  // ë™ ì„ íƒ ì‹œ ìµœì¢… ê²½ë¡œ ì—…ë°ì´íŠ¸
  function selectNeighborhood(neighborhoodName) {
    selectedPath.neighborhood = neighborhoodName; // ë™ ì´ë¦„ ì €ì¥
    updateSelectedPath(); // ì„ íƒ ê²½ë¡œ ì—…ë°ì´íŠ¸

  }

  // ì„ íƒ ê²½ë¡œ ì—…ë°ì´íŠ¸
  function updateSelectedPath() {
    const fullPath = `${selectedPath.city} ${selectedPath.district} ${selectedPath.neighborhood}`.trim();
    const selectedRegionElement = document.getElementById('selected-region');
    const selectedRegionElement2 = document.getElementById('region-SelectList');

    // ì²« ë²ˆì§¸ ìš”ì†Œ ì—…ë°ì´íŠ¸
    if (selectedRegionElement) {
      selectedRegionElement.textContent = fullPath || "ì§€ì—­ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";
    } else {
      console.error("ì„ íƒëœ ì§€ì—­ì„ í‘œì‹œí•  ìš”ì†Œ(selected-region)ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    }

    // ë‘ ë²ˆì§¸ ìš”ì†Œ ì—…ë°ì´íŠ¸
    if (selectedRegionElement2) {
      selectedRegionElement2.textContent = fullPath || "ì§€ì—­ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";
    } else {
      console.error("ì„ íƒëœ ì§€ì—­ì„ í‘œì‹œí•  ìš”ì†Œ(region-SelectList)ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    }
  }

  // ë§ˆì»¤ ================================
  var activeOverlay = null; // í˜„ì¬ í™œì„±í™”ëœ ì˜¤ë²„ë ˆì´ ì €ì¥
  function extractFloorFromAddress(address) {
    var floorMatch = address.match(/ì œ(\d+)ì¸µ/);
    return floorMatch ? parseInt(floorMatch[1], 10) : null;
  }

  function loadMarkersForRegion(regionName, gugunName) {
    $.ajax({
      url: "/api/Map/markersByRegion",
      type: "GET",
      data: {region: regionName, gugun: gugunName},
      headers: {
        'X-CSRF-Token': $('[name=_csrf]').val()
      },
      success: function (response) {
        if (response.success) {
          clearMarkers(); // ê¸°ì¡´ ë§ˆì»¤ ì‚­ì œ
          console.log("ğŸ—‘ ê¸°ì¡´ ë§ˆì»¤ ì‚­ì œ ì™„ë£Œ");

          var gradeMarkerImages = {
            "S": "/img/Map/Së“±ê¸‰_marker.png",
            "A": "/img/Map/Aë“±ê¸‰_marker.png",
            "B": "/img/Map/Bë“±ê¸‰_marker.png",
            "C": "/img/Map/Cë“±ê¸‰_marker.png",
            "D": "/img/Map/Dë“±ê¸‰_marker.png",
            "E": "/img/Map/Eë“±ê¸‰_marker.png",
            "F": "/img/Map/Fë“±ê¸‰_marker.png"
          };
          response.markers.forEach(markerData => {
            markerData.floor = extractFloorFromAddress(markerData.address) || 1; // ê¸°ë³¸ê°’ 1ì¸µ
          });

          var newMarkers = response.markers.map(markerData => {
            //console.log("markerData.lat:", markerData.lat, "markerData.lng:", markerData.lng);

            if (!markerData) {
              console.warn("markerDataê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŒ:", markerData);
              return null; // ì˜¤ë¥˜ ë°©ì§€
            }
            markerData.grade = markerData.grade || "S"; // ë“±ê¸‰ì´ ì—†ì„ ê²½ìš°ì—ëŠ” Së“±ê¸‰ìœ¼ë¡œ
            var markerImageUrl = gradeMarkerImages[markerData.grade] || "/img/Map/default_marker.png";

            var markerImage = new kakao.maps.MarkerImage(
              markerImageUrl,
              new kakao.maps.Size(30, 30),  // ë§ˆì»¤ í¬ê¸°
              {offset: new kakao.maps.Point(20, 40)}
            );

            var floorOffset = 0.00002; // ì¸µë³„ ë¯¸ì„¸í•œ ìœ„ì¹˜ ì¡°ì • (ì´ ê°’ì„ ì¡°ì •í•˜ë©´ì„œ í…ŒìŠ¤íŠ¸)
            var angleOffset = 0.000003; // ì¸µë³„ë¡œ íšŒì „í•˜ë©´ì„œ í¼ì§€ëŠ” íš¨ê³¼

            var floor = markerData.floor || 0; // ê¸°ë³¸ê°’ 0ì¸µ
            var angle = (floor * 45) * (Math.PI / 180); // ì¸µë³„ë¡œ íšŒì „í•˜ë„ë¡ ì„¤ì •

            // X, Y ì¶•ìœ¼ë¡œ ë§ˆì»¤ ë¶„ì‚°
            var newLat = parseFloat(markerData.lat) + (floorOffset * floor);
            var newLng = parseFloat(markerData.lng) + (angleOffset * floor * Math.sin(angle));


            // NaN ì²´í¬ ì¶”ê°€
            if (isNaN(newLat) || isNaN(newLng)) {
              //console.warn("âš  newLat ë˜ëŠ” newLng ê°’ì´ NaNì…ë‹ˆë‹¤. ê¸°ë³¸ ì¢Œí‘œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.");
              newLat = parseFloat(markerData.lat);
              newLng = parseFloat(markerData.lng);
            }
           /* console.log("Original lat:", markerData.lat, "Original lng:", markerData.lng);
            console.log("Adjusted lat:", newLat, "Adjusted lng:", newLng);*/

            var marker = new kakao.maps.Marker({
              // position: new kakao.maps.LatLng(markerData.lat, markerData.lng ),
              position: new kakao.maps.LatLng(newLat, newLng),
              title: markerData.title || "",
              image: markerImage,
              map: window.map
            });

           // console.log("markerData : ", markerData);
            // ë§ˆì»¤ ë°ì´í„° ì €ì¥
            marker.markerData = markerData;
            // ë“±ê¸‰ë³„ ì´ë¯¸ì§€ ë§¤í•‘
            var gradeImages = {
              "S": "/img/Map/Së“±ê¸‰.png",
              "A": "/img/Map/Aë“±ê¸‰.png",
              "B": "/img/Map/Bë“±ê¸‰.png",
              "C": "/img/Map/Cë“±ê¸‰.png",
              "D": "/img/Map/Dë“±ê¸‰.png",
              "E": "/img/Map/Eë“±ê¸‰.png",
              "F": "/img/Map/Fë“±ê¸‰.png"
            };

            // ë“±ê¸‰ ì„¤ì • (undefined ë°©ì§€)
            var gradeClass = markerData.grade ? `grade-${markerData.grade}` : "grade-Unknown";

            // ì´ë¯¸ì§€ ì„¤ì • (markerData.imageê°€ ì—†ì„ ê²½ìš° ê¸°ë³¸ê°’ ì„¤ì •)
            var imageUrl = markerData.image && markerData.image.trim() !== ""
              ? markerData.image
              : (gradeImages[markerData.grade] || 'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/thumnail.png');

            // ì»¤ìŠ¤í…€ ì˜¤ë²„ë ˆì´ ì»¨í…ì¸  ìƒì„±
            var content = `
                    <div class="wrap">
                        <div class="info">
                            <div class="title">
                                ${markerData.REGUGUN} _ ${markerData.grade || ''} ë“±ê¸‰
                                <div class="close" onclick="closeOverlay(${markerData.lat}, ${markerData.lng})" title="ë‹«ê¸°"></div>
                            </div>
                            <div class="body ${gradeClass}">
                                <div class="img">
                                   <img src="${imageUrl}" width="73" height="70">
                                </div>
                                <div class="desc">
                                    <div class="jibun ellipsis">${markerData.jibun || ''}</div>
                                    <div class="avg_score"> ì ìˆ˜ : ${markerData.avg_score || ''}</div>
                                    <div class="count"> ë°œê¸‰ê±´ìˆ˜: ${markerData.count || ''} </div>
                                     <div class="address"> ì£¼ì†Œ: ${markerData.address || ''} </div>
                                </div>
                            </div>
                        </div>
                    </div>`;

            // ì»¤ìŠ¤í…€ ì˜¤ë²„ë ˆì´ ìƒì„±
            var overlay = new kakao.maps.CustomOverlay({
              content: content,
              position: marker.getPosition(),
              map: null // ê¸°ë³¸ì ìœ¼ë¡œ ë‹«íŒ ìƒíƒœ
            });

            // ì§€ë„ ì¤Œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            kakao.maps.event.addListener(window.map, 'zoom_changed', function() {
              var level = window.map.getLevel(); // í˜„ì¬ ì§€ë„ ì¤Œ ë ˆë²¨ ê°€ì ¸ì˜¤ê¸°
             //console.log("í˜„ì¬ ì¤Œ ë ˆë²¨:", level);

              if (level > 4) { // ì¤Œ ë ˆë²¨ì´ 4ë³´ë‹¤ í¬ë©´ ì˜¤ë²„ë ˆì´ ë‹«ê¸°
                closeOverlay();
              }
            });

            // ë§ˆì»¤ í´ë¦­ ì‹œ ì˜¤ë²„ë ˆì´ í‘œì‹œ
            kakao.maps.event.addListener(marker, 'click', function () {
              if (activeOverlay) {
                activeOverlay.setMap(null); // ê¸°ì¡´ ì˜¤ë²„ë ˆì´ ë‹«ê¸°
              }
              overlay.setMap(window.map); // ìƒˆë¡œìš´ ì˜¤ë²„ë ˆì´ ì—´ê¸°
              activeOverlay = overlay; // í˜„ì¬ ì˜¤ë²„ë ˆì´ ì €ì¥

              var moveLatLon = marker.getPosition();
              var currentLevel = window.map.getLevel(); // í˜„ì¬ ì§€ë„ ì¤Œ ë ˆë²¨ ê°€ì ¸ì˜¤ê¸°

              if (currentLevel > 5) {
                window.map.setLevel(2);
              } else if (currentLevel > 2 && currentLevel <= 5) {
                window.map.setLevel(3);
              }

              //ë¹„ë™ê¸° í•¨ìˆ˜ ì•ˆì—ì„œ `setTimeout`ì„ `Promise`ë¡œ ê°ì‹¸ê¸° (ëª…í™•í•œ ë¹„ë™ê¸° ì œì–´ ê°€ëŠ¥)
              new Promise(resolve => setTimeout(resolve, 300));

              window.map.panTo(moveLatLon);

              //ê²€ìƒ‰ ê²°ê³¼ í…Œì´ë¸” ì—…ë°ì´íŠ¸
              updateSearchResultsFromMarker(marker.markerData);

              //ì„ íƒëœ ì§€ì—­ ê²½ë¡œ ì—…ë°ì´íŠ¸
              updateSelectedPathFromMarker(marker.markerData);
            });

            // ë§ˆì»¤ ë°ì´í„°ì— ì˜¤ë²„ë ˆì´ ì €ì¥ (ë‹«ê¸° ë²„íŠ¼ì—ì„œ ì°¾ê¸° ìœ„í•´)
            markerData.overlay = overlay;

            return marker;
          }).filter(marker => marker !== null);

          // í´ëŸ¬ìŠ¤í„°ëŸ¬ì— ë§ˆì»¤ ì¶”ê°€
          if (window.clusterer) {
            console.log(`${regionName} ${gugunName} ì§€ì—­ì˜ ë§ˆì»¤ ${newMarkers.length}ê°œ ì¶”ê°€`);
            window.clusterer.addMarkers(newMarkers);

          } else {
            console.error("í´ëŸ¬ìŠ¤í„°ëŸ¬ ê°ì²´ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•ŠìŒ");
          }
          $("#loading-spinner").hide();
        } else {
          console.error("ë§ˆì»¤ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
          $("#loading-spinner").hide();
        }
      },
      error: function (xhr, status, error) {
        console.error("ë§ˆì»¤ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", error);
        $("#loading-spinner").hide();
      }
    });
  }
  function updateSearchResultsFromMarker(markerData) {
    const searchResults = $("#search-results");
    searchResults.empty();

    if (!markerData) {
      searchResults.append(`
            <tr>
                <td colspan="2" style="text-align: center;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td>
            </tr>
        `);
      return;
    }

    // âœ… ë§ˆì»¤ ì •ë³´ë¥¼ í…Œì´ë¸”ì— ì¶”ê°€
    const row = `
        <tr data-realid="${markerData.REALID || ''}" data-realadd="${markerData.address || 'ì •ë³´ ì—†ìŒ'}">
            <td>1</td>
            <td class="clickable-td">${markerData.address || "ì •ë³´ ì—†ìŒ"}</td>
        </tr>
    `;
    searchResults.append(row);
  }

  function updateSelectedPathFromMarker(markerData) {
    if (!markerData || !markerData.address) {
      console.warn("ë§ˆì»¤ ë°ì´í„°ê°€ ë¶€ì¡±í•˜ì—¬ ì„ íƒëœ ì§€ì—­ì„ ì—…ë°ì´íŠ¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }

    // âœ… ì£¼ì†Œì—ì„œ í•„ìš”í•œ ë¶€ë¶„ ì¶”ì¶œ
    const addressParts = markerData.address.split(" ");
    selectedPath.city = addressParts[0] || '';  // ì‹œ/ë„
    selectedPath.district = addressParts[1] || ''; // êµ¬
    selectedPath.neighborhood = addressParts[2] || ''; // ë™

    updateSelectedPath(); // UI ê°±ì‹ 
  }



  // ì˜¤ë²„ë ˆì´ ë‹«ê¸° í•¨ìˆ˜ (íŠ¹ì • ë§ˆì»¤ì˜ ì˜¤ë²„ë ˆì´ ë‹«ê¸°)
  function closeOverlay(lat, lng) {
    if (activeOverlay) {
      activeOverlay.setMap(null);
      activeOverlay = null;
    }
  }

  // ê¸°ì¡´ ë§ˆì»¤ ì œê±° í•¨ìˆ˜
  function clearMarkers() {
    if (window.clusterer) {
      console.log("ğŸ—‘ ê¸°ì¡´ ë§ˆì»¤ ê°œìˆ˜:", window.clusterer.getMarkers().length);
      window.clusterer.clear(); // ê¸°ì¡´ í´ëŸ¬ìŠ¤í„° ì‚­ì œ
      console.log("ê¸°ì¡´ ë§ˆì»¤ ì‚­ì œ ì™„ë£Œ");

      // í´ëŸ¬ìŠ¤í„° ì‚­ì œ í›„ ë‹¤ì‹œ `clusterclick` ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì •
      window.clusterClickListenerAdded = false;
    } else {
      console.warn("âš  í´ëŸ¬ìŠ¤í„°ëŸ¬ê°€ ì•„ì§ ì´ˆê¸°í™”ë˜ì§€ ì•ŠìŒ.");
    }
  }

  $('.btn-popup-close').on('click', function() {
    $('.popup-overlay').fadeOut(200);
    $('.popup-wrapper').removeClass('active');
  });


</script>
</body>
</html>