<!DOCTYPE html>
<html lang="ko">
<style>
    .btn-clear {
        display: none !important; /* ê°•ì œë¡œ ìˆ¨ê¹€ */
    }

    .btn-close {
        display: none !important; /* ê°•ì œë¡œ ìˆ¨ê¹€ */
    }
</style>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FACT CHECK</title>
  <link rel="icon" type="image/png" href="/images/logo/icon_FACT%20CHECK.png">
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/smoothness/jquery-ui.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/> <!-- Slide css -->
  <link rel="stylesheet" href="/resource/ax5ui/ax5ui.all.css">
  <link rel="stylesheet" type="text/css" href="/assets_mobile/css/import.css">
  <link rel="stylesheet" type="text/css" href="/css/MapStyle.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>

  <script src="/assets_mobile/js/ui.js"></script> <!-- Common js -->
  <script th:inline="javascript">
    var sandanData = /*[[${session.sandanList}]]*/ [];
  </script>


  <script type="text/javascript" src="/resource/ax5ui/ax5ui.all.min.js?v=1000"></script>

  <script type="text/javascript" src="/js/ax5commUtil.js?v=1070"></script>

  <script src="/js/common.js?v=1060"></script>
  <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script> <!-- Slide js -->
  <script src="/js/Mobile.js"></script>
</head>
<div class="mobile-wrapper page-kakaoMap2"><!-- â˜…í˜ì´ì§€ Classëª… -->
  <!-- [ëª¨ë°”ì¼] í—¤ë”  -->
  <div class="mobile-layout-header">
    <header>
      <div class="left">
        <a href="#" title="ì „ì²´ë©”ë‰´" class="logo">
        </a>
      </div>
      <div class="center" style="margin-left:10px;">
        <h2>ì§€ì—­ë³„ ë“±ê¸° ìƒí™©ë§µ(ì§€ë„ë¡œ ë³´ê¸°)</h2>
      </div>
      <div class="right">
        <a href="#" title="ì „ì²´ë©”ë‰´" class="btn-menu">
          <img src="/assets_mobile/images/icon/btn-menu.svg" alt="ì „ì²´ë©”ë‰´ ì•„ì´ì½˜">
        </a>
      </div>
    </header>
  </div> <!-- //mobile-layout-header end-->

  <!-- [ëª¨ë°”ì¼] ë©”ë‰´  -->
  <div th:insert="~{mobile/mobile_menu :: mobile_menu}"></div>
  <!-- [ëª¨ë°”ì¼] ì»¨ë´ì¸   -->
  <div class="mobile-layout-contents">
    <!--- (ë ˆì´ì•„ì›ƒ) Contents ì˜ì—­ -->
    <div class="layout-contents" style="width:100%;height:100vh;">
      <!-- ì»¨í…ì¸  ì˜ì—­  -->
      <div class="contents-wrap">
        <div>
          <li style="margin-top: 5% ">
            <a href="#" class="btn btn-popup-open" data-popup="popup1" onclick="regionList()"
               title="ì§€ì—­ì„ íƒ">ì§€ì—­ ì„ íƒ</a>
          </li>
        </div>
        <div style=" margin-top: 5%">
          <span id="selected-region" style="font-size: 20px; font-weight: bold; color: #333;"></span>
        </div>

        <div id="map" style="width:100%;height: 65vh ; flex-grow: 1;"></div>

        <div style="margin-top: 5%">
          <ol id="search-results" class="list-group list-group-numbered" style="font-size: 20px;">
            <li class="list-group-item">1. ì§€ì—­ê²€ìƒ‰ ì‹œ ë³´ì´ëŠ” ë°œê¸‰ ë‚´ì—­</li>
            <li class="list-group-item">2. ì§€ì—­ê²€ìƒ‰ ì‹œ ë³´ì´ëŠ” ë°œê¸‰ ë‚´ì—­</li>
            <li class="list-group-item">3. ì§€ì—­ê²€ìƒ‰ ì‹œ ë³´ì´ëŠ” ë°œê¸‰ ë‚´ì—­</li>
          </ol>
        </div>
      </div>  <!--// contents-wrap end-->
    </div> <!--//layout-contents end -->
  </div> <!-- //mobile-layout-contents end-->

  <div class="mobile-layout-popup">
    <div class="popup-overlay"></div>
    <div class="popup-wrapper" id="popup1">
      <form id="bomForm1">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
        <div class="popup-title">
          <h3>ì§€ì—­ ì„ íƒ</h3>
          <a onclick="RegisterUserClose()" title="íŒì—…ë‹«ê¸°" class="btn-popup-close">
            <img src="/assets_mobile/images/icon/btn-popup-close.svg" alt="ë‹«ê¸°">
          </a>
        </div>
        <div class="popup-contents">
          <div class="table-wrap" id="bomForm">
            <div class="write-wrap">
              <div class="row">
                <dl>
                  <dt>
                  </dt>
                  <dd>
                    <div id="region-modal" style="display: none;">
                      <div id="region-SelectList" style="font-size: 24px; margin-bottom:25px; "></div>
                      <div id="region-list"></div>
                    </div>
                  </dd>
                </dl>
              </div>
            </div>
          </div>
        </div>
        <div class="popup-button">
          <button class="btn-navy" id="btnSaveAuth" onclick="moveToSelectedRegion()">ì§€ì—­ ê²€ìƒ‰</button>
        </div>
      </form>
    </div>
  </div> <!-- //mobile-layout-popup end -->
</div> <!-- //page-wrapper end-->
<body>
<script type="text/javascript">
  document.readyState === 'complete' ? init() : window.onload = init;
  let map;

  let selectedPath = {
    city: '',  // ì„ íƒí•œ ì‹œ/ë„
    district: '', // ì„ íƒí•œ êµ¬
    neighborhood: '' // ì„ íƒí•œ ë™
  };

  function init() {
    loadKakaoMapScript();

    localStorage.removeItem('loadedRegions'); // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ì‚­ì œ
    loadedRegions = new Set();
    //console.log("ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì´ˆê¸°í™”ë¨. loadedRegions:", loadedRegions);
  }

  //ì§€ì—­ì„ íƒ íŒì—…ì—´ê¸°
  function regionList() {
    let popup = document.getElementById('popup1');
    let overlay = document.querySelector('.popup-overlay');

    if (popup && overlay) {
      popup.classList.add('active'); // íŒì—… í™œì„±í™”
      overlay.style.display = 'block'; // ì˜¤ë²„ë ˆì´ ë³´ì´ê¸°
    } else {
      console.error('popup1 ë˜ëŠ” popup-overlay ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }
    fetchRegionDataAjax();
  }

  function RegisterUserClose() {
    let popup = document.getElementById('popup1');
    let overlay = document.querySelector('.popup-overlay');

    if (popup && overlay) {
      // íŒì—… ë¹„í™œì„±í™”
      popup.classList.remove('active');

      // ì˜¤ë²„ë ˆì´ ìˆ¨ê¸°ê¸°
      overlay.style.display = 'none';
      $('#region-SelectList').empty(); // ì„ íƒí•œ ê²½ë¡œ ì´ˆê¸°í™”
      selectedPath = {city: '', district: '', neighborhood: ''}; // ì„ íƒ ê²½ë¡œ ì´ˆê¸°í™”
      // ì…ë ¥ í¼ ì´ˆê¸°í™”
    } else {
      console.error('popup1 ë˜ëŠ” popup-overlay ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }
  }

  //ëª¨ë‹¬ ë###############################################

  // ì„œë²„ë¥¼ í†µí•´ ì¹´ì¹´ì˜¤ ì§€ë„ ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ
  function loadKakaoMapScript() {
    $.ajax({
      url: '/api/Map/script',
      type: 'GET',
      dataType: 'text',
      headers: {
        'X-CSRF-Token': $('[name=_csrf]').val()
      },
      success: function (scriptUrl) {
        // autoload=falseë¥¼ URLì— ì¶”ê°€
        const scriptWithAutoload = `${scriptUrl}&autoload=false`;

        // ê¸°ì¡´ script íƒœê·¸ ì œê±° (ì¤‘ë³µ ë°©ì§€)
        const existingScript = document.querySelector("script[src^='https://dapi.kakao.com/v2/maps/sdk.js']");
        if (existingScript) {
          existingScript.remove();
        }

        // ìƒˆë¡œìš´ script íƒœê·¸ ìƒì„± ë° ì‚½ì…
        const scriptElement = document.createElement('script');
        scriptElement.type = 'text/javascript';
        scriptElement.src = scriptUrl + "&libraries=clusterer,services&autoload=false";
        scriptElement.async = false;
        document.head.appendChild(scriptElement);

        scriptElement.onload = function () {
          console.log("ì¹´ì¹´ì˜¤ ì§€ë„ ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì™„ë£Œ");

          // ë¡œë”© ì™„ë£Œ í›„, Kakao API ê°ì²´ ì´ˆê¸°í™”
          if (typeof kakao === "undefined" || typeof kakao.maps === "undefined") {
            console.error("Kakao ì§€ë„ APIê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
            return;
          }

          // Kakao APIì˜ load ë©”ì„œë“œë¥¼ ì‚¬ìš©í•´ ì´ˆê¸°í™” ì§„í–‰
          kakao.maps.load(function () {
            initializeMap(); // ì§€ë„ ì´ˆê¸°í™” í˜¸ì¶œ
          });
        };

        scriptElement.onerror = function () {
          console.error("ì¹´ì¹´ì˜¤ ì§€ë„ ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        };
      },
      error: function (xhr, status, error) {
        console.error("ì¹´ì¹´ì˜¤ ì§€ë„ ìŠ¤í¬ë¦½íŠ¸ ìš”ì²­ ì‹¤íŒ¨:", error);
      }
    });
  }

  // ì§€ë„ ì´ˆê¸°í™”
  //   ë“±ê¸‰ë³„ í´ëŸ¬ìŠ¤í„° ìƒ‰ìƒ ë§¤í•‘
  var gradeColors = {
    "S": "#B0E57C",   // ì—°ë‘ìƒ‰ (ë§¤ìš° ì•ˆì „)
    "A": "#00A36C",   // ì´ˆë¡ìƒ‰ (ì•ˆì „)
    "B": "#3399FF",   // íŒŒë€ìƒ‰ (ë³´í†µ)
    "C": "#FFCC00",   // ë…¸ë€ìƒ‰ (ì£¼ì˜)
    "D": "#FF9900",   // ì§„í•œ ì£¼í™©ìƒ‰ (ê²½ê³ )
    "E": "#FF3333",   // ë¹¨ê°„ìƒ‰ (ìœ„í—˜)
    "F": "#000000"    // ê²€ì€ìƒ‰ (ë§¤ìš° ìœ„í—˜)
  };


  // ì§€ë„ ì´ˆê¸°í™”
  function initializeMap() {
    try {
      const container = document.getElementById('map');
      if (!container) {
        throw new Error("ì§€ë„ë¥¼ í‘œì‹œí•  #map ìš”ì†Œê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
      }

      const options = {
        center: new kakao.maps.LatLng(37.5665, 126.9780), //   ì„œìš¸íŠ¹ë³„ì‹œ ì¤‘ì‹¬ ì¢Œí‘œ
        level: 3 // í™•ëŒ€ ë ˆë²¨
      };

      window.map = new kakao.maps.Map(container, options);
      console.log("Kakao ì§€ë„ ì´ˆê¸°í™” ì™„ë£Œ");

      // í´ëŸ¬ìŠ¤í„°ëŸ¬ ìƒì„±
      if (window.map) {
        window.clusterer = new kakao.maps.MarkerClusterer({
          map: window.map,
          averageCenter: true,
          minLevel: 3
        });

        // í´ëŸ¬ìŠ¤í„° ìƒ‰ìƒ ë³€ê²½ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        kakao.maps.event.addListener(window.clusterer, 'clustered', function (clusters) {
          clusters.forEach(cluster => {
            var markers = cluster.getMarkers();
            if (markers.length === 0) return;

            //   í´ëŸ¬ìŠ¤í„° ë‚´ì—ì„œ ê°€ì¥ ë†’ì€ ìœ„í—˜ ë“±ê¸‰ ì°¾ê¸° (F > E > D > C > B > A > S)
            var gradePriority = ["F", "E", "D", "C", "B", "A", "S"]; // ë“±ê¸‰ ìš°ì„ ìˆœìœ„ ë°°ì—´
            var gradeCount = {}; // ë“±ê¸‰ ë“±ì¥ íšŸìˆ˜ ì €ì¥ ê°ì²´

            markers.forEach(marker => {
              var markerGrade = marker.markerData?.grade || "S"; // ê¸°ë³¸ê°’ "S"
              gradeCount[markerGrade] = (gradeCount[markerGrade] || 0) + 1; // ë“±ì¥ íšŸìˆ˜ ì¦ê°€
            });

            // ë“±ì¥ íšŸìˆ˜ê°€ ê°€ì¥ ë§ì€ ë“±ê¸‰ ì°¾ê¸°
            var highestGrade = Object.entries(gradeCount).reduce((topGrade, current) => {
              var [grade, count] = current;

              if (
                count > (gradeCount[topGrade] || 0) || // ë“±ì¥ íšŸìˆ˜ê°€ ë” ë§ë‹¤ë©´ ì—…ë°ì´íŠ¸
                (count === gradeCount[topGrade] && gradePriority.indexOf(grade) < gradePriority.indexOf(topGrade)) // ê°™ì€ íšŸìˆ˜ë¼ë©´ ë” ë†’ì€ ìœ„í—˜ ë“±ê¸‰ ìš°ì„ 
              ) {
                return grade;
              }
              return topGrade;
            }, "S"); // ê¸°ë³¸ê°’ "S"

            //   ê°€ì¥ ë†’ì€ ë“±ê¸‰ì˜ ìƒ‰ìƒ ì ìš©
            var backgroundColor = gradeColors[highestGrade] || "#3399FF"; // ê¸°ë³¸ íŒŒë€ìƒ‰

            //   í´ëŸ¬ìŠ¤í„° ë§ˆì»¤ ìŠ¤íƒ€ì¼ ë³€ê²½
            var clusterMarker = cluster.getClusterMarker();
            clusterMarker.setContent(`
            <div style="
                min-width: 50px;
                height: 50px;
                padding: 10px;
                color: white;
                font-size: 14px;
                font-weight: bold;
                line-height: 30px;
                text-align: center;
                border: 3px solid white;
                border-radius: 50%;
                background-color: ${backgroundColor};
                box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
                white-space: nowrap;
                position: relative;
                z-index: 2;">
               ${markers.length} ê°œ
            </div>
        `);
          });
        });

        console.log("ë§ˆì»¤ í´ëŸ¬ìŠ¤í„°ëŸ¬ ì´ˆê¸°í™” ì™„ë£Œ");
      } else {
        console.error("ì§€ë„ ê°ì²´ ì´ˆê¸°í™” ì‹¤íŒ¨");
        return;
      }

      //  ì§€ë„ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ (`idle` ì‚¬ìš©)
      kakao.maps.event.addListener(window.map, 'idle', function () {
        var center = window.map.getCenter();
        getRegionFromCoords(center, function (regionName, gugunName) {
          if (regionName && gugunName) {
            let regionKey = `${regionName} ${gugunName}`;

            if (!loadedRegions.has(regionKey)) {
              loadMarkersForRegion(regionName, gugunName);
              loadedRegions.add(regionKey);
              localStorage.setItem('loadedRegions', JSON.stringify(Array.from(loadedRegions)));
            }
          }
        });
      });

    } catch (error) {
      console.error("Kakao ì§€ë„ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
    }
  }


  // localStorageì—ì„œ ê¸°ì¡´ ì €ì¥ëœ ì§€ì—­ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° (ì—†ìœ¼ë©´ ë¹ˆ ë°°ì—´)
  var loadedRegions = new Set(JSON.parse(localStorage.getItem('loadedRegions')) || []);

  // ì¢Œí‘œë¥¼ ì‹œ/êµ¬ ì´ë¦„ìœ¼ë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
  function getRegionFromCoords(coords, callback) {
    var geocoder = new kakao.maps.services.Geocoder();

    geocoder.coord2RegionCode(coords.getLng(), coords.getLat(), function (result, status) {
      if (status === kakao.maps.services.Status.OK) {
        var regionInfo = result[0]; // ê°€ì¥ ê°€ê¹Œìš´ í–‰ì •êµ¬ì—­ ì •ë³´
        let regionName = regionInfo.address_name.split(" ")[0]; // ì˜ˆ: "ì„œìš¸íŠ¹ë³„ì‹œ"
        let gugunName = regionInfo.address_name.split(" ")[1]; // ì˜ˆ: "ê°•ë‚¨êµ¬"
        callback(regionName, gugunName);
      } else {
        console.warn("ì¢Œí‘œë¥¼ ì§€ì—­ëª…ìœ¼ë¡œ ë³€í™˜í•˜ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        callback(null, null);
      }
    });
  }
  let isMapLoading = false;

  function moveToSelectedRegion() {
    if (!window.map) {
      if (!isMapLoading) {
        isMapLoading = true;
        console.warn("ì§€ë„ ê°ì²´ê°€ ì•„ì§ ì´ˆê¸°í™”ë˜ì§€ ì•ŠìŒ, 500ms í›„ ì¬ì‹œë„...");
        setTimeout(() => {
          isMapLoading = false;  // ë‹¤ìŒ ì‹¤í–‰ì„ í—ˆìš©
          moveToSelectedRegion();
        }, 500);
      }
      return;
    }
    const regionName = `${selectedPath.city} ${selectedPath.district} ${selectedPath.neighborhood}`.trim();
    if (!regionName) {
      Alert.alert('', "ì§€ì—­ì„ ì„ íƒí•´ì£¼ì„¸ìš”!");
      return;
    }

    $.ajax({
      url: "/api/Map/coordinates",
      type: "GET",
      data: {name: regionName},
      headers: {
        'X-CSRF-Token': $('[name=_csrf]').val()
      },
      success: function (response) {
        if (response.success) {
          const latitude = response.lat;
          const longitude = response.lng;
          RegisterUserClose(); // ì§€ì—­ ì„ íƒ ì‹œ ëª¨ë‹¬ ë‹«ê¸°

          if (window.map) {
            const newCenter = new kakao.maps.LatLng(latitude, longitude);
            window.map.setCenter(newCenter);
            console.log(`ì§€ë„ ì¤‘ì‹¬ì´ ${regionName}(${latitude}, ${longitude})ë¡œ ì´ë™í–ˆìŠµë‹ˆë‹¤.`);

            // ì§€ì—­ ì •ë³´ë¥¼ ì–»ê³ , ì¤‘ë³µ ìš”ì²­ ë°©ì§€ í›„ ë§ˆì»¤ë¥¼ ë¡œë“œ
            let loadedRegions = new Set(JSON.parse(localStorage.getItem('loadedRegions') || "[]"));

            getRegionFromCoords(newCenter, function (regionName, gugunName) {
              if (regionName && gugunName) {
                let regionKey = `${regionName.trim()} ${gugunName.trim()}`;

                if (!loadedRegions.has(regionKey)) {
                  console.log(`ìƒˆë¡œìš´ ì§€ì—­(${regionKey}) ë§ˆì»¤ ìš”ì²­`);

                  // ë§ˆì»¤ ë¡œë”© í›„ì— loadedRegionsì— ì¶”ê°€í•´ì•¼ ì¤‘ë³µ ìš”ì²­ì´ ë°œìƒí•˜ì§€ ì•ŠìŒ
                  loadMarkersForRegion(regionName, gugunName).then(() => {
                    loadedRegions.add(regionKey);
                    localStorage.setItem('loadedRegions', JSON.stringify(Array.from(loadedRegions)));
                  }).catch(err => {
                    console.error(` ë§ˆì»¤ ë¡œë”© ì‹¤íŒ¨: ${err}`);
                  });

                } else {
                  //console.log(`ì´ë¯¸ ë¡œë“œëœ ì§€ì—­(${regionKey}), API ìš”ì²­ ìƒëµ`);
                }
              }
            });

          } else {
            console.warn("ì§€ë„ ê°ì²´ê°€ ì•„ì§ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
          }
        } else {
          alert("ì¢Œí‘œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }
      },
      error: function (xhr, status, error) {
        console.error("ì¢Œí‘œ ê²€ìƒ‰ API ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
        alert("ì¢Œí‘œ ê²€ìƒ‰ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
    });
  }

  //ì§€ì—­ ë¶ˆëŸ¬ì˜¤ê¸° ###########
  // SGIS API ë°ì´í„° ìš”ì²­
  function fetchRegionDataAjax() {
    $.ajax({
      url: '/api/Map', // SGIS API ì—”ë“œí¬ì¸íŠ¸
      type: 'GET',
      async: false,
      headers: {
        'X-CSRF-Token': $('[name=_csrf]').val()
      },
      success: function (data) {
        if (data.success) {
          populateRegionListAjax(data);
        } else {
          console.error("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", data.message);
        }
      },
      error: function (xhr, status, error) {
        console.error("API ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
      }
    });
  }

  // ì§€ì—­ ëª©ë¡ ìƒì„±
  function populateRegionListAjax(data) {
    const regionList = $('#region-list');
    regionList.empty(); // ê¸°ì¡´ ëª©ë¡ ì´ˆê¸°í™”

    // ì´ë¯¸ JSON ê°ì²´ë¼ë©´ JSON.parseë¥¼ í˜¸ì¶œí•˜ì§€ ì•ŠìŒ
    const results = data.data.result; // JSON ë°ì´í„° ì ‘ê·¼
    results.forEach(region => {
      const button = $('<button></button>')
        .text(region.addr_name) // ì‹œ/ë„ ì´ë¦„ ì„¤ì •
        .attr('class', 'region-button') // ìŠ¤íƒ€ì¼ í´ë˜ìŠ¤
        .attr('type', 'button')
        .on('click', () => loadDistrictsAjax(region.cd, region.addr_name)); // ì´ë¦„ê³¼ ì½”ë“œ ì „ë‹¬
      regionList.append(button); // ë²„íŠ¼ ì¶”ê°€
    });

    $('#region-modal').show(); // ëª¨ë‹¬ ë³´ì´ê¸°
  }

  // ì‹œ/ë„ ì„ íƒ ì‹œ êµ¬ ëª©ë¡ ë¡œë“œ
  function loadDistrictsAjax(cityCode, cityName) {
    selectedPath.city = cityName; // ì‹œ/ë„ ì´ë¦„ ì €ì¥
    updateSelectedPath(); // ì„ íƒ ê²½ë¡œ ì—…ë°ì´íŠ¸

    $.ajax({
      url: '/api/Map',
      type: 'GET',
      data: {cd: cityCode},
      headers: {
        'X-CSRF-Token': $('[name=_csrf]').val()
      },
      success: function (data) {
        const regionList = $('#region-list');
        regionList.empty();

        if (data.success) {
          // JSON ê°ì²´ë¡œ ë°”ë¡œ ì ‘ê·¼
          const results = data.data.result;
          results.forEach(district => {
            const button = $('<button></button>')
              .text(district.addr_name)
              .attr('class', 'district-button')
              .attr('type', 'button')
              .on('click', () => loadNeighborhoodsAjax(district.cd, district.addr_name));
            regionList.append(button);
          });
        } else {
          console.error("êµ¬ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", data.message);
        }
      },
      error: function (xhr, status, error) {
        console.error("API ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
      }
    });
  }

  // êµ¬ ì„ íƒ ì‹œ ë™ ëª©ë¡ ë¡œë“œ
  function loadNeighborhoodsAjax(districtCode, districtName) {
    selectedPath.district = districtName; // êµ¬ ì´ë¦„ ì €ì¥
    updateSelectedPath(); // ì„ íƒ ê²½ë¡œ ì—…ë°ì´íŠ¸

    $.ajax({
      url: '/api/Map',
      type: 'GET',
      data: {cd: districtCode},
      headers: {
        'X-CSRF-Token': $('[name=_csrf]').val()
      },
      success: function (data) {
        const regionList = $('#region-list');
        regionList.empty();

        if (data.success) {
          const results = data.data.result;
          results.forEach(neighborhood => {
            const button = $('<button></button>')
              .text(neighborhood.addr_name)
              .attr('class', 'neighborhood-button')
              .attr('type', 'button')
              .on('click', () => selectNeighborhood(neighborhood.addr_name));
            regionList.append(button);
          });
        } else {
          console.error("ë™ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", data.message);
        }
      },
      error: function (xhr, status, error) {
        console.error("API ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
      }
    });
  }

  // ë™ ì„ íƒ ì‹œ ìµœì¢… ê²½ë¡œ ì—…ë°ì´íŠ¸
  function selectNeighborhood(neighborhoodName) {
    selectedPath.neighborhood = neighborhoodName; // ë™ ì´ë¦„ ì €ì¥
    updateSelectedPath(); // ì„ íƒ ê²½ë¡œ ì—…ë°ì´íŠ¸

  }

  // ì„ íƒ ê²½ë¡œ ì—…ë°ì´íŠ¸
  function updateSelectedPath() {
    const fullPath = `${selectedPath.city} ${selectedPath.district} ${selectedPath.neighborhood}`.trim();
    const selectedRegionElement = document.getElementById('selected-region');
    const selectedRegionElement2 = document.getElementById('region-SelectList');

    // ì²« ë²ˆì§¸ ìš”ì†Œ ì—…ë°ì´íŠ¸
    if (selectedRegionElement) {
      selectedRegionElement.textContent = fullPath || "ì§€ì—­ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";
    } else {
      console.error("ì„ íƒëœ ì§€ì—­ì„ í‘œì‹œí•  ìš”ì†Œ(selected-region)ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    }

    // ë‘ ë²ˆì§¸ ìš”ì†Œ ì—…ë°ì´íŠ¸
    if (selectedRegionElement2) {
      selectedRegionElement2.textContent = fullPath || "ì§€ì—­ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";
    } else {
      console.error("ì„ íƒëœ ì§€ì—­ì„ í‘œì‹œí•  ìš”ì†Œ(region-SelectList)ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    }
  }

  // ë§ˆì»¤ ================================
  var activeOverlay = null; // í˜„ì¬ í™œì„±í™”ëœ ì˜¤ë²„ë ˆì´ ì €ì¥

  function loadMarkersForRegion(regionName, gugunName) {
    $.ajax({
      url: "/api/Map/markersByRegion",
      type: "GET",
      data: { region: regionName, gugun: gugunName },
      headers: {
        'X-CSRF-Token': $('[name=_csrf]').val()
      },
      success: function (response) {
        if (response.success) {
          clearMarkers(); // ê¸°ì¡´ ë§ˆì»¤ ì‚­ì œ
          console.log("ğŸ—‘ ê¸°ì¡´ ë§ˆì»¤ ì‚­ì œ ì™„ë£Œ");

          var gradeMarkerImages = {
            "S": "/img/Map/Së“±ê¸‰_marker.png",
            "A": "/img/Map/Aë“±ê¸‰_marker.png",
            "B": "/img/Map/Bë“±ê¸‰_marker.png",
            "C": "/img/Map/Cë“±ê¸‰_marker.png",
            "D": "/img/Map/Dë“±ê¸‰_marker.png",
            "E": "/img/Map/Eë“±ê¸‰_marker.png",
            "F": "/img/Map/Fë“±ê¸‰_marker.png"
          };

          var newMarkers = response.markers.map(markerData => {
            if (!markerData) {
              console.warn("markerDataê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŒ:", markerData);
              return null; // ì˜¤ë¥˜ ë°©ì§€
            }
            markerData.grade = markerData.grade || "S"; // ë“±ê¸‰ì´ ì—†ì„ ê²½ìš°ì—ëŠ” Së“±ê¸‰ìœ¼ë¡œ
            var markerImageUrl = gradeMarkerImages[markerData.grade] || "/img/Map/default_marker.png";

            var markerImage = new kakao.maps.MarkerImage(
              markerImageUrl,
              new kakao.maps.Size(30, 30),  // ë§ˆì»¤ í¬ê¸°
              { offset: new kakao.maps.Point(20, 40) }
            );

            var marker = new kakao.maps.Marker({
              position: new kakao.maps.LatLng(markerData.lat, markerData.lng),
              title: markerData.title || "No Title",
              image: markerImage,
              map: window.map
            });

            //console.log("markerData : ", markerData);
            // ë§ˆì»¤ ë°ì´í„° ì €ì¥
            marker.markerData = markerData;
            // ë“±ê¸‰ë³„ ì´ë¯¸ì§€ ë§¤í•‘
            var gradeImages = {
              "S": "/img/Map/Së“±ê¸‰.png",
              "A": "/img/Map/Aë“±ê¸‰.png",
              "B": "/img/Map/Bë“±ê¸‰.png",
              "C": "/img/Map/Cë“±ê¸‰.png",
              "D": "/img/Map/Dë“±ê¸‰.png",
              "E": "/img/Map/Eë“±ê¸‰.png",
              "F": "/img/Map/Fë“±ê¸‰.png"
            };

            // ë“±ê¸‰ ì„¤ì • (undefined ë°©ì§€)
            var gradeClass = markerData.grade ? `grade-${markerData.grade}` : "grade-Unknown";

            // ì´ë¯¸ì§€ ì„¤ì • (markerData.imageê°€ ì—†ì„ ê²½ìš° ê¸°ë³¸ê°’ ì„¤ì •)
            var imageUrl = markerData.image && markerData.image.trim() !== ""
              ? markerData.image
              : (gradeImages[markerData.grade] || 'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/thumnail.png');

            // ì»¤ìŠ¤í…€ ì˜¤ë²„ë ˆì´ ì»¨í…ì¸  ìƒì„±
            var content = `
                    <div class="wrap">
                        <div class="info">
                            <div class="title">
                                ${markerData.REGUGUN} _ ${markerData.grade || 'Unknown'} ë“±ê¸‰
                                <div class="close" onclick="closeOverlay(${markerData.lat}, ${markerData.lng})" title="ë‹«ê¸°"></div>
                            </div>
                            <div class="body ${gradeClass}">
                                <div class="img">
                                   <img src="${imageUrl}" width="73" height="70">
                                </div>
                                <div class="desc">
                                    <div class="jibun ellipsis">${markerData.jibun || ''}</div>
                                    <div class="avg_score"> ì ìˆ˜ : ${markerData.avg_score || ''}</div>
                                    <div class="count"> ë°œê¸‰ê±´ìˆ˜: ${markerData.count || ''} </div>
                                </div>
                            </div>
                        </div>
                    </div>`;

            // ì»¤ìŠ¤í…€ ì˜¤ë²„ë ˆì´ ìƒì„±
            var overlay = new kakao.maps.CustomOverlay({
              content: content,
              position: marker.getPosition(),
              map: null // ê¸°ë³¸ì ìœ¼ë¡œ ë‹«íŒ ìƒíƒœ
            });

            // ë§ˆì»¤ í´ë¦­ ì‹œ ì˜¤ë²„ë ˆì´ í‘œì‹œ
            kakao.maps.event.addListener(marker, 'click', function () {
              if (activeOverlay) {
                activeOverlay.setMap(null); // ê¸°ì¡´ ì˜¤ë²„ë ˆì´ ë‹«ê¸°
              }
              overlay.setMap(window.map); // ìƒˆë¡œìš´ ì˜¤ë²„ë ˆì´ ì—´ê¸°
              activeOverlay = overlay; // í˜„ì¬ ì˜¤ë²„ë ˆì´ ì €ì¥
            });

            // ë§ˆì»¤ ë°ì´í„°ì— ì˜¤ë²„ë ˆì´ ì €ì¥ (ë‹«ê¸° ë²„íŠ¼ì—ì„œ ì°¾ê¸° ìœ„í•´)
            markerData.overlay = overlay;

            return marker;
          });

          // í´ëŸ¬ìŠ¤í„°ëŸ¬ì— ë§ˆì»¤ ì¶”ê°€
          if (window.clusterer) {
            console.log(`${regionName} ${gugunName} ì§€ì—­ì˜ ë§ˆì»¤ ${newMarkers.length}ê°œ ì¶”ê°€`);
            window.clusterer.addMarkers(newMarkers);
          } else {
            console.error("í´ëŸ¬ìŠ¤í„°ëŸ¬ ê°ì²´ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•ŠìŒ");
          }
        } else {
          console.error("ë§ˆì»¤ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
        }
      },
      error: function (xhr, status, error) {
        console.error("ë§ˆì»¤ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", error);
      }
    });
  }


  // ì˜¤ë²„ë ˆì´ ë‹«ê¸° í•¨ìˆ˜ (íŠ¹ì • ë§ˆì»¤ì˜ ì˜¤ë²„ë ˆì´ ë‹«ê¸°)
  function closeOverlay(lat, lng) {
    if (activeOverlay) {
      activeOverlay.setMap(null);
      activeOverlay = null;
    }
  }

  // ê¸°ì¡´ ë§ˆì»¤ ì œê±° í•¨ìˆ˜
  function clearMarkers() {
    if (window.clusterer) {
      //console.log(" ê¸°ì¡´ ë§ˆì»¤ ê°œìˆ˜:", window.clusterer.getMarkers().length);
      window.clusterer.clear();
      // console.log("ê¸°ì¡´ ë§ˆì»¤ ì‚­ì œ ì™„ë£Œ");
    } else {
      console.warn("í´ëŸ¬ìŠ¤í„°ëŸ¬ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•ŠìŒ");
    }
  }
</script>
</body>
</html>