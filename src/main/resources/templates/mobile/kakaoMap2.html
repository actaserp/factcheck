<!DOCTYPE html>
<html lang="ko">
<style>
    .btn-clear {
        display: none !important; /* 강제로 숨김 */
    }

    .btn-close {
        display: none !important; /* 강제로 숨김 */
    }
</style>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FACT CHECK</title>
  <link rel="icon" type="image/png" href="/images/logo/icon_FACT%20CHECK.png">
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/smoothness/jquery-ui.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/> <!-- Slide css -->
  <link rel="stylesheet" href="/resource/ax5ui/ax5ui.all.css">
  <link rel="stylesheet" type="text/css" href="/assets_mobile/css/import.css">
  <link rel="stylesheet" type="text/css" href="/css/MapStyle.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>

  <script src="/assets_mobile/js/ui.js"></script> <!-- Common js -->
  <script th:inline="javascript">
    var sandanData = /*[[${session.sandanList}]]*/ [];
  </script>


  <script type="text/javascript" src="/resource/ax5ui/ax5ui.all.min.js?v=1000"></script>

  <script type="text/javascript" src="/js/ax5commUtil.js?v=1070"></script>

  <script src="/js/common.js?v=1060"></script>
  <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script> <!-- Slide js -->
  <script src="/js/Mobile.js"></script>
</head>
<div class="mobile-wrapper page-kakaoMap2"><!-- ★페이지 Class명 -->
  <!-- [모바일] 헤더  -->
  <div class="mobile-layout-header">
    <header>
      <div class="left">
        <a href="#" title="전체메뉴" class="logo">
        </a>
      </div>
      <div class="center" style="margin-left:10px;">
        <h2>지역별 등기 상황맵(지도로 보기)</h2>
      </div>
      <div class="right">
        <a href="#" title="전체메뉴" class="btn-menu">
          <img src="/assets_mobile/images/icon/btn-menu.svg" alt="전체메뉴 아이콘">
        </a>
      </div>
    </header>
  </div> <!-- //mobile-layout-header end-->

  <!-- [모바일] 메뉴  -->
  <div th:insert="~{mobile/mobile_menu :: mobile_menu}"></div>
  <!-- [모바일] 컨덴츠  -->
  <div class="mobile-layout-contents">
    <!--- (레이아웃) Contents 영역 -->
    <div class="layout-contents" style="width:100%;height:100vh;">
      <!-- 컨텐츠 영역  -->
      <div class="contents-wrap">
        <div>
          <li style="margin-top: 5% ">
            <a href="#" class="btn btn-popup-open" data-popup="popup1" onclick="regionList()"
               title="지역선택">지역 선택</a>
          </li>
        </div>
        <div style=" margin-top: 5%">
          <span id="selected-region" style="font-size: 20px; font-weight: bold; color: #333;"></span>
        </div>

        <div id="map" style="width:100%;height: 65vh ; flex-grow: 1;"></div>

        <div style="margin-top: 5%">
          <ol id="search-results" class="list-group list-group-numbered" style="font-size: 20px;">
            <li class="list-group-item">1. 지역검색 시 보이는 발급 내역</li>
            <li class="list-group-item">2. 지역검색 시 보이는 발급 내역</li>
            <li class="list-group-item">3. 지역검색 시 보이는 발급 내역</li>
          </ol>
        </div>
      </div>  <!--// contents-wrap end-->
    </div> <!--//layout-contents end -->
  </div> <!-- //mobile-layout-contents end-->

  <div class="mobile-layout-popup">
    <div class="popup-overlay"></div>
    <div class="popup-wrapper" id="popup1">
      <form id="bomForm1">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
        <div class="popup-title">
          <h3>지역 선택</h3>
          <a onclick="RegisterUserClose()" title="팝업닫기" class="btn-popup-close">
            <img src="/assets_mobile/images/icon/btn-popup-close.svg" alt="닫기">
          </a>
        </div>
        <div class="popup-contents">
          <div class="table-wrap" id="bomForm">
            <div class="write-wrap">
              <div class="row">
                <dl>
                  <dt>
                  </dt>
                  <dd>
                    <div id="region-modal" style="display: none;">
                      <div id="region-SelectList" style="font-size: 24px; margin-bottom:25px; "></div>
                      <div id="region-list"></div>
                    </div>
                  </dd>
                </dl>
              </div>
            </div>
          </div>
        </div>
        <div class="popup-button">
          <button class="btn-navy" id="btnSaveAuth" onclick="moveToSelectedRegion()">지역 검색</button>
        </div>
      </form>
    </div>
  </div> <!-- //mobile-layout-popup end -->
</div> <!-- //page-wrapper end-->
<body>
<script type="text/javascript">
  document.readyState === 'complete' ? init() : window.onload = init;
  let map;

  let selectedPath = {
    city: '',  // 선택한 시/도
    district: '', // 선택한 구
    neighborhood: '' // 선택한 동
  };

  function init() {
    loadKakaoMapScript();

    localStorage.removeItem('loadedRegions'); // 로컬 스토리지에서 삭제
    loadedRegions = new Set();
    //console.log("로컬 스토리지 초기화됨. loadedRegions:", loadedRegions);
  }

  //지역선택 팝업열기
  function regionList() {
    let popup = document.getElementById('popup1');
    let overlay = document.querySelector('.popup-overlay');

    if (popup && overlay) {
      popup.classList.add('active'); // 팝업 활성화
      overlay.style.display = 'block'; // 오버레이 보이기
    } else {
      console.error('popup1 또는 popup-overlay 요소를 찾을 수 없습니다.');
    }
    fetchRegionDataAjax();
  }

  function RegisterUserClose() {
    let popup = document.getElementById('popup1');
    let overlay = document.querySelector('.popup-overlay');

    if (popup && overlay) {
      // 팝업 비활성화
      popup.classList.remove('active');

      // 오버레이 숨기기
      overlay.style.display = 'none';
      $('#region-SelectList').empty(); // 선택한 경로 초기화
      selectedPath = {city: '', district: '', neighborhood: ''}; // 선택 경로 초기화
      // 입력 폼 초기화
    } else {
      console.error('popup1 또는 popup-overlay 요소를 찾을 수 없습니다.');
    }
  }

  //모달 끝###############################################

  // 서버를 통해 카카오 지도 스크립트 로드
  function loadKakaoMapScript() {
    $.ajax({
      url: '/api/Map/script',
      type: 'GET',
      dataType: 'text',
      success: function (scriptUrl) {
        // autoload=false를 URL에 추가
        const scriptWithAutoload = `${scriptUrl}&autoload=false`;

        // 기존 script 태그 제거 (중복 방지)
        const existingScript = document.querySelector("script[src^='https://dapi.kakao.com/v2/maps/sdk.js']");
        if (existingScript) {
          existingScript.remove();
        }

        // 새로운 script 태그 생성 및 삽입
        const scriptElement = document.createElement('script');
        scriptElement.type = 'text/javascript';
        scriptElement.src = scriptUrl + "&libraries=clusterer,services&autoload=false";
        scriptElement.async = false;
        document.head.appendChild(scriptElement);

        scriptElement.onload = function () {
          console.log("카카오 지도 스크립트 로드 완료");

          // 로딩 완료 후, Kakao API 객체 초기화
          if (typeof kakao === "undefined" || typeof kakao.maps === "undefined") {
            console.error("Kakao 지도 API가 로드되지 않았습니다.");
            return;
          }

          // Kakao API의 load 메서드를 사용해 초기화 진행
          kakao.maps.load(function () {
            initializeMap(); // 지도 초기화 호출
          });
        };

        scriptElement.onerror = function () {
          console.error("카카오 지도 스크립트 로드에 실패했습니다.");
        };
      },
      error: function (xhr, status, error) {
        console.error("카카오 지도 스크립트 요청 실패:", error);
      }
    });
  }

  // 지도 초기화
  function initializeMap() {
    try {
      const container = document.getElementById('map');
      if (!container) {
        throw new Error("지도를 표시할 #map 요소가 존재하지 않습니다.");
      }

      const options = {
        center: new kakao.maps.LatLng(33.450701, 126.570667), // 지도 중심 좌표
        level: 3 // 확대 레벨
      };

      window.map = new kakao.maps.Map(container, options); // 전역 변수로 map 생성
      console.log("Kakao 지도 초기화 완료");

      // map이 정상적으로 생성되었는지 확인 후 클러스터러 생성
      if (window.map) {
        window.clusterer = new kakao.maps.MarkerClusterer({
          map: window.map, // 지도 객체
          averageCenter: true, // 클러스터의 중심을 평균값으로 설정
          minLevel: 3,  // 최소 클러스터링 레벨 설정
          styles: [{
            minWidth: '30px',
            height: '30px',
            padding: '0px 6px',
            color: 'rgb(255, 255, 255)',
            fontSize: '12px',
            lineHeight: '26px',
            textAlign: 'center',
            border: '2px solid rgb(50, 108, 249)',
            borderRadius: '30px',
            backgroundColor: 'rgb(50, 108, 249)',
            whiteSpace: 'nowrap',
            position: 'relative',
            zIndex: '2'
          }]

        });
        console.log("마커 클러스터러 초기화 완료");
      } else {
        console.error(" 지도 객체 초기화 실패");
        return; // 지도 객체 없으면 실행 중지
      }

      // 지도 이벤트 리스너 등록 (`idle` 사용)
      kakao.maps.event.addListener(window.map, 'idle', function () {
        //console.log(" 지도 IDLE 이벤트 발생: 데이터 요청 가능");
        var center = window.map.getCenter();
        getRegionFromCoords(center, function (regionName, gugunName) {
          if (regionName && gugunName) {
            let regionKey = `${regionName} ${gugunName}`;

            if (!loadedRegions.has(regionKey)) {
              //console.log(` 새로운 지역(${regionKey}) 마커 요청`);
              loadMarkersForRegion(regionName, gugunName);
              loadedRegions.add(regionKey);
              localStorage.setItem('loadedRegions', JSON.stringify(Array.from(loadedRegions)));
            } else {
              //console.log(`⚡ 이미 로드된 지역(${regionKey}), API 요청 생략`);
            }
          }
        });
      });

    } catch (error) {
      console.error("Kakao 지도 초기화 중 오류 발생:", error);
    }
  }
  // localStorage에서 기존 저장된 지역 정보 불러오기 (없으면 빈 배열)
  var loadedRegions = new Set(JSON.parse(localStorage.getItem('loadedRegions')) || []);

  // 좌표를 시/구 이름으로 변환하는 함수
  function getRegionFromCoords(coords, callback) {
    var geocoder = new kakao.maps.services.Geocoder();

    geocoder.coord2RegionCode(coords.getLng(), coords.getLat(), function (result, status) {
      if (status === kakao.maps.services.Status.OK) {
        var regionInfo = result[0]; // 가장 가까운 행정구역 정보
        let regionName = regionInfo.address_name.split(" ")[0]; // 예: "서울특별시"
        let gugunName = regionInfo.address_name.split(" ")[1]; // 예: "강남구"
        callback(regionName, gugunName);
      } else {
        console.warn("좌표를 지역명으로 변환하는데 실패했습니다.");
        callback(null, null);
      }
    });
  }

  function moveToSelectedRegion() {
    if (!window.map) {
      console.error("지도 객체가 초기화되지 않았습니다.");
      setTimeout(moveToSelectedRegion, 500);
      return;
    }

    const regionName = `${selectedPath.city} ${selectedPath.district} ${selectedPath.neighborhood}`.trim();
    if (!regionName) {
      Alert.alert('', "지역을 선택해주세요!");
      return;
    }

    $.ajax({
      url: "/api/Map/coordinates",
      type: "GET",
      data: {name: regionName},
      success: function (response) {
        if (response.success) {
          const latitude = response.lat;
          const longitude = response.lng;
          RegisterUserClose(); // 지역 선택 시 모달 닫기

          if (window.map) {
            const newCenter = new kakao.maps.LatLng(latitude, longitude);
            window.map.setCenter(newCenter);
            console.log(`지도 중심이 ${regionName}(${latitude}, ${longitude})로 이동했습니다.`);

            // 지역 정보를 얻고, 중복 요청 방지 후 마커를 로드
            let loadedRegions = new Set(JSON.parse(localStorage.getItem('loadedRegions') || "[]"));

            getRegionFromCoords(newCenter, function (regionName, gugunName) {
              if (regionName && gugunName) {
                let regionKey = `${regionName.trim()} ${gugunName.trim()}`;

                if (!loadedRegions.has(regionKey)) {
                  console.log(`새로운 지역(${regionKey}) 마커 요청`);

                  // 마커 로딩 후에 loadedRegions에 추가해야 중복 요청이 발생하지 않음
                  loadMarkersForRegion(regionName, gugunName).then(() => {
                    loadedRegions.add(regionKey);
                    localStorage.setItem('loadedRegions', JSON.stringify(Array.from(loadedRegions)));
                  }).catch(err => {
                    console.error(` 마커 로딩 실패: ${err}`);
                  });

                } else {
                  //console.log(`이미 로드된 지역(${regionKey}), API 요청 생략`);
                }
              }
            });

          } else {
            console.warn("지도 객체가 아직 초기화되지 않았습니다.");
          }
        } else {
          alert("좌표를 찾을 수 없습니다.");
        }
      },
      error: function (xhr, status, error) {
        console.error("좌표 검색 API 요청 중 오류 발생:", error);
        alert("좌표 검색 중 문제가 발생했습니다.");
      }
    });
  }

  //지역 불러오기 ###########
  // SGIS API 데이터 요청
  function fetchRegionDataAjax() {
    $.ajax({
      url: '/api/Map', // SGIS API 엔드포인트
      type: 'GET',
      async: false,
      headers: {
        'X-CSRF-Token': $('[name=_csrf]').val()
      },
      success: function (data) {
        if (data.success) {
          populateRegionListAjax(data);
        } else {
          console.error("데이터 로드 실패:", data.message);
        }
      },
      error: function (xhr, status, error) {
        console.error("API 요청 중 오류 발생:", error);
      }
    });
  }

  // 지역 목록 생성
  function populateRegionListAjax(data) {
    const regionList = $('#region-list');
    regionList.empty(); // 기존 목록 초기화

    // 이미 JSON 객체라면 JSON.parse를 호출하지 않음
    const results = data.data.result; // JSON 데이터 접근
    results.forEach(region => {
      const button = $('<button></button>')
        .text(region.addr_name) // 시/도 이름 설정
        .attr('class', 'region-button') // 스타일 클래스
        .on('click', () => loadDistrictsAjax(region.cd, region.addr_name)); // 이름과 코드 전달
      regionList.append(button); // 버튼 추가
    });

    $('#region-modal').show(); // 모달 보이기
  }

  // 시/도 선택 시 구 목록 로드
  function loadDistrictsAjax(cityCode, cityName) {
    selectedPath.city = cityName; // 시/도 이름 저장
    updateSelectedPath(); // 선택 경로 업데이트

    $.ajax({
      url: '/api/Map',
      type: 'GET',
      data: {cd: cityCode},
      headers: {
        'X-CSRF-Token': $('[name=_csrf]').val()
      },
      success: function (data) {
        const regionList = $('#region-list');
        regionList.empty();

        if (data.success) {
          // JSON 객체로 바로 접근
          const results = data.data.result;
          results.forEach(district => {
            const button = $('<button></button>')
              .text(district.addr_name)
              .attr('class', 'district-button')
              .on('click', () => loadNeighborhoodsAjax(district.cd, district.addr_name));
            regionList.append(button);
          });
        } else {
          console.error("구 데이터 로드 실패:", data.message);
        }
      },
      error: function (xhr, status, error) {
        console.error("API 요청 중 오류 발생:", error);
      }
    });
  }

  // 구 선택 시 동 목록 로드
  function loadNeighborhoodsAjax(districtCode, districtName) {
    selectedPath.district = districtName; // 구 이름 저장
    updateSelectedPath(); // 선택 경로 업데이트

    $.ajax({
      url: '/api/Map',
      type: 'GET',
      data: {cd: districtCode},
      headers: {
        'X-CSRF-Token': $('[name=_csrf]').val()
      },
      success: function (data) {
        const regionList = $('#region-list');
        regionList.empty();

        if (data.success) {
          const results = data.data.result;
          results.forEach(neighborhood => {
            const button = $('<button></button>')
              .text(neighborhood.addr_name)
              .attr('class', 'neighborhood-button')
              .on('click', () => selectNeighborhood(neighborhood.addr_name));
            regionList.append(button);
          });
        } else {
          console.error("동 데이터 로드 실패:", data.message);
        }
      },
      error: function (xhr, status, error) {
        console.error("API 요청 중 오류 발생:", error);
      }
    });
  }

  // 동 선택 시 최종 경로 업데이트
  function selectNeighborhood(neighborhoodName) {
    selectedPath.neighborhood = neighborhoodName; // 동 이름 저장
    updateSelectedPath(); // 선택 경로 업데이트

  }

  // 선택 경로 업데이트
  function updateSelectedPath() {
    const fullPath = `${selectedPath.city} ${selectedPath.district} ${selectedPath.neighborhood}`.trim();
    const selectedRegionElement = document.getElementById('selected-region');
    const selectedRegionElement2 = document.getElementById('region-SelectList');

    // 첫 번째 요소 업데이트
    if (selectedRegionElement) {
      selectedRegionElement.textContent = fullPath || "지역이 선택되지 않았습니다.";
    } else {
      console.error("선택된 지역을 표시할 요소(selected-region)를 찾을 수 없습니다.");
    }

    // 두 번째 요소 업데이트
    if (selectedRegionElement2) {
      selectedRegionElement2.textContent = fullPath || "지역이 선택되지 않았습니다.";
    } else {
      console.error("선택된 지역을 표시할 요소(region-SelectList)를 찾을 수 없습니다.");
    }
  }

  // 마커 ================================
  var activeOverlay = null; // 현재 활성화된 오버레이 저장

  function loadMarkersForRegion(regionName, gugunName) {
    $.ajax({
      url: "/api/Map/markersByRegion",
      type: "GET",
      data: { region: regionName, gugun: gugunName },
      success: function (response) {
        if (response.success) {
          clearMarkers(); // 기존 마커 삭제
          console.log("🗑 기존 마커 삭제 완료");

          var newMarkers = response.markers.map(markerData => {
            // 마커 생성
            var marker = new kakao.maps.Marker({
              position: new kakao.maps.LatLng(markerData.lat, markerData.lng),
              title: markerData.title,
              map: window.map // 지도에 추가
            });

            // 커스텀 오버레이 컨텐츠 생성 (닫기 버튼에서 closeOverlay(lat, lng) 호출)
            var content = `
                        <div class="wrap">
                            <div class="info">
                                <div class="title">
                                    ${markerData.title}
                                    <div class="close" onclick="closeOverlay(${markerData.lat}, ${markerData.lng})" title="닫기"></div>
                                </div>
                                <div class="body">
                                    <div class="img">
                                        <img src="${markerData.image || 'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/thumnail.png'}" width="73" height="70">
                                    </div>
                                    <div class="desc">
                                        <div class="ellipsis">${markerData.address || '주소 정보 없음'}</div>
                                        <div class="jibun ellipsis">${markerData.jibun || ''}</div>
                                        <div><a href="${markerData.url || '#'}" target="_blank" class="link">홈페이지</a></div>
                                    </div>
                                </div>
                            </div>
                        </div>`;

            // 커스텀 오버레이 생성
            var overlay = new kakao.maps.CustomOverlay({
              content: content,
              position: marker.getPosition(),
              map: null // 기본적으로 닫힌 상태
            });

            // 마커 클릭 시 오버레이 표시
            kakao.maps.event.addListener(marker, 'click', function () {
              if (activeOverlay) {
                activeOverlay.setMap(null); // 기존 오버레이 닫기
              }
              overlay.setMap(window.map); // 새로운 오버레이 열기
              activeOverlay = overlay; // 현재 오버레이 저장
            });

            // 마커 데이터에 오버레이 저장 (닫기 버튼에서 찾기 위해)
            markerData.overlay = overlay;

            return marker;
          });

          // 클러스터러에 마커 추가
          if (window.clusterer) {
            console.log(`${regionName} ${gugunName} 지역의 마커 ${newMarkers.length}개 추가`);
            window.clusterer.addMarkers(newMarkers);
          } else {
            console.error("클러스터러 객체가 초기화되지 않음");
          }
        } else {
          console.error(" 마커 데이터를 불러오지 못했습니다.");
        }
      },
      error: function (xhr, status, error) {
        console.error("마커 불러오기 오류:", error);
      }
    });
  }

  // 오버레이 닫기 함수 (특정 마커의 오버레이 닫기)
  function closeOverlay(lat, lng) {
    if (activeOverlay) {
      activeOverlay.setMap(null);
      activeOverlay = null;
    }
  }

  // 기존 마커 제거 함수
  function clearMarkers() {
    if (window.clusterer) {
      //console.log(" 기존 마커 개수:", window.clusterer.getMarkers().length);
      window.clusterer.clear();
     // console.log("기존 마커 삭제 완료");
    } else {
      console.warn("클러스터러가 초기화되지 않음");
    }
  }
</script>
</body>
</html>