<!DOCTYPE html>
<html lang="ko">
<style>
    .btn-clear {
        display: none !important; /* 강제로 숨김 */
    }

    .btn-close {
        display: none !important; /* 강제로 숨김 */
    }

    .tab-links {
        display: flex;
        margin-left: 1px;
        margin-bottom: -1px;
        overflow: hidden;
    }

    .tab-links li {
        position: relative;
    }

    .tab-links li:first-child a {
        border-radius: 6px 0 0 0;
    }

    .tab-links li:last-child a {
        border-radius: 0 6px 0 0;
    }

    .tab-links li a {
        display: inline-flex;
        justify-content: center;
        min-width: 120px;
        padding: 3px 32px 15px 32px;
        color: #808080;
        font-size: 18px;
        font-weight: 700;
        text-align: center;
        transition: all .3s;
        border-bottom: 3px solid #C6C6C6;
    }

    .tab-links li:hover a {
        color: #4D4D4D;
        font-weight: 700;
        border-bottom: 3px solid #4D4D4D;
    }

    .tab-links li.active a {
        color: #03428E;
        font-weight: 700;
        border-bottom: 3px solid #03428E;
    }

    section .tab-links {
    }

    section .tab-links li a {
        padding: 8px 10px;
        margin-right: -1px;
        border: 1px solid #E4E4E4;
        background-color: #fff;
        color: #808080;
    }

    section .tab-links li:first-child a {
        border-radius: 12px 0 0 12px;
    }

    section .tab-links li:last-child a {
        border-radius: 0 12px 12px 0;
        margin-right: 0;
    }

    section .tab-links li.active a {
        background-color: #3069B3;
        color: #fff;
    }

    .tab-links-sub {
        display: flex;
        margin-left: 1px;
        margin-bottom: -1px;
        overflow: hidden;
    }

    .tab-links-sub li {
        position: relative;
    }

    .tab-links-sub li a {
        display: inline-flex;
        border: 1px solid #E4E4E4;
        justify-content: center;
        min-width: 90px;
        padding: 8px 32px 8px 32px;
        background-color: #fff;
        color: #333333;
        font-size: 17px;
        font-weight: 700;
        text-align: center;
        transition: all .3s;
    }

    .tab-links-sub li:hover a {
        border-radius: 3px 0 0 3px;
        color: #4D4D4D;
        border: 1px solid #E4E4E4;
        border-right: 1px solid #E4E4E4;
        border-left: 1px solid #E4E4E4;
        background-color: #f5f6fa;
    }

    .tab-links-sub li:first-child a {
        border-radius: 3px 0 0 3px;
        border-right: 0
    }

    .tab-links-sub li:first-child:hover a {
        border-radius: 3px 0 0 3px;
        color: #4D4D4D;
        border: 1px solid #b3b3b3;
        border-right: 0;
        background-color: #f5f6fa;
    }

    .tab-links-sub li:last-child a {
        border-radius: 0 3px 3px 0;
        border-left: 0
    }

    .tab-links-sub li:last-child:hover a {
        color: #4D4D4D;
        border: 1px solid #b3b3b3;
        border-left: 0;
        background-color: #f5f6fa;
        border-radius: 0 3px 3px 0;
        border-left: 0
    }

    /*section .tab-links-sub li:hover a {color: #4D4D4D; border: 1px solid #b3b3b3; background-color: #f5f6fa;}*/
    .tab-links-sub li.active a {
        background-color: #2EC9D6;
        color: #fff;
        font-weight: 700;
        border: 1px solid #2EC9D6;
    }


    .tab-contents > section, .tab-item1 > .row > section:first-child {
        border-radius: 0 15px 15px 15px;
    }

    .tab-contents > .row > section {
        border-radius: 0 15px 15px 15px;
    }

</style>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FACT CHECK</title>
  <link rel="icon" type="image/png" href="/images/logo/icon_FACT%20CHECK.png">
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/smoothness/jquery-ui.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/> <!-- Slide css -->
  <link rel="stylesheet" href="/resource/ax5ui/ax5ui.all.css">
  <link rel="stylesheet" type="text/css" href="/assets_mobile/css/import.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>

  <script src="/assets_mobile/js/ui.js"></script> <!-- Common js -->
  <script th:inline="javascript">
    var sandanData = /*[[${session.sandanList}]]*/ [];
  </script>


  <script type="text/javascript" src="/resource/ax5ui/ax5ui.all.min.js?v=1000"></script>

  <script type="text/javascript" src="/js/ax5commUtil.js?v=1070"></script>

  <script src="/js/common.js?v=1060"></script>
  <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script> <!-- Slide js -->
  <script src="/js/Mobile.js"></script>
</head>

<body>
<div class="mobile-wrapper page-ticket-list"><!-- ★페이지 Class명 -->
  <!-- [모바일] 헤더  -->
  <div class="mobile-layout-header">
    <header>
      <div class="left">
        <a href="#" title="전체메뉴" class="logo">
        </a>
      </div>
      <div class="center" style="margin-left:35px;">
        <h2>물건 열람 상세 내역</h2>
      </div>
      <div class="right">
        <a href="#" title="전체메뉴" class="btn-menu">
          <img src="/assets_mobile/images/icon/btn-menu.svg" alt="전체메뉴 아이콘">
        </a>
      </div>
    </header>
  </div> <!-- //mobile-layout-header end-->

  <!-- [모바일] 메뉴  -->
  <div th:insert="~{mobile/mobile_menu :: mobile_menu}"></div>
  <!-- [모바일] 컨덴츠  -->
  <div class="mobile-layout-contents">
    <!--- (레이아웃) Contents 영역 -->
    <div class="layout-contents">
      <!-- 검색 영역  -->
      <div class="search-wrap">
        <div class="srch-tit aco-hd">
          <p>회원들이 조회한 등기부 정보를 볼수있습니다.</p>
          <a href="#" title="열기/닫기" class="btn-aco">
            <img src="/assets_mobile/images/icon/ico-down.svg" alt="열기/닫기">
          </a>
        </div>
        <div class="srch-cont aco-cont">
          <dl>
            <dt>
              조회일자<span class="eq">*</span>
            </dt>
            <dd>
              <ul class="date-box">
                <li>
                  <input type="date" id="startDate" name="startDate">
                  <label for="startDate" class="hide">시작일</label>
                </li>
                <li>
                  <input type="date" id="endDate" name="endDate">
                  <label for="endDate" class="hide">종료일</label>
                </li>
              </ul>
            </dd>
          </dl>
          <dl>
            <dt>검색조건</dt>
            <dd>
              <div style="width: 100%; display: flex; gap: 20px;">
                <label for="property" style="display: flex; align-items: center; gap: 5px;"></label>
                <select id="property" name="property" style="width: 100%; text-align: center;">
                  <option value="my_property" selected>내가 조회한 물건</option>
                  <option value="recent_property">최근 조회한 물건</option>
                  <option value="most_viewed_property">가장 많이 발급받은 물건</option>
                  <option value="popular_property">인기물건</option>
                </select>
              </div>
            </dd>
          </dl>

          <dl>
            <dt>주소 검색</dt>
            <dd>
              <input type="text" id="keyword" name="keyword" placeholder="검색할 부동산 주소 입력">
            </dd>
          </dl>

          <div class="srch-btn">
            <button class="btn-dark" onclick="handleSearch()">조회</button>
          </div>
        </div>
      </div>
      <!-- 컨텐츠 영역  -->
      <div class="contents-wrap">
        <div class="list-top-wrap">
          <div class="list-num">
            목록 <span class="blue">- 건</span>
          </div>
        </div>
        <div id="addressWrap" class="contents-wrap">

        </div> <!--//card-wrap end-->
      </div> <!--// contents-wrap end-->
    </div> <!--//layout-contents end -->

  </div> <!-- //mobile-layout-contents end-->

  <div class="mobile-layout-popup" id="popup-history">
    <!--<div class="popup-overlay"></div>-->
    <div class="popup-wrapper">
      <div class="popup-title">
        <h3>상세내용</h3>
      </div>
      <div class="popup-contents">
        <div class="table-wrap">
          <div class="write-wrap">
            <section>
              <div class="tab-wrap" style="width: 100%;">
                <ul class="tab-links" style="margin-bottom: 10px;">
                  <li><a href="#main" name="tabs_basic">표제부</a></li>
                  <li><a href="#sub1" name="tab_production">갑구</a></li>
                  <li><a href="#sub2" name="tab_production">을구</a></li>
                </ul>

                <section class="tab-item" id="main">
                  <table class="write-table"
                         style="width: 100%; border-collapse: collapse; table-layout: fixed; ">
                    <caption style="text-align: left; margin-bottom: 8px;">상세테이블</caption>
                    <thead>
                    <tr>
                      <th colspan="4" style="text-align: center;">표 제 부 (건물의 표시)</th>
                    </tr>

                    </thead>
                    <tbody>
                    <tr>
                      <th style="text-align: center; width: 7%; padding: 5px; border: 1px solid #ddd; font-size: 13px;">
                        <label>접수</label>
                      </th>
                      <td style="width: 15%; padding: 5px; border: 1px solid #ddd;" colspan="3">

                      </td>
                    </tr>
                    <tr>
                      <th style="text-align: center; width: 7%; padding: 5px; border: 1px solid #ddd; font-size: 13px;">
                        <label>소재지번,건물명칭 및 번호</label>
                      </th>
                      <td style="width: 15%; padding: 5px; border: 1px solid #ddd;" colspan="3">

                      </td>
                    </tr>

                    <tr>
                      <th style="text-align: center; width: 7%; padding: 5px; border: 1px solid #ddd; font-size: 13px;">
                        <label>소재지번</label>
                      </th>
                      <td style="width: 15%; padding: 5px; border: 1px solid #ddd;" colspan="3">

                      </td>
                    </tr>

                    <tr>
                      <th style="text-align: center; width: 7%; padding: 5px; border: 1px solid #ddd; font-size: 13px;">
                        <label>지목</label>
                      </th>
                      <td style="width: 15%; padding: 5px; border: 1px solid #ddd;">

                      </td>

                      <th style="text-align: center; width: 7%; padding: 5px; border: 1px solid #ddd; font-size: 13px;">
                        <label>면적</label>
                      </th>
                      <td style="width: 15%; padding: 5px; border: 1px solid #ddd;">

                      </td>
                    </tr>

                    <tr>
                      <th style="text-align: center; width: 7%; padding: 5px; border: 1px solid #ddd; font-size: 13px;">
                        <label>채권최고액등</label>
                      </th>
                      <td style="width: 15%; padding: 5px; border: 1px solid #ddd;" colspan="3">
                      </td>
                    </tr>
                    </tbody>
                  </table>
                </section>


                <section class="tab-item" id="sub1">
                  <table class="write-table"
                         style="width: 100%; border-collapse: collapse; table-layout: fixed;">
                    <caption style="text-align: left; margin-bottom: 8px;">상세테이블</caption>
                    <thead>
                    <tr>
                      <th colspan="4" style="text-align: center;">갑 구 (소유권에 관한 사항)</th>
                    </tr>
                    </thead>
                    <tbody>

                    <tr>
                      <th style="font-size: 11px;">
                        등기목적
                      </th>
                      <td colspan="3">

                      </td>
                    </tr>
                    <tr>
                      <th style="font-size: 11px;">
                        접수
                      </th>
                      <td colspan="3">

                      </td>
                    </tr>
                    <tr>
                      <th style="font-size: 11px;">
                        등기원인
                      </th>
                      <td colspan="3">

                      </td>
                    </tr>

                    <tr>
                      <th style="font-size: 11px; text-align: center;" colspan="4">권리자 및 기타사항</th>

                    </tr>
                    <tr>
                      <td colspan="4">

                      </td>
                    </tr>
                    </tbody>
                  </table>
                </section>

                <section class="tab-item" id="sub2">
                  <table class="write-table"
                         style="width: 100%; border-collapse: collapse; table-layout: fixed;">
                    <caption style="text-align: left; margin-bottom: 8px;">상세테이블</caption>
                    <thead>
                    <tr>
                      <th colspan="4" style="text-align: center;">을 구 (소유권 이외의 권리에 관한 사항)</th>
                    </tr>
                    </thead>
                    <tbody>

                    <tr>
                      <th style="font-size: 11px;">
                        등기목적
                      </th>
                      <td colspan="3">

                      </td>
                    </tr>
                    <tr>
                      <th style="font-size: 11px;">
                        접수
                      </th>
                      <td colspan="3">

                      </td>
                    </tr>
                    <tr>
                      <th style="font-size: 11px;">
                        등기원인
                      </th>
                      <td colspan="3">

                      </td>
                    </tr>

                    <tr>
                      <th style="font-size: 11px; text-align: center;" colspan="4">권리자 및 기타사항</th>

                    </tr>
                    <tr>
                      <td colspan="4">

                      </td>
                    </tr>
                    </tbody>
                  </table>
                </section>
              </div>
            </section>

          </div>
        </div>
      </div>
      <div class="popup-button">
        <button class="btn-popup-close btn-navy">확인</button>
      </div>
    </div>
  </div>

  <!--이력보기 팝업-->
  <div class="mobile-layout-popup">
    <div class="popup-wrapper" id="popup-details">
      <div class="popup-title">
        <h3>이력 내역</h3>
        <a title="팝업닫기" class="btn-popup-close">
          <img src="/assets_mobile/images/icon/btn-popup-close.svg" alt="닫기">
        </a>
      </div>
      <div class="popup-contents">
        <div class="ticket-tit">
          <dl>
            <dd></dd>
          </dl>
        </div>
        <div class="table-container">
          <div class="list-table-wrap" style="overflow-x: auto;">

          </div>
        </div>
        <div class="write-wrap">
        </div>
      </div>
      <div class="popup-button">
        <button class="btn-popup-close btn-navy">확인</button>
      </div>
    </div>
  </div>

  <div class="mobile-layout-popup" id="popup-history2">
    <div class="popup-overlay"></div>
    <div class="popup-wrapper" id="scoreWrapper">
      <div class="popup-title">
        <h3>상세보기</h3>
      </div>
      <div class="popup-contents">
        <div class="table-wrap" style="width: 600px">
          <div class="write-wrap">
            <section class="tab-item">
              <div class="tab-wrap" style="width: 100%;">
                <ul class="tab-links" style="margin-bottom: 10px;">
                </ul>

                <section class="tab-item">
                  <table>
                    <thead>
                    <tr>
                      <th style="text-align: center; width: 20%; padding: 5px; border: 1px solid #ddd; font-size: 13px;">
                        <label>등기목적</label>
                      </th>
                      <th style="text-align: center; width: 37%; padding: 5px; border: 1px solid #ddd; font-size: 13px;">
                        <label>COMMENT</label>
                      </th>
                      <th style="text-align: center; width: 7%; padding: 5px; border: 1px solid #ddd; font-size: 13px;">
                        <label>날짜</label>
                      </th>
                    </tr>
                    </thead>
                    <tbody id="scoreItems2">

                    </tbody>
                  </table>
                </section>
              </div>
            </section>
          </div>
        </div>
      </div>
      <div class="popup-button">
        <button class="btn-popup-close btn-navy" id="closePopup2">확인</button>
      </div>
    </div>
  </div>

</div> <!-- //page-wrapper end-->

<script th:inline="javascript">
  // // Thymeleaf에서 값 설정: Null 체크와 기본값 처리
  // var groupid = [[${session.groupid != null ? session.groupid : 'null'}]];
  // var id = /*[[${id != null ? id : 'null'}]]*/;
  // var groupname = /*[[${groupname != null ? groupname : 'null'}]]*/;
  // var username = /*[[${username != null ? username : 'null'}]]*/;
  //
  // // 로컬스토리지에 값 유지 (null 또는 빈 문자열은 저장하지 않음)
  // if (groupid && groupid !== 'null') localStorage.setItem('groupid', groupid);
  // if (id && id !== 'null') localStorage.setItem('id', id);
  // if (username && username !== 'null') localStorage.setItem('username', username);
  // if (groupname && groupname !== 'null') localStorage.setItem('groupname', groupname);
</script>


<script type="text/javascript">

  document.readyState === 'complete' ? init() : window.onload = init;

  function formatDate(date) {
    let yyyy = date.getFullYear();
    let mm = String(date.getMonth() + 1).padStart(2, '0');
    let dd = String(date.getDate()).padStart(2, '0');
    return `${yyyy}-${mm}-${dd}`;
  }

  function updateDateRange() {
    const selectedValue = document.getElementById('property').value;
    const startDateInput = document.getElementById('startDate');
    const endDateInput = document.getElementById('endDate');

    let newStartDate;
    const today = new Date(); // 현재 날짜

    if (selectedValue === "my_property") {
      newStartDate = new Date(today.getFullYear(), 0, 1); // 올해 1월 1일
    } else if (selectedValue === "recent_property") {
      newStartDate = new Date(today);
      newStartDate.setMonth(today.getMonth() - 1); // 한 달 전
    } else if (selectedValue === "most_viewed_property") {
      newStartDate = new Date(today);
      newStartDate.setFullYear(today.getFullYear() - 1); // 일 년 전
    } else if (selectedValue === "popular_property") {
      newStartDate = new Date(today);
      newStartDate.setDate(today.getDate() - 14); // 2주 전
    }

    startDateInput.value = formatDate(newStartDate);
    endDateInput.value = formatDate(today);
  }

  // 이벤트 리스너 추가 (select 값이 변경될 때마다 실행)
  document.getElementById('property').addEventListener('change', updateDateRange);

  // 🔹 **초기 실행 시 select 요소의 현재 값으로 날짜 설정**
  document.addEventListener("DOMContentLoaded", updateDateRange);


  function init() {
    fetchListData();
  }

  function maskName(name) {
    if (!name) return '';  // name이 비어 있으면 빈 문자열을 반환

    const maskedPart = name.slice(1);  // 첫 글자 제외하고 나머지 부분
    const masked = '*'.repeat(Math.max(0, maskedPart.length));  // 음수 방지, 최소 0 이상으로 설정

    return name[0] + masked;  // 첫 글자는 그대로 두고 나머지는 *로 마스킹
  }


  // 데이터를 받아와 카드 렌더링
  function fetchListData() {
    let startDate = $('#startDate').val();
    let endDate = $('#endDate').val();
    let property = $('#property').val();
    let keyword = $('#keyword').val();


    /* console.log("전송할 데이터:", startDate, endDate, property); // 콘솔 확인*/

    $.ajax({
      url: '/api/mobile_production/read_all',
      type: 'GET',
      data: {
        'search_startDate': startDate,
        'search_endDate': endDate,
        'search_property': property,
        'keyword': keyword
      },
      success: function (data) {
        //console.log("data to server : ", data);


        const propertyData = data[property];

        // 목록 건수 업데이트
        const listNumElement = document.querySelector('.list-num .blue');
        if (listNumElement) {
          listNumElement.textContent = `${propertyData && propertyData.length ? propertyData.length : 0} 건`;
        }

        // 주소 리스트 업데이트
        const listAddressWrap = document.getElementById('addressWrap');
        if (!listAddressWrap) {
          console.error("addressWrap 요소를 찾을 수 없습니다.");
          return;
        }

        listAddressWrap.innerHTML = ''; // 기존 내용 초기화

        if (propertyData === null || propertyData.length === 0) {
          console.log("데이터가 없거나 비어 있습니다.");
          return;
        }

        const availableColors = ['card-purple'];
        let colorIndex = 0;
        let htmlContent = '';

        const selectedValue = $('#property').val();
       // console.log(JSON.stringify(propertyData, null, 2));

        propertyData.forEach(item => {
          const cardColor = availableColors[colorIndex];
          const {bgColor, textColor} = getBadgeColorByScore(item.REALSCORE); // 배경색 가져오기
          const badgeGrade = getBadgeClass(item.REALSCORE); // 등급 가져오기
          colorIndex = (colorIndex + 1) % availableColors.length;

          let buttonsHtml = `
                  <div style="display: flex; gap: 5px; align-items: center; max-width: 100%;">
                  <button class="btn btn-popup-open" data-popup="popup-history2" title="상세보기" style="padding: 4px 12px; border-radius: 20px; transition: background-color 0.3s ease;">상세보기</button>
                     <button class="btn btn-popup-open" data-popup="popup-details" title="이력보기" style="margin-top: 5px;margin-bottom: 5px; padding: 4px 12px; border-radius: 20px; transition: background-color 0.3s ease;  ">변경된 이력보기</button>
                  </div>`;

          // 날짜 포맷 변경
          const date = new Date(item.Sreqdate);
          date.setHours(date.getHours() + 9); // UTC -> KST 변환

          const year = date.getFullYear();
          const month = String(date.getMonth() + 1).padStart(2, "0");
          const day = String(date.getDate()).padStart(2, "0");

          const formattedDate = `${year}-${month}-${day}`;

          /*console.log(formattedDate);*/

          // Suserid 값이 'super' 또는 'admin'이면 마스킹하지 않음
          const maskedUserName = (item.Suserid && (item.Suserid === 'super' || item.Suserid === 'admin'))
            ? item.Suserid[0] + '****'
            : maskName(item.USERNM || '');


          htmlContent += `
                        <div class="card-box ${cardColor}" data-realadd="${item.REALADD}" data-resido="${item.RESIDO}" data-realid="${item.REALID}"
                    data-regdate="${item.REGDATE}" data-regugun="${item.REGUGUN}" data-rejimok="${item.REJIMOK}" data-rearea="${item.REAREA}"
                    data-remaxamt="${item.REMAXAMT}" data-uniqueNo="${item.UniqueNo}" style="margin-bottom: 10px;">

                            <div class="card-cont">
                              <dl class="card-address">
                                      <dd class="realadd-click" data-popup="popup-history" data-address="${item.REALADD}">
                                        ${item.REALADD}
                                      </dd>
                                   </dl>
                                ${selectedValue !== "most_viewed_property" ? `
                                    <dl>
                                        <dt>회원명</dt>
                                        <dd>${maskedUserName}</dd>
                                    </dl>` : ''}
                                 ${
            (selectedValue === "recent_property" || selectedValue === "popular_property")
              ? `<dl>
                                <dt>최근조회날짜</dt>
                                <dd>${formattedDate}</dd>
                            </dl>`
              : selectedValue === "most_viewed_property"
                ? `<dl>
                                <dt>최근발급날짜</dt>
                                <dd>${item.WksbiBalDate}</dd>
                            </dl>`
                : selectedValue === "my_property"
                  ? `<dl>
                                <dt>조회날짜</dt>
                                <dd>${formattedDate}</dd>
                            </dl>`
                  : ''
          }

                                 <dl>
                                    <dt>판정점수</dt>
                                    <dd>${item.REALSCORE}</dd>
                                </dl>
                            <dl>
                              <dt>등급</dt>
                              <dd>
                                  <div class="badge" style="background: ${bgColor}; color: ${textColor}; font-size: 15px;">
                                      ${badgeGrade} 등급
                                  </div>
                              </dd>
                            </dl>
                              ${(selectedValue === "recent_property" || selectedValue === "popular_property") ? `
                                <dl>
                                    <dt>조회수</dt>
                                    <dd>${item.record_count}</dd>
                                </dl>
                                ` : selectedValue === "most_viewed_property" ? `
                                <dl>
                                    <dt>발급횟수</dt>
                                    <dd>${item.PinNo_Count}</dd>
                                </dl>
                                ` : ''}
                            </div>
                                ${buttonsHtml}
                        </div>
                    `;
        });

        listAddressWrap.innerHTML = htmlContent;

        // cardBox 요소들이 DOM에 추가된 후, data-ranknoA 속성 설정
        const cardBoxes = listAddressWrap.querySelectorAll('.card-box'); // 모든 card-box 요소 선택

        cardBoxes.forEach(cardBox => {
          const item = propertyData.find(dataItem => dataItem.REALID === Number(cardBox.dataset.realid)); // 문자열 비교를 위해 Number() 추가
          if (item) {  // item이 undefined가 아닌 경우에만 속성 설정
            cardBox.setAttribute('data-ranknoA', JSON.stringify(item.RankNo_a_data));
            /*   console.log("data-ranknoA 설정:", cardBox.dataset.realid, JSON.stringify(item.RankNo_a_data)); // 디버깅 로그 추가*/
          } else {
            /*console.log("해당 REALID를 가진 데이터를 찾을 수 없습니다:", cardBox.dataset.realid); // 디버깅 로그 추가*/
          }
        });


        cardBoxes.forEach(cardBox => {
          const item = propertyData.find(dataItem => dataItem.REALID === Number(cardBox.dataset.realid)); // 문자열 비교를 위해 Number() 추가
          if (item) {  // item이 undefined가 아닌 경우에만 속성 설정
            cardBox.setAttribute('data-ranknoB', JSON.stringify(item.RankNo_b_data));
            /* console.log("data-ranknoB 설정:", cardBox.dataset.realid, JSON.stringify(item.RankNo_b_data)); // 디버깅 로그 추가*/
          } else {
            /*console.log("해당 REALID를 가진 데이터를 찾을 수 없습니다:", cardBox.dataset.realid); // 디버깅 로그 추가*/
          }
        });

        listAddressWrap.addEventListener('click', (event) => {
          const button = event.target.closest('.btn-popup-open[data-popup="popup-history2"]');
          const delButton = event.target.closest('.btn-popup-open[data-popup="popup-details"]');
          const address = event.target.closest('.realadd-click[data-popup="popup-history"]'); // 주소 클릭 이벤트 추가

          if (address) {
            event.preventDefault();

            const cardBox = address.closest('.card-box');
            if (!cardBox) return;

            const realId = cardBox.getAttribute('data-realid');
            console.log("주소 클릭됨! REALID:", realId);

            // AJAX 요청 실행
            $.ajax({
              url: `/api/IssueInquiry/DetailsList?realId=${realId}`,
              data: {
                'startDate': $('#startDate').val(),
                'endDate': $('#endDate').val(),
              },
              type: 'GET',
              success: function (data) {
                console.log("서버에서 가져온 상세 데이터:", data);

                // 팝업 제목 업데이트
                document.querySelector("#popup-history .popup-title h3").textContent = data.REALADD + " 상세내용 클릭이벤트";
                console.log("클릭이벤트 : ", data.data.REALADD);

                const cardBox = address.closest('.card-box');

                const realAdd = cardBox.getAttribute('data-realadd');
                const resido = cardBox.getAttribute('data-resido') || '';
                const regdate = cardBox.getAttribute('data-regdate') || '';
                const regugun = cardBox.getAttribute('data-regugun') || '';
                const rejimok = cardBox.getAttribute('data-rejimok') || '';
                const rearea = cardBox.getAttribute('data-rearea') || '';
                const uniqueNo = data.UniqueNo ? data.UniqueNo : "";
                const uniqueNoSafe = (uniqueNo === null || uniqueNo === "null") ? '' : uniqueNo;
                const remaxamt = cardBox.getAttribute('data-remaxamt') || '';
                const numericRemaxamt = !isNaN(remaxamt) && remaxamt.trim() !== '' ? Number(remaxamt) : 0;
                const formattedRemaxamt = numericRemaxamt.toLocaleString(undefined, {
                  minimumFractionDigits: 2,
                  maximumFractionDigits: 2
                });

                // 팝업 타이틀 업데이트
                const popupTitle = document.querySelector("#popup-history .popup-title h3");
                if (popupTitle) {
                  popupTitle.textContent = `${realAdd} 상세내용`;
                }
                // 날짜 포맷 변경
                const formattedRegDate = regdate
                  ? regdate.substring(0, 4) + '년' + regdate.substring(4, 6) + '월' + regdate.substring(6, 8) + '일'
                  : '';

                // 표제부
                const tds = document.querySelectorAll("#popup-history td[colspan='3']");
                if (tds.length >= 4) {  // 최소 4개 이상 있어야 함
                  tds[0].textContent = formattedRegDate && formattedRegDate !== "null" ? formattedRegDate : "-";
                  tds[1].textContent = realAdd && realAdd !== "null" ? realAdd + " " + (uniqueNoSafe && uniqueNoSafe !== "null" ? uniqueNoSafe : "-") : "-";
                  tds[2].textContent = resido && resido !== "null" ? resido + " " + (regugun && regugun !== "null" ? regugun : "-") : "-";
                  tds[3].textContent = formattedRemaxamt && formattedRemaxamt !== "null" ? formattedRemaxamt : "-";
                } else {
                  console.warn("해당 요소를 찾을 수 없거나 개수가 부족합니다.");
                }

                const rows = document.querySelector("#popup-history table tbody").getElementsByTagName("tr");
                if (rows.length >= 4) {  // 4번째 행이 있는지 확인
                  const tds = rows[3].getElementsByTagName("td");
                  if (tds.length >= 2) {  // 최소 2개의 td가 있어야 함
                    tds[0].textContent = rejimok && rejimok !== "null" ? rejimok : "-";
                    tds[1].textContent = rearea && rearea !== "null" ? rearea : "-";
                  } else {
                    console.warn("4번째 행의 td 개수가 부족합니다.");
                  }
                } else {
                  console.warn("4번째 행이 존재하지 않습니다.");
                }
                // 테이블 요소 가져오기
                const sub1Table = document.querySelector("#sub1 table tbody");
                const sub2TableBody = document.querySelector("#sub2 table tbody");

                if (!sub1Table || !sub2TableBody) {
                  console.error("오류: sub1Table 또는 sub2TableBody을 찾을 수 없습니다.");
                  return;
                }

                // 데이터를 배열로 받아서 중복 제거 후 사용
                let details = Array.isArray(data.data) && data.data.length > 0 ? data.data : [];

                if (details.length === 0) {
                  console.warn("A등기 데이터 없음");
                } else {
                  let tableBody = document.querySelector("#sub1 table tbody");
                  tableBody.innerHTML = ""; // 기존 데이터 초기화

                  details.forEach((entry) => {
                    // null 또는 undefined를 "-"로 대체하는 함수
                    const safeValue = (value) => value && value !== "null" ? value : "-";

                    // 등기 목적 행
                    let row1 = document.createElement("tr");
                    row1.innerHTML = `
            <th style="font-size: 11px;">등기목적</th>
            <td colspan="3">${safeValue(entry.RgsAimCont_A)}</td>
        `;
                    tableBody.appendChild(row1);

                    // 접수 행
                    let row2 = document.createElement("tr");
                    row2.innerHTML = `
            <th style="font-size: 11px;">접수</th>
            <td colspan="3">${safeValue(entry.Receve_A)}</td>
        `;
                    tableBody.appendChild(row2);

                    // 등기 원인 행
                    let row3 = document.createElement("tr");
                    row3.innerHTML = `
            <th style="font-size: 11px;">등기원인</th>
            <td colspan="3">${safeValue(entry.RgsCaus_A)}</td>
        `;
                    tableBody.appendChild(row3);

                    // 권리자 및 기타사항 제목
                    let row4 = document.createElement("tr");
                    row4.innerHTML = `
            <th style="font-size: 11px; text-align: center;" colspan="4">권리자 및 기타사항</th>
        `;
                    tableBody.appendChild(row4);

                    // 권리자 및 기타사항 데이터
                    let row5 = document.createElement("tr");
                    row5.innerHTML = `
            <td colspan="4">${safeValue(entry.NomprsAndEtc_A)}</td>
        `;
                    tableBody.appendChild(row5);
                  });
                }

                // 을구
                if (details.length === 0) {
                  console.warn("B등기 데이터 없음");
                } else {
                  let tableBody = document.querySelector("#sub2 table tbody"); // A등기 방식과 동일하게 변경
                  tableBody.innerHTML = ""; // 기존 데이터 초기화 추가

                  details.forEach((entry) => {
                    // null 또는 undefined를 "-"로 대체하는 함수
                    const safeValue = (value) => value && value !== "null" ? value : "-";

                    // 등기목적 행 추가
                    let row1 = document.createElement("tr");
                    row1.innerHTML = `
            <th style="font-size: 11px;">등기목적</th>
            <td colspan="3">${safeValue(entry.RgsAimCont_B)}</td>
        `;
                    tableBody.appendChild(row1);

                    // 접수 행 추가
                    let row2 = document.createElement("tr");
                    row2.innerHTML = `
            <th style="font-size: 11px;">접수</th>
            <td colspan="3">${safeValue(entry.Receve_B)}</td>
        `;
                    tableBody.appendChild(row2);

                    // 등기 원인 행 추가
                    let row3 = document.createElement("tr");
                    row3.innerHTML = `
            <th style="font-size: 11px;">등기원인</th>
            <td colspan="3">${safeValue(entry.RgsCaus_B)}</td>
        `;
                    tableBody.appendChild(row3);

                    // 권리자 및 기타사항 제목 행 추가
                    let row4 = document.createElement("tr");
                    row4.innerHTML = `
            <th style="font-size: 11px; text-align: center;" colspan="4">권리자 및 기타사항</th>
        `;
                    tableBody.appendChild(row4);

                    // 권리자 및 기타사항 데이터 행 추가
                    let row5 = document.createElement("tr");
                    row5.innerHTML = `
            <td colspan="4">${safeValue(entry.NomprsAndEtc_B)}</td>
        `;
                    tableBody.appendChild(row5);
                  });
                }

                // 팝업 열기
                document.querySelector('.popup-wrapper').classList.add('active');
              },
              error: function (xhr, status, error) {
                console.error("상세 데이터 불러오기 실패:", error);
              }
            });
          }

          if (button) {
            const cardBox = button.closest('.card-box');
            if (!cardBox) return;

            const realId = cardBox.getAttribute('data-realid');
            if (!realId) return;

            console.log("📌 상세보기 버튼 클릭됨! REALID:", realId);

            //cardDetail()` 함수 실행
            cardDetail(realId);
          }


          if (delButton) {
            const cardBox = delButton.closest('.card-box');
            if (!cardBox) return;

            const realid = cardBox.getAttribute("data-realid");
            const address = cardBox.getAttribute('data-realadd') || "주소 정보 없음";

            if (!realid) {
              console.warn("REALID 없음!");
              return;
            }

            console.log("이력보기 버튼 클릭됨! REALID, address:", realid, address);

            handleClick(realid, address);
          }

        });

      },
      error: function (xhr, status, error) {
        console.error("AJAX 요청 실패:", status, error);
        console.error("응답 내용:", xhr.responseText);
      }
    });
  }


  function handleSearch() {
    fetchListData();
    closeSearch();
  }

  // 조회버튼 클릭시 검색창 close
  function closeSearch() {
    document.querySelector('.btn-aco').click();
  }

  function getBadgeColorByScore(score) {
    if (score === "미확인") return {bgColor: "#DADADA", textColor: "black"}; // 점수 없음 (회색)
    let numericScore = parseFloat(score);

    if (numericScore >= 90) return {bgColor: "#F4F4F4", textColor: "black"}; // S 등급 (안심) → 연한 회색 (검은 글씨)
    if (numericScore >= 80) return {bgColor: "#4CAF50", textColor: "white"}; // A 등급 (관심) → 녹색
    if (numericScore >= 70) return {bgColor: "#3069B3", textColor: "white"}; // B 등급 (주의) → 파란색
    if (numericScore >= 60) return {bgColor: "#FFC107", textColor: "black"}; // C 등급 (경계) → 노란색
    if (numericScore >= 50) return {bgColor: "#FF8C00", textColor: "white"}; // D 등급 (불안) → 주황색
    if (numericScore >= 40) return {bgColor: "#EC193A", textColor: "white"}; // E 등급 (심각) → 빨간색
    return {bgColor: "#1D1D1D", textColor: "white"}; // F 등급 (위험) → 검은색 (흰 글씨)
  }

  function getBadgeClass(score) {
    if (score >= 90) return "S"; // S 등급 (안심)
    if (score >= 80) return "A"; // A 등급 (관심)
    if (score >= 70) return "B"; // B 등급 (주의)
    if (score >= 60) return "C"; // C 등급 (경계)
    if (score >= 50) return "D"; // D 등급 (불안)
    if (score >= 40) return "E"; // E 등급 (심각)
    return "F"; // F 등급 (위험)
  }

  function handleClick(realid, address) {
    $.ajax({
      url: "/api/IssueInquiry/popupDetails",
      type: "GET",
      data: {realid: realid},
      headers: {
        'X-CSRF-Token': $('[name=_csrf]').val()
      },
      success: function (response) {
        console.log("서버에서 받은 데이터(이력 보기):", response);

        if (response.success) {
          let regDateMap = {};
          let regScoreMap = {};

          if (response.findPinNO && response.findPinNO.length > 0) {
            response.findPinNO.forEach(item => {
              if (item.REALID) {
                regDateMap[item.REALID] = item.INDATEM || '';
                regScoreMap[item.REALID] = item.REALSCORE || '';
              }
            });
          }

          let listData = {
            REALID: realid,
            SHORT_ADDR: address // 받아온 주소값 사용
          };

          let transformedDataA = response.findnK ? response.findnK.map(item => ({
            ...item,
            INDATEM: regDateMap[item.REALID] || '미확인',
            REALSCORE: regScoreMap[item.REALID] || '미확인',
            displayText: `[갑구] ${item.RgsAimCont}`
          })) : [];

          let transformedDataB = response.findnE ? response.findnE.map(item => ({
            ...item,
            INDATEM: regDateMap[item.REALID] || '미확인',
            REALSCORE: regScoreMap[item.REALID] || '미확인',
            displayText: `[을구] ${item.RgsAimCont}`
          })) : [];

          updatePopupContent(transformedDataA, transformedDataB, listData);
          $('.list-card-wrap').scrollTop(0);
        } else {
          console.warn("데이터 없음:", response.message);
          Alert.alert('', "해당 물건에 대한 정보를 찾을 수 없습니다.");
        }
      },
      error: function (xhr, status, error) {
        console.error("AJAX 요청 실패:", status, error);
        Alert.alert("서버와의 통신 중 오류가 발생했습니다.");
      }
    });
  }

  function formatDateTo12Hour(indatem) {
    if (!indatem) return "미확인";

    let dateObj = new Date(indatem);
    let year = dateObj.getFullYear();
    let month = String(dateObj.getMonth() + 1).padStart(2, '0');
    let day = String(dateObj.getDate()).padStart(2, '0');
    let hours = dateObj.getHours();
    let minutes = String(dateObj.getMinutes()).padStart(2, '0');
    let period = hours >= 12 ? "PM" : "AM";

    hours = hours % 12 || 12; // 12시간제 변환

    return `${year}-${month}-${day} ${hours}:${minutes} ${period}`;
  }

  function updatePopupContent(findnK, findnE, listData) {
    let popup = document.getElementById('popup-details');
    let overlay = document.querySelector('.popup-overlay');
    let listContainer = document.querySelector('.list-table-wrap');
    let addressField = document.querySelector('#popup-details .ticket-tit dd');

    addressField.textContent = listData?.SHORT_ADDR ?? '주소 정보 없음';

    listContainer.innerHTML = '';

    let allData = [...findnK.map(item => ({...item, type: 'K'})),
      ...findnE.map(item => ({...item, type: 'E'}))];

    if (allData.length === 0) {
      console.warn("등기부등본 데이터 없음");
      Alert.alert('', "별도의 등기목적이 없습니다.");
      listContainer.innerHTML = '<p style="text-align: center; padding: 10px;">해당 물건의 등기부등본 정보가 없습니다.</p>';
      return;
    }

    let groupedData = {};
    allData.forEach(item => {
      let indateTime = formatDateTo12Hour(item.INDATEM);
      let realId = item.REALID;
      let realScore = item.REALSCORE || '';

      let groupKey = `${indateTime}_${realId}`;

      if (!groupedData[groupKey]) {
        groupedData[groupKey] = {
          items: [],
          realScores: new Set()
        };
      }
      groupedData[groupKey].items.push(item);
      groupedData[groupKey].realScores.add(realScore);
    });

    Object.keys(groupedData)
      .sort((a, b) => {
        let [indateTimeA] = a.split("_");
        let [indateTimeB] = b.split("_");

        let dateA = new Date(indateTimeA);
        let dateB = new Date(indateTimeB);
        return dateB - dateA;
      })
      .forEach(groupKey => {
        let {items, realScores} = groupedData[groupKey];
        let [indateTime, realId] = groupKey.split("_");

        let realScoreText = Array.from(realScores).join(", ");
        let cardClass = getCardClassByScore(realScoreText);

        let tableHtml = `
                <table class="register-table" style="width: 100%; border-collapse: collapse; margin-bottom: 15px; overflow-x: auto;">
                    <thead>
                        <tr class="${cardClass}" style="background-color: #f2f2f2;">
                            <th colspan="7" style="padding: 8px; text-align: left;">발급일자: ${indateTime} &nbsp;&nbsp;&nbsp;&nbsp; 점수: ${realScoreText}</th>
                        </tr>
                        <tr>
                            <th style="padding: 8px; border: 1px solid #ddd;min-width:80px;">순위번호</th>
                            <th style="padding: 8px; border: 1px solid #ddd;min-width:200px;">등기 목적</th>
                            <th style="padding: 8px; border: 1px solid #ddd;min-width:200px;">대상 소유자</th>
                            <th style="padding: 8px; border: 1px solid #ddd;min-width:400px;text-align: left;">주요 등기사항</th>
                            <th style="padding: 8px; border: 1px solid #ddd;min-width:300px;">접수정보</th>
                            <th style="padding: 8px; border: 1px solid #ddd;min-width:80px;">구분</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

        items.forEach(item => {
          let sectionName = item.type === 'K' ? '갑구' : '을구';

          tableHtml += `
                    <tr>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${item?.RankNo || ''}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${item?.Purpose || ''}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${item?.TargetOwner || ''}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;text-align: left;">${item?.Information || ''}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${item?.ReceiptInfo || ''}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${sectionName}</td>
                    </tr>
                `;
        });

        tableHtml += `
                    </tbody>
                </table>
            `;

        listContainer.innerHTML += tableHtml;
      });

    popup.classList.add('active');
    overlay.style.display = 'block';
    popup.scrollTop = 0;
  }

  //점수별 카드 색
  function getCardClassByScore(score) {
    if (score === "미확인") return "card-white"; // 점수 없음 (S 등급: 안심)
    let numericScore = parseFloat(score); // 점수를 숫자로 변환

    if (numericScore >= 90) return "card-white"; // S 등급 (안심)
    if (numericScore >= 80) return "card-green"; // A 등급 (관심)
    if (numericScore >= 70) return "card-blue";  // B 등급 (주의)
    if (numericScore >= 60) return "card-yellow"; // C 등급 (경계)
    if (numericScore >= 50) return "card-orange"; // D 등급 (불안)
    if (numericScore >= 40) return "card-red";   // E 등급 (심각)
    return "card-black"; // F 등급 (위험)
  }

  //상세보기
  function cardDetail(realId) {
    $.ajax({
      url: '/api/register/deductionDetail',
      type: 'GET',
      data: { "REALID": realId },
      success: function (response) {
        data2 = response.data;
        console.log("상세보기 데이터: ", data2);

        const scoreWrap = document.getElementById('scoreItems2');
        if (!scoreWrap) {
          console.error("❌ 오류: 'scoreItems' 요소를 찾을 수 없습니다.");
          return;
        }

        // "항목차감"이 아닌 데이터만 필터링
        let filteredData = data2.filter(data => data.HISNM !== "항목차감");

        let htmlContent = '';
        filteredData.forEach(data => {

          // 날짜 변환 (YYYYMMDD → YYYY.MM.DD)
          let formattedDate = data.HISDATE
            ? `${data.HISDATE.slice(0, 4)}.${data.HISDATE.slice(4, 6)}.${data.HISDATE.slice(6, 8)}`
            : '';

          htmlContent += `
                    <tr>
                        <td style="width: 15%; padding: 5px; border: 1px solid #ddd;">
                            ${data.HISNM}
                        </td>
                        <td style="width: 15%; padding: 5px; border: 1px solid #ddd; text-align: left;">
                            ${data.REMARK}
                        </td>
                        <td style="width: 15%; padding: 5px; border: 1px solid #ddd;">
                            ${formattedDate}
                        </td>
                    </tr>`;
        });

        // 기존 내용을 초기화 후 새로운 데이터 추가
        scoreWrap.innerHTML = htmlContent;
      },
      error: function (error) {
        console.error("🚨 API 호출 중 오류 발생:", error);
      }
    });
  }

  $('.btn-popup-close').on('click', function () {
    $('.popup-overlay').fadeOut(200);
    $('.popup-wrapper').removeClass('active');

    $('.popup-contents').scrollTop(0).scrollLeft(0);
    $('.list-table-wrap').scrollTop(0).scrollLeft(0);
  });

</script>
</body>
</html>
